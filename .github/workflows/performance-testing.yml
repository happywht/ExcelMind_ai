# ExcelMind AI æ€§èƒ½æµ‹è¯• CI/CD å·¥ä½œæµ
#
# ç”¨é€”:
# - è‡ªåŠ¨è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
# - å¯¹æ¯”å†å²åŸºçº¿
# - æ£€æµ‹æ€§èƒ½å›å½’
# - ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
#
# è§¦å‘æ¡ä»¶:
# - Pull Request åˆ° main åˆ†æ”¯
# - æ¨é€åˆ° main åˆ†æ”¯
# - æ‰‹åŠ¨è§¦å‘

name: Performance Testing

on:
  pull_request:
    branches: [main, new_master]
    paths:
      - 'services/**'
      - 'components/**'
      - 'src/**'
  push:
    branches: [main, new_master]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: true
        default: 'quick'
        type: choice
        options:
          - quick
          - full
      update_baseline:
        description: 'æ›´æ–°æ€§èƒ½åŸºçº¿'
        required: false
        type: boolean
        default: false

# æƒé™
permissions:
  contents: read
  pull-requests: write

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.x'

jobs:
  # ============================================================================
  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  # ============================================================================
  performance-test:
    name: æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Node.js
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: npm ci

      # 4. ä¸‹è½½å†å²åŸºçº¿
      - name: ä¸‹è½½å†å²åŸºçº¿
        continue-on-error: true
        uses: actions/cache@v4
        with:
          path: test-results/performance/baseline.json
          key: performance-baseline-${{ github.ref }}
          restore-keys: |
            performance-baseline-main
            performance-baseline-

      # 5. è¿è¡Œæ€§èƒ½æµ‹è¯•
      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: |
          if [ "${{ github.event.inputs.test_mode }}" = "full" ]; then
            npm run perf:full
          else
            npm run perf:quick
          fi

      # 6. å¯¹æ¯”åŸºçº¿
      - name: å¯¹æ¯”æ€§èƒ½åŸºçº¿
        if: hashFiles('test-results/performance/baseline.json') != ''
        run: npm run perf:compare
        continue-on-error: true

      # 7. æ›´æ–°åŸºçº¿ (å¦‚æœéœ€è¦)
      - name: æ›´æ–°æ€§èƒ½åŸºçº¿
        if: |
          github.event.inputs.update_baseline == 'true' ||
          github.ref == 'refs/heads/main'
        run: npm run perf:baseline

      # 8. ä¸Šä¼ æµ‹è¯•ç»“æœ
      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            test-results/performance/*.json
            test-results/performance/*.html
          retention-days: 30

      # 9. ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šæ³¨é‡Š
      - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        if: github.event_name == 'pull_request'
        run: |
          # æå–å…³é”®æŒ‡æ ‡
          echo "## æ€§èƒ½æµ‹è¯•æŠ¥å‘Š ğŸš€" > performance-report.md
          echo "" >> performance-report.md
          echo "### æµ‹è¯•æ‘˜è¦" >> performance-report.md
          echo "- æ€»æµ‹è¯•æ•°: $(node -e "console.log(require('./test-results/performance/latest-results.json').summary.totalTests)")" >> performance-report.md
          echo "- é€šè¿‡: $(node -e "console.log(require('./test-results/performance/latest-results.json').summary.passedTests)")" >> performance-report.md
          echo "- å¤±è´¥: $(node -e "console.log(require('./test-results/performance/latest-results.json').summary.failedTests)")" >> performance-report.md
          echo "" >> performance-report.md
          echo "### æ€§èƒ½å˜åŒ–" >> performance-report.md
          echo "- æ€§èƒ½æå‡: $(node -e "console.log(require('./test-results/performance/latest-results.json').summary.improvedTests)")" >> performance-report.md
          echo "- æ€§èƒ½ä¸‹é™: $(node -e "console.log(require('./test-results/performance/latest-results.json').summary.degradedTests)")" >> performance-report.md
          echo "" >> performance-report.md
          echo "ğŸ“Š è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ [æ€§èƒ½æµ‹è¯•æŠ¥å‘Š](./PERFORMANCE_BENCHMARK_REPORT.md)" >> performance-report.md

      # 10. å‘å¸ƒæ€§èƒ½æŠ¥å‘Šåˆ° PR
      - name: å‘å¸ƒæ€§èƒ½æŠ¥å‘Š
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('performance-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # ============================================================================
  # æ€§èƒ½å›å½’æ£€æµ‹
  # ============================================================================
  regression-check:
    name: æ€§èƒ½å›å½’æ£€æµ‹
    runs-on: ubuntu-latest
    needs: performance-test

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æµ‹è¯•ç»“æœ
        uses: actions/download-artifact@v4
        with:
          name: performance-results
          path: test-results/performance/

      - name: æ£€æµ‹æ€§èƒ½å›å½’
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡æ€§èƒ½å›å½’
          degraded_count=$(node -e "console.log(require('./test-results/performance/latest-results.json').summary.degradedTests || 0)")
          critical_count=$(node -e "console.log(require('./test-results/performance/latest-results.json').summary.critical || 0)")

          if [ $critical_count -gt 0 ]; then
            echo "âŒ æ£€æµ‹åˆ° $critical_count ä¸ªä¸¥é‡æ€§èƒ½å›å½’ï¼"
            exit 1
          elif [ $degraded_count -gt 3 ]; then
            echo "âš ï¸ æ£€æµ‹åˆ° $degraded_count ä¸ªæ€§èƒ½ä¸‹é™ï¼Œè¯·æ£€æŸ¥"
            exit 1
          else
            echo "âœ… æ— ä¸¥é‡æ€§èƒ½å›å½’"
          fi

  # ============================================================================
  # æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ (ä»…åœ¨ main åˆ†æ”¯)
  # ============================================================================
  generate-report:
    name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [performance-test, regression-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ä¸‹è½½æµ‹è¯•ç»“æœ
        uses: actions/download-artifact@v4
        with:
          name: performance-results
          path: test-results/performance/

      - name: ç”Ÿæˆæœˆåº¦æ€§èƒ½æŠ¥å‘Š
        run: |
          # ç”Ÿæˆæ€§èƒ½è¶‹åŠ¿å›¾
          node scripts/performance-comparator.cjs \
            test-results/performance/baseline.json \
            test-results/performance/latest-results.json \
            --html test-results/performance/monthly-report.html

      - name: ä¸Šä¼ æœˆåº¦æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: monthly-performance-report
          path: test-results/performance/monthly-report.html
          retention-days: 90

  # ============================================================================
  # æ€§èƒ½å‘Šè­¦ (å¯é€‰)
  # ============================================================================
  performance-alert:
    name: æ€§èƒ½å‘Šè­¦
    runs-on: ubuntu-latest
    needs: performance-test
    if: failure()

    steps:
      - name: å‘é€å‘Šè­¦é€šçŸ¥
        run: |
          echo "âš ï¸ æ€§èƒ½æµ‹è¯•å¤±è´¥æˆ–æ£€æµ‹åˆ°ä¸¥é‡æ€§èƒ½å›å½’"
          echo "è¯·æŸ¥çœ‹: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
