# 多步分析系统 - 错误诊断和修复指南

## 📋 问题概述

您遇到的问题：**多步分析在执行阶段失败**

### ✅ 好消息：OTAE 循环正常工作！

从您的日志可以看到：
```
进度: 20% - Observing data      ✅ 观察阶段成功
进度: 40% - Planning approach     ✅ 思考阶段成功
进度: 60% - Executing transformation ⚠️ 执行阶段失败
```

**这说明**：
- ✅ AI 服务正常
- ✅ 代码生成成功
- ✅ 数据读取成功
- ⚠️ Python 代码执行失败

---

## 🔍 常见错误原因

### 1. Python 代码语法错误

**症状**：日志中出现 `SyntaxError` 或 `IndentationError`

**原因**：AI 生成的 Python 代码有语法错误

**解决方案**：
- 系统会自动尝试修复
- 如果失败，会降级到单步执行模式
- 可以手动切换到"快速模式"直接执行

### 2. 列名不匹配

**症状**：日志中出现 `KeyError` 或 `column not found`

**原因**：AI 生成的代码使用了不存在的列名

**解决方案**：
- 确保数据文件有明确的列名
- 使用简单的列名（避免空格、特殊字符）
- 检查数据是否正确加载

### 3. 数据类型错误

**症状**：日志中出现 `TypeError` 或数据类型不匹配

**原因**：数据类型推断错误

**解决方案**：
- 确保数据格式一致
- 检查是否有空值或异常值
- 使用更简单的测试数据

### 4. AI 服务响应慢

**症状**：长时间卡在"思考"阶段

**原因**：AI 服务繁忙或网络问题

**解决方案**：
- 等待更长时间（最多2分钟）
- 检查网络连接
- 查看控制台是否有错误

---

## 🛠️ 调试步骤

### 第一步：查看详细错误信息

1. **打开浏览器控制台**（F12）
2. **查看 Console 标签**
3. **查找红色错误信息**
4. **复制完整的错误堆栈**

### 第二步：检查数据文件

确认测试文件格式正确：
- ✅ 使用 `test-simple.xlsx`（最简单）
- ✅ 数据有明确的列名
- ✅ 没有合并单元格
- ✅ 没有复杂的嵌套结构

### 第三步：尝试简单命令

使用最简单的命令测试：
```
计算总销售额
```

**避免**：
- 复杂的数据处理
- 多个 Sheet 关联
- 复杂的过滤条件

### 第四步：切换到快速模式

如果智能模式持续失败：
1. 取消勾选"智能模式"
2. 使用快速模式直接执行
3. 快速模式不使用 OTAE 循环，更直接

---

## 📊 降级机制说明

当多步分析失败时，系统会：

```
智能模式失败
    ↓
显示错误信息
    ↓
自动降级到单步执行（快速模式）
    ↓
直接生成并执行代码
    ↓
返回结果
```

**这是正常的保护机制**，确保即使多步分析失败，您仍然能得到结果。

---

## 💡 改进建议

### 短期修复（立即可用）

1. **使用快速模式**
   - 取消勾选"智能模式"
   - 直接执行任务
   - 避开 OTAE 循环

2. **使用简单命令**
   - `计算总销售额`
   - `显示所有行`
   - `按产品分组`

3. **使用简单数据**
   - `test-simple.xlsx`（最简单）
   - 避免复杂数据

### 长期优化（后续改进）

1. **改进 AI 提示词**
   - 优化代码生成质量
   - 添加更多示例
   - 改进错误处理

2. **增强错误修复**
   - 添加更多修复策略
   - 改进代码分析
   - 智能降级

3. **提高兼容性**
   - 支持更多数据格式
   - 处理边界情况
   - 容错机制

---

## 🧪 测试建议

### 推荐测试顺序

1. **第一优先**：快速模式 + 简单命令
   ```
   文件: test-simple.xlsx
   命令: 计算总销售额
   模式: 快速模式
   ```

2. **第二优先**：智能模式 + 简单命令
   ```
   文件: test-simple.xlsx
   命令: 计算总销售额
   模式: 智能模式
   ```

3. **第三优先**：复杂场景
   ```
   文件: test-complex.xlsx
   命令: 计算平均工资
   模式: 任一模式
   ```

---

## 🔧 实用技巧

### 技巧 1：使用简单列名

**好的列名**：
- `销售额`、`数量`、`产品` ✅
- `sales_amount`、`quantity`、`product` ✅

**避免的列名**：
- `销售额 (元)`、`数量（个）` ❌
- `2024年Q1销售额` ❌

### 技巧 2：使用明确的命令

**好的命令**：
- `计算总销售额` ✅
- `显示前10行` ✅
- `按产品分组求和` ✅

**避免的命令**：
- `分析一下数据看看有什么` ❌
- `帮我处理一下` ❌

### 技巧 3：分步执行复杂任务

**不要一次性做太多**：
```
❌ 计算每个地区每个产品的销售额，然后按销售额降序排列，再计算平均利润率

✅ 第一步：计算每个地区的销售额
✅ 第二步：按销售额排序
✅ 第三步：计算利润率
```

---

## 📞 需要帮助？

### 收集诊断信息

如果问题持续，请收集：

1. **完整的错误日志**
   - 打开控制台（F12）
   - 复制所有红色错误信息
   - 包括错误堆栈

2. **测试文件信息**
   - 使用的文件名
   - 文件大小
   - 数据行数

3. **执行的命令**
   - 完整的命令文本
   - 使用的是智能模式还是快速模式

4. **执行时间**
   - 每个阶段耗时
   - 总耗时

### 提交问题

将以上信息发送给我，我会：
1. 分析具体错误原因
2. 提供针对性解决方案
3. 改进系统

---

## ✅ 总结

**当前状态**：
- ✅ OTAE 循环正常工作
- ✅ 前2个阶段（观察、思考）成功
- ⚠️ 第3个阶段（执行）失败
- ✅ 降级机制正常触发

**建议**：
1. 先用快速模式测试基础功能
2. 使用简单数据和命令
3. 查看详细错误信息
4. 逐步增加复杂度

**记住**：降级到单步执行是正常的保护机制，不影响最终结果！

---

**现在可以重新测试了！** 🚀

建议从快速模式开始，使用 `test-simple.xlsx` 和命令 `计算总销售额`。
