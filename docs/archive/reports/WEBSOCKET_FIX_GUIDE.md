# WebSocketæ¶ˆæ¯æ—¶åºä¿®å¤æŒ‡å—

## é—®é¢˜è¯Šæ–­

### ç—‡çŠ¶
ç»¼åˆæµ‹è¯•ä¸­å®¢æˆ·ç«¯åœ¨5ç§’è¶…æ—¶çª—å£å†…æœªæ”¶åˆ°æœåŠ¡å™¨çš„connectedæ¶ˆæ¯ã€‚

### æ ¹æœ¬åŸå› 
åœ¨`addClient`å‡½æ•°ä¸­ï¼Œ`sendMessage`æ˜¯å¼‚æ­¥å‡½æ•°ä½†æœªè¢«awaitï¼Œå¯¼è‡´æ¶ˆæ¯å‘é€å’Œå®¢æˆ·ç«¯handlerè®¾ç½®å­˜åœ¨ç«æ€æ¡ä»¶ã€‚

### éªŒè¯
ç‹¬ç«‹æµ‹è¯•ï¼ˆsimple-websocket-test.tsï¼‰å®Œå…¨é€šè¿‡ï¼Œè¯æ˜ï¼š
- æœåŠ¡å™¨åŠŸèƒ½æ­£å¸¸
- å®¢æˆ·ç«¯èƒ½æ¥æ”¶æ¶ˆæ¯
- é—®é¢˜ä»…åœ¨äºæ—¶åº

---

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ·»åŠ awaitï¼ˆæ¨èï¼‰âœ…

**æ–‡ä»¶**: `server/websocket/websocketServer.ts`
**ä½ç½®**: ç¬¬279è¡Œ

**å½“å‰ä»£ç **:
```typescript
// å‘é€è¿æ¥ç¡®è®¤æ¶ˆæ¯
this.sendMessage(clientId, {
  type: MessageType.CONNECTED,
  payload: {
    clientId,
    serverTime: Date.now(),
    config: {
      heartbeatInterval: this.config.heartbeatInterval,
    },
  },
  timestamp: Date.now(),
});
```

**ä¿®å¤å**:
```typescript
// å‘é€è¿æ¥ç¡®è®¤æ¶ˆæ¯
await this.sendMessage(clientId, {
  type: MessageType.CONNECTED,
  payload: {
    clientId,
    serverTime: Date.now(),
    config: {
      heartbeatInterval: this.config.heartbeatInterval,
    },
  },
  timestamp: Date.now(),
});
```

**å½±å“**: ç¡®ä¿æ¶ˆæ¯å‘é€å®Œæˆåæ‰ç»§ç»­

### æ–¹æ¡ˆ2: å¢åŠ æµ‹è¯•è¶…æ—¶æ—¶é—´

**æ–‡ä»¶**: æµ‹è¯•è„šæœ¬ä¸­çš„`waitForMessage`å‡½æ•°

**å½“å‰ä»£ç **:
```typescript
function waitForMessage(ws: WebSocket, timeout: number = 5000): Promise<any> {
```

**ä¿®å¤å**:
```typescript
function waitForMessage(ws: WebSocket, timeout: number = 10000): Promise<any> {
```

**å½±å“**: ç»™å®¢æˆ·ç«¯æ›´å¤šæ—¶é—´æ¥æ”¶æ¶ˆæ¯

---

## ä¿®å¤æ­¥éª¤

### Step 1: åº”ç”¨ä»£ç ä¿®å¤

1. æ‰“å¼€`server/websocket/websocketServer.ts`
2. æ‰¾åˆ°ç¬¬279è¡Œ
3. åœ¨`this.sendMessage`å‰æ·»åŠ `await`
4. ä¿å­˜æ–‡ä»¶

### Step 2: éªŒè¯ä¿®å¤

è¿è¡Œç‹¬ç«‹æµ‹è¯•ï¼š
```bash
npx tsx scripts/simple-websocket-test.ts
```

é¢„æœŸè¾“å‡ºï¼š
```
âœ“ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
âœ“ å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ
âœ“ æ”¶åˆ°connectedæ¶ˆæ¯
âœ“ Ping/Pongæ­£å¸¸
```

### Step 3: è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

```bash
npx tsx scripts/comprehensive-websocket-test.ts
```

é¢„æœŸç»“æœï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡ç‡åº”è¯¥æ˜¾è‘—æé«˜

---

## éªŒè¯æ¸…å•

### ä¿®å¤å‰
- [ ] ç®€å•æµ‹è¯•é€šè¿‡
- [x] ç»¼åˆæµ‹è¯•å¤±è´¥ï¼ˆæ¶ˆæ¯è¶…æ—¶ï¼‰
- [ ] æœåŠ¡å™¨åŠŸèƒ½æ­£å¸¸

### ä¿®å¤å
- [x] ç®€å•æµ‹è¯•é€šè¿‡
- [ ] ç»¼åˆæµ‹è¯•é€šè¿‡ç‡>80%
- [x] æœåŠ¡å™¨åŠŸèƒ½æ­£å¸¸
- [ ] æ¶ˆæ¯å»¶è¿Ÿ<100ms

---

## å›å½’æµ‹è¯•

### å¿…é¡»éªŒè¯çš„åŠŸèƒ½

1. **è¿æ¥ç®¡ç†**
   - [ ] å®¢æˆ·ç«¯æˆåŠŸè¿æ¥
   - [ ] ç«‹å³æ”¶åˆ°connectedæ¶ˆæ¯
   - [ ] å¤šå®¢æˆ·ç«¯å¹¶å‘è¿æ¥

2. **æ¶ˆæ¯æ”¶å‘**
   - [ ] Ping/Pongå“åº”
   - [ ] è®¢é˜…ç¡®è®¤
   - [ ] æˆ¿é—´æ“ä½œ

3. **æˆ¿é—´ç®¡ç†**
   - [ ] åŠ å…¥æˆ¿é—´
   - [ ] ç¦»å¼€æˆ¿é—´
   - [ ] æˆ¿é—´å¹¿æ’­

4. **ç»Ÿè®¡ç›‘æ§**
   - [ ] è¿æ¥ç»Ÿè®¡å‡†ç¡®
   - [ ] æ¶ˆæ¯ç»Ÿè®¡å‡†ç¡®
   - [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸

---

## æ€§èƒ½éªŒè¯

### ä¿®å¤åéœ€è¦æµ‹è¯•çš„æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|----------|
| å¹¶å‘è¿æ¥æ•° | >100 | å‹åŠ›æµ‹è¯• |
| æ¶ˆæ¯å»¶è¿Ÿ | <50ms | å»¶è¿Ÿæµ‹è¯• |
| æ¶ˆæ¯ååé‡ | >5000/s | ååé‡æµ‹è¯• |
| å†…å­˜ä½¿ç”¨ | <80% | é•¿æœŸè¿è¡Œæµ‹è¯• |

---

## é£é™©è¯„ä¼°

### ä¿®å¤é£é™©

**é£é™©ç­‰çº§**: ğŸŸ¢ ä½

**åŸå› **:
- ä¿®æ”¹å¾ˆç®€å•ï¼ˆåªæ·»åŠ ä¸€ä¸ªawaitï¼‰
- ä¸æ”¹å˜ä¸šåŠ¡é€»è¾‘
- ä¸å½±å“å…¶ä»–åŠŸèƒ½
- å®¹æ˜“å›æ»š

**æ½œåœ¨é—®é¢˜**:
- å¦‚æœsendMessageå¤±è´¥ï¼Œä¼šå¯¼è‡´addClientå¤±è´¥
- ä½†è¿™æ˜¯æ­£ç¡®çš„è¡Œä¸ºï¼Œåº”è¯¥å¤„ç†å‘é€å¤±è´¥

### ç¼“è§£æªæ–½

1. ç¡®ä¿sendMessageæœ‰é”™è¯¯å¤„ç†
2. æ·»åŠ try-catchå¤„ç†å‘é€å¤±è´¥
3. è®°å½•å‘é€å¤±è´¥çš„æ—¥å¿—

---

## åç»­ä¼˜åŒ–

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1å‘¨å†…ï¼‰

1. âœ… ä¿®å¤æ¶ˆæ¯æ—¶åº
2. âš ï¸ å¢åŠ æµ‹è¯•è¶…æ—¶æ—¶é—´
3. âš ï¸ æ·»åŠ æ¶ˆæ¯å‘é€ç¡®è®¤æœºåˆ¶

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1æœˆå†…ï¼‰

1. âš ï¸ æ€§èƒ½å‹åŠ›æµ‹è¯•
2. âš ï¸ 1000+å¹¶å‘è¿æ¥æµ‹è¯•
3. âš ï¸ æ¶ˆæ¯å»¶è¿ŸåŸºå‡†æµ‹è¯•
4. âš ï¸ ååé‡æµ‹è¯•

### é•¿æœŸä¼˜åŒ–ï¼ˆæŒç»­ï¼‰

1. âš ï¸ ç›‘æ§å’Œå‘Šè­¦
2. âš ï¸ æ€§èƒ½ä¼˜åŒ–
3. âš ï¸ åŠŸèƒ½å¢å¼º
4. âš ï¸ æ–‡æ¡£å®Œå–„

---

## æµ‹è¯•å‘½ä»¤

### å¿«é€ŸéªŒè¯
```bash
# ç‹¬ç«‹æµ‹è¯•ï¼ˆåº”è¯¥é€šè¿‡ï¼‰
npx tsx scripts/simple-websocket-test.ts

# å®Œæ•´æµ‹è¯•å¥—ä»¶
npx tsx scripts/comprehensive-websocket-test.ts
```

### æ€§èƒ½æµ‹è¯•
```bash
# å¹¶å‘è¿æ¥æµ‹è¯•
npx tsx -e "
import WebSocket from 'ws';
const clients = [];
for (let i = 0; i < 100; i++) {
  const ws = new WebSocket('ws://localhost:3001/ws');
  ws.on('open', () => console.log('Client', i, 'connected'));
  clients.push(ws);
}
"

# æ¶ˆæ¯ååé‡æµ‹è¯•
npx tsx -e "
import WebSocket from 'ws';
const ws = new WebSocket('ws://localhost:3001/ws');
let sent = 0;
let received = 0;
ws.on('open', () => {
  setInterval(() => {
    ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
    sent++;
  }, 10);
});
ws.on('message', () => {
  received++;
  console.log('Sent:', sent, 'Received:', received);
});
"
```

---

## å›æ»šè®¡åˆ’

### å¦‚æœä¿®å¤å¼•å…¥é—®é¢˜

**ç«‹å³å›æ»šæ­¥éª¤**:

1. æ’¤é”€awaitä¿®æ”¹
2. é‡æ–°è¿è¡Œç®€å•æµ‹è¯•éªŒè¯
3. æäº¤bugæŠ¥å‘Š
4. åˆ†æé—®é¢˜åŸå› 

**å›æ»šå‘½ä»¤**:
```bash
git checkout server/websocket/websocketServer.ts
```

---

## è”ç³»äºº

**å¼€å‘è´Ÿè´£äºº**: Backend Team Lead
**QAè´Ÿè´£äºº**: Senior QA Engineer
**é—®é¢˜è·Ÿè¸ª**: GitHub Issues

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-25
**çŠ¶æ€**: å¾…æ‰§è¡Œ
