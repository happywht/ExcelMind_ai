# 质量规则系统 - 快速参考

## 🎯 核心概念

### 什么是质量规则？

质量规则是用于检查数据质量的标准。传统系统使用固定的4维度评分（完整性、准确性、一致性、有效性），但这种方法定义不清晰、不够通用。

**我们的创新方案**：让用户自定义规则，然后用AI执行这些规则。

### 两种执行方式

#### 1. 本地执行（推荐）
- ✅ 速度快（毫秒级）
- ✅ 完全免费
- ✅ 适合标准化检查
- 🔧 支持类型：`not_null`、`format`、`range`、`unique`、`custom`

#### 2. AI执行
- ✅ 灵活强大
- ✅ 可处理复杂业务逻辑
- ⚠️ 有成本（需要调用AI）
- 🤖 使用自然语言描述规则

### 混合执行（最佳实践）
```
60-70% 本地规则（快速、免费）
30-40% AI规则（灵活、智能）
```

---

## 📚 10个官方规则模板

| # | 规则名称 | 类型 | 检查内容 | 严重级别 |
|---|---------|------|---------|---------|
| 1 | 邮箱格式检查 | 本地 | 包含@符号和域名 | P1 |
| 2 | 手机号格式检查 | 本地 | 11位数字，1开头 | P1 |
| 3 | 必填字段检查 | 本地 | 不能为空 | P0 |
| 4 | 年龄范围检查 | 本地 | 18-65岁 | P1 |
| 5 | 身份证号格式检查 | 本地 | 18位或17位+X | P0 |
| 6 | 金额非负检查 | 本地 | ≥ 0 | P0 |
| 7 | 重复值检查 | 本地 | 不能重复 | P0 |
| 8 | 日期合理性检查 | 本地 | 1900-当前年份+1 | P2 |
| 9 | 数据长度检查 | 本地 | 不超过50字符 | P2 |
| 10 | 自定义业务规则 | AI | 用户自定义 | P1 |

---

## 🚀 快速开始

### 场景1：使用官方模板（最简单）

1. **切换到质量检查模式**
   - 点击右上角的"质量检查模式"按钮

2. **选择官方模板**
   - 在规则列表中找到"官方模板"标记的规则
   - 点击"启用"开关

3. **执行检查**
   - 点击"执行检查"按钮
   - 等待结果

### 场景2：创建自定义规则（从模板）

1. **点击"新建规则"**
   - 选择"从模板创建"
   - 选择一个最接近的模板

2. **修改规则**
   - 调整名称、描述
   - 修改检查内容和评判标准
   - 更改目标列

3. **保存并启用**
   - 点击"完成"
   - 在列表中启用新规则

### 场景3：创建AI自定义规则（完全自定义）

1. **点击"新建规则"**
   - 选择"自定义创建"

2. **填写基本信息**
   - 规则名称：例如"检查销售额是否合理"
   - 描述：例如"销售额应该与单价×数量一致"
   - 分类：业务规则
   - 严重级别：P1

3. **选择执行方式**
   - 选择"AI执行"

4. **定义规则内容**
   - 检查内容：例如"检查销售额列是否等于单价乘以数量"
   - 评判标准：例如"销售额必须等于单价×数量，误差不超过1%"

5. **保存并执行**

---

## 🎨 UI使用指南

### 模式切换器

```
[🔄 数据处理模式] [✓ 质量检查模式]
```

- **数据处理模式**：原有的AI数据处理功能
- **质量检查模式**：使用规则检查数据质量

### 规则管理面板

```
┌─────────────────────────────────┐
│  质量规则              [新建规则]│
├─────────────────────────────────┤
│ 🔍 搜索规则...                  │
│ 分类: [所有分类 ▼]              │
│ 级别: [所有级别 ▼]              │
│                                 │
│ [已启用] [官方模板] [全部]       │
├─────────────────────────────────┤
│ ⚡ 邮箱格式检查        [启用]    │
│    检查所有包含邮箱的列          │
│    官方 • 本地 • P1 • 使用5次    │
├─────────────────────────────────┤
│ ⚡ 手机号格式检查      [禁用]    │
│    检查手机号格式                │
│    官方 • 本地 • P1 • 使用2次    │
├─────────────────────────────────┤
│ ... 更多规则 ...                │
├─────────────────────────────────┤
│  [执行检查 (3 条规则)]           │
└─────────────────────────────────┘
```

### 规则创建器（5步流程）

```
步骤 1/5: 选择创建方式
  [从模板创建] ⭐ 推荐
  [自定义创建]

步骤 2/5: 基本信息
  规则名称: [必填字段检查________]
  规则描述: [检查关键字段不能为空_]
  规则分类: [完整性检查 ▼]
  严重级别: [P0] [P1] [P2] [P3]

步骤 3/5: 选择目标列
  目标列名: [姓名, 身份证, 金额__]
  执行方式: [本地执行 ⭐] / [AI执行]

步骤 4/5: 定义规则内容
  检查内容: [检查姓名、身份证、金额列]
  评判标准: [不能为空或null]

步骤 5/5: 确认并测试
  [预览所有设置]
  [完成]
```

### 结果展示面板

```
┌─────────────────────────────────┐
│  检查结果                [导出] │
├─────────────────────────────────┤
│  [✓ 8]  [✗ 2]  [⚠️ 15]  [👁️ 10]│
│                                 │
│  执行完成！                      │
│  - 总规则数: 10                  │
│  - 通过: 8 (80.0%)              │
│  - 失败: 2                       │
│  - 问题总数: 15                  │
│  - 问题行数: 10 / 1000           │
├─────────────────────────────────┤
│  筛选: [全部] [P0] [P1] [P2] [P3]│
│  [显示建议]                      │
├─────────────────────────────────┤
│ ✓ 邮箱格式检查                   │
│   ✅ 通过：检查了 1000 行数据    │
│                                 │
│ ✗ 必填字段检查                   │
│   ❌ 不通过：5 行有问题，共 8 个 │
│   [展开]                        │
│   ┌──────────────────────────┐  │
│   │ P0 行 5 - 金额           │  │
│   │ 字段 "金额" 为空         │  │
│   │ 💡 请填写 金额 字段      │  │
│   └──────────────────────────┘  │
│   [修复建议：...]               │
└─────────────────────────────────┘
```

---

## 💡 使用技巧

### 技巧1：优先使用本地规则

本地规则快且免费，应该优先使用：
- ✅ 邮箱、手机号、身份证等格式检查
- ✅ 必填字段、范围检查
- ✅ 唯一性检查

### 技巧2：AI规则用于复杂逻辑

AI规则灵活但昂贵，用于：
- ✅ 跨列关联检查（如 销售额 = 单价 × 数量）
- ✅ 复杂业务逻辑
- ✅ 数据合理性判断

### 技巧3：合理设置严重级别

- **P0**：阻塞问题，必须修复（如必填字段为空）
- **P1**：严重问题，应该修复（如格式错误）
- **P2**：一般问题，建议修复（如长度超限）
- **P3**：提示性问题，可选修复（如轻微异常）

### 技巧4：使用采样检查

对于大数据（>1000行），使用采样检查：
```typescript
const result = await ruleRouter.executeRules(rules, data, {
  sampleSize: 100  // 只检查100行
});
```

### 技巧5：批量启用官方规则

1. 点击"官方模板"筛选
2. 逐个启用需要的规则
3. 点击"执行检查"
4. 查看结果并调整

---

## 🔧 高级功能

### 导出/导入规则

**导出规则**：
```typescript
const json = await qualityRuleStorage.exportRules();
// 下载json文件
```

**导入规则**：
```typescript
await qualityRuleStorage.importRules(jsonString);
```

### 规则统计

```typescript
const stats = await qualityRuleStorage.getStatistics();
console.log(stats);
// {
//   totalRules: 10,
//   officialRules: 10,
//   customRules: 0,
//   enabledRules: 5,
//   rulesByCategory: {...},
//   rulesBySeverity: {...},
//   mostUsedRules: [...]
// }
```

### 清空缓存

```typescript
ruleRouter.clearAllCaches();
```

---

## 📊 结果解读

### 通过 ✅

```
✅ 通过：检查了 1000 行数据，邮箱, 手机号 列符合规则
```

- 所有数据都符合规则要求
- 可以继续数据处理

### 不通过 ❌

```
❌ 不通过：5 行有问题，共 8 个问题 (P0: 2个, P1: 6个)
```

- 有数据不符合规则
- 需要修复后再处理
- 点击展开查看详细问题

### 问题定位

1. 在结果面板中点击问题
2. 表格会自动滚动到对应行
3. 问题单元格会高亮显示

---

## 🐛 常见问题

### Q1: 为什么AI规则执行很慢？

**A**: AI规则需要调用AI服务，通常需要3-10秒。建议：
- 优先使用本地规则
- 使用采样检查减少数据量
- 批量执行时串行执行AI规则

### Q2: 如何降低AI成本？

**A**: 优化策略：
- 60-70%使用本地规则
- AI规则使用采样（50-100行）
- 启用结果缓存
- 避免频繁执行AI规则

### Q3: 规则检测不到问题？

**A**: 检查以下几点：
- 目标列是否正确
- 检查内容描述是否清晰
- 评判标准是否明确
- 对于AI规则，尝试重新描述

### Q4: 如何创建复杂的自定义规则？

**A**: 步骤：
1. 使用"自定义创建"
2. 选择"AI执行"
3. 用自然语言详细描述：
   - 要检查什么
   - 什么样的数据是合格的
   - 给出具体例子

### Q5: 能否检查跨表数据？

**A**: 当前版本仅支持单表检查。跨表检查功能计划在后续版本添加。

---

## 📈 性能指标

### 本地规则
- 执行速度：~1ms/行
- 内存占用：低
- 成本：免费

### AI规则
- 执行速度：~3-10s（采样50行）
- 内存占用：中
- 成本：~0.01-0.05元/次

### 混合执行
- 10条规则（7本地+3AI）：~5-15秒
- 1000行数据采样检查

---

## 🎯 最佳实践

1. **从模板开始**：先使用官方模板，再自定义
2. **优先本地**：能用本地规则就用本地规则
3. **逐步完善**：先创建基础规则，再逐步添加高级规则
4. **定期检查**：数据处理前先进行质量检查
5. **记录问题**：导出检查结果，跟踪修复进度

---

## 📚 相关文档

- [集成指南](./QUALITY_RULE_INTEGRATION_GUIDE.md)
- [进度报告](../QUALITY_RULE_MVP_PROGRESS_REPORT.md)
- [API文档](./API_DOCUMENTATION_REFERENCE.md)

---

**文档版本**：1.0
**最后更新**：2026-01-28
**维护者**：Backend Developer
