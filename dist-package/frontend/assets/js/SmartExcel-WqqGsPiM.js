import{j as e,r as j,b as Ke}from"./react-vendor-GaDxkzs9.js";import{e as be,r as Ge}from"./excelService-D5n1j0dF.js";import{l as k,u as Ve,A as Xe}from"./index-qAfVvIMr.js";import{utils as re,write as He}from"./xlsx-vendor-CkFp8p6R.js";import{o as We}from"./vendor-VUkWwLEC.js";import{i as Ye,j as ie,X as Ze,d as G,k as es,l as ss,P as Ee,m as ts,n as as,o as rs,p as ls,C as ns,q as os,r as Ae,s as X,D as Pe,t as le,T as ye,E as je,u as is,f as cs,g as ds,I as we,v as ve,w as ms,F as us,x as Ne,Z as Se,c as Ce,y as xs,h as hs,z as gs,G as ps,J as fs}from"./icons-vendor-YN3v5u9K.js";import"./ui-utils-vendor-BNe0Xlio.js";const bs=()=>{const i=window.__ELECTRON_ENV__;return i&&i.IS_ELECTRON?(console.log("[smartProcessApi] æ£€æµ‹åˆ° Electron çŽ¯å¢ƒï¼Œä½¿ç”¨:",i.API_BASE_URL),i.API_BASE_URL):"/api"},de=bs();console.log("[smartProcessApi] API_BASE_URL å·²è®¾ç½®ä¸º:",de);const ce=()=>localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token"),ys=()=>{let i=localStorage.getItem("excelmind_client_id");return i||(i=`client_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("excelmind_client_id",i)),i},ne=async(i,s,t)=>{var l,d;const a=`${de}/v2/ai/smart-process${s}`,c=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{k.debug("[smartProcessApi] Sending request",{method:i,endpoint:s,requestId:c});const r=await fetch(a,{method:i,headers:{"Content-Type":"application/json","X-Client-ID":ys(),"X-Request-ID":c,...ce()&&{Authorization:`Bearer ${ce()}`}},...t&&{body:JSON.stringify(t)}}),o=await r.json();if(!r.ok)throw new Error(((l=o.error)==null?void 0:l.message)||o.message||"APIè°ƒç”¨å¤±è´¥");if(!o.success)throw new Error(((d=o.error)==null?void 0:d.message)||"æ“ä½œå¤±è´¥");return k.debug("[smartProcessApi] Request successful",{method:i,endpoint:s,requestId:c}),o.data}catch(r){throw k.error("[smartProcessApi] Request failed",{method:i,endpoint:s,requestId:c,error:r instanceof Error?r.message:"Unknown error"}),r}},Y={async execute(i){try{k.info("[smartProcessApi] Starting smart process");const s=await ne("POST","/",{command:i.command,files:i.files,options:i.options});return k.info("[smartProcessApi] Task started",{taskId:s.taskId,status:s.status}),s}catch(s){throw k.error("[smartProcessApi] Execute failed",{error:s instanceof Error?s.message:"Unknown error"}),new Error(s instanceof Error?s.message:"å¯åŠ¨æ™ºèƒ½å¤„ç†å¤±è´¥")}},async getStatus(i){try{const s=await ne("GET",`/${i}`);return k.debug("[smartProcessApi] Got task status",{taskId:i,status:s.status}),s}catch(s){throw k.error("[smartProcessApi] Get status failed",{taskId:i,error:s instanceof Error?s.message:"Unknown error"}),s}},async waitForCompletion(i,s={}){const{pollInterval:t=2e3,timeout:a=6e4,onProgress:c}=s,l=Date.now();return new Promise((d,r)=>{const o=async()=>{try{if(Date.now()-l>a){r(new Error("ä»»åŠ¡æ‰§è¡Œè¶…æ—¶"));return}const n=await this.getStatus(i);c&&c(n),n.status==="completed"&&n.result?(k.info("[smartProcessApi] Task completed",{taskId:i}),d(n.result)):n.status==="failed"?r(new Error("ä»»åŠ¡æ‰§è¡Œå¤±è´¥")):setTimeout(o,t)}catch(n){k.error("[smartProcessApi] Poll failed",{taskId:i,error:n instanceof Error?n.message:"Unknown error"}),r(n)}};o()})},async cancel(i){try{const s=await ne("POST",`/${i}/cancel`);return k.info("[smartProcessApi] Task cancelled",{taskId:i}),{success:!0,message:s.message||"ä»»åŠ¡å·²å–æ¶ˆ"}}catch(s){throw k.error("[smartProcessApi] Cancel failed",{taskId:i,error:s instanceof Error?s.message:"Unknown error"}),s}},stream(i,s){const t=`${de}/v2/ai/smart-process/${i}/stream`,a=ce(),c=a?`?token=${encodeURIComponent(a)}`:"",l=new EventSource(t+c);return l.addEventListener("progress",d=>{var r;try{const o=JSON.parse(d.data);(r=s.onProgress)==null||r.call(s,o)}catch(o){k.error("[smartProcessApi] Failed to parse progress event",{taskId:i,error:o})}}),l.addEventListener("log",d=>{var r;try{const o=JSON.parse(d.data);(r=s.onLog)==null||r.call(s,o)}catch(o){k.error("[smartProcessApi] Failed to parse log event",{taskId:i,error:o})}}),l.addEventListener("complete",d=>{var r;try{const o=JSON.parse(d.data);(r=s.onComplete)==null||r.call(s,o),l.close()}catch(o){k.error("[smartProcessApi] Failed to parse complete event",{taskId:i,error:o})}}),l.addEventListener("error",d=>{var r;try{const o=JSON.parse(d.data);(r=s.onError)==null||r.call(s,o)}catch(o){k.error("[smartProcessApi] Failed to parse error event",{taskId:i,error:o})}l.close()}),l.onerror=d=>{var r;k.error("[smartProcessApi] EventSource error",{taskId:i,error:d}),(r=s.onError)==null||r.call(s,{code:"STREAM_ERROR",message:"å®žæ—¶è¿žæŽ¥ä¸­æ–­"})},k.info("[smartProcessApi] Started streaming",{taskId:i}),l}},js=({currentMode:i,onModeChange:s,disabled:t=!1})=>e.jsxs("div",{className:"flex items-center gap-2 bg-slate-100 rounded-lg p-1",children:[e.jsxs("button",{onClick:()=>s("processing"),disabled:t,className:`
          flex items-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-all
          ${i==="processing"?"bg-white text-emerald-700 shadow-sm":"text-slate-600 hover:bg-slate-200"}
          ${t?"opacity-50 cursor-not-allowed":""}
        `,title:"æ•°æ®å¤„ç†æ¨¡å¼ï¼šä½¿ç”¨AIè¿›è¡Œæ•°æ®è½¬æ¢ã€åˆå¹¶ç­‰æ“ä½œ",children:[e.jsx(Ye,{className:"w-4 h-4"}),"æ•°æ®å¤„ç†æ¨¡å¼"]}),e.jsxs("button",{onClick:()=>s("quality"),disabled:t,className:`
          flex items-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-all
          ${i==="quality"?"bg-white text-blue-700 shadow-sm":"text-slate-600 hover:bg-slate-200"}
          ${t?"opacity-50 cursor-not-allowed":""}
        `,title:"è´¨é‡æ£€æŸ¥æ¨¡å¼ï¼šä½¿ç”¨è§„åˆ™æ£€æŸ¥æ•°æ®è´¨é‡",children:[e.jsx(ie,{className:"w-4 h-4"}),"è´¨é‡æ£€æŸ¥æ¨¡å¼"]})]}),$e="excelmind_quality_rules",Re="excelmind_rule_usage_stats",oe=[{id:"official-email-format",name:"é‚®ç®±æ ¼å¼æ£€æŸ¥",description:'æ£€æŸ¥æ‰€æœ‰åŒ…å«"é‚®ç®±"æˆ–"email"çš„åˆ—ï¼Œç¡®ä¿é‚®ç®±æ ¼å¼æ­£ç¡®',category:"æ ¼å¼æ£€æŸ¥",checkContent:'æ£€æŸ¥æ‰€æœ‰åŒ…å«"é‚®ç®±"ã€"email"ã€"é‚®ä»¶"çš„åˆ—',criteria:"å¿…é¡»åŒ…å«@ç¬¦å·ï¼Œä¸”@åŽå¿…é¡»æœ‰åŸŸåï¼ˆå¦‚qq.comã€163.comã€gmail.comï¼‰",severity:"P1",executionType:"local",localRule:{type:"format",params:{pattern:"^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$"}},exampleColumns:["é‚®ç®±","email","Email","ç”µå­é‚®ä»¶","è”ç³»é‚®ç®±"]},{id:"official-phone-format",name:"æ‰‹æœºå·æ ¼å¼æ£€æŸ¥",description:"æ£€æŸ¥æ‰‹æœºå·åˆ—ï¼Œç¡®ä¿æ ¼å¼ä¸ºä¸­å›½å¤§é™†æ‰‹æœºå·",category:"æ ¼å¼æ£€æŸ¥",checkContent:'æ£€æŸ¥æ‰€æœ‰åŒ…å«"ç”µè¯"ã€"æ‰‹æœº"ã€"phone"ã€"tel"çš„åˆ—',criteria:"å¿…é¡»ä¸º11ä½æ•°å­—ï¼Œä¸”ä»¥1å¼€å¤´ï¼Œç¬¬äºŒä½ä¸º3-9",severity:"P1",executionType:"local",localRule:{type:"format",params:{pattern:"^1[3-9]\\d{9}$"}},exampleColumns:["æ‰‹æœºå·","ç”µè¯","phone","Phone","è”ç³»ç”µè¯","æ‰‹æœº"]},{id:"official-required-fields",name:"å¿…å¡«å­—æ®µæ£€æŸ¥",description:"æ£€æŸ¥å…³é”®ä¸šåŠ¡å­—æ®µï¼Œç¡®ä¿ä¸èƒ½ä¸ºç©º",category:"å®Œæ•´æ€§æ£€æŸ¥",checkContent:"æ£€æŸ¥å…³é”®ä¸šåŠ¡å­—æ®µï¼ˆå¦‚å§“åã€èº«ä»½è¯ã€è®¢å•å·ã€é‡‘é¢ç­‰ï¼‰",criteria:"å­—æ®µå€¼ä¸èƒ½ä¸ºç©ºã€nullã€ç©ºå­—ç¬¦ä¸²æˆ–ä»…åŒ…å«ç©ºç™½å­—ç¬¦",severity:"P0",executionType:"local",localRule:{type:"not_null",params:{}},exampleColumns:["å§“å","èº«ä»½è¯å·","è®¢å•å·","é‡‘é¢","äº§å“åç§°"]},{id:"official-age-range",name:"å¹´é¾„èŒƒå›´æ£€æŸ¥",description:"æ£€æŸ¥å¹´é¾„å­—æ®µæ˜¯å¦åœ¨åˆç†èŒƒå›´å†…",category:"åˆç†æ€§æ£€æŸ¥",checkContent:'æ£€æŸ¥åŒ…å«"å¹´é¾„"çš„åˆ—',criteria:"å¹´é¾„å¿…é¡»åœ¨18-65å²ä¹‹é—´ï¼ˆé€‚ç”¨äºŽèŒåœºæ•°æ®ï¼‰",severity:"P1",executionType:"local",localRule:{type:"range",params:{min:18,max:65}},exampleColumns:["å¹´é¾„","Age","å‘˜å·¥å¹´é¾„"]},{id:"official-id-card-format",name:"èº«ä»½è¯å·æ ¼å¼æ£€æŸ¥",description:"æ£€æŸ¥ä¸­å›½å¤§é™†èº«ä»½è¯å·æ ¼å¼æ˜¯å¦æ­£ç¡®",category:"æ ¼å¼æ£€æŸ¥",checkContent:'æ£€æŸ¥åŒ…å«"èº«ä»½è¯"ã€"id"çš„åˆ—',criteria:"å¿…é¡»ä¸º18ä½æ•°å­—ï¼Œæˆ–17ä½æ•°å­—+X/xï¼ˆæœ€åŽä¸€ä½ä¸ºæ ¡éªŒä½ï¼‰",severity:"P0",executionType:"local",localRule:{type:"format",params:{pattern:"^[1-9]\\d{5}(18|19|20)\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])\\d{3}[\\dXx]$"}},exampleColumns:["èº«ä»½è¯å·","èº«ä»½è¯","id_card","IdCard"]},{id:"official-amount-non-negative",name:"é‡‘é¢éžè´Ÿæ£€æŸ¥",description:"æ£€æŸ¥é‡‘é¢å­—æ®µï¼Œç¡®ä¿é‡‘é¢ä¸ä¸ºè´Ÿæ•°",category:"åˆç†æ€§æ£€æŸ¥",checkContent:'æ£€æŸ¥æ‰€æœ‰åŒ…å«"é‡‘é¢"ã€"ä»·æ ¼"ã€"price"ã€"amount"çš„åˆ—',criteria:"é‡‘é¢å¿…é¡»å¤§äºŽæˆ–ç­‰äºŽ0",severity:"P0",executionType:"local",localRule:{type:"range",params:{min:0}},exampleColumns:["é‡‘é¢","ä»·æ ¼","Price","Amount","å•ä»·","æ€»ä»·","é”€å”®é¢"]},{id:"official-unique-check",name:"é‡å¤å€¼æ£€æŸ¥",description:"æ£€æŸ¥å”¯ä¸€æ€§å­—æ®µï¼Œç¡®ä¿æ²¡æœ‰é‡å¤å€¼",category:"å”¯ä¸€æ€§æ£€æŸ¥",checkContent:"æ£€æŸ¥å”¯ä¸€æ€§å­—æ®µï¼ˆå¦‚è®¢å•å·ã€IDã€å·¥å·ç­‰ï¼‰",criteria:"å­—æ®µå€¼ä¸èƒ½æœ‰é‡å¤ï¼Œæ¯ä¸ªå€¼åªèƒ½å‡ºçŽ°ä¸€æ¬¡",severity:"P0",executionType:"local",localRule:{type:"unique",params:{}},exampleColumns:["è®¢å•å·","ID","å·¥å·","å­¦å·","äº§å“ç¼–å·"]},{id:"official-date-range",name:"æ—¥æœŸåˆç†æ€§æ£€æŸ¥",description:"æ£€æŸ¥æ—¥æœŸå­—æ®µæ˜¯å¦åœ¨åˆç†èŒƒå›´å†…",category:"åˆç†æ€§æ£€æŸ¥",checkContent:"æ£€æŸ¥æ‰€æœ‰æ—¥æœŸç±»åž‹çš„åˆ—",criteria:"æ—¥æœŸå¿…é¡»åœ¨1900-01-01åˆ°å½“å‰å¹´ä»½+1ä¹‹é—´",severity:"P2",executionType:"local",localRule:{type:"range",params:{min:new Date("1900-01-01").getTime(),max:new Date().setFullYear(new Date().getFullYear()+1)}},exampleColumns:["æ—¥æœŸ","Date","å‡ºç”Ÿæ—¥æœŸ","å…¥èŒæ—¥æœŸ","è®¢å•æ—¥æœŸ"]},{id:"official-text-length",name:"æ•°æ®é•¿åº¦æ£€æŸ¥",description:"æ£€æŸ¥æ–‡æœ¬å­—æ®µé•¿åº¦ï¼Œé˜²æ­¢è¶…é•¿æ•°æ®",category:"æ ¼å¼æ£€æŸ¥",checkContent:"æ£€æŸ¥æ–‡æœ¬å­—æ®µçš„é•¿åº¦",criteria:"æ–‡æœ¬é•¿åº¦ä¸èƒ½è¶…è¿‡å­—æ®µé™åˆ¶ï¼ˆé»˜è®¤50å­—ç¬¦ï¼‰",severity:"P2",executionType:"local",localRule:{type:"custom",params:{maxLength:50}},exampleColumns:["å§“å","äº§å“åç§°","å¤‡æ³¨","æè¿°"]},{id:"official-custom-business-rule",name:"ä¸šåŠ¡è§„åˆ™è‡ªå®šä¹‰æ£€æŸ¥",description:"ä½¿ç”¨AIè¿›è¡Œè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘æ£€æŸ¥",category:"ä¸šåŠ¡è§„åˆ™",checkContent:"ç”¨æˆ·è‡ªå®šä¹‰çš„ä¸šåŠ¡é€»è¾‘æè¿°",criteria:"ç”¨æˆ·è‡ªå®šä¹‰çš„è¯„åˆ¤æ ‡å‡†",severity:"P1",executionType:"ai",localRule:void 0,exampleColumns:[]}];class ws{constructor(){this.rules=new Map,this.usageStats=new Map,this.loadFromStorage()}loadFromStorage(){try{const s=localStorage.getItem($e);s&&JSON.parse(s).forEach(c=>{this.rules.set(c.id,c)});const t=localStorage.getItem(Re);if(t){const a=JSON.parse(t);this.usageStats=new Map(Object.entries(a))}this.rules.size===0&&this.initializeOfficialRules()}catch(s){console.error("åŠ è½½è§„åˆ™æ•°æ®å¤±è´¥:",s),this.initializeOfficialRules()}}saveToStorage(){try{const s=Array.from(this.rules.values());localStorage.setItem($e,JSON.stringify(s));const t=Object.fromEntries(this.usageStats);localStorage.setItem(Re,JSON.stringify(t))}catch(s){console.error("ä¿å­˜è§„åˆ™æ•°æ®å¤±è´¥:",s)}}initializeOfficialRules(){oe.forEach(s=>{const t={id:s.id,name:s.name,description:s.description,category:s.category,checkContent:s.checkContent,criteria:s.criteria,severity:s.severity,executionType:s.executionType,localRule:s.localRule,targetColumns:s.exampleColumns,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),usageCount:0,isOfficial:!0,isEnabled:!0};this.rules.set(t.id,t)}),this.saveToStorage()}generateId(){return`rule_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async saveRule(s){var c,l;const t=new Date().toISOString(),a={...s,id:s.id||this.generateId(),createdAt:s.id&&((c=this.rules.get(s.id))==null?void 0:c.createdAt)||t,updatedAt:t,usageCount:s.id&&((l=this.rules.get(s.id))==null?void 0:l.usageCount)||0};return this.rules.set(a.id,a),this.saveToStorage(),a}async getRule(s){return this.rules.get(s)||null}async listRules(s){let t=Array.from(this.rules.values());if(s&&(s.category&&(t=t.filter(a=>a.category===s.category)),s.severity&&(t=t.filter(a=>a.severity===s.severity)),s.executionType&&(t=t.filter(a=>a.executionType===s.executionType)),s.isOfficial!==void 0&&(t=t.filter(a=>a.isOfficial===s.isOfficial)),s.isEnabled!==void 0&&(t=t.filter(a=>a.isEnabled===s.isEnabled)),s.searchTerm)){const a=s.searchTerm.toLowerCase();t=t.filter(c=>c.name.toLowerCase().includes(a)||c.description.toLowerCase().includes(a)||c.category.toLowerCase().includes(a))}return t.sort((a,c)=>a.isOfficial!==c.isOfficial?a.isOfficial?-1:1:c.usageCount-a.usageCount)}async deleteRule(s){if(!this.rules.has(s))throw new Error(`è§„åˆ™ä¸å­˜åœ¨: ${s}`);if(this.rules.get(s).isOfficial)throw new Error("ä¸èƒ½åˆ é™¤å®˜æ–¹è§„åˆ™ï¼Œå¯ä»¥ç¦ç”¨");this.rules.delete(s),this.usageStats.delete(s),this.saveToStorage()}async toggleRule(s){const t=this.rules.get(s);if(!t)throw new Error(`è§„åˆ™ä¸å­˜åœ¨: ${s}`);return t.isEnabled=!t.isEnabled,t.updatedAt=new Date().toISOString(),this.saveToStorage(),t}async incrementUsage(s){const t=this.rules.get(s);t&&(t.usageCount++,this.saveToStorage())}async getOfficialRules(){return Array.from(this.rules.values()).filter(s=>s.isOfficial)}async getCustomRules(){return Array.from(this.rules.values()).filter(s=>!s.isOfficial)}async getStatistics(){const s=Array.from(this.rules.values()),t={},a={P0:0,P1:0,P2:0,P3:0};s.forEach(l=>{t[l.category]=(t[l.category]||0)+1,a[l.severity]++});const c=s.sort((l,d)=>d.usageCount-l.usageCount).slice(0,5).map(l=>({ruleId:l.id,name:l.name,usageCount:l.usageCount}));return{totalRules:s.length,officialRules:s.filter(l=>l.isOfficial).length,customRules:s.filter(l=>!l.isOfficial).length,enabledRules:s.filter(l=>l.isEnabled).length,rulesByCategory:t,rulesBySeverity:a,mostUsedRules:c}}async getTemplates(){return oe}async createFromTemplate(s,t){const a=oe.find(l=>l.id===s);if(!a)throw new Error(`æ¨¡æ¿ä¸å­˜åœ¨: ${s}`);const c={name:t.name||a.name,description:t.description||a.description,category:t.category||a.category,checkContent:t.checkContent||a.checkContent,criteria:t.criteria||a.criteria,severity:t.severity||a.severity,executionType:t.executionType||a.executionType,localRule:t.localRule||a.localRule,targetColumns:t.targetColumns||a.exampleColumns,isOfficial:!1,isEnabled:!0};return this.saveRule(c)}async exportRules(s){const t=s?s.map(a=>this.rules.get(a)).filter(Boolean):Array.from(this.rules.values());return JSON.stringify(t,null,2)}async importRules(s,t=!1){const a=JSON.parse(s);let c=0;for(const l of a){const d=this.rules.get(l.id);d?t&&(l.usageCount=d.usageCount,this.rules.set(l.id,l),c++):(l.id=this.generateId(),l.usageCount=0,this.rules.set(l.id,l),c++)}return this.saveToStorage(),c}async resetToDefault(){this.rules.clear(),this.usageStats.clear(),this.initializeOfficialRules()}async clearCustomRules(){Array.from(this.rules.values()).filter(t=>!t.isOfficial).map(t=>t.id).forEach(t=>{this.rules.delete(t),this.usageStats.delete(t)}),this.saveToStorage()}}const K=new ws,vs=({rule:i,onClose:s,onSave:t})=>{const[a,c]=j.useState(i?2:1),[l,d]=j.useState(null),[r,o]=j.useState(!1),[n,x]=j.useState({name:"",description:"",category:"",checkContent:"",criteria:"",severity:"P1",executionType:"ai",targetColumns:[],isEnabled:!0,isOfficial:!1,localRule:void 0}),[p,N]=j.useState([]);j.useEffect(()=>{S(),i&&(x({...i,targetColumns:Array.isArray(i.targetColumns)?[...i.targetColumns]:[]}),o(!1))},[i]);const S=async()=>{const b=await K.getTemplates();N(b)},$=()=>{a<5&&c(a+1)},w=()=>{a>1&&c(a-1)},T=async()=>{try{if(i){const b={...n,id:i.id,createdAt:i.createdAt,updatedAt:new Date().toISOString(),usageCount:i.usageCount};await K.saveRule(b)}else r&&l?await K.createFromTemplate(l,n):await K.saveRule(n);t()}catch(b){console.error("ä¿å­˜è§„åˆ™å¤±è´¥:",b),alert(`ä¿å­˜å¤±è´¥: ${b instanceof Error?b.message:"æœªçŸ¥é”™è¯¯"}`)}},D=()=>{switch(a){case 1:return i?!0:r?l!==null:!0;case 2:return n.name&&n.description&&n.category;case 3:return!0;case 4:return n.checkContent&&n.criteria;case 5:return!0;default:return!1}},O=(b,L)=>{x(J=>({...J,[b]:L}))},f=()=>{switch(a){case 1:return v();case 2:return _();case 3:return B();case 4:return q();case 5:return U()}},v=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:i?"ç¼–è¾‘è§„åˆ™":"é€‰æ‹©åˆ›å»ºæ–¹å¼"}),i&&e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 mb-2",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{className:"font-semibold",children:"æ­£åœ¨ç¼–è¾‘è§„åˆ™"})]}),e.jsxs("div",{className:"text-sm text-blue-700 space-y-1",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"åç§°ï¼š"}),i.name]}),e.jsxs("div",{children:[e.jsx("strong",{children:"åˆ†ç±»ï¼š"}),i.category]}),e.jsxs("div",{children:[e.jsx("strong",{children:"æè¿°ï¼š"}),i.description]})]}),e.jsx("p",{className:"text-xs text-blue-600 mt-2",children:'ç‚¹å‡»"ä¸‹ä¸€æ­¥"å¯ä¿®æ”¹è§„åˆ™çš„æ‰€æœ‰å†…å®¹'})]}),!i&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:()=>{var b;o(!0),d(((b=p[0])==null?void 0:b.id)||null)},className:`w-full p-4 rounded-lg border-2 text-left transition-all ${r?"border-emerald-500 bg-emerald-50":"border-slate-200 hover:border-emerald-300"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-slate-800",children:"ä»Žæ¨¡æ¿åˆ›å»º"}),r&&e.jsx(G,{className:"w-5 h-5 text-emerald-600"})]}),e.jsx("p",{className:"text-sm text-slate-600",children:"åŸºäºŽå®˜æ–¹æ¨¡æ¿å¿«é€Ÿåˆ›å»ºè§„åˆ™ï¼Œç„¶åŽè‡ªå®šä¹‰ä¿®æ”¹"})]}),e.jsxs("button",{onClick:()=>o(!1),className:`w-full p-4 rounded-lg border-2 text-left transition-all ${r?"border-slate-200 hover:border-blue-300":"border-blue-500 bg-blue-50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-slate-800",children:"è‡ªå®šä¹‰åˆ›å»º"}),!r&&e.jsx(G,{className:"w-5 h-5 text-blue-600"})]}),e.jsx("p",{className:"text-sm text-slate-600",children:"å®Œå…¨è‡ªå®šä¹‰è§„åˆ™ï¼Œé€‚ç”¨äºŽç‰¹æ®Šä¸šåŠ¡éœ€æ±‚"})]})]}),r&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"é€‰æ‹©æ¨¡æ¿"}),e.jsxs("select",{value:l||"",onChange:b=>d(b.target.value),className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none",children:[e.jsx("option",{value:"",children:"è¯·é€‰æ‹©æ¨¡æ¿..."}),p.map(b=>e.jsx("option",{value:b.id,children:b.name},b.id))]})]})]})]}),_=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"åŸºæœ¬ä¿¡æ¯"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"è§„åˆ™åç§° *"}),e.jsx("input",{type:"text",value:n.name||"",onChange:b=>O("name",b.target.value),placeholder:"ä¾‹å¦‚ï¼šé‚®ç®±æ ¼å¼æ£€æŸ¥",className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"è§„åˆ™æè¿° *"}),e.jsx("textarea",{value:n.description||"",onChange:b=>O("description",b.target.value),placeholder:"ç®€è¦æè¿°è¿™ä¸ªè§„åˆ™çš„ä½œç”¨...",rows:3,className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"è§„åˆ™åˆ†ç±» *"}),e.jsxs("select",{value:n.category||"",onChange:b=>O("category",b.target.value),className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none",children:[e.jsx("option",{value:"",children:"è¯·é€‰æ‹©åˆ†ç±»..."}),e.jsx("option",{value:"æ ¼å¼æ£€æŸ¥",children:"æ ¼å¼æ£€æŸ¥"}),e.jsx("option",{value:"å®Œæ•´æ€§æ£€æŸ¥",children:"å®Œæ•´æ€§æ£€æŸ¥"}),e.jsx("option",{value:"ä¸€è‡´æ€§æ£€æŸ¥",children:"ä¸€è‡´æ€§æ£€æŸ¥"}),e.jsx("option",{value:"åˆç†æ€§æ£€æŸ¥",children:"åˆç†æ€§æ£€æŸ¥"}),e.jsx("option",{value:"å”¯ä¸€æ€§æ£€æŸ¥",children:"å”¯ä¸€æ€§æ£€æŸ¥"}),e.jsx("option",{value:"ä¸šåŠ¡è§„åˆ™",children:"ä¸šåŠ¡è§„åˆ™"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"ä¸¥é‡çº§åˆ«"}),e.jsx("div",{className:"flex gap-2",children:["P0","P1","P2","P3"].map(b=>e.jsx("button",{onClick:()=>O("severity",b),className:`px-4 py-2 rounded-lg font-medium transition-all ${n.severity===b?b==="P0"?"bg-red-100 text-red-700 border-2 border-red-300":b==="P1"?"bg-orange-100 text-orange-700 border-2 border-orange-300":b==="P2"?"bg-yellow-100 text-yellow-700 border-2 border-yellow-300":"bg-blue-100 text-blue-700 border-2 border-blue-300":"bg-slate-100 text-slate-600 border-2 border-transparent hover:border-slate-300"}`,children:b},b))}),e.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:[n.severity==="P0"&&"é˜»å¡žé—®é¢˜ï¼šå¿…é¡»ä¿®å¤",n.severity==="P1"&&"ä¸¥é‡é—®é¢˜ï¼šåº”è¯¥ä¿®å¤",n.severity==="P2"&&"ä¸€èˆ¬é—®é¢˜ï¼šå»ºè®®ä¿®å¤",n.severity==="P3"&&"æç¤ºæ€§é—®é¢˜ï¼šå¯é€‰ä¿®å¤"]})]})]}),B=()=>{var b;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"é€‰æ‹©ç›®æ ‡åˆ—"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"ç›®æ ‡åˆ—åï¼ˆç”¨é€—å·åˆ†éš”ï¼‰"}),e.jsx("textarea",{value:((b=n.targetColumns)==null?void 0:b.join(", "))||"",onChange:L=>O("targetColumns",L.target.value.split(/[,ï¼Œ]/).map(J=>J.trim()).filter(Boolean)),placeholder:"ä¾‹å¦‚ï¼šé‚®ç®±, æ‰‹æœºå·, è”ç³»ç”µè¯",rows:3,className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"å¦‚æžœç•™ç©ºï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹åŒ…å«å…³é”®å­—çš„åˆ—"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"æ‰§è¡Œæ–¹å¼"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>O("executionType","local"),className:`w-full p-3 rounded-lg border-2 text-left transition-all ${n.executionType==="local"?"border-emerald-500 bg-emerald-50":"border-slate-200 hover:border-emerald-300"}`,children:[e.jsx("div",{className:"font-semibold text-slate-800 mb-1",children:"æœ¬åœ°æ‰§è¡Œ"}),e.jsx("div",{className:"text-sm text-slate-600",children:"å¿«é€Ÿã€å…è´¹ï¼Œé€‚åˆæ ‡å‡†åŒ–æ£€æŸ¥"})]}),e.jsxs("button",{onClick:()=>O("executionType","ai"),className:`w-full p-3 rounded-lg border-2 text-left transition-all ${n.executionType==="ai"?"border-blue-500 bg-blue-50":"border-slate-200 hover:border-blue-300"}`,children:[e.jsx("div",{className:"font-semibold text-slate-800 mb-1",children:"AIæ‰§è¡Œ"}),e.jsx("div",{className:"text-sm text-slate-600",children:"çµæ´»ã€æœ‰æˆæœ¬ï¼Œé€‚åˆå¤æ‚ä¸šåŠ¡é€»è¾‘"})]})]})]})]})},q=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"å®šä¹‰è§„åˆ™å†…å®¹"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"æ£€æŸ¥å†…å®¹ *"}),e.jsx("textarea",{value:n.checkContent||"",onChange:b=>O("checkContent",b.target.value),placeholder:"ä¾‹å¦‚ï¼šæ£€æŸ¥æ‰€æœ‰åŒ…å«'é‚®ç®±'çš„åˆ—",rows:3,className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"ç”¨è‡ªç„¶è¯­è¨€æè¿°è¦æ£€æŸ¥ä»€ä¹ˆ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"è¯„åˆ¤æ ‡å‡† *"}),e.jsx("textarea",{value:n.criteria||"",onChange:b=>O("criteria",b.target.value),placeholder:"ä¾‹å¦‚ï¼šå¿…é¡»åŒ…å«@ç¬¦å·ï¼Œä¸”@åŽå¿…é¡»æœ‰åŸŸå",rows:3,className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"ç”¨è‡ªç„¶è¯­è¨€æè¿°ä»€ä¹ˆæ ·çš„æ•°æ®æ˜¯åˆæ ¼çš„"})]}),n.executionType==="local"&&e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("div",{className:"text-sm font-medium text-blue-800 mb-1",children:"æœ¬åœ°æ‰§è¡Œéœ€è¦é…ç½®"}),e.jsx("p",{className:"text-xs text-blue-600",children:"æœ¬åœ°æ‰§è¡Œéœ€è¦åœ¨ä¸‹ä¸€æ­¥ä¸­é…ç½®å…·ä½“çš„æ£€æŸ¥é€»è¾‘ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ã€èŒƒå›´ç­‰ï¼‰"})]})]}),U=()=>{var b;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"ç¡®è®¤å¹¶æµ‹è¯•"}),e.jsxs("div",{className:"p-4 bg-slate-50 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"è§„åˆ™åç§°ï¼š"}),e.jsx("span",{className:"text-sm text-slate-800 ml-2",children:n.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"åˆ†ç±»ï¼š"}),e.jsx("span",{className:"text-sm text-slate-800 ml-2",children:n.category})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"ä¸¥é‡çº§åˆ«ï¼š"}),e.jsx("span",{className:`text-sm ml-2 px-2 py-0.5 rounded ${n.severity==="P0"?"bg-red-100 text-red-700":n.severity==="P1"?"bg-orange-100 text-orange-700":n.severity==="P2"?"bg-yellow-100 text-yellow-700":"bg-blue-100 text-blue-700"}`,children:n.severity})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"æ‰§è¡Œæ–¹å¼ï¼š"}),e.jsx("span",{className:"text-sm text-slate-800 ml-2",children:n.executionType==="local"?"æœ¬åœ°æ‰§è¡Œ":"AIæ‰§è¡Œ"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"ç›®æ ‡åˆ—ï¼š"}),e.jsx("span",{className:"text-sm text-slate-800 ml-2",children:(b=n.targetColumns)!=null&&b.length?n.targetColumns.join(", "):"è‡ªåŠ¨æ£€æµ‹"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"æ£€æŸ¥å†…å®¹ï¼š"}),e.jsx("p",{className:"text-sm text-slate-800 mt-1",children:n.checkContent})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"è¯„åˆ¤æ ‡å‡†ï¼š"}),e.jsx("p",{className:"text-sm text-slate-800 mt-1",children:n.criteria})]})]}),e.jsxs("div",{className:"p-4 bg-emerald-50 rounded-lg border border-emerald-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 mb-1",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{className:"font-semibold",children:"å‡†å¤‡å°±ç»ª"})]}),e.jsx("p",{className:"text-sm text-emerald-700",children:'ç‚¹å‡»"å®Œæˆ"åˆ›å»ºè§„åˆ™ï¼Œåˆ›å»ºåŽå¯ä»¥åœ¨è§„åˆ™åˆ—è¡¨ä¸­å¯ç”¨å¹¶æ‰§è¡Œ'})]})]})};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-800",children:i?"ç¼–è¾‘è§„åˆ™":"åˆ›å»ºæ–°è§„åˆ™"}),i&&e.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:["æ­£åœ¨ç¼–è¾‘ï¼š",i.name]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:e.jsx(Ze,{className:"w-5 h-5 text-slate-500"})})]}),e.jsxs("div",{className:"px-6 py-4 bg-slate-50 border-b border-slate-200",children:[e.jsx("div",{className:"flex items-center justify-between",children:[1,2,3,4,5].map(b=>e.jsxs(Ke.Fragment,{children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full font-semibold text-sm transition-all ${b===a?"bg-emerald-600 text-white":b<a?"bg-emerald-100 text-emerald-700":"bg-slate-200 text-slate-500"}`,children:b<a?e.jsx(G,{className:"w-4 h-4"}):b}),b<5&&e.jsx("div",{className:`flex-1 h-1 mx-2 rounded ${b<a?"bg-emerald-600":"bg-slate-200"}`})]},b))}),e.jsxs("div",{className:"flex justify-between mt-2 text-xs text-slate-600",children:[e.jsx("span",{children:"æ–¹å¼"}),e.jsx("span",{children:"åŸºæœ¬ä¿¡æ¯"}),e.jsx("span",{children:"ç›®æ ‡åˆ—"}),e.jsx("span",{children:"è§„åˆ™å†…å®¹"}),e.jsx("span",{children:"ç¡®è®¤"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:f()}),e.jsxs("div",{className:"flex items-center justify-between p-4 border-t border-slate-200 bg-slate-50",children:[e.jsxs("button",{onClick:w,disabled:a===1,className:"flex items-center gap-2 px-4 py-2 text-slate-700 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(es,{className:"w-4 h-4"}),"ä¸Šä¸€æ­¥"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:s,className:"px-4 py-2 text-slate-700 hover:bg-slate-100 rounded-lg transition-colors",children:"å–æ¶ˆ"}),a<5?e.jsxs("button",{onClick:$,disabled:!D(),className:"flex items-center gap-2 px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium",children:["ä¸‹ä¸€æ­¥",e.jsx(ss,{className:"w-4 h-4"})]}):e.jsxs("button",{onClick:T,className:"flex items-center gap-2 px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium",children:[e.jsx(G,{className:"w-4 h-4"}),"å®Œæˆ"]})]})]})]})})},Ns=({onRulesChange:i,onExecuteRules:s,executing:t=!1})=>{const[a,c]=j.useState([]),[l,d]=j.useState([]),[r,o]=j.useState({}),[n,x]=j.useState(!1),[p,N]=j.useState(null),[S,$]=j.useState(""),[w,T]=j.useState(""),[D,O]=j.useState("");j.useEffect(()=>{f()},[]),j.useEffect(()=>{v()},[a,r,S,w,D]);const f=async()=>{const h=await K.listRules();c(h),i==null||i(h)},v=()=>{let h=[...a];if(S){const P=S.toLowerCase();h=h.filter(Q=>Q.name.toLowerCase().includes(P)||Q.description.toLowerCase().includes(P))}w&&(h=h.filter(P=>P.category===w)),D&&(h=h.filter(P=>P.severity===D)),r.isEnabled!==void 0&&(h=h.filter(P=>P.isEnabled===r.isEnabled)),r.isOfficial!==void 0&&(h=h.filter(P=>P.isOfficial===r.isOfficial)),d(h)},_=async h=>{try{await K.toggleRule(h),await f()}catch(P){console.error("åˆ‡æ¢è§„åˆ™å¤±è´¥:",P),alert(`åˆ‡æ¢è§„åˆ™å¤±è´¥: ${P instanceof Error?P.message:"æœªçŸ¥é”™è¯¯"}`)}},B=async h=>{if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§„åˆ™å—ï¼Ÿ"))try{await K.deleteRule(h),await f()}catch(P){console.error("åˆ é™¤è§„åˆ™å¤±è´¥:",P),alert(`åˆ é™¤è§„åˆ™å¤±è´¥: ${P instanceof Error?P.message:"æœªçŸ¥é”™è¯¯"}`)}},q=h=>{N(h),x(!0)},U=h=>{switch(h){case"P0":return"text-red-600 bg-red-50 border-red-200";case"P1":return"text-orange-600 bg-orange-50 border-orange-200";case"P2":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"P3":return"text-blue-600 bg-blue-50 border-blue-200"}},b=h=>{switch(h){case"local":return"æœ¬åœ°";case"ai":return"AI";case"hybrid":return"æ··åˆ";default:return h}},L=Array.from(new Set(a.map(h=>h.category))),J=l.filter(h=>h.isEnabled).length;return e.jsxs("div",{className:"h-full flex flex-col bg-white",children:[e.jsxs("div",{className:"p-4 border-b border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"è´¨é‡è§„åˆ™"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-slate-500",children:["å·²å¯ç”¨ ",J," / ",l.length]}),e.jsxs("button",{onClick:()=>{N(null),x(!0)},className:"flex items-center gap-1 px-3 py-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm font-medium transition-colors",children:[e.jsx(Ee,{className:"w-4 h-4"}),"æ–°å»ºè§„åˆ™"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(ts,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"æœç´¢è§„åˆ™...",value:S,onChange:h=>$(h.target.value),className:"w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none"})]}),e.jsxs("select",{value:w,onChange:h=>T(h.target.value),className:"px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none",children:[e.jsx("option",{value:"",children:"æ‰€æœ‰åˆ†ç±»"}),L.map(h=>e.jsx("option",{value:h,children:h},h))]}),e.jsxs("select",{value:D,onChange:h=>O(h.target.value),className:"px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none",children:[e.jsx("option",{value:"",children:"æ‰€æœ‰çº§åˆ«"}),e.jsx("option",{value:"P0",children:"P0 - é˜»å¡ž"}),e.jsx("option",{value:"P1",children:"P1 - ä¸¥é‡"}),e.jsx("option",{value:"P2",children:"P2 - ä¸€èˆ¬"}),e.jsx("option",{value:"P3",children:"P3 - æç¤º"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("button",{onClick:()=>o({...r,isEnabled:!0}),className:`px-2 py-1 rounded ${r.isEnabled===!0?"bg-emerald-100 text-emerald-700":"text-slate-500 hover:bg-slate-100"}`,children:"å·²å¯ç”¨"}),e.jsx("button",{onClick:()=>o({...r,isOfficial:!0}),className:`px-2 py-1 rounded ${r.isOfficial===!0?"bg-blue-100 text-blue-700":"text-slate-500 hover:bg-slate-100"}`,children:"å®˜æ–¹æ¨¡æ¿"}),e.jsx("button",{onClick:()=>o({}),className:`px-2 py-1 rounded ${Object.keys(r).length===0?"bg-slate-200 text-slate-700":"text-slate-500 hover:bg-slate-100"}`,children:"å…¨éƒ¨"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:l.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-400",children:[e.jsx("p",{children:"æ²¡æœ‰æ‰¾åˆ°è§„åˆ™"}),e.jsx("p",{className:"text-xs mt-1",children:'ç‚¹å‡»"æ–°å»ºè§„åˆ™"åˆ›å»ºç¬¬ä¸€ä¸ªè§„åˆ™'})]}):e.jsx("div",{className:"space-y-2",children:l.map(h=>e.jsx("div",{className:`p-3 rounded-lg border transition-all ${h.isEnabled?"bg-white border-slate-200 hover:border-emerald-300":"bg-slate-50 border-slate-200 opacity-60"}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx("button",{onClick:()=>_(h.id),disabled:t,className:"mt-1",children:h.isEnabled?e.jsx(as,{className:"w-5 h-5 text-emerald-600"}):e.jsx(rs,{className:"w-5 h-5 text-slate-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:`font-semibold text-sm ${h.isEnabled?"text-slate-800":"text-slate-500"}`,children:h.name}),h.isOfficial&&e.jsx(ls,{className:"w-3.5 h-3.5 text-yellow-500 fill-yellow-500"}),e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium border ${U(h.severity)}`,children:h.severity}),e.jsx("span",{className:"px-2 py-0.5 rounded text-xs bg-slate-100 text-slate-600",children:b(h.executionType)})]}),e.jsx("p",{className:"text-xs text-slate-500 mb-1",children:h.description}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-slate-400",children:[e.jsx("span",{children:h.category}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ns,{className:"w-3 h-3"}),"ä½¿ç”¨ ",h.usageCount," æ¬¡"]}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:h.targetColumns.length>0?h.targetColumns.join(", "):"è‡ªåŠ¨æ£€æµ‹"})]})]})]}),e.jsx("div",{className:"flex items-center gap-1",children:!h.isOfficial&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>q(h),disabled:t||h.isEnabled,className:"p-1.5 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded transition-colors disabled:opacity-50",title:"ç¼–è¾‘",children:e.jsx(os,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>B(h.id),disabled:t||h.isEnabled,className:"p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors disabled:opacity-50",title:"åˆ é™¤",children:e.jsx(Ae,{className:"w-4 h-4"})})]})})]})},h.id))})}),J>0&&e.jsx("div",{className:"p-4 border-t border-slate-200 bg-slate-50",children:e.jsx("button",{onClick:()=>s==null?void 0:s(l.filter(h=>h.isEnabled)),disabled:t,className:`
              w-full py-2.5 rounded-lg font-medium text-white transition-all
              flex items-center justify-center gap-2
              ${t?"bg-slate-300 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-blue-900/20"}
            `,children:t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"æ‰§è¡Œä¸­..."]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4"}),"æ‰§è¡Œæ£€æŸ¥ (",J," æ¡è§„åˆ™)"]})})}),n&&e.jsx(vs,{rule:p,onClose:()=>{x(!1),N(null)},onSave:async()=>{await f(),x(!1),N(null)}})]})},Ss=({results:i,batchResult:s,data:t,onIssueClick:a,onClose:c})=>{const[l,d]=j.useState(new Set),[r,o]=j.useState("all"),[n,x]=j.useState(!0),p={total:i.length,passed:i.filter(f=>f.pass).length,failed:i.filter(f=>!f.pass).length,totalIssues:i.reduce((f,v)=>f+v.issues.length,0),totalIssueRows:i.reduce((f,v)=>f+v.issueRows,0)},N=[];i.forEach(f=>{f.issues.forEach(v=>{N.push({issue:v,ruleName:f.ruleName})})});const S=r==="all"?N:N.filter(({issue:f})=>f.severity===r),$={P0:[],P1:[],P2:[],P3:[]};S.forEach(({issue:f,ruleName:v})=>{$[f.severity].push({issue:f,ruleName:v})});const w=f=>{d(v=>{const _=new Set(v);return _.has(f)?_.delete(f):_.add(f),_})},T=f=>{switch(f){case"P0":return"text-red-600 bg-red-50 border-red-200";case"P1":return"text-orange-600 bg-orange-50 border-orange-200";case"P2":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"P3":return"text-blue-600 bg-blue-50 border-blue-200"}},D=f=>{switch(f){case"P0":return e.jsx(le,{className:"w-4 h-4"});case"P1":return e.jsx(ye,{className:"w-4 h-4"});case"P2":return e.jsx(we,{className:"w-4 h-4"});case"P3":return e.jsx(we,{className:"w-4 h-4"})}},O=()=>{const f={timestamp:new Date().toISOString(),summary:(s==null?void 0:s.overallSummary)||"",statistics:p,results:i.map(q=>({ruleName:q.ruleName,pass:q.pass,summary:q.summary,issueCount:q.issues.length,issues:q.issues}))},v=new Blob([JSON.stringify(f,null,2)],{type:"application/json"}),_=URL.createObjectURL(v),B=document.createElement("a");B.href=_,B.download=`quality-report-${Date.now()}.json`,B.click(),URL.revokeObjectURL(_)};return e.jsxs("div",{className:"h-full flex flex-col bg-white",children:[e.jsxs("div",{className:"p-4 border-b border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"æ£€æŸ¥ç»“æžœ"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:O,className:"flex items-center gap-1 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-100 rounded-lg transition-colors",title:"å¯¼å‡ºæŠ¥å‘Š",children:[e.jsx(Pe,{className:"w-4 h-4"}),"å¯¼å‡º"]}),c&&e.jsx("button",{onClick:c,className:"text-slate-400 hover:text-slate-600",children:"âœ•"})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[e.jsxs("div",{className:"p-3 bg-emerald-50 rounded-lg border border-emerald-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-700 mb-1",children:[e.jsx(X,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:"é€šè¿‡"})]}),e.jsx("div",{className:"text-2xl font-bold text-emerald-800",children:p.passed})]}),e.jsxs("div",{className:"p-3 bg-red-50 rounded-lg border border-red-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-700 mb-1",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:"å¤±è´¥"})]}),e.jsx("div",{className:"text-2xl font-bold text-red-800",children:p.failed})]}),e.jsxs("div",{className:"p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-orange-700 mb-1",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:"é—®é¢˜æ•°"})]}),e.jsx("div",{className:"text-2xl font-bold text-orange-800",children:p.totalIssues})]}),e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-700 mb-1",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:"é—®é¢˜è¡Œ"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-800",children:p.totalIssueRows})]})]}),(s==null?void 0:s.overallSummary)&&e.jsx("div",{className:"mt-3 p-3 bg-slate-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-slate-700 whitespace-pre-line",children:s.overallSummary})})]}),e.jsxs("div",{className:"px-4 py-3 border-b border-slate-200 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(is,{className:"w-4 h-4 text-slate-400"}),e.jsx("span",{className:"text-sm font-medium text-slate-700",children:"ç­›é€‰ï¼š"}),e.jsxs("button",{onClick:()=>o("all"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="all"?"bg-slate-800 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:["å…¨éƒ¨ (",p.totalIssues,")"]}),e.jsxs("button",{onClick:()=>o("P0"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="P0"?"bg-red-600 text-white":"bg-red-50 text-red-600 hover:bg-red-100"}`,children:["P0 (",$.P0.length,")"]}),e.jsxs("button",{onClick:()=>o("P1"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="P1"?"bg-orange-600 text-white":"bg-orange-50 text-orange-600 hover:bg-orange-100"}`,children:["P1 (",$.P1.length,")"]}),e.jsxs("button",{onClick:()=>o("P2"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="P2"?"bg-yellow-600 text-white":"bg-yellow-50 text-yellow-600 hover:bg-yellow-100"}`,children:["P2 (",$.P2.length,")"]}),e.jsxs("button",{onClick:()=>o("P3"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="P3"?"bg-blue-600 text-white":"bg-blue-50 text-blue-600 hover:bg-blue-100"}`,children:["P3 (",$.P3.length,")"]})]}),e.jsxs("button",{onClick:()=>x(!n),className:"text-sm text-slate-600 hover:text-slate-800",children:[n?"éšè—":"æ˜¾ç¤º","å»ºè®®"]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsx("div",{className:"p-4 space-y-3",children:i.map(f=>e.jsxs("div",{className:`border rounded-lg overflow-hidden ${f.pass?"border-emerald-200 bg-emerald-50":"border-red-200 bg-red-50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between p-3 cursor-pointer hover:bg-opacity-80",onClick:()=>w(f.ruleId),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[f.pass?e.jsx(X,{className:"w-5 h-5 text-emerald-600"}):e.jsx(le,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-slate-800",children:f.ruleName}),e.jsx("div",{className:"text-xs text-slate-600",children:f.summary})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:[f.issues.length," ä¸ªé—®é¢˜ â€¢ ",f.executionTime,"ms"]}),l.has(f.ruleId)?e.jsx(cs,{className:"w-4 h-4 text-slate-400"}):e.jsx(ds,{className:"w-4 h-4 text-slate-400"})]})]}),l.has(f.ruleId)&&f.issues.length>0&&e.jsx("div",{className:"border-t border-slate-200 p-3 bg-white",children:e.jsxs("div",{className:"space-y-2",children:[f.issues.slice(0,20).map((v,_)=>e.jsxs("div",{className:`p-2 rounded border text-sm cursor-pointer hover:bg-slate-50 ${T(v.severity)}`,onClick:()=>a==null?void 0:a(v.row,v.column),children:[e.jsxs("div",{className:"flex items-start justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[D(v.severity),e.jsxs("span",{className:"font-medium",children:["è¡Œ ",v.row," - ",v.column]})]}),a&&e.jsx(je,{className:"w-3 h-3 text-slate-400"})]}),e.jsx("div",{className:"text-slate-700 mb-1",children:v.description}),v.suggestion&&e.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:["ðŸ’¡ ",v.suggestion]})]},_)),f.issues.length>20&&e.jsxs("div",{className:"text-center text-xs text-slate-500 pt-2",children:["è¿˜æœ‰ ",f.issues.length-20," ä¸ªé—®é¢˜..."]})]})}),l.has(f.ruleId)&&n&&f.suggestions.length>0&&e.jsxs("div",{className:"border-t border-slate-200 p-3 bg-blue-50",children:[e.jsx("div",{className:"text-sm font-medium text-blue-800 mb-2",children:"ä¿®å¤å»ºè®®ï¼š"}),e.jsx("ul",{className:"space-y-1",children:f.suggestions.map((v,_)=>e.jsxs("li",{className:"text-sm text-blue-700 flex items-start gap-2",children:[e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:v})]},_))})]})]},f.ruleId))}),p.totalIssues===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-slate-400",children:[e.jsx(X,{className:"w-16 h-16 mb-4 text-emerald-500"}),e.jsx("p",{className:"text-lg font-medium",children:"æ•°æ®è´¨é‡è‰¯å¥½"}),e.jsx("p",{className:"text-sm",children:"æ‰€æœ‰è§„åˆ™éƒ½å·²é€šè¿‡"})]})]})]})},Cs=({data:i,issues:s,highlightedCell:t,onCellClick:a,children:c})=>{const l=j.useMemo(()=>{const n=new Map;return s.forEach(x=>{const p=`${x.row}_${x.column}`;n.has(p)||n.set(p,[]),n.get(p).push(x)}),n},[s]),d=(n,x)=>{const N=`${n+1}_${x}`,S=l.get(N);if(!S||S.length===0)return{};const $=S.reduce((D,O)=>{const f=["P0","P1","P2","P3"];return Math.max(f.indexOf(O.severity),f.indexOf(D))},"P3"),T={P0:{bg:"rgba(239, 68, 68, 0.2)",border:"#ef4444"},P1:{bg:"rgba(249, 115, 22, 0.2)",border:"#f97316"},P2:{bg:"rgba(234, 179, 8, 0.2)",border:"#eab308"},P3:{bg:"rgba(59, 130, 246, 0.2)",border:"#3b82f6"}}[$];return{backgroundColor:T.bg,border:`2px solid ${T.border}`,cursor:"pointer"}},r=(n,x)=>{const p=n+1,N=`${p}_${x}`,S=l.get(N),$="transition-all hover:opacity-80";return!S||S.length===0?$:(t==null?void 0:t.row)===p&&(t==null?void 0:t.column)===x?`${$} ring-2 ring-offset-1 ring-emerald-500`:$},o=(n,x)=>{const p=n+1,N=`${p}_${x}`,S=l.get(N);S&&S.length>0&&(a==null||a(p,x))};return e.jsx(e.Fragment,{children:c({getCellStyle:d,getCellClassName:r,handleCellClick:o})})},$s={stopOnFirstError:!1,maxIssues:1e3,sampleSize:0,enableCache:!0,parallel:!1};class Rs{constructor(){this.cache=new Map}async executeRule(s,t,a={}){const c={...$s,...a},l=Date.now();if(c.enableCache){const n=this.getCacheKey(s,t),x=this.cache.get(n);if(x)return x}if(!s.localRule)return{ruleId:s.id,ruleName:s.name,pass:!1,issues:[],summary:"è§„åˆ™æœªå®šä¹‰æœ¬åœ°æ‰§è¡Œé€»è¾‘",suggestions:["è¯·ä½¿ç”¨AIæ‰§è¡Œæˆ–å®šä¹‰æœ¬åœ°è§„åˆ™"],executionTime:Date.now()-l,checkedRows:0,issueRows:0};const d=s.targetColumns.length>0?s.targetColumns:this.detectTargetColumns(s,t);if(d.length===0)return{ruleId:s.id,ruleName:s.name,pass:!0,issues:[],summary:"æœªæ£€æµ‹åˆ°ç›®æ ‡åˆ—",suggestions:["è¯·æ‰‹åŠ¨æŒ‡å®šè¦æ£€æŸ¥çš„åˆ—"],executionTime:Date.now()-l,checkedRows:0,issueRows:0};let r=[];switch(s.localRule.type){case"not_null":r=this.checkNotNull(s,t,d,c);break;case"format":r=this.checkFormat(s,t,d,c);break;case"range":r=this.checkRange(s,t,d,c);break;case"unique":r=this.checkUnique(s,t,d,c);break;case"custom":r=this.checkCustom(s,t,d,c);break;default:r=[]}const o={ruleId:s.id,ruleName:s.name,pass:r.length===0,issues:r.slice(0,c.maxIssues),summary:this.buildSummary(s,r,t.length,d),suggestions:this.buildSuggestions(s,r),executionTime:Date.now()-l,checkedRows:t.length,issueRows:new Set(r.map(n=>n.row)).size};if(c.enableCache){const n=this.getCacheKey(s,t);this.cache.set(n,o)}return o}detectTargetColumns(s,t){if(t.length===0)return[];const a=Object.keys(t[0]);if(s.targetColumns&&s.targetColumns.length>0)return s.targetColumns.filter(d=>a.includes(d));const c=s.checkContent.toLowerCase(),l=[/åŒ…å«["'](.+?)["']çš„åˆ—/,/["'](.+?)["']åˆ—/,/æ£€æŸ¥["'](.+?)["']/];for(const d of l){const r=c.match(d);if(r&&r[1]){const o=r[1].split(/[,ï¼Œã€]/).map(x=>x.trim().toLowerCase()),n=a.filter(x=>o.some(p=>x.toLowerCase().includes(p)||p.includes(x.toLowerCase())));if(n.length>0)return n}}if(s.localRule&&"exampleColumns"in s){const d=s.exampleColumns||[],r=a.filter(o=>d.some(n=>o.toLowerCase().includes(n.toLowerCase())||n.toLowerCase().includes(o.toLowerCase())));if(r.length>0)return r}return[]}checkNotNull(s,t,a,c){const l=[];for(let d=0;d<t.length;d++){const r=t[d];for(const o of a){const n=r[o];if((n==null||n===""||typeof n=="string"&&n.trim()==="")&&(l.push({row:d+1,column:o,value:n,description:`å­—æ®µ "${o}" ä¸ºç©º`,severity:s.severity,suggestion:`è¯·å¡«å†™ ${o} å­—æ®µ`}),c.stopOnFirstError))return l}}return l}checkFormat(s,t,a,c){var o,n;const l=[],d=(n=(o=s.localRule)==null?void 0:o.params)==null?void 0:n.pattern;if(!d)return l;const r=new RegExp(d);for(let x=0;x<t.length;x++){const p=t[x];for(const N of a){const S=p[N];if(S!=null&&S!==""){const $=String(S).trim();if(!r.test($)&&(l.push({row:x+1,column:N,value:S,description:`å­—æ®µ "${N}" çš„æ ¼å¼ä¸ç¬¦åˆè¦æ±‚: ${S}`,severity:s.severity,suggestion:`è¯·æ£€æŸ¥ ${N} å­—æ®µæ ¼å¼æ˜¯å¦æ­£ç¡®`}),c.stopOnFirstError))return l}}}return l}checkRange(s,t,a,c){var o,n,x,p;const l=[],d=(n=(o=s.localRule)==null?void 0:o.params)==null?void 0:n.min,r=(p=(x=s.localRule)==null?void 0:x.params)==null?void 0:p.max;for(let N=0;N<t.length;N++){const S=t[N];for(const $ of a){const w=S[$];if(w==null||w==="")continue;let T;if(w instanceof Date)T=w.getTime();else if(typeof w=="string"&&!isNaN(Date.parse(w)))T=new Date(w).getTime();else if(typeof w=="number")T=w;else continue;if(d!==void 0&&T<d&&l.push({row:N+1,column:$,value:w,description:`å­—æ®µ "${$}" çš„å€¼ ${w} å°äºŽæœ€å°å€¼ ${d}`,severity:s.severity,suggestion:`è¯·å°† ${$} å­—æ®µçš„å€¼è°ƒæ•´ä¸ºå¤§äºŽæˆ–ç­‰äºŽ ${d}`}),r!==void 0&&T>r&&l.push({row:N+1,column:$,value:w,description:`å­—æ®µ "${$}" çš„å€¼ ${w} å¤§äºŽæœ€å¤§å€¼ ${r}`,severity:s.severity,suggestion:`è¯·å°† ${$} å­—æ®µçš„å€¼è°ƒæ•´ä¸ºå°äºŽæˆ–ç­‰äºŽ ${r}`}),c.stopOnFirstError&&l.length>0)return l}}return l}checkUnique(s,t,a,c){const l=[];for(const d of a){const r=new Map;for(let o=0;o<t.length;o++){const n=t[o][d];if(n!=null&&n!==""){const x=r.get(n)||[];x.push(o+1),r.set(n,x)}}r.forEach((o,n)=>{if(o.length>1){for(const x of o)l.push({row:x,column:d,value:n,description:`å­—æ®µ "${d}" çš„å€¼ "${n}" é‡å¤å‡ºçŽ° ${o.length} æ¬¡`,severity:s.severity,suggestion:`è¯·ç¡®ä¿ ${d} å­—æ®µçš„å€¼å”¯ä¸€`});if(c.stopOnFirstError)return l}})}return l}checkCustom(s,t,a,c){var r,o;const l=[],d=(o=(r=s.localRule)==null?void 0:r.params)==null?void 0:o.maxLength;if(d!==void 0)for(let n=0;n<t.length;n++){const x=t[n];for(const p of a){const N=x[p];if(N!=null){const S=String(N);if(S.length>d&&(l.push({row:n+1,column:p,value:N,description:`å­—æ®µ "${p}" çš„é•¿åº¦ ${S.length} è¶…è¿‡æœ€å¤§é•¿åº¦ ${d}`,severity:s.severity,suggestion:`è¯·å°† ${p} å­—æ®µçš„é•¿åº¦ç¼©çŸ­åˆ° ${d} å­—ç¬¦ä»¥å†…`}),c.stopOnFirstError))return l}}}return l}buildSummary(s,t,a,c){if(t.length===0)return`âœ… é€šè¿‡ï¼šæ£€æŸ¥äº† ${a} è¡Œæ•°æ®ï¼Œ${c.join(", ")} åˆ—ç¬¦åˆè§„åˆ™`;const l=new Set(t.map(o=>o.row)).size,d=t.reduce((o,n)=>(o[n.severity]=(o[n.severity]||0)+1,o),{}),r=Object.entries(d).map(([o,n])=>`${o}: ${n}ä¸ª`).join(", ");return`âŒ ä¸é€šè¿‡ï¼š${l} è¡Œæœ‰é—®é¢˜ï¼Œå…± ${t.length} ä¸ªé—®é¢˜ (${r})`}buildSuggestions(s,t){if(t.length===0)return["æ•°æ®è´¨é‡è‰¯å¥½ï¼Œç»§ç»­ä¿æŒ"];const a=new Set;return t.forEach(c=>{c.suggestion&&a.add(c.suggestion)}),s.severity==="P0"&&a.add("è¿™æ˜¯é˜»å¡žæ€§é—®é¢˜ï¼Œå¿…é¡»ä¿®å¤æ‰èƒ½ç»§ç»­å¤„ç†"),Array.from(a).slice(0,5)}getCacheKey(s,t){return`${s.id}_${t.length}_${JSON.stringify(s.targetColumns)}`}clearCache(){this.cache.clear()}getCacheSize(){return this.cache.size}}const W=new Rs,Es={stopOnFirstError:!1,maxIssues:100,sampleSize:50,enableCache:!0,parallel:!1};class As{constructor(){this.cache=new Map}async executeRule(s,t,a={}){const c={...Es,...a},l=Date.now();if(c.enableCache){const x=this.getCacheKey(s,t),p=this.cache.get(x);if(p)return p}const d=c.sampleSize||Math.min(100,t.length),r=t.length>d?this.sampleData(t,d):t,o=s.targetColumns.length>0?s.targetColumns:Object.keys(r[0]||{}),n=this.buildPrompt(s,r,o);try{const x=await this.callAIService(n),p=this.parseAIResult(s,x,t.length,o,l);if(c.enableCache){const N=this.getCacheKey(s,t);this.cache.set(N,p)}return p}catch(x){return{ruleId:s.id,ruleName:s.name,pass:!1,issues:[],summary:`AIæ‰§è¡Œå¤±è´¥: ${x instanceof Error?x.message:"æœªçŸ¥é”™è¯¯"}`,suggestions:["è¯·æ£€æŸ¥è§„åˆ™å®šä¹‰æ˜¯å¦æ¸…æ™°","å°è¯•ä½¿ç”¨æœ¬åœ°è§„åˆ™","è”ç³»æŠ€æœ¯æ”¯æŒ"],executionTime:Date.now()-l,checkedRows:r.length,issueRows:0}}}sampleData(s,t){if(s.length<=t)return s;const a=Math.floor(s.length/t),c=[];for(let l=0;l<s.length&&(c.push(s[l]),!(c.length>=t));l+=a);return c}buildPrompt(s,t,a){return`
ä½ æ˜¯ä¸€ä¸ªæ•°æ®è´¨é‡æ£€æŸ¥ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹è§„åˆ™è¯„ä¼°æ•°æ®ï¼š

## è§„åˆ™ä¿¡æ¯
- è§„åˆ™åç§°ï¼š${s.name}
- è§„åˆ™æè¿°ï¼š${s.description}
- æ£€æŸ¥å†…å®¹ï¼š${s.checkContent}
- è¯„åˆ¤æ ‡å‡†ï¼š${s.criteria}
- ä¸¥é‡çº§åˆ«ï¼š${s.severity}

## æ•°æ®é¢„è§ˆ
- åˆ—åï¼š${a.join(", ")}
- æ•°æ®è¡Œæ•°ï¼š${t.length} è¡Œ
- å‰10è¡Œæ•°æ®ï¼š
${JSON.stringify(t.slice(0,10),null,2)}

## ä»»åŠ¡è¦æ±‚
è¯·æ£€æŸ¥æ•°æ®å¹¶è¿”å›žJSONæ ¼å¼ç»“æžœï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
\`\`\`json
{
  "pass": true/false,
  "issues": [
    {
      "row": è¡Œå·ï¼ˆä»Ž1å¼€å§‹ï¼‰,
      "column": "åˆ—å",
      "value": "é—®é¢˜å€¼",
      "description": "é—®é¢˜æè¿°",
      "severity": "P0/P1/P2/P3",
      "suggestion": "ä¿®å¤å»ºè®®"
    }
  ],
  "summary": "æ‰§è¡Œæ‘˜è¦",
  "suggestions": ["å»ºè®®1", "å»ºè®®2", "å»ºè®®3"]
}
\`\`\`

## æ³¨æ„äº‹é¡¹
1. åªè¿”å›žJSONï¼Œä¸è¦å…¶ä»–æ–‡å­—è¯´æ˜Ž
2. rowå­—æ®µå¿…é¡»æ˜¯å®žé™…æ•°æ®ä¸­çš„è¡Œå·
3. å¦‚æžœæ•°æ®é‡‡æ ·æ£€æŸ¥ï¼Œè¯·åœ¨summaryä¸­è¯´æ˜Ž
4. issuesæ•°ç»„æœ€å¤šè¿”å›ž100ä¸ªé—®é¢˜
5. suggestionsæ•°ç»„æœ€å¤šè¿”å›ž5æ¡å»ºè®®
`.trim()}async callAIService(s){var t,a,c,l,d;try{let r;const o=globalThis.__ELECTRON_ENV__;o&&o.IS_ELECTRON?(r=o.API_BASE_URL,console.log("[AI Rule Executor] æ£€æµ‹åˆ° Electron çŽ¯å¢ƒï¼Œä½¿ç”¨:",r)):(r=globalThis.__VITE_API_BASE_URL__||"/api",r.startsWith("http")||(r=`http://localhost:3001${r}`)),r=r.replace(/\/$/,""),console.log("[AI Rule Executor] è°ƒç”¨AIæœåŠ¡:",{url:`${r}/v2/ai/chat`,promptLength:s.length});const n=await fetch(`${r}/v2/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:s,history:[],contextDocs:""})});if(!n.ok){let S="";try{const $=await n.json();S=JSON.stringify($),console.error("[AI Rule Executor] AIæœåŠ¡é”™è¯¯å“åº”:",{status:n.status,statusText:n.statusText,error:$})}catch{S=await n.text(),console.error("[AI Rule Executor] AIæœåŠ¡é”™è¯¯å“åº” (æ— æ³•è§£æžJSON):",{status:n.status,statusText:n.statusText,text:S})}throw new Error(`AIæœåŠ¡å“åº”å¤±è´¥: ${n.status} - ${S}`)}const x=await n.json();if(!x.success)throw console.error("[AI Rule Executor] AIæœåŠ¡è¿”å›žå¤±è´¥:",x),new Error(((t=x.error)==null?void 0:t.message)||"AIè°ƒç”¨å¤±è´¥");const p=((a=x.data)==null?void 0:a.response)||((l=(c=x.data)==null?void 0:c.message)==null?void 0:l.content)||((d=x.data)==null?void 0:d.content);if(!p)throw console.error("[AI Rule Executor] AIè¿”å›žå†…å®¹ä¸ºç©º:",x),new Error("AIè¿”å›žå†…å®¹ä¸ºç©º");console.log("[AI Rule Executor] AIè¿”å›žå†…å®¹é•¿åº¦:",p.length);const N=p.match(/```json\n([\s\S]*?)\n```/)||p.match(/\{[\s\S]*\}/);if(N){const S=N[1]||N[0];return console.log("[AI Rule Executor] æˆåŠŸæå–JSONç»“æžœ"),JSON.parse(S)}return console.warn("[AI Rule Executor] æœªæ‰¾åˆ°JSONæ ¼å¼ç»“æžœï¼Œè¿”å›žé»˜è®¤é€šè¿‡"),{pass:!0,issues:[],summary:"AIæ£€æŸ¥å®Œæˆï¼ˆæœªè¿”å›žç»“æž„åŒ–ç»“æžœï¼‰",suggestions:[]}}catch(r){throw console.error("[AI Rule Executor] AIæœåŠ¡è°ƒç”¨å¤±è´¥:",r),r}}parseAIResult(s,t,a,c,l){if(!t||typeof t!="object")throw new Error("AIè¿”å›žç»“æžœæ ¼å¼é”™è¯¯");const d=(t.issues||[]).map(r=>({row:r.row||0,column:r.column||"",value:r.value,description:r.description||"æ•°æ®è´¨é‡é—®é¢˜",severity:r.severity||s.severity,suggestion:r.suggestion}));return{ruleId:s.id,ruleName:s.name,pass:t.pass||d.length===0,issues:d.slice(0,100),summary:t.summary||this.buildSummary(s,d,a,c),suggestions:t.suggestions||[],executionTime:Date.now()-l,checkedRows:a,issueRows:new Set(d.map(r=>r.row)).size}}buildSummary(s,t,a,c){if(t.length===0)return`âœ… é€šè¿‡ï¼ˆAIæ£€æŸ¥ï¼‰ï¼šæ£€æŸ¥äº† ${a} è¡Œæ•°æ®ï¼Œ${c.join(", ")} åˆ—ç¬¦åˆè§„åˆ™`;const l=new Set(t.map(o=>o.row)).size,d=t.reduce((o,n)=>(o[n.severity]=(o[n.severity]||0)+1,o),{}),r=Object.entries(d).map(([o,n])=>`${o}: ${n}ä¸ª`).join(", ");return`âŒ ä¸é€šè¿‡ï¼ˆAIæ£€æŸ¥ï¼‰ï¼š${l} è¡Œæœ‰é—®é¢˜ï¼Œå…± ${t.length} ä¸ªé—®é¢˜ (${r})`}getCacheKey(s,t){const a=this.hashData(t);return`ai_${s.id}_${a}`}hashData(s){const t=JSON.stringify(s.slice(0,5));return`${s.length}_${t.length}`}clearCache(){this.cache.clear()}getCacheSize(){return this.cache.size}async testAvailability(){try{const s={id:"test",name:"æµ‹è¯•è§„åˆ™",description:"æµ‹è¯•",category:"æµ‹è¯•",checkContent:"æµ‹è¯•",criteria:"æµ‹è¯•",severity:"P1",executionType:"ai",targetColumns:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),usageCount:0,isOfficial:!1,isEnabled:!0},t=[{a:1,b:2}];return(await this.executeRule(s,t,{sampleSize:1})).executionTime>0}catch(s){return console.error("AIæœåŠ¡ä¸å¯ç”¨:",s),!1}}}const V=new As;class Ps{async executeRules(s,t,a={}){const c=Date.now(),l=s.filter(p=>p.isEnabled);if(l.length===0)return{totalRules:s.length,executedRules:0,skippedRules:s.length,results:[],overallSummary:"æ²¡æœ‰å¯ç”¨çš„è§„åˆ™",totalExecutionTime:0};const d=l.filter(p=>p.executionType==="local"),r=l.filter(p=>p.executionType==="ai"),o=await this.executeLocalRules(d,t,a),n=await this.executeAIRules(r,t,a),x=[...o,...n];for(const p of l)await K.incrementUsage(p.id);return{totalRules:s.length,executedRules:l.length,skippedRules:s.length-l.length,results:x,overallSummary:this.buildOverallSummary(x,t.length),totalExecutionTime:Date.now()-c}}async executeLocalRules(s,t,a){if(s.length===0)return[];const c=s.map(l=>W.executeRule(l,t,a));return Promise.all(c)}async executeAIRules(s,t,a){if(s.length===0)return[];const c=[];for(const l of s)try{const d=await V.executeRule(l,t,a);c.push(d)}catch(d){console.error(`AIè§„åˆ™æ‰§è¡Œå¤±è´¥ (${l.name}):`,d),c.push({ruleId:l.id,ruleName:l.name,pass:!1,issues:[],summary:`æ‰§è¡Œå¤±è´¥: ${d instanceof Error?d.message:"æœªçŸ¥é”™è¯¯"}`,suggestions:["è¯·ç¨åŽé‡è¯•","å°è¯•ä½¿ç”¨æœ¬åœ°è§„åˆ™"],executionTime:0,checkedRows:0,issueRows:0})}return c}async executeSingleRule(s,t,a={}){return s.executionType==="local"?W.executeRule(s,t,a):s.executionType==="ai"?V.executeRule(s,t,a):this.executeHybridRule(s,t,a)}async executeHybridRule(s,t,a){if(s.localRule){const c=await W.executeRule(s,t,a);if(!c.pass&&c.issues.length>0){console.log(`æœ¬åœ°è§„åˆ™å‘çŽ°é—®é¢˜ï¼Œä½¿ç”¨AIæ·±åº¦åˆ†æž: ${s.name}`);const l=await V.executeRule(s,t,{...a,sampleSize:Math.min(50,t.length)});return{...c,issues:[...c.issues,...l.issues],suggestions:[...c.suggestions,...l.suggestions],summary:`${c.summary}ï¼ŒAIæ·±åº¦åˆ†æž: ${l.summary}`,executionTime:c.executionTime+l.executionTime}}return c}return V.executeRule(s,t,a)}buildOverallSummary(s,t){const a=s.filter(o=>o.pass).length,c=s.filter(o=>!o.pass).length,l=s.reduce((o,n)=>o+n.issues.length,0),d=s.reduce((o,n)=>o+n.issueRows,0),r=(a/s.length*100).toFixed(1);return`
æ‰§è¡Œå®Œæˆï¼
- æ€»è§„åˆ™æ•°ï¼š${s.length}
- é€šè¿‡ï¼š${a} (${r}%)
- å¤±è´¥ï¼š${c}
- é—®é¢˜æ€»æ•°ï¼š${l}
- é—®é¢˜è¡Œæ•°ï¼š${d} / ${t}
    `.trim()}async getExecutionSuggestions(s,t){const a=[],c=s.filter(r=>r.executionType==="local"),l=s.filter(r=>r.executionType==="ai");c.length===0&&a.push("å»ºè®®æ·»åŠ æœ¬åœ°è§„åˆ™ä»¥åŠ å¿«æ‰§è¡Œé€Ÿåº¦"),l.length>5&&a.push("AIè§„åˆ™è¾ƒå¤šï¼Œæ‰§è¡Œå¯èƒ½è¾ƒæ…¢ä¸”æœ‰æˆæœ¬ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨æœ¬åœ°è§„åˆ™"),t>1e4&&a.push("æ•°æ®é‡è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨é‡‡æ ·æ£€æŸ¥ä»¥åŠ å¿«é€Ÿåº¦");const d=new Set(s.map(r=>r.category));return d.has("æ ¼å¼æ£€æŸ¥")||a.push("å»ºè®®æ·»åŠ æ ¼å¼æ£€æŸ¥è§„åˆ™"),d.has("å®Œæ•´æ€§æ£€æŸ¥")||a.push("å»ºè®®æ·»åŠ å®Œæ•´æ€§æ£€æŸ¥è§„åˆ™"),a}clearAllCaches(){W.clearCache(),V.clearCache()}getCacheStats(){return{local:W.getCacheSize(),ai:V.getCacheSize()}}}const ks=new Ps,Ms=()=>{var fe;const{filesData:i,activeFileId:s,setFilesData:t,setActiveFileId:a,setExcelData:c,setView:l}=Ve(),[d,r]=j.useState(""),[o,n]=j.useState(new Set),[x,p]=j.useState(""),[N,S]=j.useState(!1),[$,w]=j.useState([]),[T,D]=j.useState(!1),[O,f]=j.useState(""),[v,_]=j.useState(null),[B,q]=j.useState([]),[U,b]=j.useState(!0),[L,J]=j.useState("processing"),[h,P]=j.useState([]),[Q,Z]=j.useState([]),[ke,ee]=j.useState(null),[Ie,me]=j.useState(!1),[Te,se]=j.useState(null),ue=j.useRef(null),te=j.useRef(null);j.useCallback(m=>{_(m),m.progress.percentage>0&&w(g=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`è¿›åº¦: ${m.progress.percentage}% - ${m.progress.message}`},...g])},[]);const Oe=j.useMemo(()=>({idle:"ç©ºé—²",observing:"è§‚å¯Ÿæ•°æ®...",thinking:"AIæ€è€ƒä¸­...",acting:"æ‰§è¡Œè½¬æ¢...",evaluating:"è¯„ä¼°ç»“æžœ...",repairing:"ä¿®å¤é”™è¯¯...",completed:"å·²å®Œæˆ",failed:"å¤±è´¥",cancelled:"å·²å–æ¶ˆ"}),[]),xe=j.useCallback(m=>`${Math.round(m*100)}%`,[]),_e=j.useCallback(async m=>{if(i.length===0){alert("è¯·å…ˆä¸Šä¼ æ–‡ä»¶");return}const g=i.find(u=>u.id===s);if(!g||!d){alert("è¯·é€‰æ‹©æ–‡ä»¶å’Œå·¥ä½œè¡¨");return}const y=g.sheets[d];if(!y||y.length===0){alert("å½“å‰å·¥ä½œè¡¨æ²¡æœ‰æ•°æ®");return}me(!0),Z([]),ee(null),se(null),w(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`å¼€å§‹æ‰§è¡Œè´¨é‡æ£€æŸ¥ï¼Œå…± ${m.length} æ¡è§„åˆ™...`},...u]);try{const u=await ks.executeRules(m,y,{sampleSize:y.length>1e3?100:0,maxIssues:100});Z(u.results),ee(u);const C=u.results.filter(E=>E.pass).length,R=u.results.filter(E=>!E.pass).length,A=u.results.reduce((E,I)=>E+I.issues.length,0);w(E=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:R===0?"success":"error",message:`è´¨é‡æ£€æŸ¥å®Œæˆï¼é€šè¿‡ ${C}/${u.results.length}ï¼Œå‘çŽ° ${A} ä¸ªé—®é¢˜ï¼Œè€—æ—¶ ${Math.round(u.totalExecutionTime/1e3)}s`},...E])}catch(u){console.error("è´¨é‡æ£€æŸ¥å¤±è´¥:",u);const C=u instanceof Error?u.message:"æœªçŸ¥é”™è¯¯";w(R=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:`è´¨é‡æ£€æŸ¥å¤±è´¥: ${C}`},...R]),alert(`è´¨é‡æ£€æŸ¥å¤±è´¥: ${C}`)}finally{me(!1)}},[i,s,d]),he=j.useCallback((m,g)=>{se({row:m,column:g});const y=document.querySelector(`tr[data-row="${m}"]`);y&&y.scrollIntoView({behavior:"smooth",block:"center"}),w(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`è·³è½¬åˆ°é—®é¢˜ä½ç½®ï¼šè¡Œ ${m}ï¼Œåˆ— ${g}`},...u])},[]),De=j.useCallback(m=>{P(m)},[]),Le=j.useCallback(()=>{Z([]),ee(null),se(null)},[]),Fe=j.useCallback(async()=>{te.current&&(te.current.abort(),te.current=null),S(!1),w(m=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:"ç”¨æˆ·å–æ¶ˆäº†æ‰§è¡Œ"},...m])},[]);j.useEffect(()=>{if(s){const m=i.find(g=>g.id===s);m&&!d&&r(m.currentSheetName)}else r("")},[s,i]);const Me=async m=>{if(m.target.files&&m.target.files.length>0){const g=[];for(let y=0;y<m.target.files.length;y++)try{const u=await Ge(m.target.files[y]);g.push(u)}catch(u){k.error(`Error reading file ${m.target.files[y].name}`,u)}t([...i,...g]),!s&&g.length>0&&(a(g[0].id),r(g[0].currentSheetName))}},qe=async()=>{if(!(i.length===0||!x.trim())){S(!0),f(""),_(null);try{const m=i.map(g=>({id:g.id,fileName:g.fileName,sheets:g.sheets,currentSheetName:g.currentSheetName,metadata:g.metadata}));if(U){w(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:"å¯åŠ¨å¤šæ­¥åˆ†æžç³»ç»Ÿ (Observe-Think-Act-Evaluate)... é€šè¿‡åŽç«¯APIæœåŠ¡"},...u]);const g=await Y.execute({command:x,files:m,options:{useAgenticMode:!0,maxRetries:3,qualityThreshold:.7,enableAutoRepair:!0}});w(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`ä»»åŠ¡å·²åˆ›å»º (ID: ${g.taskId})ï¼Œæ­£åœ¨å¤„ç†...`},...u]);const y=await Y.waitForCompletion(g.taskId,{pollInterval:2e3,timeout:3e5,onProgress:u=>{u.status==="processing"&&w(C=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`å¤„ç†ä¸­... (å·²ç”¨æ—¶: ${Math.round((u.elapsed||0)/1e3)}s)`},...C])}});if(y.success&&y.data){const u=[...i];let C=0;if(Object.entries(y.data).forEach(([R,A])=>{if(typeof A=="object"&&!Array.isArray(A)){const E=A,I=u.findIndex(M=>M.fileName===R);if(I>=0){const M=u[I];Object.entries(E).forEach(([ae,H])=>{Array.isArray(H)&&(M.sheets[ae]=H)}),C++}else{const M=Object.keys(E)[0];u.push({id:R+"-"+Date.now(),fileName:R,sheets:E,currentSheetName:M}),C++}}else if(Array.isArray(A)){const E=u.findIndex(I=>I.fileName===R);if(E>=0){const I=u[E];I.sheets[I.currentSheetName]=A,C++}else u.push({id:R+"-"+Date.now(),fileName:R,sheets:{Sheet1:A},currentSheetName:"Sheet1"}),C++}}),t(u),y.qualityReport){const R=xe(y.qualityReport.overallQuality);w(A=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"success",message:`æ‰§è¡Œå®Œæˆï¼è´¨é‡è¯„åˆ†: ${R}ï¼Œå¤„ç†äº† ${C} ä¸ªæ–‡ä»¶ï¼Œè€—æ—¶ ${Math.round(y.executionSummary.totalTime/1e3)}s`},...A])}else w(R=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"success",message:`æ‰§è¡Œå®Œæˆã€‚å¤„ç†äº† ${C} ä¸ªæ–‡ä»¶ã€‚`},...R])}else throw new Error("å¤šæ­¥åˆ†æžå¤±è´¥ï¼Œå°è¯•é™çº§åˆ°å•æ­¥æ‰§è¡Œ")}else await ge(m)}catch(m){if(U){w(g=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:`å¤šæ­¥åˆ†æžå¤±è´¥: ${m.message}ï¼Œé™çº§åˆ°å•æ­¥æ‰§è¡Œ...`},...g]);try{const g=i.map(y=>({id:y.id,fileName:y.fileName,sheets:y.sheets,currentSheetName:y.currentSheetName,metadata:y.metadata}));await ge(g)}catch(g){w(y=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:`æ‰§è¡Œå¤±è´¥: ${g.message}`},...y])}}else w(g=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:m.message},...g])}finally{S(!1)}}},ge=async m=>{w(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:"ä½¿ç”¨å¿«é€Ÿæ‰§è¡Œæ¨¡å¼ï¼ˆé€šè¿‡APIï¼‰..."},...u]),w(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:"æ­£åœ¨é€šè¿‡ API æ‰§è¡Œä»»åŠ¡..."},...u]);const g=await Y.execute({command:x,files:m,options:{maxRetries:1,qualityThreshold:0,enableAutoRepair:!1,logLevel:"warn"}});w(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`ä»»åŠ¡å·²åˆ›å»º (ID: ${g.taskId})ï¼Œæ­£åœ¨æ‰§è¡Œ...`},...u]);const y=await Y.waitForCompletion(g.taskId,{pollInterval:1e3,timeout:6e4,onProgress:u=>{u.status==="processing"&&w(C=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`æ‰§è¡Œä¸­... (å·²ç”¨æ—¶: ${Math.round((u.elapsed||0)/1e3)}s)`},...C])}});if(y.success&&y.data){const u=[...i];let C=0;if(Object.entries(y.data).forEach(([R,A])=>{if(typeof A=="object"&&!Array.isArray(A)){const E=A,I=u.findIndex(M=>M.fileName===R);if(I>=0){const M=u[I];Object.entries(E).forEach(([ae,H])=>{Array.isArray(H)&&(M.sheets[ae]=H)}),C++}else{const M=Object.keys(E)[0];u.push({id:R+"-"+Date.now(),fileName:R,sheets:E,currentSheetName:M}),C++}}else if(Array.isArray(A)){const E=u.findIndex(I=>I.fileName===R);if(E>=0){const I=u[E];I.sheets[I.currentSheetName]=A,C++}else u.push({id:R+"-"+Date.now(),fileName:R,sheets:{Sheet1:A},currentSheetName:"Sheet1"}),C++}}),C===0)throw new Error("æ²¡æœ‰æˆåŠŸå¤„ç†ä»»ä½•æ–‡ä»¶æ•°æ®");t(u),w(R=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"success",message:`æ‰§è¡Œå®Œæˆã€‚å¤„ç†äº† ${C} ä¸ªæ–‡ä»¶ã€‚`},...R])}else throw new Error(y.error||"å¿«é€Ÿæ‰§è¡Œå¤±è´¥")},Ue=(m,g)=>{g.stopPropagation(),t(y=>y.filter(u=>u.id!==m)),n(y=>{const u=new Set(y);return u.delete(m),u}),s===m&&(a(null),r(""))},ze=(m,g)=>{g.stopPropagation(),be(m.sheets,m.fileName)},Je=(m,g)=>{g.stopPropagation(),n(y=>{const u=new Set(y);return u.has(m)?u.delete(m):u.add(m),u})},pe=(m,g)=>{g==null||g.stopPropagation(),c(m),l(Xe.DOCUMENT_SPACE)},Be=()=>{o.size===i.length?n(new Set):n(new Set(i.map(m=>m.id)))},Qe=async()=>{if(o.size===0)return;S(!0);const m=new We;let g=0;if(i.forEach(y=>{if(o.has(y.id)){const u=re.book_new();Object.entries(y.sheets).forEach(([A,E])=>{const I=re.json_to_sheet(E);re.book_append_sheet(u,I,A)});const C=He(u,{bookType:"xlsx",type:"array"});let R=y.fileName;R.endsWith(".xlsx")||(R+=".xlsx"),m.file(R,C),g++}}),g>0)try{const y=await m.generateAsync({type:"blob"}),u=window.URL.createObjectURL(y),C=document.createElement("a");C.href=u,C.download=`excelmind_batch_export_${Date.now()}.zip`,C.click(),window.URL.revokeObjectURL(u),w(R=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"success",message:`æˆåŠŸæ‰“åŒ…å¹¶ä¸‹è½½ ${g} ä¸ªæ–‡ä»¶ã€‚`},...R])}catch(y){k.error(y),w(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:"æ‰“åŒ…å¤±è´¥ã€‚"},...u])}S(!1)},F=i.find(m=>m.id===s),z=F&&d?F.sheets[d]:null;return e.jsxs("div",{className:"h-full flex flex-col bg-slate-50",children:[e.jsxs("div",{className:"bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-800",children:L==="processing"?"æ™ºèƒ½å¤šæ–‡ä»¶å¤„ç†å·¥ä½œåŒº":"æ•°æ®è´¨é‡æ£€æŸ¥å·¥ä½œåŒº"}),e.jsx("p",{className:"text-sm text-slate-500",children:L==="processing"?"ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œè¿›è¡Œè·¨è¡¨æ ¸å¯¹ã€åˆå¹¶æˆ–ç­›é€‰":"ä½¿ç”¨è´¨é‡è§„åˆ™æ£€æŸ¥æ•°æ®ï¼Œå‘çŽ°å¹¶ä¿®å¤é—®é¢˜"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(js,{currentMode:L,onModeChange:J,disabled:i.length===0}),e.jsx("input",{type:"file",multiple:!0,accept:".xlsx, .xls",onChange:Me,className:"hidden",ref:ue}),e.jsxs("button",{onClick:()=>{var m;return(m=ue.current)==null?void 0:m.click()},className:"flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 rounded-lg transition-colors font-medium text-sm border border-emerald-200",children:[e.jsx(Ee,{className:"w-4 h-4"}),"æ·»åŠ æ–‡ä»¶"]})]})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:"w-[400px] flex flex-col border-r border-slate-200 bg-white shadow-sm z-10",children:L==="processing"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:Be,className:"text-slate-500 hover:text-emerald-600 transition-colors",title:"å…¨é€‰/å–æ¶ˆå…¨é€‰",children:i.length>0&&o.size===i.length?e.jsx(ie,{className:"w-5 h-5 text-emerald-600"}):e.jsx(ve,{className:"w-5 h-5"})}),e.jsxs("span",{className:"text-sm font-semibold text-slate-700",children:["æ–‡ä»¶åˆ—è¡¨ (",i.length,")"]})]}),o.size>0&&e.jsxs("button",{onClick:Qe,className:"text-xs flex items-center gap-1 bg-emerald-600 text-white px-3 py-1 rounded-lg hover:bg-emerald-700 transition-all shadow-sm",children:[e.jsx(ms,{className:"w-3.5 h-3.5"}),"ä¸‹è½½é€‰ä¸­ (",o.size,")"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 border-b border-slate-100",children:i.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-400 border-2 border-dashed border-slate-100 rounded-xl",children:[e.jsx("p",{children:"å·¥ä½œåŒºä¸ºç©º"}),e.jsx("p",{className:"text-xs mt-1",children:"è¯·æ·»åŠ  Excel æ–‡ä»¶"})]}):e.jsx("ul",{className:"space-y-2",children:i.map(m=>e.jsxs("li",{onClick:()=>a(m.id),className:`group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all border ${s===m.id?"bg-emerald-50 border-emerald-200 shadow-sm":"bg-white border-slate-100 hover:bg-slate-50"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 overflow-hidden",children:[e.jsx("div",{onClick:g=>Je(m.id,g),className:"flex-shrink-0 text-slate-400 hover:text-emerald-600 transition-colors",children:o.has(m.id)?e.jsx(ie,{className:"w-4 h-4 text-emerald-600"}):e.jsx(ve,{className:"w-4 h-4"})}),e.jsx("div",{className:`p-2 rounded-lg ${s===m.id?"bg-emerald-200 text-emerald-700":"bg-slate-100 text-slate-500"}`,children:e.jsx(us,{className:"w-4 h-4"})}),e.jsxs("div",{className:"truncate",children:[e.jsx("p",{className:`text-sm font-medium truncate ${s===m.id?"text-slate-800":"text-slate-600"}`,children:m.fileName}),e.jsxs("p",{className:"text-xs text-slate-400",children:[Object.keys(m.sheets).length," ä¸ªå·¥ä½œè¡¨"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:g=>pe(m,g),className:"text-slate-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity p-1",title:"å‘é€åˆ°æ–‡æ¡£ç”Ÿæˆ",children:e.jsx(Ne,{className:"w-4 h-4"})}),e.jsx("button",{onClick:g=>ze(m,g),className:"text-slate-300 hover:text-emerald-400 opacity-0 group-hover:opacity-100 transition-opacity p-1",title:"ä¸‹è½½æ–‡ä»¶",children:e.jsx(Pe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:g=>Ue(m.id,g),className:"text-slate-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1",title:"åˆ é™¤æ–‡ä»¶",children:e.jsx(Ae,{className:"w-4 h-4"})})]})]},m.id))})}),e.jsxs("div",{className:"p-4 bg-slate-50 border-t border-slate-200",children:[v&&N&&e.jsxs("div",{className:"mb-3 p-3 bg-gradient-to-r from-emerald-50 to-blue-50 rounded-xl border border-emerald-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"w-4 h-4 text-emerald-600"}),e.jsx("span",{className:"text-xs font-bold text-emerald-700",children:"å¤šæ­¥åˆ†æžç³»ç»Ÿ"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-xs font-semibold text-slate-600",children:[v.progress.percentage,"%"]})})]}),e.jsx("div",{className:"w-full bg-slate-200 rounded-full h-2 mb-2",children:e.jsx("div",{className:"bg-gradient-to-r from-emerald-500 to-blue-500 h-2 rounded-full transition-all duration-300",style:{width:`${v.progress.percentage}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"font-medium text-slate-700",children:Oe[v.status]||v.status}),v.qualityReport&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:`w-3 h-3 ${v.qualityReport.overallQuality>=.8?"text-green-500":"text-yellow-500"}`}),e.jsxs("span",{className:"font-semibold text-slate-600",children:["è´¨é‡: ",xe(v.qualityReport.overallQuality)]})]})]}),e.jsx("div",{className:"mt-2 flex items-center gap-1 text-xs",children:[{key:"observing",label:"è§‚å¯Ÿ",icon:"ðŸ‘ï¸"},{key:"thinking",label:"æ€è€ƒ",icon:"ðŸ§ "},{key:"acting",label:"æ‰§è¡Œ",icon:"âš¡"},{key:"evaluating",label:"è¯„ä¼°",icon:"âœ…"}].map(m=>{const g=v.status===m.key,y=["observing","thinking"].includes(m.key)&&["acting","evaluating","completed"].includes(v.status);return e.jsxs("div",{className:`flex-1 flex items-center justify-center gap-1 py-1 px-2 rounded-lg transition-all ${g?"bg-emerald-500 text-white font-bold":y?"bg-emerald-100 text-emerald-700":"bg-slate-100 text-slate-400"}`,children:[e.jsx("span",{children:m.icon}),e.jsx("span",{className:"hidden sm:inline",children:m.label})]},m.key)})}),v.status==="repairing"&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-amber-600 bg-amber-50 p-2 rounded-lg",children:[e.jsx(Ce,{className:"w-3 h-3"}),e.jsx("span",{className:"font-medium",children:"æ£€æµ‹åˆ°é”™è¯¯ï¼Œæ­£åœ¨è‡ªåŠ¨ä¿®å¤..."})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-bold text-slate-700",children:"AI æŒ‡ä»¤"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>b(!U),className:`text-xs px-2 py-1 rounded-lg font-medium transition-all flex items-center gap-1 ${U?"bg-emerald-100 text-emerald-700 border border-emerald-300":"bg-slate-100 text-slate-600 border border-slate-200"}`,title:U?"å¤šæ­¥åˆ†æžæ¨¡å¼ï¼šæ”¯æŒè‡ªæˆ‘ä¿®å¤å’Œè´¨é‡è¯„ä¼°":"å•æ­¥æ‰§è¡Œæ¨¡å¼ï¼šå¿«é€Ÿæ‰§è¡Œ",children:[e.jsx(Se,{className:"w-3 h-3"}),U?"æ™ºèƒ½æ¨¡å¼":"å¿«é€Ÿæ¨¡å¼"]}),e.jsxs("button",{onClick:()=>D(!T),className:"text-xs font-normal text-slate-400 hover:text-emerald-600 flex items-center gap-1",children:[e.jsx(xs,{className:"w-3 h-3"})," ",T?"éšè—ä»£ç ":"æŸ¥çœ‹ä»£ç "]})]})]}),T&&O&&e.jsx("div",{className:"mb-3 p-2 bg-slate-900 text-green-400 text-xs font-mono rounded-lg max-h-32 overflow-y-auto",children:e.jsx("pre",{children:O})}),e.jsx("textarea",{value:x,onChange:m=>p(m.target.value),placeholder:`æè¿°æ‚¨çš„è·¨æ–‡ä»¶éœ€æ±‚... 
ä¾‹å¦‚ï¼š'å¯¹æ¯”è¡¨Aå’Œè¡¨Bï¼Œæ‰¾å‡ºé‡‘é¢ä¸ä¸€è‡´çš„è¡Œï¼Œå­˜ä¸ºæ–°æ–‡ä»¶å·®å¼‚è¡¨'`,className:"w-full h-24 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none text-slate-700 resize-none bg-white text-sm shadow-sm"}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsxs("button",{onClick:qe,disabled:N||!x||i.length===0,className:`flex-1 py-2.5 rounded-xl flex items-center justify-center gap-2 font-bold text-white transition-all text-sm ${N||!x||i.length===0?"bg-slate-300 cursor-not-allowed":"bg-emerald-600 hover:bg-emerald-700 shadow-md hover:shadow-emerald-900/20"}`,children:[N?e.jsx(hs,{className:"w-4 h-4 animate-spin"}):e.jsx(gs,{className:"w-4 h-4"}),"æ‰§è¡Œæ™ºèƒ½å¤„ç†"]}),N&&e.jsxs("button",{onClick:Fe,className:"px-4 py-2.5 rounded-xl bg-red-100 text-red-600 hover:bg-red-200 transition-all font-bold text-sm flex items-center gap-2",title:"å–æ¶ˆæ‰§è¡Œ",children:[e.jsx(Ce,{className:"w-4 h-4"}),"å–æ¶ˆ"]})]}),v&&!N&&v.status==="completed"&&e.jsxs("div",{className:"mt-3 p-3 bg-green-50 rounded-xl border border-green-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-700 font-bold text-sm mb-2",children:[e.jsx(X,{className:"w-4 h-4"}),"æ‰§è¡Œå®Œæˆ"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-xs text-slate-600",children:((fe=v.result)==null?void 0:fe.executionSummary)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:["æ€»æ­¥éª¤: ",v.result.executionSummary.totalSteps]}),e.jsxs("div",{children:["æˆåŠŸ: ",v.result.executionSummary.successfulSteps]}),e.jsxs("div",{children:["è€—æ—¶: ",Math.round(v.result.executionSummary.totalTime/1e3),"s"]}),e.jsxs("div",{children:["å¤±è´¥: ",v.result.executionSummary.failedSteps]})]})})]})]}),e.jsx("div",{className:"h-32 bg-slate-900 overflow-y-auto p-3 text-xs font-mono",children:$.length===0?e.jsx("span",{className:"text-slate-600",children:"ç­‰å¾…æŒ‡ä»¤..."}):$.map(m=>e.jsxs("div",{className:"mb-1.5 flex gap-2",children:[e.jsxs("span",{className:`uppercase font-bold ${m.status==="success"?"text-green-400":m.status==="error"?"text-red-400":"text-yellow-400"}`,children:["[",m.status,"]"]}),e.jsx("span",{className:"text-slate-300",children:m.message})]},m.id))})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ns,{onRulesChange:De,onExecuteRules:_e,executing:Ie}),e.jsx("div",{className:"h-32 bg-slate-900 overflow-y-auto p-3 text-xs font-mono border-t border-slate-200",children:$.length===0?e.jsx("span",{className:"text-slate-600",children:"ç­‰å¾…è´¨é‡æ£€æŸ¥..."}):$.map(m=>e.jsxs("div",{className:"mb-1.5 flex gap-2",children:[e.jsxs("span",{className:`uppercase font-bold ${m.status==="success"?"text-green-400":m.status==="error"?"text-red-400":"text-yellow-400"}`,children:["[",m.status,"]"]}),e.jsx("span",{className:"text-slate-300",children:m.message})]},m.id))})]})}),e.jsx("div",{className:"flex-1 bg-slate-50 flex flex-col overflow-hidden",children:L==="quality"&&Q.length>0?e.jsx(Ss,{results:Q,batchResult:ke||void 0,data:z||[],onIssueClick:he,onClose:Le}):F&&z?e.jsx(Cs,{data:z,issues:Q.flatMap(m=>m.issues),highlightedCell:Te,onCellClick:he,children:({getCellStyle:m,getCellClassName:g,handleCellClick:y})=>e.jsxs("div",{className:"flex-1 flex flex-col m-4 bg-white rounded-xl shadow border border-slate-200 overflow-hidden",children:[e.jsxs("div",{className:"p-3 border-b border-slate-100 flex justify-between items-center bg-white",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-bold text-slate-700",children:F.fileName}),Object.keys(F.sheets).length>1&&e.jsx("select",{value:d,onChange:u=>r(u.target.value),className:"text-xs px-2 py-1 bg-emerald-50 text-emerald-700 rounded-full border border-emerald-200 outline-none cursor-pointer hover:bg-emerald-100 transition-colors",children:Object.keys(F.sheets).map(u=>e.jsx("option",{value:u,children:u},u))}),Object.keys(F.sheets).length===1&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-slate-100 text-slate-500 rounded-full",children:d}),e.jsxs("span",{className:"text-xs text-slate-400",children:["(",z.length," è¡Œ)"]}),L==="quality"&&Q.length>0&&e.jsxs("span",{className:"text-xs px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full",children:[Q.reduce((u,C)=>u+C.issues.length,0)," ä¸ªé—®é¢˜"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>pe(F),className:"text-xs flex items-center gap-1 text-white bg-blue-600 hover:bg-blue-700 font-medium px-3 py-1.5 rounded-lg shadow-sm transition-all",title:"ä½¿ç”¨æ­¤æ•°æ®ç”Ÿæˆæ–‡æ¡£",children:[e.jsx(Ne,{className:"w-3.5 h-3.5"})," å‘é€åˆ°ç”Ÿæˆå™¨"]}),e.jsxs("button",{onClick:()=>be(F.sheets,F.fileName),className:"text-xs flex items-center gap-1 text-slate-600 hover:text-emerald-600 font-medium px-3 py-1.5 rounded-lg border border-slate-200 hover:border-emerald-200 hover:bg-emerald-50 transition-all",title:"å¯¼å‡ºæ‰€æœ‰å·¥ä½œè¡¨",children:[e.jsx(ps,{className:"w-3.5 h-3.5"})," å¯¼å‡ºæ–‡ä»¶ ",Object.keys(F.sheets).length>1&&`(${Object.keys(F.sheets).length}ä¸ªå·¥ä½œè¡¨)`]})]})]}),e.jsxs("div",{className:"flex-1 overflow-auto w-full",children:[e.jsxs("table",{className:"w-full text-left text-sm border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-12 p-2 bg-slate-50 border-b border-r border-slate-200 text-center text-slate-400 text-xs font-mono sticky top-0 z-10",children:"#"}),z.length>0&&Object.keys(z[0]).map(u=>e.jsx("th",{className:"p-2 border-b border-r border-slate-100 bg-slate-50 sticky top-0 font-semibold text-slate-600 whitespace-nowrap min-w-[100px] z-10",children:u},u))]})}),e.jsx("tbody",{children:z.slice(0,200).map((u,C)=>e.jsxs("tr",{className:"hover:bg-blue-50/30 border-b border-slate-50 last:border-0 group",children:[e.jsx("td",{className:"p-2 bg-slate-50 border-r border-slate-100 text-center text-slate-400 text-xs font-mono group-hover:bg-blue-50/30",children:C+1}),Object.entries(u).map(([R,A],E)=>e.jsx("td",{style:m(C,R),className:g(C,R),onClick:()=>y(C,R),children:String(A)},E))]},C))})]}),z.length===0&&e.jsx("div",{className:"p-10 text-center text-slate-400",children:"æ­¤è¡¨æ— æ•°æ®"}),z.length>200&&e.jsxs("div",{className:"p-2 text-center text-xs text-slate-400 bg-slate-50 border-t border-slate-100",children:["é¢„è§ˆå‰ 200 è¡Œ (å…± ",z.length," è¡Œ)"]})]})]})}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-slate-300",children:[e.jsx(fs,{className:"w-16 h-16 mb-4 opacity-20"}),e.jsx("p",{className:"font-medium",children:"é€‰æ‹©å·¦ä¾§æ–‡ä»¶ä»¥é¢„è§ˆæ•°æ®"})]})})]})]})};export{Ms as SmartExcel,Ms as default};
