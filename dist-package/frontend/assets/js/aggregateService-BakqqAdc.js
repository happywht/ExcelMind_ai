function h(s,u){return u.groupBy&&u.groupBy.length>0?g(s,u):[o(s,u.rules)]}function g(s,u){const n=new Map;s.forEach(e=>{const r=u.groupBy.map(t=>String(e[t]||"")).join("|||");n.has(r)||n.set(r,[]),n.get(r).push(e)});const c=[];return n.forEach((e,r)=>{const t=r.split("|||"),a=o(e,u.rules);u.groupBy.forEach((l,i)=>{a[l]=t[i]}),c.push(a)}),c}function o(s,u){const n={};return u.forEach(c=>{const{field:e,operation:r,alias:t,delimiter:a}=c,l=t||`${r}_${e}`;n[l]=m(s,e,r,a)}),n}function m(s,u,n,c){if(s.length===0)return p(n);const e=s.map(r=>r[u]).filter(r=>r!=null);switch(n){case"sum":return e.reduce((t,a)=>t+Number(a||0),0);case"avg":if(e.length===0)return 0;const r=e.reduce((t,a)=>t+Number(a||0),0);return Number((r/e.length).toFixed(2));case"count":return e.length;case"max":return Math.max(...e.map(t=>Number(t||0)));case"min":return Math.min(...e.map(t=>Number(t||0)));case"first":return e[0];case"last":return e[e.length-1];case"join":return e.join(c||", ");default:throw new Error(`不支持的聚合操作: ${n}`)}}function p(s){switch(s){case"sum":case"avg":case"max":case"min":return 0;case"count":return 0;case"first":case"last":case"join":return"";default:return null}}export{h as executeAggregate};
