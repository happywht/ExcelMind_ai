import{r as g,j as e,M as L}from"./react-vendor-GaDxkzs9.js";import{c as I}from"./aiProxyService-DlcChlVb.js";import{read as U,utils as V}from"./xlsx-vendor-CkFp8p6R.js";import{m as G}from"./docx-vendor-Bfp-vY9X.js";import{p as H}from"./pdf-vendor-7J3DIG-7.js";import{u as X,l as $}from"./index-BMR0u2QP.js";import{B as E,K as _,ah as T,ai as Y,x as q,aj as J,O as F,r as Q}from"./icons-vendor-YN3v5u9K.js";import"./vendor-VUkWwLEC.js";import"./ui-utils-vendor-BNe0Xlio.js";const Z=o=>{let a=`DOCUMENT: ${o.fileName}
`;return a+=`TYPE: Excel Spreadsheet
`,a+=`SHEETS: ${Object.keys(o.sheets).join(", ")}

`,Object.entries(o.sheets).forEach(([i,f])=>{if(a+=`--- SHEET: ${i} ---
`,o.metadata&&o.metadata[i]){const d=o.metadata[i];a+=`Dimemsions: ${d.rowCount} rows x ${d.columnCount} columns
`}else a+=`Row Count: ${f.length}
`;if(f.length===0){a+=`(Empty Sheet)

`;return}const c=Object.keys(f[0]);a+=`Columns: ${c.join(", ")}
`,a+=`Column Types:
`,c.forEach(d=>{const n=f[0][d];a+=`  - ${d}: ${typeof n} (e.g., "${String(n).substring(0,50)}")
`}),a+=`
Sample Data (First 5 Rows):
`,a+=`| ${c.join(" | ")} |
`,a+=`| ${c.map(()=>"---").join(" | ")} |
`,f.slice(0,5).forEach(d=>{const n=c.map(v=>{const w=d[v];return w==null?"":String(w).replace(/\n/g," ").substring(0,50)}).join(" | ");a+=`| ${n} |
`}),a+=`
`}),a},ee=(o,a)=>{if(o.length===0)return"No active Excel files in workspace.";let i=`=== CURRENT WORKSPACE EXCEL DATA ===

`;return[...o].sort((c,d)=>c.id===a?-1:d.id===a?1:0).forEach(c=>{i+=Z(c),i+=`
=====================================

`}),i},S=H;S.GlobalWorkerOptions&&(S.GlobalWorkerOptions.workerSrc="https://esm.sh/pdfjs-dist@3.11.174/build/pdf.worker.min.js");const xe=()=>{const[o,a]=g.useState([{role:"model",text:"你好！我是您的财务与审计助手。您可以在右侧上传知识库文档，或者连接当前工作区的 Excel 数据进行分析。",timestamp:Date.now()}]),[i,f]=g.useState(""),[c,d]=g.useState(!1),[n,v]=g.useState([]),[w,B]=g.useState(!0),C=g.useRef(null),{filesData:u,activeFileId:D}=X(),[N,R]=g.useState(!1);g.useEffect(()=>{u.length>0},[u.length]);const K=()=>{var t;(t=C.current)==null||t.scrollIntoView({behavior:"smooth"})};g.useEffect(()=>{K()},[o]);const k=async()=>{if(!i.trim())return;const t={role:"user",text:i,timestamp:Date.now()};a(r=>[...r,t]),f(""),d(!0);let s=n.map(r=>`--- 知识库文件: ${r.name} (${r.type}) ---
${r.content}`).join(`

`);if(N&&u.length>0){const r=ee(u,D);s=`${r}

${s}`,$.debug("Injected Excel Context length:",r.length)}const b={role:"model",text:await I(t.text,o.map(r=>({role:r.role,text:r.text})),s),timestamp:Date.now()};a(r=>[...r,b]),d(!1)},M=async t=>{var r;const s=(r=t.name.split(".").pop())==null?void 0:r.toLowerCase();let m="",b="text";try{if(["xlsx","xls","csv"].includes(s||"")){b="excel";const h=await t.arrayBuffer(),l=U(h,{type:"array"});let x="";l.SheetNames.forEach(p=>{const j=l.Sheets[p],y=V.sheet_to_csv(j);y.trim()&&(x+=`
[Sheet: ${p}]
${y}
`)}),m=x}else if(s==="docx"){b="word";const h=await t.arrayBuffer(),l=await G.extractRawText({arrayBuffer:h});m=l.value,l.messages.length>0&&$.warn("Mammoth messages:",l.messages)}else if(s==="pdf"){b="pdf";const h=await t.arrayBuffer(),x=await S.getDocument({data:h}).promise;let p="";for(let j=1;j<=x.numPages;j++){const W=(await(await x.getPage(j)).getTextContent()).items.map(A=>A.str).join(" ");p+=`
[Page ${j}]
${W}
`}m=p}else m=await t.text();return{content:m.trim(),type:b}}catch(h){throw $.error("Failed to parse file",h),new Error(`解析文件失败: ${t.name}`)}},O=async t=>{const s=t.target.files;if(!s)return;const m=n.length+s.length;if(m>5){alert(`最多只能上传5个文件。当前有${n.length}个文件，选择${s.length}个文件，总数${m}个文件超过限制。`);return}const b=10*1024*1024;for(let l=0;l<s.length;l++)if(s[l].size>b){alert(`文件 ${s[l].name} 大小超过10MB限制。`);return}const r=new Set(n.map(l=>l.name)),h=[];for(let l=0;l<s.length;l++){const x=s[l];if(r.has(x.name)){alert(`文件 "${x.name}" 已经上传过了。请删除后重新上传或重命名文件。`);continue}try{const{content:p,type:j}=await M(x);p&&h.push({id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),name:x.name,content:p,type:j,size:x.size,uploadTime:new Date})}catch(p){alert(`处理文件 "${x.name}" 时出错: ${p.message}`)}}h.length>0&&v(l=>[...l,...h])},z=t=>{v(s=>s.filter(m=>m.id!==t))},P=()=>{v([])};return e.jsxs("div",{className:"h-full flex bg-white",children:[e.jsxs("div",{className:"flex-1 flex flex-col relative",children:[e.jsxs("div",{className:"p-4 border-b border-slate-100 flex justify-between items-center bg-white z-10",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h2",{className:"text-lg font-bold text-slate-800 flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5 text-emerald-600"}),"审计助手"]}),e.jsxs("div",{className:`flex items-center gap-2 px-3 py-1.5 rounded-full border transition-all cursor-pointer ${N&&u.length>0?"bg-emerald-50 border-emerald-200 text-emerald-700":"bg-slate-50 border-slate-200 text-slate-500"}`,onClick:()=>{if(u.length===0){alert("请先在“数据工坊”或右上角添加 Excel 文件");return}R(!N)},children:[e.jsx(_,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-xs font-medium",children:u.length>0?`当前工作区 (${u.length})`:"未连接数据"}),e.jsx("div",{className:`w-8 h-4 rounded-full p-0.5 transition-colors ${N&&u.length>0?"bg-emerald-500":"bg-slate-300"}`,children:e.jsx("div",{className:`w-3 h-3 bg-white rounded-full shadow-sm transition-transform ${N&&u.length>0?"translate-x-4":"translate-x-0"}`})})]})]}),e.jsx("button",{onClick:()=>B(!w),className:`p-2 rounded-lg transition-colors ${w?"bg-emerald-50 text-emerald-600":"text-slate-400 hover:bg-slate-50"}`,children:e.jsx(T,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50/50",children:[o.map((t,s)=>e.jsxs("div",{className:`flex gap-3 ${t.role==="user"?"flex-row-reverse":"flex-row"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${t.role==="user"?"bg-slate-200":"bg-emerald-600"}`,children:t.role==="user"?e.jsx(Y,{className:"w-5 h-5 text-slate-600"}):e.jsx(E,{className:"w-5 h-5 text-white"})}),e.jsx("div",{className:`max-w-[80%] p-4 rounded-2xl text-sm leading-relaxed shadow-sm ${t.role==="user"?"bg-slate-800 text-white rounded-tr-none":"bg-white border border-slate-100 text-slate-700 rounded-tl-none"}`,children:e.jsx(L,{children:t.text})})]},s)),c&&e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center",children:e.jsx(E,{className:"w-5 h-5 text-white"})}),e.jsx("div",{className:"bg-white p-4 rounded-2xl rounded-tl-none border border-slate-100 shadow-sm",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-emerald-400 rounded-full animate-bounce"}),e.jsx("span",{className:"w-2 h-2 bg-emerald-400 rounded-full animate-bounce delay-75"}),e.jsx("span",{className:"w-2 h-2 bg-emerald-400 rounded-full animate-bounce delay-150"})]})})]}),e.jsx("div",{ref:C})]}),e.jsx("div",{className:"p-4 bg-white border-t border-slate-100",children:e.jsxs("div",{className:"flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-slate-200 focus-within:ring-2 focus-within:ring-emerald-100 focus-within:border-emerald-400 transition-all",children:[e.jsx("input",{type:"text",value:i,onChange:t=>f(t.target.value),onKeyDown:t=>t.key==="Enter"&&k(),placeholder:N?"已连接工作区，可以询问表格数据相关的问题...":"询问关于审计规范或财务数据的问题...",className:"flex-1 bg-transparent border-none outline-none px-2 text-slate-700 placeholder:text-slate-400"}),e.jsx("button",{onClick:k,disabled:c||!i,className:"p-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(q,{className:"w-4 h-4"})})]})})]}),w&&e.jsxs("div",{className:"w-80 border-l border-slate-200 bg-white flex flex-col shadow-xl z-20 transition-all",children:[e.jsxs("div",{className:"p-4 border-b border-slate-100 bg-slate-50",children:[e.jsxs("h3",{className:"font-semibold text-slate-700 flex items-center gap-2",children:[e.jsx(T,{className:"w-4 h-4"})," 知识库"]}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"支持上传审计准则、Word、PDF 或 Excel 文件作为上下文。"})]}),e.jsxs("div",{className:"p-4 space-y-4 flex-1 overflow-y-auto",children:[e.jsxs("label",{className:"block w-full border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 hover:border-emerald-400 transition-colors group",children:[e.jsx("input",{type:"file",accept:".txt,.md,.json,.xml,.csv,.xlsx,.xls,.docx,.pdf",multiple:!0,onChange:O,className:"hidden"}),e.jsx(J,{className:"w-8 h-8 text-slate-300 mx-auto mb-2 group-hover:text-emerald-500 transition-colors"}),e.jsx("span",{className:"text-sm text-slate-500 font-medium",children:"添加文件"}),e.jsx("p",{className:"text-[10px] text-slate-400 mt-1",children:"支持 Excel, PDF, Word, CSV, TXT (最多5个)"})]}),n.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm font-semibold text-slate-700",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(F,{className:"w-4 h-4"})," 知识库文件 (",n.length,"/5)"]}),n.length>1&&e.jsx("button",{onClick:P,className:"text-xs text-red-500 hover:text-red-700 font-normal",children:"清空全部"})]}),n.map(t=>e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-slate-200 relative group hover:border-emerald-300 transition-colors",children:[e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:()=>z(t.id),className:"p-1 hover:bg-red-100 text-slate-400 hover:text-red-500 rounded",title:"删除文件",children:e.jsx(Q,{className:"w-3 h-3"})})}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-emerald-50 text-emerald-600",children:e.jsx(F,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"text-sm font-medium text-slate-800 truncate",title:t.name,children:t.name}),e.jsxs("div",{className:"flex items-center gap-4 mt-1",children:[e.jsx("span",{className:"text-xs text-slate-500 capitalize",children:t.type}),e.jsxs("span",{className:"text-xs text-slate-400",children:[(t.size/1024).toFixed(1),"KB"]}),e.jsx("span",{className:"text-xs text-slate-400",children:new Date(t.uploadTime).toLocaleTimeString()})]}),e.jsxs("div",{className:"mt-2 text-xs text-slate-600 line-clamp-3 font-mono bg-slate-50 p-2 rounded border border-slate-100 overflow-hidden",children:[t.content.substring(0,150),"..."]})]})]})]},t.id)),e.jsxs("div",{className:"text-xs text-slate-500 text-right pt-2 border-t border-slate-100",children:["总计 ",n.reduce((t,s)=>t+s.content.length,0).toLocaleString()," 字符"]})]})]})]})]})};export{xe as default};
