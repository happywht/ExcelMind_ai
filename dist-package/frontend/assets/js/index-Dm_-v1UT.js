const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./docx-vendor-Bfp-vY9X.js","./react-vendor-GaDxkzs9.js","./vendor-VUkWwLEC.js"])))=>i.map(i=>d[i]);
import{l as Ne,_ as He,u as Zt}from"./index-BMR0u2QP.js";import{r as N,j as t,b as Be}from"./react-vendor-GaDxkzs9.js";import{r as es}from"./excelService-5ufxowtn.js";import{m as ts,P as ss,I as rs,D as as}from"./docx-vendor-Bfp-vY9X.js";import{A as ns,J as is}from"./vendor-VUkWwLEC.js";import{K as _t,g as ct,M as $t,N as Ft,O as te,d as Ve,J as gt,I as vt,P as Pe,r as De,a as Ze,Q as xt,U as _e,W as st,h as Ce,Z as ft,C as ls,V as os,s as Te,Y as qe,c as nt,D as Le,_ as cs,m as dt,e as Dt,E as it,$ as Ht,a0 as Wt,a1 as ds,u as us,a2 as rt,z as qt,a3 as Qt,a4 as ms,X as Ge,y as et,A as jt,l as ps,a5 as hs,T as Ot,a6 as gs,w as xs,a7 as fs,a8 as ys,i as bs,a9 as Ns,aa as vs,ab as js,ac as ws,ad as Ut,t as Es,ae as Ss,G as Pt,af as Cs}from"./icons-vendor-YN3v5u9K.js";import"./ui-utils-vendor-BNe0Xlio.js";import"./xlsx-vendor-CkFp8p6R.js";const Ts=/\{\{([^}]+)\}\}/g;function _s(u){const e=u.match(Ts);return e?[...new Set(e)]:[]}async function Os(u){try{const e=await u.arrayBuffer(),r=(await ts.convertToHtml({arrayBuffer:e},{styleMap:["p[style-name='Title'] => h1.doc-title:fresh","p[style-name='Subtitle'] => h2.doc-subtitle:fresh","p[style-name='Heading 1'] => h1:fresh","p[style-name='Heading 2'] => h2:fresh","p[style-name='Heading 3'] => h3:fresh","p[style-name='Heading 4'] => h4:fresh","p[style-name='Heading 5'] => h5:fresh","p[style-name='Heading 6'] => h6:fresh","comment-reference => sup"]})).value,a=r.replace(/<[^>]+>/g," "),i=_s(a),n=a.includes("{{#if")||a.includes("{{/if}}"),l=a.includes("{{#each")||a.includes("{{/each}}");return{placeholders:i,textContent:a,htmlPreview:r,hasConditionalBlocks:n,hasLoops:l}}catch(e){throw new Error(`模板解析失败: ${e instanceof Error?e.message:String(e)}`)}}async function Rt(u){const e=await u.arrayBuffer(),s=await Os(u);return{id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),file:u,name:u.name,size:u.size,arrayBuffer:e,htmlPreview:s.htmlPreview,placeholders:s.placeholders}}function Rs(u){try{let e=u.trim();const s=/```(?:json)?\s*([\s\S]*?)\s*```/i,r=e.match(s);r&&(e=r[1]);const a=e.indexOf("{"),i=e.lastIndexOf("}");if(a!==-1&&i!==-1&&i>a)e=e.substring(a,i+1);else if(a===-1){const n=e.indexOf("["),l=e.lastIndexOf("]");n!==-1&&l!==-1&&l>n&&(e=e.substring(n,l+1))}return e=e.replace(/\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\//g,""),e=e.replace(/,(\s*[}\]])/g,"$1"),JSON.parse(e)}catch(e){try{const s=u.replace(/([{,]\s*)([a-zA-Z0-9_]+?)\s*:/g,'$1"$2":');return JSON.parse(s)}catch{throw new Error(`Failed to parse JSON: ${e instanceof Error?e.message:String(e)}`)}}}var wt={};const Ms=typeof process<"u"&&wt!==void 0;let yt=null;const Bt=()=>{if(!yt){const u=Ms?wt.ZHIPU_API_KEY||wt.API_KEY||"":"ccd69d4c776d4e2696a6ef026159fb9c.YUPVkBmrRXu1xoZG";if(!u)throw new Error(`AI服务API密钥未配置。请检查环境变量：
- Node.js环境: ZHIPU_API_KEY 或 API_KEY
- 浏览器环境: VITE_ANTHROPIC_API_KEY`);yt=new ns({apiKey:u,baseURL:"https://open.bigmodel.cn/api/anthropic",dangerouslyAllowBrowser:!0})}return yt};async function Is(u){var i,n;const{allSheetsInfo:e,primarySheet:s,templatePlaceholders:r,userInstruction:a}=u;try{const l=Ls({allSheetsInfo:e,primarySheet:s,templatePlaceholders:r,userInstruction:a}),o=await Bt().messages.create({model:"glm-4.7",max_tokens:8192,messages:[{role:"user",content:l}]}),c=((i=o.content[0])==null?void 0:i.type)==="text"?o.content[0].text:"";if(!c)throw new Error("AI未返回响应");let d=Vt(c,e);const h=`
      我刚刚生成了一个文档映射方案，请评估其是否符合用户指令。
      
      【用户指令】
      "${a}"
      
      【生成的方案 (JSON)】
      ${JSON.stringify(d,null,2)}
      
      【评估要求】
      1. 方案是否覆盖了用户的核心意图（如筛选条件、数据分组、多Sheet关联）？
      2. 关键占位符是否已映射？
      
      如果方案完美，请直接返回 "PASS"。
      如果存在严重问题，请返回修复后的完整JSON（格式同上）。不要解释，只返回修复后的JSON。
    `;try{const p=await Bt().messages.create({model:"glm-4.7",max_tokens:8192,messages:[{role:"user",content:h}]}),x=((n=p.content[0])==null?void 0:n.type)==="text"?p.content[0].text.trim():"";if(x&&x!=="PASS"&&x.startsWith("{")){Ne.info("AI Self-Correction Triggered: Updating Mapping Scheme");const y=Vt(x,e);y&&y.mappings.length>0&&(d=y)}}catch(p){Ne.warn("Self-Correction failed, using original result:",p)}const{aiProcessingService:m}=await He(async()=>{const{aiProcessingService:p}=await Promise.resolve().then(()=>Us);return{aiProcessingService:p}},void 0,import.meta.url),{FormatterService:f}=await He(async()=>{const{FormatterService:p}=await Promise.resolve().then(()=>Nr);return{FormatterService:p}},void 0,import.meta.url);if(d.primarySheet){const p=e.find(x=>x.sheetName===d.primarySheet);p&&p.sampleData&&await Promise.all(d.mappings.map(async x=>{if(x.transform||p.headers.indexOf(x.excelColumn)===-1)return;const E=p.sampleData.map(F=>F[x.excelColumn]),R=await m.analyzeColumnContent(x.excelColumn,E);if(R.suggestedFormatter){const D=f.getFormatters().find(k=>k.id===R.suggestedFormatter);D&&(x.transform=D.generateCode(),Ne.info(`[Auto-Format] Applied ${D.label} to column ${x.excelColumn}`))}}))}return d}catch(l){throw Ne.error("多Sheet映射生成失败:",l),new Error(`AI映射生成失败: ${l instanceof Error?l.message:String(l)}`)}}function Ls(u){const{allSheetsInfo:e,primarySheet:s,templatePlaceholders:r,userInstruction:a}=u,i=e.map(n=>`
工作表名称: ${n.sheetName}
- 数据行数: ${n.rowCount} (共${n.rowCount}行)
- 字段列表: ${n.headers.join(", ")}
- 样本数据(前5行):
${JSON.stringify(n.sampleData.slice(0,5),null,2)}
`).join(`
`);return`
你是专业的智能文档映射专家。你的任务是将Excel多Sheet数据智能映射到Word模板的占位符。

【Excel文件结构 - 多工作表】
文件包含 ${e.length} 个工作表:
${i}

${s?`【用户指定主工作表】${s}`:""}

【Word模板占位符】
检测到 ${r.length} 个占位符:
${r.map(n=>`  - ${n}`).join(`
`)}

【用户指令】
"${a}"

【任务要求】
1. **选择主工作表**: 如果用户未指定，智能选择最合适的主工作表（通常是包含主要数据的工作表）
2. **字段映射**: 将主工作表的字段映射到模板占位符（考虑语义相似度）
3. **跨Sheet关联**: 识别需要从其他工作表查找的字段，建立关联关系
4. **数据筛选**: 根据用户指令确定是否需要筛选数据
5. **生成方案**: 生成完整可执行的映射方案

【跨Sheet映射场景】
- 当模板需要的字段在主Sheet中不存在时，查找其他Sheet
- 识别关联字段（如"部门ID"、"员工ID"等）
- 确定关系类型（oneToOne: 一对一, manyToOne: 多对一）

【输出格式要求】
必须输出纯净的JSON格式，不要包含任何Markdown标记：
{
  "explanation": "映射思路的详细说明",
  "primarySheet": "选择的主工作表名称",
  "reasoning": "选择该主工作表的原因",
  "filterCondition": "筛选条件的JavaScript代码或null",
  "mappings": [
    {
      "placeholder": "{{占位符}}",
      "excelColumn": "主Sheet中的列名",
      "transform": "数据转换代码(可选)"
    }
  ],
  "crossSheetMappings": [
    {
      "placeholder": "{{跨Sheet占位符}}",
      "sourceSheet": "来源工作表名称",
      "sourceColumn": "来源列名",
      "lookupKey": "关联字段（在主Sheet和来源Sheet中都存在）",
      "relationshipType": "oneToOne或manyToOne",
      "transform": "数据转换代码(可选)"
    }
  ],
  "unmappedPlaceholders": ["未能映射的占位符"],
  "loopMappings": [
    {
      "id": "自动生成的ID",
      "loopPlaceholder": "循环占位符(如Projects)",
      "type": "group_by", // 或 'lookup'
      "groupByColumn": "分组字段(仅group_by)",
      "mappings": [
        // 循环内部的字段映射
        {"placeholder": "{{ItemName}}", "excelColumn": "ItemName"}
      ]
    }
  ],
  "virtualColumns": [
    {
      "id": "vcol_1",
      "name": "显式名称",
      "type": "const",
      "value": "静态值"
    }
  ],
  "confidence": 0.95
}

【高级模式说明】
1. **列表循环 (Loop)**:
   - 如果模板包含 {#Projects}...{/Projects} 结构，请生成 loopMappings。
   - type: "group_by" (单表分组) 或 "lookup" (跨表关联)。

2. **分组融合 (Group Merge / Flattening)**:
   - 如果模板包含 {{Name1}}, {{Name2}} 这种带索引的占位符，说明用户希望将多行数据融合到同一页。
   - 处理方式：
     1. 创建一个 loopMappings (type="group_by")，按主键(如InvoiceNo)分组。
     2. 在 mappings (主层级) 中，将 {{Name1}} 映射到 Name_1 (系统会自动拍平分组数据)。
     3. 告诉用户：系统会自动生成 Column_Index 格式的变量。

3. **虚拟列 (Virtual Column)**:
   - 用于生成静态文本 (type="const") 或 简单变量。

【多Sheet映射示例】

示例1 - 简单单Sheet映射:
用户指令: "把员工信息填入模板"
工作表:
  - 员工表: {姓名, 部门, 职位, 工资}
  - 部门表: {部门ID, 部门名称, 负责人}
占位符: [{{姓名}}, {{部门}}, {{职位}}]
输出:
{
  "explanation": "员工表包含所需的主要数据，直接从员工表映射字段",
  "primarySheet": "员工表",
  "reasoning": "员工表包含所有需要的字段（姓名、部门、职位），无需跨Sheet查找",
  "filterCondition": null,
  "mappings": [
    {"placeholder": "{{姓名}}", "excelColumn": "姓名"},
    {"placeholder": "{{部门}}", "excelColumn": "部门"},
    {"placeholder": "{{职位}}", "excelColumn": "职位"}
  ],
  "crossSheetMappings": [],
  "unmappedPlaceholders": [],
  "confidence": 1.0
}

示例2 - 跨Sheet查找关联数据:
用户指令: "生成员工工资单，包含部门负责人信息"
工作表:
  - 员工表: {员工ID, 姓名, 部门ID, 工资}
  - 部门表: {部门ID, 部门名称, 负责人}
占位符: [{{姓名}}, {{工资}}, {{部门负责人}}]
输出:
{
  "explanation": "主数据来自员工表，部门负责人信息需要通过部门ID关联到部门表",
  "primarySheet": "员工表",
  "reasoning": "员工表是主要数据源，包含员工ID、姓名、工资等核心信息",
  "filterCondition": null,
  "mappings": [
    {"placeholder": "{{姓名}}", "excelColumn": "姓名"},
    {"placeholder": "{{工资}}", "excelColumn": "工资"}
  ],
  "crossSheetMappings": [
    {
      "placeholder": "{{部门负责人}}",
      "sourceSheet": "部门表",
      "sourceColumn": "负责人",
      "lookupKey": "部门ID",
      "relationshipType": "manyToOne",
      "transform": null
    }
  ],
  "unmappedPlaceholders": [],
  "confidence": 0.95
}

示例3 - 筛选+跨Sheet映射:
用户指令: "生成销售部门所有员工的工资单"
工作表:
  - 员工表: {员工ID, 姓名, 部门ID, 工资}
  - 部门表: {部门ID, 部门名称}
占位符: [{{姓名}}, {{工资}}, {{部门名称}}]
输出:
{
  "explanation": "筛选销售部门的员工，从员工表获取基础信息，通过部门ID关联部门表获取部门名称",
  "primarySheet": "员工表",
  "reasoning": "员工表包含主要数据和筛选字段（部门ID）",
  "filterCondition": "row['部门ID'] === '销售部' || row['部门名称'] === '销售部'",
  "mappings": [
    {"placeholder": "{{姓名}}", "excelColumn": "姓名"},
    {"placeholder": "{{工资}}", "excelColumn": "工资"}
  ],
  "crossSheetMappings": [
    {
      "placeholder": "{{部门名称}}",
      "sourceSheet": "部门表",
      "sourceColumn": "部门名称",
      "lookupKey": "部门ID",
      "relationshipType": "manyToOne"
    }
  ],
  "unmappedPlaceholders": [],
  "confidence": 0.9
}

示例4 - 分组融合 (Flattening):
用户指令: "将同一Session的多个演讲者填入模板 (Name1, Name2)"
Excel: {SessionID, SpeakerName, Topic}
模板: [{{SessionID}}, {{SpeakerName1}}, {{SpeakerName2}}]
输出:
{
  "explanation": "检测到带索引的占位符，使用分组融合模式。按SessionID分组，并映射扁平化后的变量。",
  "primarySheet": "Sheet1",
  "mappings": [
    {"placeholder": "{{SessionID}}", "excelColumn": "SessionID"},
    {"placeholder": "{{SpeakerName1}}", "excelColumn": "SpeakerName_1"},
    {"placeholder": "{{SpeakerName2}}", "excelColumn": "SpeakerName_2"}
  ],
  "loopMappings": [
    {
      "id": "loop_session",
      "loopPlaceholder": "Matches", // 隐式循环
      "type": "group_by",
      "groupByColumn": "SessionID",
      "mappings": []
    }
  ],
  "unmappedPlaceholders": [],
  "confidence": 0.95
}

现在请处理上述用户任务，输出JSON格式。
`}function Vt(u,e){var s;try{const r=Rs(u);if(!r.explanation||!r.primarySheet)throw new Error("AI响应缺少必需字段");return e.some(i=>i.sheetName===r.primarySheet)||(Ne.warn(`AI选择的主Sheet "${r.primarySheet}" 不存在，使用第一个Sheet`),r.primarySheet=((s=e[0])==null?void 0:s.sheetName)||"Sheet1"),Array.isArray(r.mappings)||(r.mappings=[]),r.crossSheetMappings&&!Array.isArray(r.crossSheetMappings)&&(r.crossSheetMappings=[]),Array.isArray(r.unmappedPlaceholders)||(r.unmappedPlaceholders=[]),r.crossSheetMappings&&r.crossSheetMappings.length>0&&(r.crossSheetMappings=r.crossSheetMappings.filter(i=>e.some(l=>l.sheetName===i.sourceSheet)?!0:(Ne.warn(`跨Sheet映射的来源Sheet "${i.sourceSheet}" 不存在，已忽略`),!1))),r.allSheetsInfo=e,r}catch(r){return Ne.error("多Sheet映射JSON解析失败，使用降级策略:",r),ks(u,e)}}function ks(u,e){var r;const s={explanation:`AI解析失败，使用降级策略。原始响应：${u.substring(0,200)}...`,primarySheet:((r=e==null?void 0:e[0])==null?void 0:r.sheetName)||"Sheet1",filterCondition:null,mappings:[],unmappedPlaceholders:[],crossSheetMappings:[]};return e&&(s.allSheetsInfo=e),s}class be extends Error{constructor(e,s,r){super(e),this.name="DocxGenerationError",this.code=s,this.details=r,this.timestamp=Date.now(),Object.setPrototypeOf(this,be.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,be)}toJSON(){return{name:this.name,message:this.message,code:this.code,details:this.details,timestamp:this.timestamp,stack:this.stack}}static fromError(e,s="UNKNOWN_ERROR"){if(e instanceof be)return e;if(!e.message.includes("template error")){if(!e.message.includes("Duplicate variable")){if(!e.message.includes("Undefined variable")){if(!e.message.includes("inflate")){if(!e.message.includes("deflate")){if(e.message.includes("Unclosed loop")){const r=e.message.match(/tag "([^"]+)"/),a=r?r[1]:"unknown";e.message=`模板语法错误：发现未闭合的循环标签 "{#${a}"。请检查Word模板，确保每个 "{#${a}}" 都有对应的 "{/${a}}"。`}else if(e.message.includes("Closing tag does not match"))e.message="模板语法错误：循环闭合标签不匹配。请检查嵌套结构。";else if(e.properties&&e.properties.errors instanceof Array){const r=e.properties.errors;if(r.length>0){const a=r[0],i=be.fromError(a,s);e.message=`${i.message} (以及其他 ${r.length-1} 个错误)`,i.code}}}}}}}}}async function As(u){performance.now();const{templateBuffer:e,data:s,cmdDelimiter:r={start:"{{",end:"}}"},imageOptions:a,parserOptions:i={},dryRun:n=!1}=u;try{let l;try{l=new ss(e)}catch(f){throw be.fromError(f,"DECOMPRESSION_FAILED")}const o=[];if(a){const f={getImage:a.getImage,getSize:a.getSize||(()=>[100,100]),centered:a.centered??!1};o.push(new rs(f))}const c={paragraphLoop:!0,linebreaks:!0,nullGetter:()=>"",...i},d=new as(l,{modules:o,paragraphLoop:c.paragraphLoop,linebreaks:c.linebreaks,nullGetter:c.nullGetter,delimiters:{start:r.start,end:r.end}});try{d.render(s)}catch(f){throw be.fromError(f,"RENDER_FAILED")}if(n)return new Blob([],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});let h;try{h=d.getZip().generate({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}})}catch(f){throw be.fromError(f,"COMPRESSION_FAILED")}return h}catch(l){throw l instanceof be?l:be.fromError(l instanceof Error?l:new Error(String(l)),"UNKNOWN_ERROR")}}function $s(u){const e=["name","名称","title","标题","subject","主题","productName","产品名称","companyName","公司名称","customerName","客户名称","employeeName","员工姓名","studentName","学生姓名"];for(const s of e)if(u[s]&&typeof u[s]=="string"&&u[s].trim())return s;return null}function Fs(u){return u.replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"_").replace(/[\x00-\x1f\x80-\x9f]/g,"").replace(/^\.+/,"").substring(0,100)}const Mt=class Mt{static async generateDocument(e){const{templateBuffer:s,data:r,options:a={}}=e,i=this.applyEnhancedOptions(r,a);let n;return a.images&&Object.keys(a.images).length>0&&(n=this.createImageOptions(a.images)),await As({templateBuffer:s,data:i,imageOptions:n,parserOptions:{paragraphLoop:!0,linebreaks:!0}})}static async batchGenerate(e){const{templateBuffer:s,dataList:r,baseFileName:a="document",options:i={}}=e,{concurrency:n=3,batchSize:l=10,onProgress:o,continueOnError:c=!0,retryCount:d=2}=i,h=[];let m=0,f=0;for(let p=0;p<r.length;p+=l){const y=r.slice(p,p+l).map(async(R,F)=>{const D=p+F;let k=0;for(;k<=d;)try{const P=await this.generateDocument({templateBuffer:s,data:R});let ue=`${a}_${D+1}.docx`;const oe=$s(R);return oe&&R[oe]&&(ue=`${Fs(String(R[oe]))}.docx`),m++,o==null||o(m+f,r.length),{blob:P,fileName:ue,dataIndex:D,recordData:R}}catch(P){if(k++,k>d){if(f++,Ne.error(`生成第${D+1}个文档失败:`,P),o==null||o(m+f,r.length),!c)throw P;return null}await new Promise(ue=>setTimeout(ue,1e3*k))}return null}),E=[];for(let R=0;R<y.length;R+=n){const F=y.slice(R,R+n),D=await Promise.all(F);E.push(...D)}for(const R of E)R&&h.push(R)}return h}static applyEnhancedOptions(e,s){const r={...e};return s.conditions&&Object.entries(s.conditions).forEach(([a,i])=>{r[a]=i}),s.loops&&Object.entries(s.loops).forEach(([a,i])=>{r[a]=i}),s.images&&Object.entries(s.images).forEach(([a,i])=>{r[a]=i}),r}static createImageOptions(e){return{getImage:async(s,r)=>{try{if(s.startsWith("data:")){const a=s.split(",")[1],i=atob(a),n=new Uint8Array(i.length);for(let l=0;l<i.length;l++)n[l]=i.charCodeAt(l);return n}if(s.startsWith("http")){const n=await(await(await fetch(s)).blob()).arrayBuffer();return new Uint8Array(n)}if(typeof s=="string"){const a=atob(s),i=new Uint8Array(a.length);for(let n=0;n<a.length;n++)i[n]=a.charCodeAt(n);return i}return new Uint8Array(0)}catch(a){throw Ne.error(`加载图片失败 [${r}]:`,a),new be(`无法加载图片: ${r}`,"IMAGE_LOAD_FAILED",{tagValue:s,tagName:r})}},getSize:async s=>{try{return s.startsWith("data:image/")?await Ds(s):[200,200]}catch{return[200,200]}}}}static clearCache(){this.cache.clear()}};Mt.cache=new Map;let lt=Mt;async function Ds(u){return new Promise((e,s)=>{const r=new Image;r.onload=()=>{e([r.width,r.height])},r.onerror=()=>{s(new Error("无法加载图片"))},r.src=u})}async function qs(u,e="documents.zip"){try{const s=new is;return u.forEach(a=>{s.file(a.fileName,a.blob)}),await s.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}})}catch(s){throw new Error(`ZIP创建失败: ${s instanceof Error?s.message:String(s)}`)}}function at(u,e){const s=URL.createObjectURL(u),r=document.createElement("a");r.href=s,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)}async function Gt(u,e="documents.zip"){const s=await qs(u,e);at(s,e)}const bt={FEW_SHOT_EXAMPLES:{MAX_EXAMPLES:20,MIN_EXAMPLES:5}};class Qs{constructor(e){this.examples=new Map,this.cache=new Map,this.feedbackHistory=new Map,this.config=this.mergeConfig(e)}addExample(e){e.id||(e.id=this.generateExampleId()),this.examples.set(e.id,e),this.invalidateCache()}addExamples(e){e.forEach(s=>this.addExample(s))}getExample(e){return this.examples.get(e)}getAllExamples(){return Array.from(this.examples.values())}getExamplesByType(e){return this.getAllExamples().filter(s=>s.queryType===e)}getExamplesByDifficulty(e){return this.getAllExamples().filter(s=>s.difficulty===e)}getExamplesByTags(e){return this.getAllExamples().filter(s=>e.some(r=>s.tags.includes(r)))}updateExample(e,s){const r=this.examples.get(e);if(!r)return!1;const a={...r,...s};return this.examples.set(e,a),this.invalidateCache(),!0}removeExample(e){const s=this.examples.delete(e);return s&&this.invalidateCache(),s}clearExamples(){this.examples.clear(),this.invalidateCache()}calculateSimilarity(e,s,r=this.config.similarity.defaultMethod){switch(r){case"cosine":return this.cosineSimilarity(e,s);case"jaccard":return this.jaccardSimilarity(e,s);case"levenshtein":return this.levenshteinSimilarity(e,s);case"semantic":return this.semanticSimilarity(e,s);case"hybrid":return this.hybridSimilarity(e,s);default:return this.cosineSimilarity(e,s)}}calculateDetailedSimilarity(e,s){const r={cosine:this.cosineSimilarity(e,s.naturalQuery),jaccard:this.jaccardSimilarity(e,s.naturalQuery),levenshtein:this.levenshteinSimilarity(e,s.naturalQuery),semantic:this.semanticSimilarity(e,s.naturalQuery)},a=this.config.similarity.weights,i=r.cosine*a.cosine+r.jaccard*a.jaccard+r.levenshtein*a.levenshtein+r.semantic*a.semantic;return{exampleId:s.id,score:i,method:"hybrid",details:r}}findRelevantExamples(e,s=[],r=this.config.retrieval.defaultTopK,a=this.config.retrieval.defaultStrategy){const i=Date.now(),n=this.buildCacheKey(e,s,r,a),l=this.cache.get(n);if(l&&this.config.retrieval.enableCache)return l.examples;let o;switch(a){case"keyword":o=this.keywordBasedRetrieval(e,s,r);break;case"type_based":o=this.typeBasedRetrieval(e,r);break;case"difficulty_based":o=this.difficultyBasedRetrieval(e,r);break;case"adaptive":o=this.adaptiveRetrieval(e,s,r);break;case"hybrid":default:o=this.hybridRetrieval(e,s,r);break}const c=Date.now()-i;return this.config.retrieval.enableCache&&this.cache.set(n,{examples:o,scores:[],metadata:{query:e,strategy:a,totalCandidates:this.examples.size,retrievedCount:o.length,retrievalTime:c}}),o}getRetrievalResult(e,s=[],r=5,a="hybrid"){const i=this.findRelevantExamples(e,s,r,a),n=i.map(l=>this.calculateDetailedSimilarity(e,l));return{examples:i,scores:n,metadata:{query:e,strategy:a,totalCandidates:this.examples.size,retrievedCount:i.length,retrievalTime:0}}}buildFewShotPrompt(e,s,r){const a=this.mergePromptConfig(r);switch(a.templateType){case"base":return this.buildBasePrompt(e,s,a);case"few_shot":return this.buildFewShotPromptInternal(e,s,a);case"cot":return this.buildCoTPrompt(e,s,a);case"hybrid":return this.buildHybridPrompt(e,s,a);default:return this.buildFewShotPromptInternal(e,s,a)}}buildBasePrompt(e,s,r){const a=[];return r.systemMessage?a.push(r.systemMessage):a.push(this.getDefaultSystemMessage()),r.customInstructions&&a.push(`
${r.customInstructions}`),a.push(`
用户查询：${e}`),a.join(`
`)}buildFewShotPromptInternal(e,s,r){const a=[];return a.push(r.systemMessage||this.getDefaultSystemMessage()),s.length>0&&(a.push(`
以下是参考示例：
`),s.forEach((i,n)=>{a.push(this.formatExample(i,n+1,r))})),r.customInstructions&&a.push(`
${r.customInstructions}`),a.push(`
现在请处理以下查询：`),a.push(`自然语言查询：${e}`),a.push(`
请输出对应的SQL查询：`),a.join(`
`)}buildCoTPrompt(e,s,r){const a=[];return a.push(r.systemMessage||this.getCoTSystemMessage()),s.length>0&&(a.push(`
以下是参考示例和推理过程：
`),s.filter(i=>i.reasoningSteps&&i.reasoningSteps.length>0).forEach((i,n)=>{a.push(this.formatCoTExample(i,n+1,r))})),a.push(`
现在请按以下步骤处理查询：`),a.push(`自然语言查询：${e}`),a.push(`
请按以下格式输出：`),a.push("1. 推理过程："),a.push("2. SQL查询："),a.join(`
`)}buildHybridPrompt(e,s,r){const a=[];if(a.push(r.systemMessage||this.getDefaultSystemMessage()),s.length>0){a.push(`
以下是参考示例：
`);const i=s.filter(l=>l.reasoningSteps&&l.reasoningSteps.length>0),n=s.filter(l=>!l.reasoningSteps||l.reasoningSteps.length===0);i.slice(0,Math.ceil(r.maxExamples/2)).forEach((l,o)=>{a.push(this.formatCoTExample(l,o+1,r))}),n.slice(0,Math.floor(r.maxExamples/2)).forEach((l,o)=>{a.push(this.formatExample(l,o+1+i.length,r))})}return a.push(`
现在请处理以下查询：`),a.push(`自然语言查询：${e}`),a.push(`
请输出：`),a.push("1. 推理过程（如果查询较复杂）"),a.push("2. SQL查询："),a.join(`
`)}recordFeedback(e,s){if(!this.config.learning.enableFeedback)return;this.feedbackHistory.has(e)||this.feedbackHistory.set(e,[]);const r=this.feedbackHistory.get(e);if(r.push(s),r.length>=this.config.learning.feedbackThreshold){const a=r.reduce((i,n)=>i+n,0)/r.length;this.updateExampleWeight(e,a)}}getStatistics(){const e=this.getAllExamples(),s={simple:0,aggregate:0,join:0,complex:0},r={beginner:0,intermediate:0,advanced:0},a={manual:0,generated:0,user:0};e.forEach(o=>{s[o.queryType]++,r[o.difficulty]++,a[o.source]++});let i=0,n=0;this.feedbackHistory.forEach(o=>{i+=o.reduce((c,d)=>c+d,0),n+=o.length});const l=n>0?i/n:0;return{totalExamples:e.length,examplesByType:s,examplesByDifficulty:r,examplesBySource:a,averageFeedbackScore:l}}cosineSimilarity(e,s){const r=this.tokenize(e),a=this.tokenize(s),i=new Set([...r,...a]),n=this.computeTF(r,i),l=this.computeTF(a,i);let o=0;i.forEach(h=>{o+=n.get(h)*l.get(h)});const c=Math.sqrt(Array.from(n.values()).reduce((h,m)=>h+m*m,0)),d=Math.sqrt(Array.from(l.values()).reduce((h,m)=>h+m*m,0));return c===0||d===0?0:o/(c*d)}jaccardSimilarity(e,s){const r=new Set(this.tokenize(e)),a=new Set(this.tokenize(s)),i=new Set([...r].filter(l=>a.has(l))),n=new Set([...r,...a]);return n.size===0?0:i.size/n.size}levenshteinSimilarity(e,s){const r=this.levenshteinDistance(e,s),a=Math.max(e.length,s.length);return a===0?1:1-r/a}levenshteinDistance(e,s){const r=e.length,a=s.length,i=Array(r+1).fill(0).map(()=>Array(a+1).fill(0));for(let n=0;n<=r;n++)i[n][0]=n;for(let n=0;n<=a;n++)i[0][n]=n;for(let n=1;n<=r;n++)for(let l=1;l<=a;l++)e[n-1]===s[l-1]?i[n][l]=i[n-1][l-1]:i[n][l]=Math.min(i[n-1][l],i[n][l-1],i[n-1][l-1])+1;return i[r][a]}semanticSimilarity(e,s){const r=this.extractKeywords(e),a=this.extractKeywords(s);if(r.length===0&&a.length===0||r.length===0||a.length===0)return 0;const i=r.filter(l=>a.includes(l)).length,n=new Set([...r,...a]).size;return i/n}hybridSimilarity(e,s){const r=this.config.similarity.weights;return this.cosineSimilarity(e,s)*r.cosine+this.jaccardSimilarity(e,s)*r.jaccard+this.levenshteinSimilarity(e,s)*r.levenshtein+this.semanticSimilarity(e,s)*r.semantic}keywordBasedRetrieval(e,s,r){const a=this.extractKeywords(e);[...a,...s];const i=this.getAllExamples().map(n=>{const l=this.extractKeywords(n.naturalQuery),o=n.fields||[],c=a.filter(f=>l.includes(f)).length,d=s.filter(f=>o.includes(f)).length,h=c/Math.max(a.length,1),m=d/Math.max(s.length,1);return{example:n,score:h*.7+m*.3}});return i.sort((n,l)=>l.score-n.score),i.slice(0,r).map(n=>n.example)}typeBasedRetrieval(e,s){const r=this.predictQueryType(e),i=this.getExamplesByType(r).map(n=>({example:n,score:this.calculateSimilarity(e,n.naturalQuery)}));return i.sort((n,l)=>l.score-n.score),i.slice(0,s).map(n=>n.example)}difficultyBasedRetrieval(e,s){const r=this.predictDifficulty(e);let a=this.getExamplesByDifficulty(r);a.length<s&&(r==="beginner"?a=[...a,...this.getExamplesByDifficulty("intermediate")]:r==="advanced"?a=[...a,...this.getExamplesByDifficulty("intermediate")]:a=[...a,...this.getExamplesByDifficulty("beginner"),...this.getExamplesByDifficulty("advanced")]);const i=a.map(n=>({example:n,score:this.calculateSimilarity(e,n.naturalQuery)}));return i.sort((n,l)=>l.score-n.score),i.slice(0,s).map(n=>n.example)}hybridRetrieval(e,s,r){const a=this.keywordBasedRetrieval(e,s,r*2),i=this.typeBasedRetrieval(e,r*2),n=this.difficultyBasedRetrieval(e,r*2),l=new Map;return a.forEach(c=>{const d=this.calculateSimilarity(e,c.naturalQuery);l.set(c.id,{example:c,score:d*1})}),i.forEach(c=>{const d=this.calculateSimilarity(e,c.naturalQuery),h=l.get(c.id);h?h.score+=d*.8:l.set(c.id,{example:c,score:d*.8})}),n.forEach(c=>{const d=this.calculateSimilarity(e,c.naturalQuery),h=l.get(c.id);h?h.score+=d*.6:l.set(c.id,{example:c,score:d*.6})}),Array.from(l.values()).sort((c,d)=>d.score-c.score).slice(0,r).map(c=>c.example)}adaptiveRetrieval(e,s,r){const a=this.analyzeQueryComplexity(e),i=s.length>0;return a==="simple"&&i?this.keywordBasedRetrieval(e,s,r):a==="complex"?this.typeBasedRetrieval(e,r):this.hybridRetrieval(e,s,r)}tokenize(e){return e.toLowerCase().replace(/[^\u4e00-\u9fa5a-z0-9\s]/g," ").split(/\s+/).filter(s=>s.length>0)}computeTF(e,s){const r=new Map;return s.forEach(a=>r.set(a,0)),e.forEach(a=>{const i=r.get(a)||0;r.set(a,i+1)}),r}extractKeywords(e){const s=this.tokenize(e),r=new Set(["的","了","是","在","有","和","与","或","就","都","而","及","the","a","an","is","are","was","were","in","on","at","to","for","of","with","and"]);return s.filter(a=>!r.has(a)&&a.length>1)}predictQueryType(e){const s=e.toLowerCase();return s.includes("子查询")||s.includes("窗口")||s.includes("row_number")?"complex":s.includes("join")||s.includes("连接")||s.includes("关联")||s.includes("跨表")?"join":s.includes("总计")||s.includes("平均")||s.includes("count")||s.includes("sum")||s.includes("avg")||s.includes("max")||s.includes("min")||s.includes("分组")||s.includes("group by")?"aggregate":"simple"}predictDifficulty(e){const s=this.predictQueryType(e),r=e.toLowerCase();return s==="complex"||r.includes("子查询")||r.includes("窗口函数")||r.includes("case when")?"advanced":s==="join"||s==="aggregate"||r.includes("having")||r.includes("order by")||r.includes("多个")?"intermediate":"beginner"}analyzeQueryComplexity(e){const s=e.toLowerCase();let r=0;return(s.includes("join")||s.includes("连接"))&&(r+=2),(s.includes("group by")||s.includes("分组"))&&(r+=2),s.includes("子查询")&&(r+=3),(s.includes("窗口")||s.includes("row_number"))&&(r+=3),s.includes("case when")&&(r+=2),s.includes("having")&&(r+=2),r>=5?"complex":r>=2?"medium":"simple"}formatExample(e,s,r){const a=[];return a.push(`示例 ${s}:`),a.push(`自然语言：${e.naturalQuery}`),r.includeExplanation&&e.intent&&a.push(`意图：${e.intent}`),r.includeSQL&&a.push(`SQL：${e.sqlQuery}`),a.push(""),a.join(`
`)}formatCoTExample(e,s,r){const a=[];return a.push(`示例 ${s}:`),a.push(`自然语言：${e.naturalQuery}`),e.reasoningSteps&&e.reasoningSteps.length>0&&r.includeReasoning&&(a.push("推理过程："),e.reasoningSteps.forEach((i,n)=>{a.push(`  ${n+1}. ${i}`)})),r.includeSQL&&a.push(`SQL：${e.sqlQuery}`),a.push(""),a.join(`
`)}getDefaultSystemMessage(){return`你是一个专业的SQL查询生成助手。你的任务是将自然语言查询转换为准确的SQL查询。

请根据提供的示例，理解用户的查询意图，并生成相应的SQL语句。

注意：
1. 确保SQL语法正确
2. 使用提供的字段名称
3. 注意查询的性能和可读性`}getCoTSystemMessage(){return`你是一个专业的SQL查询生成助手。请使用思维链（Chain-of-Thought）方法来分析和生成SQL查询。

对于每个查询，请按以下步骤思考：
1. 理解查询意图：用户想要什么数据？
2. 识别涉及的字段：需要哪些列？
3. 确定查询类型：简单查询、聚合、连接还是子查询？
4. 设计查询结构：如何组织SQL语句？
5. 编写SQL代码：具体的SQL实现

请输出完整的推理过程和最终的SQL查询。`}updateExampleWeight(e,s){this.examples.get(e)&&console.log(`Updated example ${e} with avg score: ${s}`)}generateExampleId(){return`example_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}buildCacheKey(e,s,r,a){return`${e}_${s.join(",")}_${r}_${a}`}invalidateCache(){this.cache.clear()}mergeConfig(e){const s={similarity:{defaultMethod:"hybrid",threshold:.5,weights:{cosine:.3,jaccard:.2,levenshtein:.2,semantic:.3}},retrieval:{defaultStrategy:"hybrid",defaultTopK:5,maxCandidates:100,enableCache:!0},prompting:{defaultTemplate:"few_shot",maxExamples:bt.FEW_SHOT_EXAMPLES.MAX_EXAMPLES,minExamples:bt.FEW_SHOT_EXAMPLES.MIN_EXAMPLES},learning:{enableFeedback:!0,autoUpdateExamples:!1,feedbackThreshold:5}};return{similarity:{...s.similarity,...e==null?void 0:e.similarity},retrieval:{...s.retrieval,...e==null?void 0:e.retrieval},prompting:{...s.prompting,...e==null?void 0:e.prompting},learning:{...s.learning,...e==null?void 0:e.learning}}}mergePromptConfig(e){return{...{templateType:"few_shot",maxExamples:bt.FEW_SHOT_EXAMPLES.MAX_EXAMPLES,includeReasoning:!1,includeSQL:!0,includeExplanation:!0},...e}}clearCache(){this.cache.clear()}getCacheSize(){return this.cache.size}exportExamples(){return this.getAllExamples()}importExamples(e){this.clearExamples(),this.addExamples(e)}validateExample(e){const s=[];return(!e.naturalQuery||e.naturalQuery.trim().length===0)&&s.push("缺少自然语言查询"),(!e.sqlQuery||e.sqlQuery.trim().length===0)&&s.push("缺少SQL查询"),e.queryType||s.push("缺少查询类型"),e.difficulty||s.push("缺少难度级别"),(!e.tags||e.tags.length===0)&&s.push("缺少标签"),{valid:s.length===0,errors:s}}validateAllExamples(){const e=new Map;return this.getAllExamples().forEach(s=>{e.set(s.id,this.validateExample(s))}),e}findSimilarExamples(e,s=.7,r=10){return this.getAllExamples().map(i=>({example:i,similarity:this.calculateSimilarity(e,i.naturalQuery)})).filter(i=>i.similarity>=s).sort((i,n)=>n.similarity-i.similarity).slice(0,r).map(i=>i.example)}getExampleStats(e){const s=this.examples.get(e);if(!s)return null;const r=this.feedbackHistory.get(e)||[],a=r.length>0?r.reduce((i,n)=>i+n,0)/r.length:0;return{example:s,feedbackHistory:r,avgFeedback:a}}updateExamplesFromFeedback(e){e.forEach(({exampleId:s,score:r})=>{this.recordFeedback(s,r)})}generateReport(){const e=this.getStatistics(),s=[];return s.push(`=== Few-Shot引擎统计报告 ===
`),s.push(`总示例数：${e.totalExamples}`),s.push(`
按类型分布：`),Object.entries(e.examplesByType).forEach(([r,a])=>{s.push(`  - ${r}: ${a}`)}),s.push(`
按难度分布：`),Object.entries(e.examplesByDifficulty).forEach(([r,a])=>{s.push(`  - ${r}: ${a}`)}),s.push(`
按来源分布：`),Object.entries(e.examplesBySource).forEach(([r,a])=>{s.push(`  - ${r}: ${a}`)}),s.push(`
平均反馈分数：${e.averageFeedbackScore.toFixed(2)}`),s.push(`
缓存大小：${this.getCacheSize()}`),s.join(`
`)}async optimizeExamples(){let e=0,s=0,r=0;return this.validateAllExamples().forEach((i,n)=>{i.valid||(this.removeExample(n),e++)}),this.feedbackHistory.forEach((i,n)=>{i.reduce((o,c)=>o+c,0)/i.length<.3&&(this.removeExample(n),e++)}),{removed:e,updated:s,added:r}}selectDiverseExamples(e,s,r=5){const a=this.findRelevantExamples(e,s,r*2);if(a.length<=r)return a;const i=[],n=[...a];for(i.push(n.shift());i.length<r&&n.length>0;){let l=-1,o=0;n.forEach((c,d)=>{const h=Math.min(...i.map(m=>this.calculateSimilarity(c.naturalQuery,m.naturalQuery)));h>l&&(l=h,o=d)}),i.push(n.splice(o,1)[0])}return i}getRecommendedExamples(e,s=[],r=5){const a=this.predictQueryType(e),i=this.predictDifficulty(e),n=this.findRelevantExamples(e,s,r),l=[];l.push(`查询类型：${a}`),l.push(`难度级别：${i}`),n.length>0?l.push(`找到${n.length}个相关示例`):l.push("未找到相关示例，建议添加更多示例");const o=n.length>0?.8:.3;return{examples:n,recommendations:l,confidence:o}}async batchProcessQueries(e,s=[],r=5){const a=new Map;for(const i of e){const n=this.findRelevantExamples(i,s,r);a.set(i,n)}return a}async*streamProcessQueries(e,s=[],r=5,a=10){for(let i=0;i<e.length;i+=a){const n=e.slice(i,i+a);for(const l of n){const o=this.findRelevantExamples(l,s,r);yield{query:l,examples:o}}}}evaluateExampleQuality(){const e=this.getAllExamples(),s=[],r={simple:0,aggregate:0,join:0,complex:0},a={beginner:0,intermediate:0,advanced:0};e.forEach(o=>{r[o.queryType]++,a[o.difficulty]++}),r.simple<10&&s.push("简单查询示例不足（建议至少10个）"),r.aggregate<10&&s.push("聚合查询示例不足（建议至少10个）"),r.join<10&&s.push("JOIN查询示例不足（建议至少10个）"),r.complex<10&&s.push("复杂查询示例不足（建议至少10个）");const i=Object.values(r).filter(o=>o>=10).length/4,n=Object.values(a).filter(o=>o>=10).length/3;return{overall:i*.6+n*.4,byType:r,byDifficulty:a,issues:s}}generateCompletionSuggestions(){this.getStatistics();const e=[],s=["simple","aggregate","join","complex"],r=["beginner","intermediate","advanced"];return s.forEach(a=>{r.forEach(i=>{const n=this.getAllExamples().filter(l=>l.queryType===a&&l.difficulty===i).length;n<5&&e.push({type:a,difficulty:i,count:5-n})})}),{neededExamples:e,totalNeeded:e.reduce((a,i)=>a+i.count,0)}}}const We={async processRule(u,e){const s=u.replace(/^\/\/ AI\s*/i,"").trim(),r=typeof e=="string"?{value:e}:e;try{const a=await fetch("/api/ai/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rule:s,context:r})});if(!a.ok){const n=await a.json().catch(()=>({}));throw new Error(n.error||`Request failed with status ${a.status}`)}const i=await a.json();return{result:i.result,cost:i.duration}}catch(a){return console.error("[AI Service] Process Failed:",a),{result:"",error:a.message||"AI 服务连接失败"}}},async generateCellContent(u,e){return this.processRule(u,e)},async autoConfigMapping(u,e){try{const s={placeholders:u,sheets:e},r=`
            Task: Auto-configure mapping between Word Template and Excel Sheets.
            
            Template Placeholders: ${JSON.stringify(u)}
            
            Excel Sheets Headers: ${JSON.stringify(e)}
            
            Instructions:
            1. Analyze the semantic relationship between Placeholders and Excel Headers.
            2. Identifying Output Structure: You must return a valid JSON object matching the 'MappingScheme' interface.
            3. CRITICAL: Your JSON must include a "mappings" array. Do not just echo the input.
            
            Output JSON Format Example:
            {
              "explanation": "Brief reasoning",
              "primarySheet": "Sheet1",
              "mappings": [
                { "placeholder": "{{Name}}", "excelColumn": "EmployeeName", "ruleType": "direct" },
                { "placeholder": "{{Date}}", "excelColumn": "JoinDate", "format": "yyyy-MM-dd" }
              ],
              "unmappedPlaceholders": []
            }
            
            IMPORTANT: Return ONLY the JSON code block. No conversational filler.
            `,a=await fetch("/api/ai/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rule:"AUTO_CONFIG",context:s,instruction:r})});if(!a.ok)throw new Error("Backend request failed");const i=await a.json();let n=null;try{let l=i.result;const o=l.match(/```json\s*(\{[\s\S]*?\})\s*```/)||l.match(/```\s*(\{[\s\S]*?\})\s*```/);if(o)l=o[1];else if(l.indexOf("{")>-1){const c=l.indexOf("{"),d=l.lastIndexOf("}");d>c&&(l=l.substring(c,d+1))}n=JSON.parse(l)}catch(l){console.error("Failed to parse AI Auto-Config result",l,i.result)}if(!n||!n.mappings||!Array.isArray(n.mappings)||n.mappings.length===0){console.warn("AI returned empty/invalid mappings, using Local Heuristic Fallback.");const l=[],o=[],c=Object.values(e).flat();u.forEach(d=>{const h=d.replace(/[{}]/g,"").trim(),m=c.find(p=>p===h);if(m){l.push({placeholder:d,excelColumn:m,ruleType:"direct"});return}const f=c.find(p=>p.includes(h)||h.includes(p));if(f){l.push({placeholder:d,excelColumn:f,ruleType:"direct"});return}o.push(d)}),n={explanation:"AI Service Unavailable or returned empty. Using Local Best-Effort Matching.",primarySheet:Object.keys(e)[0]||"Sheet1",filterCondition:null,mappings:l,unmappedPlaceholders:o,confidence:.5}}return n.mappings||(n.mappings=[]),n}catch(s){return console.error("Auto Config Failed:",s),null}},async analyzeColumnContent(u,e){const s=e.filter(l=>l!=null&&l!=="").map(String);return s.length===0?{type:"text",confidence:.1}:s.every(l=>!isNaN(Date.parse(l))&&(l.includes("-")||l.includes("/")||l.includes("年")))?{type:"date",confidence:.9,suggestedFormatter:"DATE_CN"}:s.every(l=>!isNaN(parseFloat(l.replace(/[¥,]/g,""))))?u.includes("金额")||u.includes("费")||u.includes("钱")?{type:"number",confidence:.85,suggestedFormatter:"CURRENCY_CN"}:{type:"number",confidence:.8}:s.some(l=>/^1[3-9]\d{9}$/.test(l.replace(/\s/g,"")))||u.includes("手机")||u.includes("电话")?{type:"text",confidence:.95,suggestedFormatter:"MASK_PHONE"}:s.some(l=>/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/.test(l))||u.includes("身份证")||u.includes("证件")?{type:"text",confidence:.95,suggestedFormatter:"MASK_ID"}:{type:"text",confidence:.5}}},Us=Object.freeze(Object.defineProperty({__proto__:null,aiProcessingService:We},Symbol.toStringTag,{value:"Module"})),Ps=[{id:"simple_select_001",naturalQuery:"查询所有员工的信息",sqlQuery:"SELECT * FROM employees;",queryType:"simple",intent:"获取所有记录",fields:["employees"],conditions:[],reasoningSteps:["识别需求：获取员工表的所有数据","确定操作：SELECT * 选择所有列","确定表：FROM employees"],difficulty:"beginner",tags:["select","all","employees"],source:"manual"},{id:"simple_select_002",naturalQuery:"只查询员工的姓名和邮箱",sqlQuery:"SELECT name, email FROM employees;",queryType:"simple",intent:"获取特定字段",fields:["name","email","employees"],conditions:[],reasoningSteps:["识别需求：只获取员工的姓名和邮箱","确定字段：name, email","确定表：FROM employees"],difficulty:"beginner",tags:["select","specific","fields"],source:"manual"},{id:"simple_select_003",naturalQuery:"显示产品的名称和价格",sqlQuery:"SELECT product_name, price FROM products;",queryType:"simple",intent:"获取特定字段",fields:["product_name","price","products"],conditions:[],difficulty:"beginner",tags:["select","products","price"],source:"manual"},{id:"simple_select_004",naturalQuery:"查询客户的姓名和电话号码",sqlQuery:"SELECT customer_name, phone FROM customers;",queryType:"simple",intent:"获取特定字段",fields:["customer_name","phone","customers"],conditions:[],difficulty:"beginner",tags:["select","customers","contact"],source:"manual"},{id:"simple_select_005",naturalQuery:"列出所有订单的订单号和订单日期",sqlQuery:"SELECT order_id, order_date FROM orders;",queryType:"simple",intent:"获取特定字段",fields:["order_id","order_date","orders"],conditions:[],difficulty:"beginner",tags:["select","orders","date"],source:"manual"},{id:"simple_select_006",naturalQuery:"查询员工的ID、姓名和部门",sqlQuery:"SELECT employee_id, name, department FROM employees;",queryType:"simple",intent:"获取特定字段",fields:["employee_id","name","department","employees"],conditions:[],difficulty:"beginner",tags:["select","employees","department"],source:"manual"},{id:"simple_select_007",naturalQuery:"显示产品名称、类别和库存数量",sqlQuery:"SELECT product_name, category, stock_quantity FROM products;",queryType:"simple",intent:"获取特定字段",fields:["product_name","category","stock_quantity","products"],conditions:[],difficulty:"beginner",tags:["select","products","inventory"],source:"manual"},{id:"simple_select_008",naturalQuery:"查询客户的ID、姓名和地址",sqlQuery:"SELECT customer_id, customer_name, address FROM customers;",queryType:"simple",intent:"获取特定字段",fields:["customer_id","customer_name","address","customers"],conditions:[],difficulty:"beginner",tags:["select","customers","address"],source:"manual"},{id:"simple_select_009",naturalQuery:"列出所有部门的名称",sqlQuery:"SELECT department_name FROM departments;",queryType:"simple",intent:"获取特定字段",fields:["department_name","departments"],conditions:[],difficulty:"beginner",tags:["select","departments","name"],source:"manual"},{id:"simple_select_010",naturalQuery:"查询订单的订单号、客户ID和总金额",sqlQuery:"SELECT order_id, customer_id, total_amount FROM orders;",queryType:"simple",intent:"获取特定字段",fields:["order_id","customer_id","total_amount","orders"],conditions:[],difficulty:"beginner",tags:["select","orders","amount"],source:"manual"}],Bs=[{id:"where_001",naturalQuery:'查询姓名为"张三"的员工信息',sqlQuery:"SELECT * FROM employees WHERE name = '张三';",queryType:"simple",intent:"精确匹配",fields:["name","employees"],conditions:["name = '张三'"],reasoningSteps:["识别需求：查找特定姓名的员工","确定表：employees",'确定条件：WHERE name = "张三"'],difficulty:"beginner",tags:["where","equals","filter"],source:"manual"},{id:"where_002",naturalQuery:"查询年龄大于30岁的员工",sqlQuery:"SELECT * FROM employees WHERE age > 30;",queryType:"simple",intent:"数值比较",fields:["age","employees"],conditions:["age > 30"],difficulty:"beginner",tags:["where","greater_than","age"],source:"manual"},{id:"where_003",naturalQuery:"查找价格低于100元的产品",sqlQuery:"SELECT * FROM products WHERE price < 100;",queryType:"simple",intent:"数值比较",fields:["price","products"],conditions:["price < 100"],difficulty:"beginner",tags:["where","less_than","price"],source:"manual"},{id:"where_004",naturalQuery:'查询部门是"销售部"的员工',sqlQuery:"SELECT * FROM employees WHERE department = '销售部';",queryType:"simple",intent:"精确匹配",fields:["department","employees"],conditions:["department = '销售部'"],difficulty:"beginner",tags:["where","equals","department"],source:"manual"},{id:"where_005",naturalQuery:'查找状态为"已发货"的订单',sqlQuery:"SELECT * FROM orders WHERE status = '已发货';",queryType:"simple",intent:"精确匹配",fields:["status","orders"],conditions:["status = '已发货'"],difficulty:"beginner",tags:["where","status","orders"],source:"manual"},{id:"where_006",naturalQuery:"查询库存大于0的产品",sqlQuery:"SELECT * FROM products WHERE stock_quantity > 0;",queryType:"simple",intent:"数值比较",fields:["stock_quantity","products"],conditions:["stock_quantity > 0"],difficulty:"beginner",tags:["where","inventory","available"],source:"manual"},{id:"where_007",naturalQuery:"查找工资在5000到10000之间的员工",sqlQuery:"SELECT * FROM employees WHERE salary BETWEEN 5000 AND 10000;",queryType:"simple",intent:"范围查询",fields:["salary","employees"],conditions:["salary BETWEEN 5000 AND 10000"],difficulty:"intermediate",tags:["where","between","salary"],source:"manual"},{id:"where_008",naturalQuery:'查询邮箱包含"gmail.com"的客户',sqlQuery:"SELECT * FROM customers WHERE email LIKE '%gmail.com';",queryType:"simple",intent:"模糊匹配",fields:["email","customers"],conditions:["email LIKE '%gmail.com'"],difficulty:"intermediate",tags:["where","like","email"],source:"manual"},{id:"where_009",naturalQuery:'查找城市是"北京"或"上海"的客户',sqlQuery:"SELECT * FROM customers WHERE city IN ('北京', '上海');",queryType:"simple",intent:"多值匹配",fields:["city","customers"],conditions:["city IN ('北京', '上海')"],difficulty:"intermediate",tags:["where","in","city"],source:"manual"},{id:"where_010",naturalQuery:"查询没有分配部门的员工",sqlQuery:"SELECT * FROM employees WHERE department IS NULL;",queryType:"simple",intent:"空值检查",fields:["department","employees"],conditions:["department IS NULL"],difficulty:"intermediate",tags:["where","null","department"],source:"manual"}],Vs=[{id:"orderby_001",naturalQuery:"按年龄从大到小排序显示员工",sqlQuery:"SELECT * FROM employees ORDER BY age DESC;",queryType:"simple",intent:"降序排序",fields:["age","employees"],conditions:[],difficulty:"beginner",tags:["order_by","desc","age"],source:"manual"},{id:"orderby_002",naturalQuery:"按价格从低到高显示产品",sqlQuery:"SELECT * FROM products ORDER BY price ASC;",queryType:"simple",intent:"升序排序",fields:["price","products"],conditions:[],difficulty:"beginner",tags:["order_by","asc","price"],source:"manual"},{id:"orderby_003",naturalQuery:"按订单日期从新到旧显示订单",sqlQuery:"SELECT * FROM orders ORDER BY order_date DESC;",queryType:"simple",intent:"日期降序",fields:["order_date","orders"],conditions:[],difficulty:"beginner",tags:["order_by","date","desc"],source:"manual"},{id:"orderby_004",naturalQuery:"按姓名字母顺序显示员工",sqlQuery:"SELECT * FROM employees ORDER BY name ASC;",queryType:"simple",intent:"字符串排序",fields:["name","employees"],conditions:[],difficulty:"beginner",tags:["order_by","name","asc"],source:"manual"},{id:"orderby_005",naturalQuery:"先按部门排序，再按工资降序显示员工",sqlQuery:"SELECT * FROM employees ORDER BY department ASC, salary DESC;",queryType:"simple",intent:"多字段排序",fields:["department","salary","employees"],conditions:[],difficulty:"intermediate",tags:["order_by","multiple","sort"],source:"manual"}],Gs=[{id:"limit_001",naturalQuery:"显示前5个产品",sqlQuery:"SELECT * FROM products LIMIT 5;",queryType:"simple",intent:"限制数量",fields:["products"],conditions:[],difficulty:"beginner",tags:["limit","top","products"],source:"manual"},{id:"limit_002",naturalQuery:"查询最新的10条订单",sqlQuery:"SELECT * FROM orders ORDER BY order_date DESC LIMIT 10;",queryType:"simple",intent:"最新记录",fields:["order_date","orders"],conditions:[],reasoningSteps:["识别需求：获取最新的订单","确定排序：按日期降序 ORDER BY order_date DESC","限制数量：LIMIT 10"],difficulty:"intermediate",tags:["limit","order_by","latest"],source:"manual"},{id:"limit_003",naturalQuery:"显示工资最高的3名员工",sqlQuery:"SELECT * FROM employees ORDER BY salary DESC LIMIT 3;",queryType:"simple",intent:"Top-N查询",fields:["salary","employees"],conditions:[],difficulty:"intermediate",tags:["limit","top","salary"],source:"manual"},{id:"limit_004",naturalQuery:"跳过前5条记录，显示接下来的10条记录",sqlQuery:"SELECT * FROM products LIMIT 10 OFFSET 5;",queryType:"simple",intent:"分页查询",fields:["products"],conditions:[],difficulty:"intermediate",tags:["limit","offset","pagination"],source:"manual"},{id:"limit_005",naturalQuery:"显示第2页的产品，每页10条",sqlQuery:"SELECT * FROM products LIMIT 10 OFFSET 10;",queryType:"simple",intent:"分页查询",fields:["products"],conditions:[],difficulty:"intermediate",tags:["limit","offset","page"],source:"manual"}],Hs=[{id:"agg_001",naturalQuery:"统计员工总数",sqlQuery:"SELECT COUNT(*) as total_employees FROM employees;",queryType:"aggregate",intent:"计数",fields:["employees"],conditions:[],reasoningSteps:["识别需求：计算员工总数","选择函数：COUNT(*) 统计所有行","添加别名：as total_employees"],difficulty:"beginner",tags:["count","total","employees"],source:"manual"},{id:"agg_002",naturalQuery:"计算所有订单的总金额",sqlQuery:"SELECT SUM(total_amount) as total_sales FROM orders;",queryType:"aggregate",intent:"求和",fields:["total_amount","orders"],conditions:[],reasoningSteps:["识别需求：计算订单总金额","选择函数：SUM(total_amount) 求和","添加别名：as total_sales"],difficulty:"beginner",tags:["sum","total","orders"],source:"manual"},{id:"agg_003",naturalQuery:"计算员工的平均工资",sqlQuery:"SELECT AVG(salary) as average_salary FROM employees;",queryType:"aggregate",intent:"平均值",fields:["salary","employees"],conditions:[],difficulty:"beginner",tags:["avg","salary","employees"],source:"manual"},{id:"agg_004",naturalQuery:"查找最高工资",sqlQuery:"SELECT MAX(salary) as max_salary FROM employees;",queryType:"aggregate",intent:"最大值",fields:["salary","employees"],conditions:[],difficulty:"beginner",tags:["max","salary","employees"],source:"manual"},{id:"agg_005",naturalQuery:"查找最低价格的产品",sqlQuery:"SELECT MIN(price) as min_price FROM products;",queryType:"aggregate",intent:"最小值",fields:["price","products"],conditions:[],difficulty:"beginner",tags:["min","price","products"],source:"manual"},{id:"agg_006",naturalQuery:"统计销售部的员工人数",sqlQuery:"SELECT COUNT(*) as sales_count FROM employees WHERE department = '销售部';",queryType:"aggregate",intent:"条件计数",fields:["department","employees"],conditions:["department = '销售部'"],reasoningSteps:["识别需求：统计特定部门的员工数",'添加条件：WHERE department = "销售部"',"计数：COUNT(*)"],difficulty:"intermediate",tags:["count","where","department"],source:"manual"},{id:"agg_007",naturalQuery:"计算已发货订单的总金额",sqlQuery:"SELECT SUM(total_amount) as shipped_total FROM orders WHERE status = '已发货';",queryType:"aggregate",intent:"条件求和",fields:["total_amount","status","orders"],conditions:["status = '已发货'"],difficulty:"intermediate",tags:["sum","where","status"],source:"manual"},{id:"agg_008",naturalQuery:"计算每个部门的平均工资",sqlQuery:"SELECT department, AVG(salary) as avg_salary FROM employees GROUP BY department;",queryType:"aggregate",intent:"分组聚合",fields:["department","salary","employees"],conditions:[],reasoningSteps:["识别需求：按部门计算平均工资","选择分组：GROUP BY department","计算平均：AVG(salary)"],difficulty:"intermediate",tags:["avg","group_by","department"],source:"manual"},{id:"agg_009",naturalQuery:"统计每个产品类别的产品数量",sqlQuery:"SELECT category, COUNT(*) as product_count FROM products GROUP BY category;",queryType:"aggregate",intent:"分组计数",fields:["category","products"],conditions:[],difficulty:"intermediate",tags:["count","group_by","category"],source:"manual"},{id:"agg_010",naturalQuery:"计算每个客户的订单总数和总金额",sqlQuery:"SELECT customer_id, COUNT(*) as order_count, SUM(total_amount) as total_spent FROM orders GROUP BY customer_id;",queryType:"aggregate",intent:"多聚合函数",fields:["customer_id","total_amount","orders"],conditions:[],reasoningSteps:["识别需求：统计每个客户的订单情况","选择分组：GROUP BY customer_id","多个聚合：COUNT(*) 和 SUM(total_amount)"],difficulty:"intermediate",tags:["count","sum","group_by","customer"],source:"manual"}],Ws=[{id:"groupby_001",naturalQuery:"统计每个部门的员工数量",sqlQuery:"SELECT department, COUNT(*) as employee_count FROM employees GROUP BY department;",queryType:"aggregate",intent:"分组统计",fields:["department","employees"],conditions:[],reasoningSteps:["识别需求：按部门统计员工数","分组字段：department","聚合函数：COUNT(*)"],difficulty:"intermediate",tags:["group_by","count","department"],source:"manual"},{id:"groupby_002",naturalQuery:"计算每个产品类别的平均价格",sqlQuery:"SELECT category, AVG(price) as avg_price FROM products GROUP BY category;",queryType:"aggregate",intent:"分组平均",fields:["category","price","products"],conditions:[],difficulty:"intermediate",tags:["group_by","avg","category"],source:"manual"},{id:"groupby_003",naturalQuery:"统计每个订单状态的数量",sqlQuery:"SELECT status, COUNT(*) as status_count FROM orders GROUP BY status;",queryType:"aggregate",intent:"分组统计",fields:["status","orders"],conditions:[],difficulty:"intermediate",tags:["group_by","count","status"],source:"manual"},{id:"groupby_004",naturalQuery:"计算每个城市的客户数量",sqlQuery:"SELECT city, COUNT(*) as customer_count FROM customers GROUP BY city;",queryType:"aggregate",intent:"分组统计",fields:["city","customers"],conditions:[],difficulty:"intermediate",tags:["group_by","count","city"],source:"manual"},{id:"groupby_005",naturalQuery:"统计每个员工的订单数量",sqlQuery:"SELECT employee_id, COUNT(*) as order_count FROM orders GROUP BY employee_id;",queryType:"aggregate",intent:"分组统计",fields:["employee_id","orders"],conditions:[],difficulty:"intermediate",tags:["group_by","count","employee"],source:"manual"},{id:"groupby_006",naturalQuery:"计算每年每月的销售总额",sqlQuery:"SELECT YEAR(order_date) as year, MONTH(order_date) as month, SUM(total_amount) as monthly_sales FROM orders GROUP BY YEAR(order_date), MONTH(order_date);",queryType:"aggregate",intent:"时间分组",fields:["order_date","total_amount","orders"],conditions:[],reasoningSteps:["识别需求：按年月统计销售额","提取时间：YEAR(order_date), MONTH(order_date)","分组：GROUP BY YEAR(order_date), MONTH(order_date)","聚合：SUM(total_amount)"],difficulty:"advanced",tags:["group_by","date","sum"],source:"manual"},{id:"groupby_007",naturalQuery:"统计每个部门每个职位的员工数",sqlQuery:"SELECT department, position, COUNT(*) as employee_count FROM employees GROUP BY department, position;",queryType:"aggregate",intent:"多字段分组",fields:["department","position","employees"],conditions:[],reasoningSteps:["识别需求：按部门和职位统计","多字段分组：GROUP BY department, position","聚合：COUNT(*)"],difficulty:"advanced",tags:["group_by","multiple","department"],source:"manual"},{id:"groupby_008",naturalQuery:"查找每个类别中最贵的产品",sqlQuery:"SELECT category, MAX(price) as max_price FROM products GROUP BY category;",queryType:"aggregate",intent:"分组最大值",fields:["category","price","products"],conditions:[],difficulty:"intermediate",tags:["group_by","max","price"],source:"manual"},{id:"groupby_009",naturalQuery:"计算每个客户的平均订单金额",sqlQuery:"SELECT customer_id, AVG(total_amount) as avg_order_value FROM orders GROUP BY customer_id;",queryType:"aggregate",intent:"分组平均",fields:["customer_id","total_amount","orders"],conditions:[],difficulty:"intermediate",tags:["group_by","avg","customer"],source:"manual"},{id:"groupby_010",naturalQuery:"统计每个状态下的订单总金额和订单数",sqlQuery:"SELECT status, COUNT(*) as order_count, SUM(total_amount) as total_amount FROM orders GROUP BY status;",queryType:"aggregate",intent:"多聚合",fields:["status","total_amount","orders"],conditions:[],difficulty:"intermediate",tags:["group_by","count","sum"],source:"manual"}],zs=[{id:"having_001",naturalQuery:"查找订单数量超过5的客户",sqlQuery:"SELECT customer_id, COUNT(*) as order_count FROM orders GROUP BY customer_id HAVING COUNT(*) > 5;",queryType:"aggregate",intent:"聚合条件过滤",fields:["customer_id","orders"],conditions:[],reasoningSteps:["识别需求：找出订单多的客户","先分组：GROUP BY customer_id","再过滤：HAVING COUNT(*) > 5"],difficulty:"advanced",tags:["having","group_by","count"],source:"manual"},{id:"having_002",naturalQuery:"查找平均工资大于8000的部门",sqlQuery:"SELECT department, AVG(salary) as avg_salary FROM employees GROUP BY department HAVING AVG(salary) > 8000;",queryType:"aggregate",intent:"聚合条件过滤",fields:["department","salary","employees"],conditions:[],reasoningSteps:["识别需求：找出高薪部门","先分组计算平均：GROUP BY department, AVG(salary)","再过滤：HAVING AVG(salary) > 8000"],difficulty:"advanced",tags:["having","avg","salary"],source:"manual"},{id:"having_003",naturalQuery:"查找总销售额超过10000的产品类别",sqlQuery:"SELECT category, SUM(price * stock_quantity) as total_value FROM products GROUP BY category HAVING SUM(price * stock_quantity) > 10000;",queryType:"aggregate",intent:"聚合条件过滤",fields:["category","price","stock_quantity","products"],conditions:[],difficulty:"advanced",tags:["having","sum","category"],source:"manual"},{id:"having_004",naturalQuery:"查找员工数大于10的部门",sqlQuery:"SELECT department, COUNT(*) as employee_count FROM employees GROUP BY department HAVING COUNT(*) > 10;",queryType:"aggregate",intent:"聚合条件过滤",fields:["department","employees"],conditions:[],difficulty:"advanced",tags:["having","count","department"],source:"manual"},{id:"having_005",naturalQuery:"查找平均订单金额大于500的客户",sqlQuery:"SELECT customer_id, AVG(total_amount) as avg_amount FROM orders GROUP BY customer_id HAVING AVG(total_amount) > 500;",queryType:"aggregate",intent:"聚合条件过滤",fields:["customer_id","total_amount","orders"],conditions:[],difficulty:"advanced",tags:["having","avg","customer"],source:"manual"}],Ys=[{id:"join_inner_001",naturalQuery:"查询员工及其所属部门的名称",sqlQuery:"SELECT employees.name, departments.department_name FROM employees INNER JOIN departments ON employees.department_id = departments.department_id;",queryType:"join",intent:"表连接",fields:["name","department_name","employees","departments"],conditions:[],reasoningSteps:["识别需求：获取员工和部门信息","确定表：employees（主表）, departments（关联表）","连接条件：ON employees.department_id = departments.department_id","连接类型：INNER JOIN（只返回匹配的记录）"],difficulty:"intermediate",tags:["inner_join","department","employee"],source:"manual"},{id:"join_inner_002",naturalQuery:"查询订单及其对应的客户信息",sqlQuery:"SELECT orders.order_id, orders.order_date, customers.customer_name FROM orders INNER JOIN customers ON orders.customer_id = customers.customer_id;",queryType:"join",intent:"表连接",fields:["order_id","order_date","customer_name","orders","customers"],conditions:[],difficulty:"intermediate",tags:["inner_join","customer","order"],source:"manual"},{id:"join_inner_003",naturalQuery:"查询订单详情和产品信息",sqlQuery:"SELECT order_items.order_id, products.product_name, order_items.quantity, order_items.price FROM order_items INNER JOIN products ON order_items.product_id = products.product_id;",queryType:"join",intent:"表连接",fields:["order_items","products"],conditions:[],difficulty:"intermediate",tags:["inner_join","product","order_item"],source:"manual"},{id:"join_inner_004",naturalQuery:"查询员工姓名和他们的经理姓名",sqlQuery:"SELECT e.name as employee_name, m.name as manager_name FROM employees e INNER JOIN employees m ON e.manager_id = m.employee_id;",queryType:"join",intent:"自连接",fields:["name","manager_id","employees"],conditions:[],reasoningSteps:["识别需求：获取员工和经理信息","特点：员工和经理都在同一张表","自连接：FROM employees e INNER JOIN employees m","连接条件：ON e.manager_id = m.employee_id"],difficulty:"advanced",tags:["inner_join","self_join","manager"],source:"manual"},{id:"join_inner_005",naturalQuery:"查询客户及其所在地区的名称",sqlQuery:"SELECT customers.customer_name, regions.region_name FROM customers INNER JOIN regions ON customers.region_id = regions.region_id;",queryType:"join",intent:"表连接",fields:["customer_name","region_name","customers","regions"],conditions:[],difficulty:"intermediate",tags:["inner_join","region","customer"],source:"manual"},{id:"join_inner_006",naturalQuery:"查询产品及其所属类别",sqlQuery:"SELECT products.product_name, categories.category_name FROM products INNER JOIN categories ON products.category_id = categories.category_id;",queryType:"join",intent:"表连接",fields:["product_name","category_name","products","categories"],conditions:[],difficulty:"intermediate",tags:["inner_join","category","product"],source:"manual"},{id:"join_inner_007",naturalQuery:"查询订单金额大于1000的订单及其客户信息",sqlQuery:"SELECT orders.order_id, customers.customer_name, orders.total_amount FROM orders INNER JOIN customers ON orders.customer_id = customers.customer_id WHERE orders.total_amount > 1000;",queryType:"join",intent:"带条件的连接",fields:["order_id","customer_name","total_amount","orders","customers"],conditions:["total_amount > 1000"],reasoningSteps:["识别需求：获取大额订单和客户信息","先连接：INNER JOIN customers ON ...","再过滤：WHERE total_amount > 1000"],difficulty:"intermediate",tags:["inner_join","where","amount"],source:"manual"},{id:"join_inner_008",naturalQuery:"查询员工及其处理的订单数量",sqlQuery:"SELECT employees.name, COUNT(orders.order_id) as order_count FROM employees INNER JOIN orders ON employees.employee_id = orders.employee_id GROUP BY employees.employee_id, employees.name;",queryType:"join",intent:"连接+聚合",fields:["name","orders","employees"],conditions:[],reasoningSteps:["识别需求：统计每个员工的订单数","连接表：INNER JOIN orders","分组统计：GROUP BY employees.employee_id","计数：COUNT(orders.order_id)"],difficulty:"advanced",tags:["inner_join","count","group_by"],source:"manual"},{id:"join_inner_009",naturalQuery:"查询销售部门的员工姓名",sqlQuery:"SELECT employees.name FROM employees INNER JOIN departments ON employees.department_id = departments.department_id WHERE departments.department_name = '销售部';",queryType:"join",intent:"连接+过滤",fields:["name","employees","departments"],conditions:["department_name = '销售部'"],difficulty:"intermediate",tags:["inner_join","where","department"],source:"manual"},{id:"join_inner_010",naturalQuery:"查询购买了产品的客户和产品名称",sqlQuery:"SELECT customers.customer_name, products.product_name FROM customers INNER JOIN orders ON customers.customer_id = orders.customer_id INNER JOIN order_items ON orders.order_id = order_items.order_id INNER JOIN products ON order_items.product_id = products.product_id;",queryType:"join",intent:"多表连接",fields:["customer_name","product_name","customers","orders","order_items","products"],conditions:[],reasoningSteps:["识别需求：获取客户和购买的产品","多表连接：customers -> orders -> order_items -> products","每个连接都有对应的ON条件"],difficulty:"advanced",tags:["inner_join","multiple_tables","product"],source:"manual"}],Js=[{id:"join_left_001",naturalQuery:"查询所有员工及其部门信息（包括没有部门的员工）",sqlQuery:"SELECT employees.name, departments.department_name FROM employees LEFT JOIN departments ON employees.department_id = departments.department_id;",queryType:"join",intent:"左连接",fields:["name","department_name","employees","departments"],conditions:[],reasoningSteps:["识别需求：获取所有员工，即使没有部门","选择LEFT JOIN：保留左表（employees）的所有记录","结果：没有部门的员工，department_name为NULL"],difficulty:"intermediate",tags:["left_join","department","employee"],source:"manual"},{id:"join_left_002",naturalQuery:"查询所有客户及其订单（包括没有订单的客户）",sqlQuery:"SELECT customers.customer_name, orders.order_id, orders.order_date FROM customers LEFT JOIN orders ON customers.customer_id = orders.customer_id;",queryType:"join",intent:"左连接",fields:["customer_name","order_id","order_date","customers","orders"],conditions:[],difficulty:"intermediate",tags:["left_join","customer","order"],source:"manual"},{id:"join_left_003",naturalQuery:"查询所有产品及其销售记录（包括未售出的产品）",sqlQuery:"SELECT products.product_name, order_items.quantity FROM products LEFT JOIN order_items ON products.product_id = order_items.product_id;",queryType:"join",intent:"左连接",fields:["product_name","quantity","products","order_items"],conditions:[],difficulty:"intermediate",tags:["left_join","product","sales"],source:"manual"},{id:"join_left_004",naturalQuery:"查找没有订单的客户",sqlQuery:"SELECT customers.customer_name FROM customers LEFT JOIN orders ON customers.customer_id = orders.customer_id WHERE orders.order_id IS NULL;",queryType:"join",intent:"左连接+空值检查",fields:["customer_name","customers","orders"],conditions:["order_id IS NULL"],reasoningSteps:["识别需求：找出从未下单的客户","使用LEFT JOIN：保留所有客户","过滤条件：WHERE orders.order_id IS NULL（未匹配到订单）"],difficulty:"advanced",tags:["left_join","null","filter"],source:"manual"},{id:"join_left_005",naturalQuery:"查询员工及其经理（包括没有经理的员工）",sqlQuery:"SELECT e.name as employee_name, m.name as manager_name FROM employees e LEFT JOIN employees m ON e.manager_id = m.employee_id;",queryType:"join",intent:"自连接-左连接",fields:["name","manager_id","employees"],conditions:[],difficulty:"advanced",tags:["left_join","self_join","manager"],source:"manual"},{id:"join_left_006",naturalQuery:"查询所有类别及其产品数量（包括没有产品的类别）",sqlQuery:"SELECT categories.category_name, COUNT(products.product_id) as product_count FROM categories LEFT JOIN products ON categories.category_id = products.category_id GROUP BY categories.category_id, categories.category_name;",queryType:"join",intent:"左连接+聚合",fields:["category_name","products","categories"],conditions:[],difficulty:"advanced",tags:["left_join","count","group_by"],source:"manual"},{id:"join_left_007",naturalQuery:"查询所有部门及其员工数（包括没有员工的部门）",sqlQuery:"SELECT departments.department_name, COUNT(employees.employee_id) as employee_count FROM departments LEFT JOIN employees ON departments.department_id = employees.department_id GROUP BY departments.department_id, departments.department_name;",queryType:"join",intent:"左连接+聚合",fields:["department_name","employees","departments"],conditions:[],difficulty:"advanced",tags:["left_join","count","group_by"],source:"manual"},{id:"join_left_008",naturalQuery:"查询所有订单及其支付状态（包括未支付的订单）",sqlQuery:"SELECT orders.order_id, payments.payment_status FROM orders LEFT JOIN payments ON orders.order_id = payments.order_id;",queryType:"join",intent:"左连接",fields:["order_id","payment_status","orders","payments"],conditions:[],difficulty:"intermediate",tags:["left_join","payment","order"],source:"manual"}],Ks=[{id:"join_multi_001",naturalQuery:"查询订单、客户和产品的完整信息",sqlQuery:"SELECT orders.order_id, customers.customer_name, products.product_name, order_items.quantity FROM ((orders INNER JOIN customers ON orders.customer_id = customers.customer_id) INNER JOIN order_items ON orders.order_id = order_items.order_id) INNER JOIN products ON order_items.product_id = products.product_id;",queryType:"join",intent:"多表连接",fields:["orders","customers","products","order_items"],conditions:[],reasoningSteps:["识别需求：获取订单的完整信息","确定涉及的表：orders, customers, order_items, products","规划连接顺序：orders -> customers -> order_items -> products","每个连接都有对应的ON条件"],difficulty:"advanced",tags:["multi_join","orders","products"],source:"manual"},{id:"join_multi_002",naturalQuery:"查询员工、部门、地区的信息",sqlQuery:"SELECT employees.name, departments.department_name, regions.region_name FROM ((employees INNER JOIN departments ON employees.department_id = departments.department_id) INNER JOIN regions ON departments.region_id = regions.region_id);",queryType:"join",intent:"多表连接",fields:["name","department_name","region_name","employees","departments","regions"],conditions:[],difficulty:"advanced",tags:["multi_join","employee","department"],source:"manual"},{id:"join_multi_003",naturalQuery:"查询每个订单的总金额和客户名称",sqlQuery:"SELECT orders.order_id, customers.customer_name, SUM(order_items.price * order_items.quantity) as order_total FROM orders INNER JOIN customers ON orders.customer_id = customers.customer_id INNER JOIN order_items ON orders.order_id = order_items.order_id GROUP BY orders.order_id, customers.customer_name;",queryType:"join",intent:"多表连接+聚合",fields:["orders","customers","order_items"],conditions:[],reasoningSteps:["识别需求：计算每个订单的总金额","连接表：orders, customers, order_items","聚合计算：SUM(price * quantity)","分组：GROUP BY order_id, customer_name"],difficulty:"advanced",tags:["multi_join","sum","group_by"],source:"manual"},{id:"join_multi_004",naturalQuery:"查询员工的姓名、部门名称和经理姓名",sqlQuery:"SELECT e.name as employee_name, d.department_name, m.name as manager_name FROM employees e INNER JOIN departments d ON e.department_id = d.department_id LEFT JOIN employees m ON e.manager_id = m.employee_id;",queryType:"join",intent:"多表连接",fields:["name","department_name","employees","departments"],conditions:[],reasoningSteps:["识别需求：获取员工、部门和经理信息","连接1：INNER JOIN departments（员工必属于部门）","连接2：LEFT JOIN employees（经理可能为空）"],difficulty:"advanced",tags:["multi_join","manager","department"],source:"manual"},{id:"join_multi_005",naturalQuery:"查询购买了特定类别产品的客户",sqlQuery:"SELECT DISTINCT customers.customer_name FROM customers INNER JOIN orders ON customers.customer_id = orders.customer_id INNER JOIN order_items ON orders.order_id = order_items.order_id INNER JOIN products ON order_items.product_id = products.product_id WHERE products.category = '电子产品';",queryType:"join",intent:"多表连接+过滤",fields:["customer_name","customers","orders","order_items","products"],conditions:["category = '电子产品'"],difficulty:"advanced",tags:["multi_join","where","category"],source:"manual"},{id:"join_multi_006",naturalQuery:"查询每个部门的员工数、平均工资和部门名称",sqlQuery:"SELECT departments.department_name, COUNT(employees.employee_id) as employee_count, AVG(employees.salary) as avg_salary FROM departments LEFT JOIN employees ON departments.department_id = employees.department_id GROUP BY departments.department_id, departments.department_name;",queryType:"join",intent:"多表连接+聚合",fields:["department_name","employees","departments"],conditions:[],difficulty:"advanced",tags:["multi_join","count","avg"],source:"manual"},{id:"join_multi_007",naturalQuery:"查询订单日期、客户名称、产品名称和数量",sqlQuery:"SELECT orders.order_date, customers.customer_name, products.product_name, order_items.quantity FROM orders INNER JOIN customers ON orders.customer_id = customers.customer_id INNER JOIN order_items ON orders.order_id = order_items.order_id INNER JOIN products ON order_items.product_id = products.product_id ORDER BY orders.order_date DESC;",queryType:"join",intent:"多表连接+排序",fields:["order_date","customer_name","product_name","orders","customers","products","order_items"],conditions:[],difficulty:"advanced",tags:["multi_join","order_by","date"],source:"manual"}],Xs=[{id:"subquery_001",naturalQuery:"查询工资高于平均工资的员工",sqlQuery:"SELECT * FROM employees WHERE salary > (SELECT AVG(salary) FROM employees);",queryType:"complex",intent:"子查询-比较",fields:["salary","employees"],conditions:[],reasoningSteps:["识别需求：找出高薪员工","先计算平均工资：SELECT AVG(salary) FROM employees","再比较：WHERE salary > (子查询结果)"],difficulty:"advanced",tags:["subquery","avg","comparison"],source:"manual"},{id:"subquery_002",naturalQuery:'查询与"张三"在同一部门的员工',sqlQuery:"SELECT * FROM employees WHERE department = (SELECT department FROM employees WHERE name = '张三') AND name != '张三';",queryType:"complex",intent:"子查询-匹配",fields:["department","name","employees"],conditions:["name != '张三'"],reasoningSteps:["识别需求：找出同部门的其他员工",'先找到张三的部门：SELECT department FROM employees WHERE name = "张三"',"再查找同部门员工：WHERE department = (子查询)",'排除张三自己：AND name != "张三"'],difficulty:"advanced",tags:["subquery","department","filter"],source:"manual"},{id:"subquery_003",naturalQuery:"查询购买过产品ID为1的所有客户",sqlQuery:"SELECT * FROM customers WHERE customer_id IN (SELECT customer_id FROM orders WHERE order_id IN (SELECT order_id FROM order_items WHERE product_id = 1));",queryType:"complex",intent:"嵌套子查询",fields:["customer_id","customers","orders","order_items"],conditions:[],reasoningSteps:["识别需求：找到购买特定产品的客户","最内层：找到包含该产品的订单项","中间层：找到对应的订单","最外层：找到下单的客户","使用IN连接多层子查询"],difficulty:"advanced",tags:["subquery","nested","in"],source:"manual"},{id:"subquery_004",naturalQuery:"查询销售额最高的产品类别",sqlQuery:"SELECT category_name FROM categories WHERE category_id = (SELECT category_id FROM products GROUP BY category_id ORDER BY SUM(price * stock_quantity) DESC LIMIT 1);",queryType:"complex",intent:"子查询-排序",fields:["category_name","categories","products"],conditions:[],reasoningSteps:["识别需求：找到最畅销的类别","先计算每个类别的销售额：GROUP BY category_id","排序并取第一：ORDER BY ... DESC LIMIT 1","再查询类别名称：WHERE category_id = (子查询)"],difficulty:"advanced",tags:["subquery","order_by","top"],source:"manual"},{id:"subquery_005",naturalQuery:"查询每个部门工资最高的员工",sqlQuery:"SELECT * FROM employees e1 WHERE salary = (SELECT MAX(salary) FROM employees e2 WHERE e2.department = e1.department);",queryType:"complex",intent:"相关子查询",fields:["salary","department","employees"],conditions:[],reasoningSteps:["识别需求：找出各部门的最高薪员工","相关子查询：对于每个员工e1，找出其部门的最高工资","比较：WHERE e1.salary = (子查询结果)","特点：子查询引用外层查询的表"],difficulty:"advanced",tags:["subquery","correlated","max"],source:"manual"},{id:"subquery_006",naturalQuery:"查询没有下订单的客户",sqlQuery:"SELECT * FROM customers WHERE NOT EXISTS (SELECT * FROM orders WHERE orders.customer_id = customers.customer_id);",queryType:"complex",intent:"NOT EXISTS子查询",fields:["customers","orders"],conditions:[],reasoningSteps:["识别需求：找出从未下单的客户","使用NOT EXISTS：检查是否不存在订单","子查询：SELECT * FROM orders WHERE customer_id匹配","优势：效率比IN某些情况更高"],difficulty:"advanced",tags:["subquery","not_exists","filter"],source:"manual"},{id:"subquery_007",naturalQuery:"查询订单金额大于部门平均工资的订单",sqlQuery:"SELECT * FROM orders WHERE total_amount > (SELECT AVG(salary) FROM employees);",queryType:"complex",intent:"跨表子查询",fields:["total_amount","orders","employees"],conditions:[],difficulty:"advanced",tags:["subquery","cross_table","comparison"],source:"manual"},{id:"subquery_008",naturalQuery:"查询至少下过3次订单的客户",sqlQuery:"SELECT * FROM customers WHERE (SELECT COUNT(*) FROM orders WHERE orders.customer_id = customers.customer_id) >= 3;",queryType:"complex",intent:"子查询-聚合条件",fields:["customers","orders"],conditions:[],reasoningSteps:["识别需求：找出活跃客户","子查询：计算每个客户的订单数 COUNT(*)","条件：订单数 >= 3"],difficulty:"advanced",tags:["subquery","count","filter"],source:"manual"}],Zs=[{id:"window_001",naturalQuery:"查询每个部门的员工及其工资排名",sqlQuery:"SELECT name, department, salary, RANK() OVER (PARTITION BY department ORDER BY salary DESC) as salary_rank FROM employees;",queryType:"complex",intent:"窗口函数-排名",fields:["name","department","salary","employees"],conditions:[],reasoningSteps:["识别需求：计算部门内的工资排名","窗口函数：RANK() - 排名函数","分区：PARTITION BY department - 按部门分组","排序：ORDER BY salary DESC - 工资降序"],difficulty:"advanced",tags:["window_function","rank","partition"],source:"manual"},{id:"window_002",naturalQuery:"查询每个员工的工资及其部门平均工资",sqlQuery:"SELECT name, department, salary, AVG(salary) OVER (PARTITION BY department) as dept_avg_salary FROM employees;",queryType:"complex",intent:"窗口函数-聚合",fields:["name","department","salary","employees"],conditions:[],reasoningSteps:["识别需求：显示员工工资和部门平均工资","窗口函数：AVG(salary) OVER (...)","分区：PARTITION BY department - 按部门计算","特点：不使用GROUP BY，保留所有行"],difficulty:"advanced",tags:["window_function","avg","partition"],source:"manual"},{id:"window_003",naturalQuery:"计算每个员工的累计销售额",sqlQuery:"SELECT employee_id, sale_date, amount, SUM(amount) OVER (PARTITION BY employee_id ORDER BY sale_date) as cumulative_sales FROM sales;",queryType:"complex",intent:"窗口函数-累计",fields:["employee_id","sale_date","amount","sales"],conditions:[],reasoningSteps:["识别需求：计算每个销售员的累计业绩","窗口函数：SUM(amount) OVER (...)","分区：PARTITION BY employee_id - 按员工分组","排序：ORDER BY sale_date - 按日期累计"],difficulty:"advanced",tags:["window_function","sum","cumulative"],source:"manual"},{id:"window_004",naturalQuery:"查询每行记录的行号",sqlQuery:"SELECT name, department, salary, ROW_NUMBER() OVER (ORDER BY salary DESC) as row_num FROM employees;",queryType:"complex",intent:"窗口函数-行号",fields:["name","department","salary","employees"],conditions:[],reasoningSteps:["识别需求：给记录编号","窗口函数：ROW_NUMBER() - 生成唯一行号","排序：ORDER BY salary DESC - 按工资降序编号"],difficulty:"advanced",tags:["window_function","row_number","order"],source:"manual"},{id:"window_005",naturalQuery:"查询每个产品类别的销售额及其在总销售额中的占比",sqlQuery:"SELECT category, SUM(price * stock_quantity) as category_sales, SUM(price * stock_quantity) OVER () as total_sales, SUM(price * stock_quantity) / SUM(price * stock_quantity) OVER () as sales_ratio FROM products GROUP BY category;",queryType:"complex",intent:"窗口函数-占比",fields:["category","price","stock_quantity","products"],conditions:[],reasoningSteps:["识别需求：计算各类别销售额占比","聚合：GROUP BY category, SUM(...)","窗口函数：SUM(...) OVER () - 总销售额（无分区）","计算占比：category_sales / total_sales"],difficulty:"advanced",tags:["window_function","ratio","total"],source:"manual"},{id:"window_006",naturalQuery:"查询每个员工前一笔和后一笔的销售记录",sqlQuery:"SELECT employee_id, sale_date, amount, LAG(amount) OVER (PARTITION BY employee_id ORDER BY sale_date) as prev_amount, LEAD(amount) OVER (PARTITION BY employee_id ORDER BY sale_date) as next_amount FROM sales;",queryType:"complex",intent:"窗口函数-偏移",fields:["employee_id","sale_date","amount","sales"],conditions:[],reasoningSteps:["识别需求：访问相邻行的数据","LAG：取前一行的值","LEAD：取后一行的值","分区和排序：PARTITION BY employee_id ORDER BY sale_date"],difficulty:"advanced",tags:["window_function","lag","lead"],source:"manual"},{id:"window_007",naturalQuery:"查询每个部门工资前三名的员工",sqlQuery:"SELECT * FROM (SELECT name, department, salary, DENSE_RANK() OVER (PARTITION BY department ORDER BY salary DESC) as rank FROM employees) ranked WHERE rank <= 3;",queryType:"complex",intent:"窗口函数-Top-N",fields:["name","department","salary","employees"],conditions:[],reasoningSteps:["识别需求：找出各部门Top 3员工","内层查询：使用DENSE_RANK()计算排名","外层查询：WHERE rank <= 3过滤","使用DENSE_RANK而非RANK：处理并列情况"],difficulty:"advanced",tags:["window_function","dense_rank","top_n"],source:"manual"}],er=[{id:"combined_001",naturalQuery:"查询所有客户和员工的姓名（合并结果）",sqlQuery:"SELECT customer_name as name, 'customer' as type FROM customers UNION ALL SELECT name, 'employee' as type FROM employees;",queryType:"complex",intent:"UNION合并",fields:["customer_name","name","customers","employees"],conditions:[],reasoningSteps:["识别需求：合并客户和员工的姓名","使用UNION ALL：合并两个查询结果（保留重复）","添加类型列：区分来源","确保列数和类型匹配"],difficulty:"intermediate",tags:["union","combine","merge"],source:"manual"},{id:"combined_002",naturalQuery:"查询工资大于5000的员工和销售额大于10000的订单（去重）",sqlQuery:'SELECT name, salary as amount, "employee" as type FROM employees WHERE salary > 5000 UNION SELECT order_id, total_amount, "order" as type FROM orders WHERE total_amount > 10000;',queryType:"complex",intent:"UNION去重",fields:["name","salary","employees","orders"],conditions:["salary > 5000","total_amount > 10000"],reasoningSteps:["识别需求：合并高薪员工和大额订单","使用UNION（非ALL）：自动去重","确保列数和数据类型匹配","添加类型列区分来源"],difficulty:"intermediate",tags:["union","filter","combine"],source:"manual"},{id:"combined_003",naturalQuery:"查询北京的客户和北京的员工",sqlQuery:"SELECT customer_name as name, 'customer' as type FROM customers WHERE city = '北京' UNION ALL SELECT name, 'employee' as type FROM employees WHERE city = '北京';",queryType:"complex",intent:"UNION条件合并",fields:["customer_name","name","city","customers","employees"],conditions:["city = '北京'"],difficulty:"intermediate",tags:["union","where","city"],source:"manual"},{id:"combined_004",naturalQuery:"查询产品价格大于平均值的产品，和库存为0的产品",sqlQuery:"SELECT product_name, 'high_price' as reason FROM products WHERE price > (SELECT AVG(price) FROM products) UNION ALL SELECT product_name, 'out_of_stock' as reason FROM products WHERE stock_quantity = 0;",queryType:"complex",intent:"UNION多条件",fields:["product_name","price","stock_quantity","products"],conditions:[],reasoningSteps:["识别需求：找出高价格和缺货产品","第一个查询：price > 平均值","第二个查询：stock_quantity = 0","使用UNION ALL合并，添加原因列"],difficulty:"advanced",tags:["union","subquery","filter"],source:"manual"},{id:"combined_005",naturalQuery:"查询每个客户的订单数，包括没有订单的客户",sqlQuery:"SELECT customers.customer_name, COUNT(orders.order_id) as order_count FROM customers LEFT JOIN orders ON customers.customer_id = orders.customer_id GROUP BY customers.customer_id, customers.customer_name UNION ALL SELECT 'Total', COUNT(*) FROM orders;",queryType:"complex",intent:"UNION总计",fields:["customer_name","customers","orders"],conditions:[],reasoningSteps:["识别需求：统计每个客户订单数，并添加总计行","第一个查询：LEFT JOIN统计每个客户","第二个查询：计算总订单数","使用UNION ALL添加总计行"],difficulty:"advanced",tags:["union","group_by","total"],source:"manual"}],zt=[...Ps,...Bs,...Vs,...Gs,...Hs,...Ws,...zs,...Ys,...Js,...Ks,...Xs,...Zs,...er],Nt={};zt.forEach(u=>{u.tags.forEach(e=>{Nt[e]||(Nt[e]=[]),Nt[e].push(u)})});const ne=class ne{validateSyntax(e){try{if(!e||e.trim().length===0)return{valid:!1,error:"SQL语句为空"};const s=this.normalizeSQL(e);if(!this.hasValidStructure(s))return{valid:!1,error:"SQL语句缺少必要的子句（SELECT, FROM等）"};if(!this.areBracketsBalanced(s))return{valid:!1,error:"SQL语句中括号不匹配"};if(!this.areQuotesBalanced(s))return{valid:!1,error:"SQL语句中引号不匹配"};const r=this.validateKeywordOrder(s);return r.valid?typeof alasql<"u"?this.validateWithAlaSQL(e):{valid:!0}:r}catch(s){return{valid:!1,error:s instanceof Error?s.message:String(s)}}}checkInjection(e){const s=[],r=[];let a="low";for(const{pattern:n,type:l,severity:o}of ne.INJECTION_PATTERNS){const c=e.match(n);c&&(r.push(l),s.push(...c),this.compareSeverity(o,a)>0&&(a=o))}return e.split(";").filter(n=>n.trim().length>0).length>1&&(r.push("multi_statement"),s.push("检测到多条SQL语句"),a="high"),{detected:s.length>0,types:[...new Set(r)],patterns:[...new Set(s)],severity:a}}validateIdentifiers(e,s){const r=[],a=[],i=[],n=[],l=this.extractTableNames(e);for(const c of l){const d=c.toLowerCase()in s.tables||Object.keys(s.tables).some(h=>h.toLowerCase()===c.toLowerCase());r.push({name:c,exists:d,position:"FROM/JOIN子句"}),d||i.push(c)}const o=this.extractColumnNames(e);for(const c of o){let d=!1,h="";for(const[m,f]of Object.entries(s.tables))if(f.columns.some(p=>p.name.toLowerCase()===c.toLowerCase())){d=!0,h=m;break}a.push({name:c,exists:d,position:h||"未知"}),!d&&!c.includes("*")&&n.push(c)}return{tables:r,columns:a,missingTables:i,missingColumns:n}}validateComplexity(e,s=50){var f,p;const r=[];let a=0;const i=e.toUpperCase(),n=(i.match(/\b(INNER|LEFT|RIGHT|FULL|CROSS)\s+JOIN\b/g)||[]).length;if(n>0){const x=n*ne.COMPLEXITY_WEIGHTS.join;r.push({type:"join",score:x,description:`包含${n}个JOIN操作`}),a+=x}const l=(e.match(/\(.*\bSELECT\b/g)||[]).length;if(l>0){const x=l*ne.COMPLEXITY_WEIGHTS.subquery;r.push({type:"subquery",score:x,description:`包含${l}个子查询`}),a+=x}const o=i.match(/\b(SUM|AVG|COUNT|MAX|MIN|STDDEV|VARIANCE)\s*\(/g)||[];if(o.length>0){const x=o.length*ne.COMPLEXITY_WEIGHTS.aggregation;r.push({type:"aggregate",score:x,description:`使用${o.length}个聚合函数`}),a+=x}if(/\bGROUP\s+BY\b/.test(i)){const y=(((f=i.split(/\bGROUP\s+BY\b/)[1])==null?void 0:f.split(/\bORDER\s+BY\b|\bLIMIT\b|\bHAVING\b/)[0])||"").split(",").filter(R=>R.trim()).length,E=ne.COMPLEXITY_WEIGHTS.groupBy+y*2;r.push({type:"other",score:E,description:`按${y}列分组`}),a+=E}if(/\bORDER\s+BY\b/.test(i)){const y=(((p=i.split(/\bORDER\s+BY\b/)[1])==null?void 0:p.split(/\bLIMIT\b|\bOFFSET\b/)[0])||"").split(",").filter(R=>R.trim()).length,E=y*ne.COMPLEXITY_WEIGHTS.orderBy;r.push({type:"other",score:E,description:`按${y}列排序`}),a+=E}if(/\bHAVING\b/.test(i)){const x=ne.COMPLEXITY_WEIGHTS.having;r.push({type:"other",score:x,description:"使用HAVING子句"}),a+=x}const c=(i.match(/\bUNION\s+(ALL\s+)?/gi)||[]).length;if(c>0){const x=c*ne.COMPLEXITY_WEIGHTS.union;r.push({type:"union",score:x,description:`包含${c}个UNION操作`}),a+=x}const d=(i.match(/\bCASE\b/g)||[]).length;if(d>0){const x=d*ne.COMPLEXITY_WEIGHTS.case;r.push({type:"other",score:x,description:`包含${d}个CASE表达式`}),a+=x}const h=(i.match(/[A-Z_][A-Z0-9_]*\s*\(/g)||[]).length;if(h>0){const x=h*ne.COMPLEXITY_WEIGHTS.function;r.push({type:"other",score:x,description:`调用${h}个函数`}),a+=x}let m;return a<=15?m="simple":a<=30?m="medium":a<=60?m="complex":m="very_complex",{score:a,level:m,exceedsThreshold:a>s,factors:r}}detectDangerousOperations(e){const s=[];e.toUpperCase().replace(/\s+/g," ");for(const r of ne.DANGEROUS_KEYWORDS){const a=new RegExp(`\\b${r}\\b`,"gi");let i;for(;(i=a.exec(e))!==null;){const n=["DROP","TRUNCATE","DELETE"].includes(r)?"high":"medium";s.push({type:r,severity:n,position:`位置${i.index}`,description:this.getDangerousOperationDescription(r)})}}return s}extractTableNames(e){const s=[],r=e.toUpperCase(),a=r.match(/\bFROM\s+([^\s,]+)/gi);a&&a.forEach(n=>{const l=n.replace(/\bFROM\s+/i,"").replace(/[\[\]]/g,"");l&&!s.includes(l)&&s.push(l)});const i=r.match(/\b(?:INNER|LEFT|RIGHT|FULL|CROSS)?\s*JOIN\s+([^\s,]+)/gi);return i&&i.forEach(n=>{const l=n.replace(/\b(?:INNER|LEFT|RIGHT|FULL|CROSS)?\s*JOIN\s+/i,"").replace(/[\[\]]/g,"");l&&!s.includes(l)&&s.push(l)}),s}extractColumnNames(e){const s=[],r=e.replace(/'[^^']*'/g,"").replace(/"[^^"]*"/g,""),a=r.match(/SELECT\s+(.*?)\s+FROM/is);if(a&&a[1]){const n=a[1];this.splitSelectList(n).forEach(o=>{const c=this.extractColumnName(o);c&&!s.includes(c)&&s.push(c)})}const i=r.match(/WHERE\s+(.*?)(?:\s+GROUP\s+BY|\s+ORDER\s+BY|\s+LIMIT|$)/is);return i&&i[1]&&this.extractColumnsFromExpression(i[1]).forEach(l=>{l&&!s.includes(l)&&s.push(l)}),s}extractColumnsFromExpression(e){const s=[],r=/\b([a-zA-Z_][a-zA-Z0-9_]*|[\u4e00-\u9fa5]+)\b/g;let a;for(;(a=r.exec(e))!==null;){const i=a[1];!this.isKeyword(i)&&!this.isFunction(i)&&s.push(i)}return s}isKeyword(e){return ne.SQL_KEYWORDS.includes(e.toUpperCase())}isFunction(e){return["SUM","AVG","COUNT","MAX","MIN","STDDEV","VARIANCE","UPPER","LOWER","TRIM","SUBSTRING","CONCAT","DATE","YEAR","MONTH","DAY","NOW","CURDATE","CAST","CONVERT","COALESCE","NULLIF","ISNULL","ABS","ROUND","CEIL","FLOOR","POWER","SQRT"].includes(e.toUpperCase())}extractColumnName(e){const s=e.split(/\s+AS\s+/i)[0].trim(),a=(s.split(".").pop()||s).replace(/[\[\]]/g,"");return this.isFunction(a.split("(")[0])?"":a}splitSelectList(e){const s=[];let r="",a=0;for(let i=0;i<e.length;i++){const n=e[i];n==="("?(a++,r+=n):n===")"?(a--,r+=n):n===","&&a===0?(s.push(r.trim()),r=""):r+=n}return r.trim()&&s.push(r.trim()),s}normalizeSQL(e){return e.replace(/\s+/g," ").replace(/\s*,\s*/g,",").replace(/\s*\(\s*/g,"(").replace(/\s*\)\s*/g,")").trim().toUpperCase()}hasValidStructure(e){return!(!/\b(SELECT|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER|TRUNCATE)\b/i.test(e)||/\bSELECT\b/i.test(e)&&!/\bFROM\b/i.test(e)&&!/^\s*SELECT\s+[\d\s+,.*]+\s*$/i.test(e))}areBracketsBalanced(e){let s=0;for(const r of e)if(r==="(")s++;else if(r===")"&&(s--,s<0))return!1;return s===0}areQuotesBalanced(e){let s=!1,r=!1;for(let a=0;a<e.length;a++){const i=e[a],n=a>0?e[a-1]:"";i==="'"&&n!=="\\"&&(s=!s),i==='"'&&n!=="\\"&&(r=!r)}return!s&&!r}validateKeywordOrder(e){const s=this.normalizeSQL(e),r=["SELECT","FROM","JOIN","WHERE","GROUP BY","HAVING","ORDER BY","LIMIT"];let a=-1;for(const i of r){const n=s.indexOf(i);if(n!==-1){if(n<a)return{valid:!1,error:`关键字顺序错误: ${i} 应该在前面出现`};a=n}}return{valid:!0}}validateWithAlaSQL(e){try{return alasql.parse(e),{valid:!0}}catch(s){return{valid:!1,error:s instanceof Error?s.message:String(s)}}}compareSeverity(e,s){const r={low:0,medium:1,high:2,critical:3};return r[e]-r[s]}getDangerousOperationDescription(e){return{DROP:"删除表或数据库结构",TRUNCATE:"清空表中所有数据",DELETE:"删除表中数据",UPDATE:"修改表中数据",INSERT:"插入新数据",ALTER:"修改表结构",CREATE:"创建新表或数据库对象",GRANT:"授予用户权限",REVOKE:"撤销用户权限",EXEC:"执行存储过程或命令",EXECUTE:"执行存储过程或命令"}[e]||"危险操作"}};ne.INJECTION_PATTERNS=[{pattern:/('|('')|;|\-\-|\/\*|\*\/)/gi,type:"comment",severity:"medium"},{pattern:/(\b(or|and)\s+[\w\s]*?=\s*[\w\s]*?)/gi,type:"boolean_based",severity:"high"},{pattern:/(\bunion\s+select\b)/gi,type:"union_based",severity:"high"},{pattern:/(\b(exec|execute)\s+\w+)/gi,type:"command_execution",severity:"critical"},{pattern:/(\bxp_|sp_)\w+/gi,type:"stored_procedure",severity:"critical"},{pattern:/\bwaitfor\s+delay\b/gi,type:"time_based",severity:"high"},{pattern:/(\b(cast|convert)\s*\(.*?\s+as\s+int\b)/gi,type:"error_based",severity:"high"},{pattern:/(\b(load_file|into\s+outfile)\b)/gi,type:"file_access",severity:"critical"},{pattern:/(<|>|<<|>>|\^|\|)/,type:"bitwise_operator",severity:"low"},{pattern:/(\b(eval|execute)\s*\()/gi,type:"dynamic_execution",severity:"critical"}],ne.DANGEROUS_KEYWORDS=["DROP","TRUNCATE","DELETE","UPDATE","INSERT","ALTER","CREATE","GRANT","REVOKE","EXEC","EXECUTE"],ne.COMPLEXITY_WEIGHTS={join:10,subquery:15,aggregation:5,groupBy:5,orderBy:3,having:7,union:10,case:5,function:2,nestedFunction:5},ne.SQL_KEYWORDS=["SELECT","FROM","WHERE","JOIN","INNER","LEFT","RIGHT","FULL","OUTER","ON","AND","OR","NOT","IN","LIKE","BETWEEN","NULL","IS","ORDER","BY","GROUP","HAVING","LIMIT","OFFSET","TOP","INSERT","INTO","VALUES","UPDATE","SET","DELETE","CREATE","TABLE","DROP","ALTER","TRUNCATE","UNION","INTERSECT","EXCEPT","DISTINCT","SUM","AVG","COUNT","MAX","MIN","STDDEV","VARIANCE","CASE","WHEN","THEN","ELSE","END","AS","ASC","DESC","WITH","ROLLUP","CUBE"];let Et=ne;class tr{validateStructure(e,s){if(!e.data||e.data.length===0)return{matches:!0,actualColumns:[]};const r=Object.keys(e.data[0]);if(!s)return{matches:!0,actualColumns:r};const a=Array.isArray(s)?s:[],i=a.filter(o=>!r.includes(o)),n=r.filter(o=>!a.includes(o));return{matches:i.length===0,expectedColumns:a,actualColumns:r,missingColumns:i.length>0?i:void 0,extraColumns:n.length>0?n:void 0}}validateRange(e,s){const r=[];return!e.data||e.data.length===0?{inRange:!0,outOfRangeValues:[]}:(e.data.forEach((a,i)=>{Object.entries(a).forEach(([n,l])=>{if(typeof l=="number"&&s[n]){const{min:o,max:c}=s[n];o!==void 0&&l<o&&r.push({column:n,rowIndex:i,actualValue:l,min:o}),c!==void 0&&l>c&&r.push({column:n,rowIndex:i,actualValue:l,max:c})}})}),{inRange:r.length===0,outOfRangeValues:r})}validateConsistency(e,s){const r=[];if(!s||s.length===0)return{consistent:!0,score:100,inconsistencies:[]};if(!e.data||e.data.length===0)return{consistent:!0,score:100,inconsistencies:[]};const a=Object.keys(e.data[0]);for(const n of s){if(!n.data||n.data.length===0)continue;const l=n.columns||Object.keys(n.data[0]);a.length!==l.length&&r.push({column:"*",issue:`列数不一致: 当前${a.length}列，历史${l.length}列`,severity:"medium"});const o=a.filter(h=>!l.includes(h)),c=l.filter(h=>!a.includes(h));o.length>0&&r.push({column:o.join(", "),issue:`新增列: ${o.join(", ")}`,severity:"low"}),c.length>0&&r.push({column:c.join(", "),issue:`缺失列: ${c.join(", ")}`,severity:"medium"});const d=Math.abs(e.rowCount-n.rowCount)/n.rowCount;d>.5&&r.push({column:"*",issue:`行数显著变化: 当前${e.rowCount}行，历史${n.rowCount}行 (${Math.round(d*100)}%差异)`,severity:"low"})}let i=100;return r.forEach(n=>{n.severity==="high"?i-=20:n.severity==="medium"?i-=10:n.severity==="low"&&(i-=5)}),{consistent:r.length===0,score:Math.max(0,i),inconsistencies:r}}detectOutliers(e){const s=[];if(!e.data||e.data.length<3)return{detected:!1,outliers:[]};const r=Object.keys(e.data[0]);for(const a of r){const i=e.data.map(p=>p[a]).filter(p=>typeof p=="number");if(i.length<3)continue;const n=[...i].sort((p,x)=>p-x),l=Math.floor(n.length*.25),o=Math.floor(n.length*.75),c=n[l],d=n[o],h=d-c,m=c-1.5*h,f=d+1.5*h;e.data.forEach((p,x)=>{const y=p[a];if(typeof y=="number"&&(y<m||y>f)){const E=i.reduce((k,P)=>k+P,0)/i.length,R=i.reduce((k,P)=>k+Math.pow(P-E,2),0)/i.length,F=Math.sqrt(R),D=Math.abs((y-E)/F);s.push({column:a,rowIndex:x,value:y,deviation:D})}})}return{detected:s.length>0,outliers:s}}checkNullRatio(e){const s={};if(!e.data||e.data.length===0)return s;const r=Object.keys(e.data[0]);for(const a of r){const i=e.data.filter(n=>{const l=n[a];return l==null||l===""}).length;s[a]={count:i,ratio:i/e.rowCount}}return s}validateDataTypeConsistency(e){const s={};if(!e.data||e.data.length===0)return s;const r=Object.keys(e.data[0]);for(const a of r){const i=new Set;e.data.forEach(n=>{const l=n[a];let o=typeof l;o==="number"?o=Number.isInteger(l)?"integer":"float":o==="string"&&(isNaN(Date.parse(l))||(o="date")),i.add(o)}),s[a]={consistent:i.size<=1,types:i}}return s}detectDuplicates(e){if(!e.data||e.data.length===0)return{count:0,ratio:0,duplicates:[]};const s=new Set,r=[];return e.data.forEach(a=>{const i=JSON.stringify(a);s.has(i)?r.push(a):s.add(i)}),{count:r.length,ratio:r.length/e.rowCount,duplicates:r}}validateNumericPrecision(e){const s={};if(!e.data||e.data.length===0)return s;const r=Object.keys(e.data[0]);for(const a of r){const i=e.data.map(l=>l[a]).filter(l=>typeof l=="number"&&!Number.isInteger(l));if(i.length===0)continue;let n=0;i.forEach(l=>{const c=l.toString().split(".")[1];c&&(n=Math.max(n,c.length))}),s[a]={maxPrecision:n,hasIssues:n>10}}return s}}class sr{detectFieldHallucination(e,s){const r=[];if(!e.sqlQuery)return[{type:"field",issue:"没有SQL查询",severity:"high",suggestion:"请提供SQL查询"}];const a=this.extractFieldsFromSQL(e.sqlQuery),i=new Set;return Object.values(s.tables).forEach(n=>{n.columns.forEach(l=>{i.add(l.name.toLowerCase()),i.add(l.name.toUpperCase())})}),a.forEach(n=>{const l=n.toLowerCase();if(n==="*"||this.isFunction(n))return;let o=!1,c="";if(i.has(l))o=!0;else{const d=this.findSimilarField(l,i);d?(o=!1,c=`可能是指 "${d}"`):(o=!1,c="该字段在数据库中不存在")}o||r.push({type:"field",issue:`字段 "${n}" 不存在`,severity:"high",suggestion:c})}),r}detectTableHallucination(e,s){const r=[];if(!e.sqlQuery)return[{type:"table",issue:"没有SQL查询",severity:"high",suggestion:"请提供SQL查询"}];const a=this.extractTablesFromSQL(e.sqlQuery),i=new Set(Object.keys(s.tables).map(n=>n.toLowerCase()));return a.forEach(n=>{const l=n.toLowerCase();if(!i.has(l)){const o=this.findSimilarTable(l,i),c=o?`可能是指表 "${o}"`:"该表在数据库中不存在";r.push({type:"table",issue:`表 "${n}" 不存在`,severity:"high",suggestion:c})}}),r}detectValueHallucination(e,s){const r=[];return this.extractLiteralValues(e.sqlQuery).forEach(({value:i,position:n})=>{typeof i=="number"&&(this.isSuspiciousNumber(i)&&r.push({type:"value",issue:`可疑的数值: ${i} 在 ${n}`,severity:"medium",position:n,suggestion:"请确认这个数值是否正确"}),this.isCommonHallucinatedValue(i)&&r.push({type:"value",issue:`常见的幻觉数值: ${i}`,severity:"medium",position:n,suggestion:"请验证这个数值的来源"}))}),e.result&&e.result.data&&this.detectNumericOutliers(e.result.data).forEach(n=>{r.push({type:"value",issue:`结果中的异常值: ${n.value} (列: ${n.column}, 行: ${n.rowIndex})`,severity:n.severity,suggestion:"该值可能是计算错误或数据问题"})}),e.confidence!==void 0&&e.confidence<.7&&r.push({type:"value",issue:`AI置信度较低: ${Math.round(e.confidence*100)}%`,severity:"low",suggestion:"建议人工审核结果"}),r}detectLogicHallucination(e,s){const r=[];if(!e.sqlQuery)return[{type:"logic",issue:"没有SQL查询",severity:"high",suggestion:"请提供SQL查询"}];const a=e.sqlQuery.toUpperCase();if(this.hasContradictoryConditions(a)&&r.push({type:"logic",issue:"查询条件可能存在矛盾",severity:"medium",suggestion:"请检查WHERE子句中的条件是否相互矛盾"}),this.hasRiskyEmptyResultOperation(a)&&r.push({type:"logic",issue:"查询可能返回空结果，但使用了聚合函数",severity:"low",suggestion:"考虑添加COALESCE或IFNULL处理"}),s.originalQuery){const o=s.originalQuery.toLowerCase(),c=a.toLowerCase();(o.includes("同时")||o.includes("并且")||o.includes("都"))&&c.includes(" or ")&&!c.includes(" and ")&&r.push({type:"logic",issue:'查询要求"同时满足"但使用了OR而不是AND',severity:"high",suggestion:"应该使用AND而不是OR"}),(o.includes("或者")||o.includes("或")||o.includes("任意"))&&c.includes(" and ")&&!c.includes(" or ")&&r.push({type:"logic",issue:'查询要求"或者"但使用了AND而不是OR',severity:"high",suggestion:"应该使用OR而不是AND"})}const i=this.detectJoinLogicIssues(a,s.schema);r.push(...i);const n=this.detectAggregationLogicIssues(a);r.push(...n);const l=this.detectSubqueryLogicIssues(a);if(r.push(...l),e.reasoning){const o=this.validateReasoning(e.reasoning,e.sqlQuery);r.push(...o)}return r}calculateHallucinationScore(e,s){let r=0;const a=this.detectFieldHallucination(e,s.schema),i=this.detectTableHallucination(e,s.schema),n=this.detectValueHallucination(e,s),l=this.detectLogicHallucination(e,s);return[...a,...i,...n,...l].forEach(c=>{switch(c.severity){case"critical":r+=30;break;case"high":r+=20;break;case"medium":r+=10;break;case"low":r+=5;break}}),Math.min(100,r)}extractFieldsFromSQL(e){const s=[],r=e.replace(/'[^^']*'/g,"").replace(/"[^^"]*"/g,""),a=r.match(/SELECT\s+(.*?)\s+FROM/is);if(a&&a[1]){const l=a[1];this.splitByCommaOutsideParentheses(l).forEach(c=>{const d=this.extractFieldName(c);d&&d!=="*"&&s.push(d)})}const i=r.match(/WHERE\s+(.*?)(?:\s+GROUP\s+BY|\s+ORDER\s+BY|\s+LIMIT|$)/is);if(i&&i[1]){const l=this.extractFieldsFromExpression(i[1]);s.push(...l)}const n=r.match(/ON\s+([\s\S]*?)(?:\s+(?:LEFT|RIGHT|INNER|OUTER)?\s*JOIN|WHERE|$)/gi);return n&&n.forEach(l=>{const o=l.replace(/\bON\s+/i,""),c=this.extractFieldsFromExpression(o);s.push(...c)}),[...new Set(s)]}extractTablesFromSQL(e){const s=[],r=e.toUpperCase(),a=r.match(/\bFROM\s+([^\s,]+)/gi);a&&a.forEach(n=>{const l=n.replace(/\bFROM\s+/i,"").replace(/[\[\]]/g,"");l&&s.push(l)});const i=r.match(/\b(?:INNER|LEFT|RIGHT|FULL|CROSS)?\s*JOIN\s+([^\s,]+)/gi);return i&&i.forEach(n=>{const l=n.replace(/\b(?:INNER|LEFT|RIGHT|FULL|CROSS)?\s*JOIN\s+/i,"").replace(/[\[\]]/g,"");l&&s.push(l)}),[...new Set(s)]}extractFieldsFromExpression(e){const s=[],r=/([a-zA-Z_][a-zA-Z0-9_]*|[\u4e00-\u9fa5]+)/g;let a;for(;(a=r.exec(e))!==null;){const i=a[1];!this.isKeyword(i)&&!this.isFunction(i)&&s.push(i)}return s}extractFieldName(e){const s=e.split(/\s+AS\s+/i)[0].trim();return(s.split(".").pop()||s).replace(/[\[\]]/g,"")}splitByCommaOutsideParentheses(e){const s=[];let r="",a=0;for(let i=0;i<e.length;i++){const n=e[i];if(n==="(")a++;else if(n===")")a--;else if(n===","&&a===0){s.push(r.trim()),r="";continue}r+=n}return r.trim()&&s.push(r.trim()),s}findSimilarField(e,s){let r=null,a=1/0;for(const i of s){const n=this.levenshteinDistance(e,i);n<a&&n<=3&&(a=n,r=i)}return r}findSimilarTable(e,s){let r=null,a=1/0;for(const i of s){const n=this.levenshteinDistance(e,i);n<a&&n<=3&&(a=n,r=i)}return r}levenshteinDistance(e,s){const r=e.length,a=s.length,i=Array(r+1).fill(null).map(()=>Array(a+1).fill(0));for(let n=0;n<=r;n++)i[n][0]=n;for(let n=0;n<=a;n++)i[0][n]=n;for(let n=1;n<=r;n++)for(let l=1;l<=a;l++)e[n-1]===s[l-1]?i[n][l]=i[n-1][l-1]:i[n][l]=Math.min(i[n-1][l]+1,i[n][l-1]+1,i[n-1][l-1]+1);return i[r][a]}extractLiteralValues(e){const s=[],r=/\b(\d+\.?\d*)\b/g;let a;for(;(a=r.exec(e))!==null;)s.push({value:parseFloat(a[1]),position:`位置${a.index}`});const i=/'([^']*)'/g;for(;(a=i.exec(e))!==null;)s.push({value:a[1],position:`位置${a.index}`});return s}isSuspiciousNumber(e){return!!(Math.abs(e)>1e10||Math.abs(e)<1e-10&&e!==0||[42,666,777,12345,9999].includes(e))}isCommonHallucinatedValue(e){return[0,1,100,-1,999].includes(e)}detectNumericOutliers(e){const s=[];return e.length===0||Object.keys(e[0]).forEach(a=>{const i=e.map((d,h)=>({value:d[a],rowIndex:h})).filter(d=>typeof d.value=="number");if(i.length<3)return;const n=i.map(d=>d.value),l=n.reduce((d,h)=>d+h,0)/n.length,o=n.reduce((d,h)=>d+Math.pow(h-l,2),0)/n.length,c=Math.sqrt(o);i.forEach(({value:d,rowIndex:h})=>{const m=Math.abs((d-l)/c);m>3&&s.push({value:d,column:a,rowIndex:h,severity:m>5?"high":m>4?"medium":"low"})})}),s}hasContradictoryConditions(e){const s=[/(\w+)\s*>\s*(\d+)\s+AND\s+\1\s*<\s*(\d+)/gi,/(\w+)\s*=\s*'?(\w+)'?\s+AND\s+\1\s*!=\s*'?(\w+)'?/gi,/(\w+)\s+IS\s+NOT\s+NULL\s+AND\s+\1\s+IS\s+NULL/gi];for(const r of s)if(r.test(e))return!0;return!1}hasRiskyEmptyResultOperation(e){return[/SUM\s*\([^)]+\)\s*\/\s*COUNT\s*\([^)]+\)/gi,/AVG\s*\([^)]+\)\s*\*\s*COUNT\s*\([^)]+\)/gi].some(r=>r.test(e))}detectJoinLogicIssues(e,s){const r=[];return/\bJOIN\s+\w+/i.test(e)&&!/\bON\b/i.test(e)&&r.push({type:"logic",issue:"JOIN语句缺少ON条件",severity:"high",suggestion:"请添加ON条件指定关联关系"}),/\bFROM\s+\w+\s*,\s*\w+/i.test(e)&&!/\bWHERE\b/i.test(e)&&r.push({type:"logic",issue:"可能产生笛卡尔积（缺少WHERE条件）",severity:"medium",suggestion:"请添加适当的WHERE条件"}),r}detectAggregationLogicIssues(e){const s=[],r=/\b(SUM|AVG|COUNT|MAX|MIN)\s*\(/i.test(e),a=/\bGROUP\s+BY\b/i.test(e);if(r&&!a){const i=e.match(/SELECT\s+(.*?)\s+FROM/i);i&&i[1]&&this.splitByCommaOutsideParentheses(i[1]).length>1&&s.push({type:"logic",issue:"查询包含聚合函数但没有GROUP BY，可能导致错误结果",severity:"medium",suggestion:"考虑添加GROUP BY或移除非聚合列"})}return s}detectSubqueryLogicIssues(e){const s=[],r=(e.match(/\(.*\bSELECT\b/gi)||[]).length;return r>3&&s.push({type:"logic",issue:`包含${r}个子查询，可能影响性能和可读性`,severity:"low",suggestion:"考虑使用JOIN或临时表简化查询"}),/\bSELECT\b.*\bWHERE\b.*\bSELECT\b/gi.test(e)&&s.push({type:"logic",issue:"包含相关子查询，可能性能较差",severity:"low",suggestion:"考虑使用JOIN优化"}),s}validateReasoning(e,s){const r=[],a=this.extractTablesFromSQL(s),i=e.toLowerCase();for(const n of a)i.includes(n.toLowerCase())||r.push({type:"logic",issue:`推理过程中没有提到表 "${n}"`,severity:"low",suggestion:"推理过程应该说明使用的每个表"});return r}isKeyword(e){return["SELECT","FROM","WHERE","JOIN","INNER","LEFT","RIGHT","FULL","OUTER","ON","AND","OR","NOT","IN","LIKE","BETWEEN","NULL","IS","ORDER","BY","GROUP","HAVING","LIMIT","OFFSET","TOP","SUM","AVG","COUNT","MAX","MIN","STDDEV","VARIANCE","CASE","WHEN","THEN","ELSE","END","AS","ASC","DESC"].includes(e.toUpperCase())}isFunction(e){return["SUM","AVG","COUNT","MAX","MIN","STDDEV","VARIANCE","UPPER","LOWER","TRIM","SUBSTRING","CONCAT","DATE","YEAR","MONTH","DAY","NOW","CURDATE","CAST","CONVERT","COALESCE","NULLIF","ISNULL","ABS","ROUND","CEIL","FLOOR","POWER","SQRT","LEN","LENGTH","LEFT","RIGHT","MID"].includes(e.toUpperCase())}}class rr{generateSQLFix(e){const s=[];switch(e.type){case"syntax":s.push(...this.generateSyntaxFix(e));break;case"injection":s.push(...this.generateInjectionFix(e));break;case"missing_table":s.push(...this.generateMissingTableFix(e));break;case"missing_column":s.push(...this.generateMissingColumnFix(e));break;case"complexity":s.push(...this.generateComplexityFix(e));break;case"dangerous":s.push(...this.generateDangerousOpFix(e));break}return s}generateHallucinationFix(e){const s=[];switch(e.type){case"field":s.push({id:`halluc-field-${Date.now()}`,type:"hallucination",priority:e.severity==="high"?"high":"medium",title:"字段名幻觉",description:e.issue,suggested:e.suggestion,autoFixable:!1});break;case"table":s.push({id:`halluc-table-${Date.now()}`,type:"hallucination",priority:e.severity==="high"?"high":"medium",title:"表名幻觉",description:e.issue,suggested:e.suggestion,autoFixable:!1});break;case"value":s.push({id:`halluc-value-${Date.now()}`,type:"hallucination",priority:"medium",title:"数值幻觉",description:e.issue,suggested:e.suggestion,autoFixable:!1});break;case"logic":s.push({id:`halluc-logic-${Date.now()}`,type:"hallucination",priority:e.severity==="high"?"high":"medium",title:"逻辑幻觉",description:e.issue,suggested:e.suggestion,autoFixable:!1});break}return s}generateResultFix(e){const s=[];switch(e.type){case"structure":s.push(...this.generateStructureFix(e.validation));break;case"range":s.push(...this.generateRangeFix(e.validation));break;case"outlier":s.push(...this.generateOutlierFix(e.validation));break}return s}generateFixWizard(e){const s=[];let r=!0;e.sqlValidation.syntaxValid||(s.push({title:"修复SQL语法错误",description:e.sqlValidation.syntaxError||"SQL语句存在语法错误",options:[{title:"查看错误详情",description:"显示具体的语法错误位置和原因",isAutoFix:!1},{title:"重新生成SQL",description:"让AI重新生成正确的SQL语句",isAutoFix:!0,fixCode:"REGENERATE_SQL"}]}),r=!1),e.sqlValidation.injectionCheck.detected&&s.push({title:"处理SQL注入风险",description:`检测到${e.sqlValidation.injectionCheck.types.length}种注入模式`,options:[{title:"移除危险字符",description:"自动移除或转义可能导致注入的字符",isAutoFix:!0,fixCode:"SANITIZE_SQL"},{title:"使用参数化查询",description:"改用参数化查询防止注入",isAutoFix:!1}]});const a=e.sqlValidation.identifierCheck.missingTables,i=e.sqlValidation.identifierCheck.missingColumns;if((a.length>0||i.length>0)&&(s.push({title:"修复缺失的表或字段",description:`缺失: ${[...a,...i].join(", ")}`,options:[{title:"使用相似名称",description:"尝试使用相似的表名或字段名",isAutoFix:!0,fixCode:"SUGGEST_SIMILAR"},{title:"移除缺失项",description:"从查询中移除不存在的表或字段",isAutoFix:!0,fixCode:"REMOVE_MISSING"},{title:"手动修复",description:"手动指定正确的表名或字段名",isAutoFix:!1}]}),r=!1),e.sqlValidation.complexityCheck.exceedsThreshold&&s.push({title:"降低查询复杂度",description:`当前复杂度: ${e.sqlValidation.complexityCheck.score}`,options:[{title:"拆分查询",description:"将复杂查询拆分为多个简单查询",isAutoFix:!1},{title:"使用临时表",description:"使用临时表存储中间结果",isAutoFix:!1},{title:"保持原样",description:"接受当前复杂度，继续执行",isAutoFix:!0,fixCode:"ACCEPT_COMPLEXITY"}]}),e.sqlValidation.dangerousOperations.length>0&&(s.push({title:"审查危险操作",description:`检测到${e.sqlValidation.dangerousOperations.length}个危险操作`,options:e.sqlValidation.dangerousOperations.map(n=>({title:`审查${n.type}操作`,description:n.description,isAutoFix:!1}))}),r=!1),e.hallucinationDetection){const n=[...e.hallucinationDetection.fieldHallucinations,...e.hallucinationDetection.tableHallucinations,...e.hallucinationDetection.valueHallucinations,...e.hallucinationDetection.logicHallucinations];n.length>0&&(s.push({title:"处理AI幻觉",description:`检测到${n.length}个可能的幻觉`,options:[{title:"人工审核",description:"仔细审查AI生成的输出",isAutoFix:!1},{title:"重新生成",description:"让AI重新生成输出",isAutoFix:!0,fixCode:"REGENERATE_OUTPUT"},{title:"应用建议",description:"应用AI的修复建议",isAutoFix:!1}]}),r=!1)}if(e.resultValidation){const{structure:n,range:l,outliers:o}=e.resultValidation;n.matches||s.push({title:"调整结果结构",description:"结果结构与预期不符",options:[{title:"调整查询",description:"修改SQL以返回正确的列",isAutoFix:!1},{title:"调整预期",description:"更新预期的结果结构",isAutoFix:!0,fixCode:"UPDATE_EXPECTATION"}]}),l&&!l.inRange&&s.push({title:"处理超出范围的值",description:`发现${l.outOfRangeValues.length}个超出范围的值`,options:[{title:"筛选异常值",description:"添加WHERE条件过滤异常值",isAutoFix:!1},{title:"标记异常值",description:"在结果中标记异常值",isAutoFix:!0,fixCode:"FLAG_OUTLIERS"},{title:"保持原样",description:"保留所有值，不做处理",isAutoFix:!0,fixCode:"KEEP_ALL"}]}),o&&o.detected&&s.push({title:"处理异常值",description:`检测到${o.outliers.length}个异常值`,options:[{title:"移除异常值",description:"从结果中移除异常值",isAutoFix:!0,fixCode:"REMOVE_OUTLIERS"},{title:"替换异常值",description:"用平均值或中位数替换",isAutoFix:!0,fixCode:"REPLACE_OUTLIERS"},{title:"保留并标记",description:"保留异常值但进行标记",isAutoFix:!0,fixCode:"FLAG_OUTLIERS"}]})}return{steps:s,currentStep:0,canAutoFix:r}}generateSyntaxFix(e){const s=[],r=e.error||"";return r.includes("括号")&&s.push({id:`fix-syntax-bracket-${Date.now()}`,type:"sql_syntax",priority:"high",title:"修复括号匹配",description:"SQL语句中的括号不匹配",autoFixable:!0,applyCode:"FIX_BRACKETS"}),r.includes("引号")&&s.push({id:`fix-syntax-quote-${Date.now()}`,type:"sql_syntax",priority:"high",title:"修复引号匹配",description:"SQL语句中的引号不匹配",autoFixable:!0,applyCode:"FIX_QUOTES"}),(r.includes("FROM")||r.includes("SELECT"))&&s.push({id:`fix-syntax-structure-${Date.now()}`,type:"sql_syntax",priority:"high",title:"修复SQL结构",description:"SQL语句缺少必要的子句",autoFixable:!1,suggested:"确保包含SELECT和FROM子句"}),s.push({id:`fix-syntax-generic-${Date.now()}`,type:"sql_syntax",priority:"high",title:"重新生成SQL",description:"让AI重新生成正确的SQL语句",autoFixable:!0,applyCode:"REGENERATE_SQL"}),s}generateInjectionFix(e){var r;const s=[];return s.push({id:`fix-injection-sanitize-${Date.now()}`,type:"injection",priority:"critical",title:"清理SQL注入",description:`检测到${((r=e.patterns)==null?void 0:r.length)||0}个注入模式`,autoFixable:!0,applyCode:"SANITIZE_SQL",suggested:"移除或转义危险字符"}),s.push({id:`fix-injection-param-${Date.now()}`,type:"injection",priority:"high",title:"使用参数化查询",description:"改用参数化查询防止SQL注入",autoFixable:!1,suggested:"使用?或@param代替直接拼接值"}),s}generateMissingTableFix(e){const s=[],r=e.missing||[];return r.forEach(a=>{s.push({id:`fix-table-${a}-${Date.now()}`,type:"identifier",priority:"high",title:`表 "${a}" 不存在`,description:`数据库中找不到表 ${a}`,autoFixable:!1,suggested:"检查表名是否正确或使用相似的表名"})}),r.length>1&&s.push({id:`fix-tables-all-${Date.now()}`,type:"identifier",priority:"high",title:"修复所有缺失表",description:`批量处理${r.length}个缺失表`,autoFixable:!0,applyCode:"FIX_ALL_TABLES"}),s}generateMissingColumnFix(e){const s=[],r=e.missing||[];return r.forEach(a=>{s.push({id:`fix-column-${a}-${Date.now()}`,type:"identifier",priority:"medium",title:`字段 "${a}" 不存在`,description:`表中找不到字段 ${a}`,autoFixable:!1,suggested:"检查字段名是否正确或使用相似的字段名"})}),r.length>1&&s.push({id:`fix-columns-all-${Date.now()}`,type:"identifier",priority:"medium",title:"修复所有缺失字段",description:`批量处理${r.length}个缺失字段`,autoFixable:!0,applyCode:"FIX_ALL_COLUMNS"}),s}generateComplexityFix(e){const s=[],r=e.complexity;return r&&(s.push({id:`fix-complexity-${Date.now()}`,type:"complexity",priority:"low",title:"降低查询复杂度",description:`当前复杂度为 ${r.score} (${r.level})`,autoFixable:!1,suggested:"考虑拆分查询或使用临时表"}),r.factors.forEach(a=>{let i="";switch(a.type){case"join":i="考虑减少JOIN数量或使用子查询";break;case"subquery":i="考虑将子查询改为JOIN";break;case"aggregation":i="考虑减少聚合函数的使用";break;case"groupBy":i="考虑减少分组列数";break;default:i=a.description}s.push({id:`fix-complexity-${a.type}-${Date.now()}`,type:"complexity",priority:"low",title:`优化${a.type}`,description:a.description,autoFixable:!1,suggested:i})})),s}generateDangerousOpFix(e){const s=[];return(e.operations||[]).forEach(a=>{const i=a.severity==="high";s.push({id:`fix-dangerous-${a.type}-${Date.now()}`,type:"injection",priority:i?"critical":"high",title:`${a.type}操作需要确认`,description:a.description,autoFixable:!1,suggested:i?"强烈建议取消或修改此操作":"请确认是否要执行此操作"})}),s}generateStructureFix(e){const s=[];return e.missingColumns&&e.missingColumns.length>0&&s.push({id:`fix-structure-missing-${Date.now()}`,type:"result",priority:"medium",title:"添加缺失列",description:`缺失列: ${e.missingColumns.join(", ")}`,autoFixable:!1,suggested:"在SELECT子句中添加缺失的列"}),e.extraColumns&&e.extraColumns.length>0&&s.push({id:`fix-structure-extra-${Date.now()}`,type:"result",priority:"low",title:"移除额外列",description:`额外列: ${e.extraColumns.join(", ")}`,autoFixable:!0,applyCode:"REMOVE_EXTRA_COLUMNS"}),s}generateRangeFix(e){var r;const s=[];return s.push({id:`fix-range-${Date.now()}`,type:"result",priority:"medium",title:"处理超出范围的值",description:`发现${((r=e.outOfRangeValues)==null?void 0:r.length)||0}个超出范围的值`,autoFixable:!0,applyCode:"FILTER_OUT_OF_RANGE"}),s}generateOutlierFix(e){var r;const s=[];return s.push({id:`fix-outlier-${Date.now()}`,type:"result",priority:"low",title:"处理异常值",description:`检测到${((r=e.outliers)==null?void 0:r.length)||0}个异常值`,autoFixable:!0,applyCode:"HANDLE_OUTLIERS"}),s}}class ar{constructor(e){this.criteria=e}check(e){var n;const s=[],r=[];e.sqlValidation.syntaxValid||s.push("syntax"),e.sqlValidation.injectionCheck.detected&&s.push("injection");const a=e.sqlValidation.identifierCheck.missingTables.length+e.sqlValidation.identifierCheck.missingColumns.length;if(a>0&&(this.criteria.requiredChecks.includes("identifiers")?s.push("identifiers"):r.push(`有${a}个缺失的表或字段`)),e.sqlValidation.complexityCheck.exceedsThreshold&&r.push("查询复杂度超出阈值"),e.sqlValidation.dangerousOperations.length>0&&(this.criteria.requiredChecks.includes("safety")?s.push("safety"):r.push("检测到危险操作")),e.hallucinationDetection){const l=e.hallucinationDetection.score;l>50?s.push("hallucination"):l>20&&r.push("检测到可能的AI幻觉")}return e.resultValidation&&(e.resultValidation.structure.matches||r.push("结果结构与预期不符"),(n=e.resultValidation.outliers)!=null&&n.detected&&r.push("结果中存在异常值")),{passed:s.length===0&&e.score>=this.criteria.minScore,score:e.score,failedChecks:s,warnings:r}}getScore(e){return e.score}generateReport(e){const s=this.check(e),r=this.calculateMetrics(e),a=this.determineGrade(s.score),i=this.generateRecommendations(e,r);return{score:s.score,grade:a,passed:s.passed,metrics:r,recommendations:i,timestamp:new Date}}updateCriteria(e){this.criteria={...this.criteria,...e}}getCriteria(){return{...this.criteria}}calculateMetrics(e){const s=[],r=e.sqlValidation.syntaxValid?100:0;s.push({name:"语法正确性",value:r,target:100,passed:e.sqlValidation.syntaxValid,weight:30});const a=e.sqlValidation.injectionCheck.detected,i=e.sqlValidation.dangerousOperations.length>0,n=!a&&!i?100:a?0:50;s.push({name:"安全性",value:n,target:100,passed:!a,weight:25});const l=e.sqlValidation.identifierCheck.missingTables.length+e.sqlValidation.identifierCheck.missingColumns.length,o=Math.max(0,100-l*20);s.push({name:"标识符正确性",value:o,target:100,passed:l===0,weight:20});const c=e.sqlValidation.complexityCheck.exceedsThreshold,d=c?50:100;s.push({name:"复杂度合理性",value:d,target:100,passed:!c,weight:10});let h=100;return e.hallucinationDetection&&(h=100-e.hallucinationDetection.score),s.push({name:"AI可靠性",value:Math.max(0,h),target:80,passed:h>=80,weight:15}),s}determineGrade(e){return e>=90?"A":e>=80?"B":e>=70?"C":e>=60?"D":"F"}generateRecommendations(e,s){const r=[],a=s.filter(i=>!i.passed);for(const i of a)switch(i.name){case"语法正确性":r.push("检查SQL语法错误","确保括号和引号匹配","验证所有关键字拼写正确");break;case"安全性":e.sqlValidation.injectionCheck.detected&&r.push("移除SQL注入风险","使用参数化查询代替字符串拼接","对用户输入进行严格的验证和转义"),e.sqlValidation.dangerousOperations.length>0&&r.push("审查所有危险操作","考虑使用只读查询","在生产环境中执行前进行完整备份");break;case"标识符正确性":r.push("检查所有表名和字段名","使用数据库实际的表结构","考虑使用相似名称的建议");break;case"复杂度合理性":r.push("简化查询逻辑","考虑拆分复杂查询","使用临时表存储中间结果");break;case"AI可靠性":r.push("人工审核AI生成的结果","验证AI的推理过程","考虑使用更可靠的查询方法");break}return e.warnings.length>0&&r.push(`注意以下警告: ${e.warnings.slice(0,3).join(", ")}`),a.length>0&&r.push("建议在执行前进行完整测试","考虑使用查询分析工具进一步优化"),[...new Set(r)]}}class nr{constructor(e){this.hallucinationDetectorRef=this.hallucinationDetector,this.defaultConfig={enableInjectionCheck:(e==null?void 0:e.enableInjectionCheck)??!0,enableHallucinationCheck:(e==null?void 0:e.enableHallucinationCheck)??!0,enableComplexityCheck:(e==null?void 0:e.enableComplexityCheck)??!0,maxComplexity:(e==null?void 0:e.maxComplexity)??50,enableResultValidation:(e==null?void 0:e.enableResultValidation)??!0,qualityGateThreshold:(e==null?void 0:e.qualityGateThreshold)??70,strictMode:(e==null?void 0:e.strictMode)??!1},this.sqlValidator=new Et,this.resultValidator=new tr,this.hallucinationDetector=new sr,this.fixGenerator=new rr,this.qualityGate=new ar({minScore:this.defaultConfig.qualityGateThreshold,requiredChecks:["syntax","injection","identifiers"],warningThreshold:50,errorThreshold:30})}validateSQL(e,s){const r=performance.now(),a=[],i=[],n=[];try{const l=this.sqlValidator.validateSyntax(e);if(l.valid||(a.push(`SQL语法错误: ${l.error}`),n.push(...this.fixGenerator.generateSQLFix({type:"syntax",sql:e,error:l.error}))),this.defaultConfig.enableInjectionCheck){const m=this.sqlValidator.checkInjection(e);if(m.detected){const f={low:"低",medium:"中",high:"高",critical:"严重"};a.push(`检测到SQL注入尝试 (${f[m.severity]}风险): ${m.types.join(", ")}`),n.push(...this.fixGenerator.generateSQLFix({type:"injection",sql:e,patterns:m.patterns}))}}const o=this.sqlValidator.validateIdentifiers(e,s);if(o.missingTables.length>0&&(a.push(`不存在的表: ${o.missingTables.join(", ")}`),n.push(...this.fixGenerator.generateSQLFix({type:"missing_table",sql:e,missing:o.missingTables}))),o.missingColumns.length>0&&(a.push(`不存在的字段: ${o.missingColumns.join(", ")}`),n.push(...this.fixGenerator.generateSQLFix({type:"missing_column",sql:e,missing:o.missingColumns}))),this.defaultConfig.enableComplexityCheck){const m=this.sqlValidator.validateComplexity(e);m.exceedsThreshold&&(i.push(`查询复杂度过高 (${m.score}/${this.defaultConfig.maxComplexity})`),n.push(...this.fixGenerator.generateSQLFix({type:"complexity",sql:e,complexity:m})))}const c=this.sqlValidator.detectDangerousOperations(e);if(c.length>0){const m=c.map(f=>`${f.type}操作`).join(", ");i.push(`检测到危险操作: ${m}`),n.push(...this.fixGenerator.generateSQLFix({type:"dangerous",sql:e,operations:c}))}const d=this.calculateSQLValidationScore({syntaxValid:l.valid,injectionDetected:this.defaultConfig.enableInjectionCheck?this.sqlValidator.checkInjection(e).detected:!1,missingIdentifiers:o.missingTables.length+o.missingColumns.length,complexityExceeds:this.defaultConfig.enableComplexityCheck?this.sqlValidator.validateComplexity(e).exceedsThreshold:!1,hasDangerousOps:c.length>0});return{passed:d>=this.defaultConfig.qualityGateThreshold,score:d,sqlValidation:{syntaxValid:l.valid,syntaxError:l.error,injectionCheck:this.sqlValidator.checkInjection(e),identifierCheck:o,complexityCheck:this.sqlValidator.validateComplexity(e),dangerousOperations:c},suggestions:n,errors:a,warnings:i,timestamp:new Date,duration:performance.now()-r}}catch(l){return{passed:!1,score:0,sqlValidation:{syntaxValid:!1,syntaxError:l instanceof Error?l.message:String(l),injectionCheck:{detected:!1,types:[],patterns:[],severity:"low"},identifierCheck:{tables:[],columns:[],missingTables:[],missingColumns:[]},complexityCheck:{score:0,level:"simple",exceedsThreshold:!1,factors:[]},dangerousOperations:[]},suggestions:[],errors:[l instanceof Error?l.message:String(l)],warnings:[],timestamp:new Date,duration:performance.now()-r}}}validateResult(e,s){const r=performance.now(),a=[],i=[],n=[];try{const l=this.resultValidator.validateStructure(e,s);l.matches||(i.push("结果结构不符合预期"),n.push(...this.fixGenerator.generateResultFix({type:"structure",validation:l})));const o=this.resultValidator.validateRange(e,{});!o.inRange&&o.outOfRangeValues.length>0&&(i.push(`发现${o.outOfRangeValues.length}个超出范围的值`),n.push(...this.fixGenerator.generateResultFix({type:"range",validation:o})));const c=this.resultValidator.detectOutliers(e);c.detected&&(i.push(`检测到${c.outliers.length}个异常值`),n.push(...this.fixGenerator.generateResultFix({type:"outlier",validation:c})));const d=this.calculateResultValidationScore({structureMatches:l.matches,inRange:o.inRange,hasOutliers:c.detected});return{passed:d>=this.defaultConfig.qualityGateThreshold,score:d,sqlValidation:{syntaxValid:!0,injectionCheck:{detected:!1,types:[],patterns:[],severity:"low"},identifierCheck:{tables:[],columns:[],missingTables:[],missingColumns:[]},complexityCheck:{score:0,level:"simple",exceedsThreshold:!1,factors:[]},dangerousOperations:[]},resultValidation:{structure:l,range:o,outliers:c},suggestions:n,errors:a,warnings:i,timestamp:new Date,duration:performance.now()-r}}catch(l){return{passed:!1,score:0,sqlValidation:{syntaxValid:!0,injectionCheck:{detected:!1,types:[],patterns:[],severity:"low"},identifierCheck:{tables:[],columns:[],missingTables:[],missingColumns:[]},complexityCheck:{score:0,level:"simple",exceedsThreshold:!1,factors:[]},dangerousOperations:[]},suggestions:[],errors:[l instanceof Error?l.message:String(l)],warnings:[],timestamp:new Date,duration:performance.now()-r}}}detectHallucination(e,s){const r=performance.now();try{const a=this.hallucinationDetector.detectFieldHallucination(e,s.schema),i=this.hallucinationDetector.detectTableHallucination(e,s.schema),n=this.hallucinationDetector.detectValueHallucination(e,s),l=this.hallucinationDetector.detectLogicHallucination(e,s),o=this.hallucinationDetector.calculateHallucinationScore(e,s),c=[...a,...i,...n,...l],d=o>50||c.some(m=>m.severity==="high"),h=this.generateHallucinationAssessment(o,c);return{score:o,hallucinations:c,assessment:h,requiresHumanReview:d,duration:performance.now()-r}}catch{return{score:100,hallucinations:[{type:"logic",issue:"幻觉检测过程出错",severity:"high",suggestion:"请人工审核AI输出"}],assessment:"幻觉检测失败",requiresHumanReview:!0,duration:performance.now()-r}}}generateFixSuggestion(e){return this.fixGenerator.generateFixWizard(e).steps.flatMap(s=>s.options.map(r=>({id:`fix-${Date.now()}-${Math.random()}`,type:e.sqlValidation.syntaxValid?"result":"sql_syntax",priority:r.isAutoFix?"high":"medium",title:s.title,description:r.description,suggested:r.fixCode,applyCode:r.fixCode,autoFixable:r.isAutoFix??!1})))}runValidationSuite(e,s){var l,o;const r=performance.now(),a=[],i=[],n=[];try{const c=this.validateSQL(e.sqlQuery,s.schema);a.push(...c.errors),i.push(...c.warnings),n.push(...c.suggestions);let d;if(this.defaultConfig.enableResultValidation&&e.result){const p=this.validateResult(e.result);a.push(...p.errors),i.push(...p.warnings),n.push(...p.suggestions),d=p.resultValidation}let h;if(this.defaultConfig.enableHallucinationCheck){const p=this.detectHallucination(e,s);h={score:p.score,fieldHallucinations:p.hallucinations.filter(x=>x.type==="field"),tableHallucinations:p.hallucinations.filter(x=>x.type==="table"),valueHallucinations:p.hallucinations.filter(x=>x.type==="value"),logicHallucinations:p.hallucinations.filter(x=>x.type==="logic")},p.score>30&&i.push(`检测到可能的AI幻觉 (分数: ${p.score}/100)`),p.requiresHumanReview&&i.push("建议人工审核AI输出"),p.hallucinations.forEach(x=>{n.push(...this.fixGenerator.generateHallucinationFix(x))})}const m=this.calculateOverallScore({sqlScore:c.score,resultScore:d?this.calculateResultValidationScore({structureMatches:d.structure.matches,inRange:((l=d.range)==null?void 0:l.inRange)??!0,hasOutliers:((o=d.outliers)==null?void 0:o.detected)??!1}):100,hallucinationScore:h?100-h.score:100});return{passed:this.defaultConfig.strictMode?a.length===0:m>=this.defaultConfig.qualityGateThreshold,score:m,sqlValidation:c.sqlValidation,resultValidation:d,hallucinationDetection:h,suggestions:n,errors:a,warnings:i,timestamp:new Date,duration:performance.now()-r}}catch(c){return{passed:!1,score:0,sqlValidation:{syntaxValid:!1,syntaxError:c instanceof Error?c.message:String(c),injectionCheck:{detected:!1,types:[],patterns:[],severity:"low"},identifierCheck:{tables:[],columns:[],missingTables:[],missingColumns:[]},complexityCheck:{score:0,level:"simple",exceedsThreshold:!1,factors:[]},dangerousOperations:[]},suggestions:[],errors:[c instanceof Error?c.message:String(c)],warnings:[],timestamp:new Date,duration:performance.now()-r}}}checkQualityGate(e){return this.qualityGate.generateReport(e)}calculateSQLValidationScore(e){let s=100;return e.syntaxValid||(s-=40),e.injectionDetected&&(s-=50),s-=e.missingIdentifiers*10,e.complexityExceeds&&(s-=15),e.hasDangerousOps&&(s-=20),Math.max(0,s)}calculateResultValidationScore(e){let s=100;return e.structureMatches||(s-=30),e.inRange||(s-=20),e.hasOutliers&&(s-=10),Math.max(0,s)}calculateOverallScore(e){return Math.round(e.sqlScore*.5+e.resultScore*.3+e.hallucinationScore*.2)}generateHallucinationAssessment(e,s){return e>=80?"严重幻觉：AI输出包含大量错误信息，强烈建议人工审核":e>=50?"中度幻觉：AI输出可能包含不准确信息，建议人工审核":e>=20?"轻度幻觉：AI输出基本可靠，但存在少量不确定信息":"无明显幻觉：AI输出可靠"}validateMappingResult(e,s){const r=[],a=[],i=[],n=[];try{const l=Object.keys(e.fieldMapping||{});for(const c of s.templatePlaceholders)l.includes(c)||(i.push(c),r.push(`占位符 "${c}" 未被映射`));for(const[c,d]of Object.entries(e.fieldMapping||{})){const h=typeof d=="string"?d:d.fieldName;typeof h=="string"&&!s.excelHeaders.includes(h)&&(n.push(h),a.push(`占位符 "${c}" 映射到不存在的字段: "${h}"`))}if(e.auxiliarySheetMappings)for(const[c,d]of Object.entries(e.auxiliarySheetMappings)){const h=d;h.lookupField&&!s.excelHeaders.includes(h.lookupField)&&r.push(`占位符 "${c}" 的查找字段 "${h.lookupField}" 可能不存在`)}return{isValid:a.length===0,warnings:r,errors:a,missingPlaceholders:i,invalidFields:n}}catch(l){return{isValid:!1,warnings:[],errors:[l instanceof Error?l.message:String(l)],missingPlaceholders:[],invalidFields:[]}}}}class Yt{constructor(e,s,r={}){this.collector=e,this.benchmarkEvaluator=s,this.config={slowQueryThreshold:1e3,minSampleSize:10,trendAnalysisWindowSize:100,...r}}analyzeQueryPerformance(e){const s=e||this.collector.getMetrics("query");if(s.length===0)return{totalQueries:0,slowQueries:[],avgExecutionTime:0,slowestQuery:null,fastestQuery:null,cacheHitRate:0,queryTypeDistribution:{}};const r=s.length,a=this.calculateAverage(s.map(m=>m.executionTime)),i=this.identifySlowQueries(void 0,s),n=[...s].sort((m,f)=>f.executionTime-m.executionTime),l=n[0]?{query:n[0].query,executionTime:n[0].executionTime,executionCount:1,avgExecutionTime:n[0].executionTime,lastExecution:n[0].timestamp,queryType:n[0].queryType,suggestions:this.generateQueryOptimizationSuggestions(n[0])}:null,o=n[n.length-1]?{query:n[n.length-1].query,executionTime:n[n.length-1].executionTime}:null,c=s.filter(m=>m.cached),d=r>0?c.length/r*100:0,h={};return s.forEach(m=>{h[m.queryType]=(h[m.queryType]||0)+1}),{totalQueries:r,slowQueries:i,avgExecutionTime:a,slowestQuery:l,fastestQuery:o,cacheHitRate:d,queryTypeDistribution:h}}identifySlowQueries(e,s){const r=e||this.config.slowQueryThreshold,a=s||this.collector.getMetrics("query"),i=new Map;a.forEach(l=>{const o=i.get(l.query);o?(o.count++,o.totalTime+=l.executionTime,l.executionTime>o.maxTime&&(o.maxTime=l.executionTime),o.lastExecution=Math.max(o.lastExecution,l.timestamp)):i.set(l.query,{count:1,totalTime:l.executionTime,maxTime:l.executionTime,lastExecution:l.timestamp,queryType:l.queryType,query:l.query})});const n=[];return i.forEach((l,o)=>{const c=l.totalTime/l.count;(l.maxTime>=r||c>=r/2)&&n.push({query:l.query,executionTime:l.maxTime,executionCount:l.count,avgExecutionTime:c,lastExecution:l.lastExecution,queryType:l.queryType,suggestions:this.generateQueryOptimizationSuggestions({query:o,executionTime:c,queryType:l.queryType})})}),n.sort((l,o)=>o.executionTime-l.executionTime)}generateQueryOptimizationSuggestions(e){const s=[],{query:r,executionTime:a,queryType:i}=e;return a>this.config.slowQueryThreshold&&s.push(`查询执行时间 (${a.toFixed(2)}ms) 超过阈值，建议优化`),r.toLowerCase().includes("select *")&&s.push("避免使用 SELECT *，明确指定需要的列"),r.toLowerCase().includes("join")&&(s.push("确保JOIN字段有索引"),s.push("考虑使用INNER JOIN代替OUTER JOIN以提升性能")),r.toLowerCase().includes("like %")&&s.push("前导通配符查询无法使用索引，考虑全文索引或其他搜索方案"),r.toLowerCase().includes("order by")&&!r.toLowerCase().includes("limit")&&s.push("ORDER BY 后建议添加 LIMIT 限制结果集大小"),i==="aggregate"&&s.push("聚合查询可以考虑使用物化视图或预计算"),s.length===0&&s.push("查询性能良好，无需优化"),s}analyzeTrend(e,s){let r;if(s?r=this.collector.getMetricsByTimeRange(e,s.from,s.to):r=this.collector.getMetrics(e),r.length<this.config.minSampleSize)return{metric:e,timeRange:s||{from:0,to:Date.now()},dataPoints:[],trend:"stable",changeRate:0};const a=r.map(o=>({timestamp:o.timestamp,value:o.value})),i=this.calculateTrend(a),n=this.calculateChangeRate(a),l=this.generateForecast(a);return{metric:e,timeRange:{from:a[0].timestamp,to:a[a.length-1].timestamp},dataPoints:a,trend:i,changeRate:n,forecast:l}}calculateTrend(e){if(e.length<2)return"stable";const s=e.length;let r=0,a=0,i=0,n=0;e.forEach((o,c)=>{r+=c,a+=o.value,i+=c*o.value,n+=c*c});const l=(s*i-r*a)/(s*n-r*r);return l<-.1?"improving":l>.1?"degrading":"stable"}calculateChangeRate(e){if(e.length<2)return 0;const s=e[0].value,r=e[e.length-1].value;return s===0?0:(r-s)/s*100}generateForecast(e){if(e.length<5)return;const s=Math.min(5,e.length),r=e.slice(-s),a=r.reduce((o,c)=>o+c.value,0)/s,i=r.reduce((o,c)=>o+Math.pow(c.value-a,2),0)/s,n=Math.sqrt(i),l=Math.max(0,Math.min(1,1-n/a));return{nextValue:a,confidence:l}}identifyBottlenecks(){var i;const e=[],s=this.analyzeQueryPerformance();s.slowQueries.length>0&&e.push({id:"query_performance",type:"query",severity:s.avgExecutionTime>2e3?"high":"medium",affectedMetrics:["query.execution_time"],description:`发现 ${s.slowQueries.length} 个慢查询，平均执行时间 ${s.avgExecutionTime.toFixed(2)}ms`,impact:s.slowQueries.map(n=>({metricName:"query.execution_time",degradation:n.executionTime}))});const r=this.collector.getMetrics("ai_call");if(r.length>0){const n=this.calculateAverage(r.map(l=>l.value));n>3e3&&e.push({id:"ai_response_time",type:"ai",severity:n>5e3?"high":"medium",affectedMetrics:["ai.response_time"],description:`AI平均响应时间 ${n.toFixed(2)}ms 超过建议值`,impact:[{metricName:"ai.response_time",degradation:n}]})}const a=this.collector.getMetrics("memory");if(a.length>0){const n=a[a.length-1];((i=n.metadata)==null?void 0:i.percentage)>80&&e.push({id:"memory_usage",type:"resource",severity:"high",affectedMetrics:["memory.usage"],description:`内存使用率 ${n.metadata.percentage.toFixed(1)}% 过高`,impact:[{metricName:"memory.usage",degradation:n.metadata.percentage}]})}return e}generateOptimizationSuggestions(e){const s=e||this.identifyBottlenecks(),r=[];return s.forEach(a=>{var i,n,l,o,c,d;switch(a.type){case"query":r.push({id:`opt_${a.id}`,type:"query",priority:a.severity==="high"?"high":"medium",title:"优化查询性能",description:"通过添加索引、优化查询语句或使用缓存来提升查询性能",estimatedImprovement:{metric:"query.execution_time",currentValue:((i=a.impact[0])==null?void 0:i.degradation)||0,expectedValue:((n=a.impact[0])==null?void 0:n.degradation)*.5||0,improvementPercentage:50},steps:["检查并添加适当的索引","优化JOIN操作的顺序","使用查询缓存减少重复查询","考虑使用物化视图预计算聚合结果"],relatedMetrics:["query.execution_time","query.cache_hit_rate"]});break;case"ai":r.push({id:`opt_${a.id}`,type:"ai",priority:"medium",title:"优化AI响应时间",description:"通过缓存AI响应、批量处理或使用更快的模型来减少响应时间",estimatedImprovement:{metric:"ai.response_time",currentValue:((l=a.impact[0])==null?void 0:l.degradation)||0,expectedValue:((o=a.impact[0])==null?void 0:o.degradation)*.6||0,improvementPercentage:40},steps:["启用AI响应缓存","使用更快的模型处理简单请求","批量处理AI请求以减少网络开销","考虑使用本地模型处理简单任务"],relatedMetrics:["ai.response_time","ai.cache_hit_rate"]});break;case"resource":r.push({id:`opt_${a.id}`,type:"resource",priority:a.severity==="high"?"high":"medium",title:"优化内存使用",description:"通过释放未使用的资源、优化数据结构或增加内存限制来减少内存占用",estimatedImprovement:{metric:"memory.usage",currentValue:((c=a.impact[0])==null?void 0:c.degradation)||0,expectedValue:((d=a.impact[0])==null?void 0:d.degradation)*.7||0,improvementPercentage:30},steps:["定期清理未使用的缓存数据","优化数据结构减少内存占用","使用流式处理大数据集","考虑分页或虚拟滚动技术"],relatedMetrics:["memory.usage","cache.size"]});break}}),r}generateReport(e){const s=Date.now(),r=e||{from:s-36e5,to:s},a=this.collector.getMetricsByTimeRange("query",r.from,r.to),i=this.collector.getMetricsByTimeRange("ai_call",r.from,r.to),n=this.collector.getMetricsByTimeRange("document",r.from,r.to),l=this.collector.getMetricsByTimeRange("memory",r.from,r.to),o=this.collector.getMetricsByTimeRange("cpu",r.from,r.to),c={query:{totalQueries:a.length,avgResponseTime:a.length>0?this.calculateAverage(a.map(p=>p.value)):0,slowQueryCount:this.identifySlowQueries(void 0,a).length,cacheHitRate:this.calculateCacheHitRate(a)},ai:{totalCalls:i.length,avgResponseTime:i.length>0?this.calculateAverage(i.map(p=>p.value)):0,successRate:this.calculateSuccessRate(i),totalTokens:i.reduce((p,x)=>{var y;return p+(((y=x.metadata)==null?void 0:y.tokensUsed)||0)},0)},document:{totalGenerated:n.length,avgGenerationTime:n.length>0?this.calculateAverage(n.map(p=>p.value)):0,successRate:this.calculateSuccessRate(n)},resources:{avgMemoryUsage:l.length>0?this.calculateAverage(l.map(p=>p.value)):0,peakMemoryUsage:l.length>0?Math.max(...l.map(p=>p.value)):0,avgCpuUsage:o.length>0?this.calculateAverage(o.map(p=>p.value)):0}},d=this.benchmarkEvaluator.calculateOverallScore({query:a.slice(0,100).map(p=>({type:p.queryType,time:p.value})),ai:i.slice(0,50).map(p=>{var x;return{type:((x=p.metadata)==null?void 0:x.callType)||"simple",time:p.value}}),document:n.slice(0,50).map(p=>{var x,y;return{method:((x=p.metadata)==null?void 0:x.method)||"single",count:((y=p.metadata)==null?void 0:y.documentCount)||1,time:p.value}}),resources:l.length>0?{memory:c.resources.avgMemoryUsage/(1024*1024),cpu:c.resources.avgCpuUsage}:void 0}),h=this.identifyBottlenecks(),m=this.generateOptimizationSuggestions(h),f=[...a,...i,...n,...l,...o];return{reportId:this.generateReportId(),timeRange:r,generatedAt:s,summary:c,metrics:f,score:d,suggestions:m}}comparePerformance(e,s){const r=[];if(e.summary.query.totalQueries>0&&s.summary.query.totalQueries>0){const l=e.summary.query.avgResponseTime,o=s.summary.query.avgResponseTime,c=o-l,d=c/l*100;r.push({metric:"query.avg_response_time",beforeValue:l,afterValue:o,change:c,changePercentage:d,status:c<0?"improved":c>0?"degraded":"unchanged"})}if(e.summary.ai.totalCalls>0&&s.summary.ai.totalCalls>0){const l=e.summary.ai.avgResponseTime,o=s.summary.ai.avgResponseTime,c=o-l,d=c/l*100;r.push({metric:"ai.avg_response_time",beforeValue:l,afterValue:o,change:c,changePercentage:d,status:c<0?"improved":c>0?"degraded":"unchanged"})}if(e.summary.resources.avgMemoryUsage>0&&s.summary.resources.avgMemoryUsage>0){const l=e.summary.resources.avgMemoryUsage,o=s.summary.resources.avgMemoryUsage,c=o-l,d=c/l*100;r.push({metric:"resources.avg_memory_usage",beforeValue:l,afterValue:o,change:c,changePercentage:d,status:c<0?"improved":c>0?"degraded":"unchanged"})}const a=r.filter(l=>l.status==="improved").length,i=r.filter(l=>l.status==="degraded").length;let n;return a>i?n=`性能有所提升，${a} 项指标改进，${i} 项指标下降`:i>a?n=`性能有所下降，${i} 项指标下降，${a} 项指标改进`:n="性能基本持平",{comparisonId:this.generateReportId(),before:e,after:s,comparedAt:Date.now(),improvements:r,overallAssessment:n}}calculateAverage(e){return e.length===0?0:e.reduce((s,r)=>s+r,0)/e.length}calculateCacheHitRate(e){return e.length===0?0:e.filter(r=>r.cached).length/e.length*100}calculateSuccessRate(e){return e.length===0?100:e.filter(r=>{var a;return((a=r.metadata)==null?void 0:a.success)!==!1}).length/e.length*100}generateReportId(){return`report_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}const Fe={queries:{simple:{target:5,warning:10,error:20},filter:{target:10,warning:20,error:50},aggregate:{target:15,warning:30,error:100},join:{target:20,warning:50,error:200}},ai:{simple:{target:1e3,warning:2e3,error:3e3},complex:{target:2e3,warning:4e3,error:6e3}},document:{single:{target:300,warning:500,error:1e3},batch_10:{target:3e3,warning:5e3,error:1e4},batch_100:{target:3e4,warning:5e4,error:6e4}},resources:{memory:{target:200,warning:400,error:800},cpu:{target:50,warning:75,error:90}}};class St{constructor(e=Fe){this.benchmarks=e}evaluateQuery(e,s){const r=this.benchmarks.queries[e];return r?s<=r.target?{grade:"A",level:"excellent",message:`性能优秀，执行时间 ${s}ms 小于目标值 ${r.target}ms`}:s<=r.warning?{grade:"B",level:"good",message:`性能良好，执行时间 ${s}ms 在警告值 ${r.warning}ms 以内`}:s<=r.error?{grade:"C",level:"fair",message:`性能一般，执行时间 ${s}ms 接近错误阈值 ${r.error}ms`}:{grade:"D",level:"poor",message:`性能较差，执行时间 ${s}ms 超过错误阈值 ${r.error}ms，建议优化`}:{grade:"C",level:"fair",message:"未知查询类型"}}evaluateAI(e,s){const r=this.benchmarks.ai[e];return r?s<=r.target?{grade:"A",level:"excellent",message:`响应优秀，响应时间 ${s}ms 小于目标值 ${r.target}ms`}:s<=r.warning?{grade:"B",level:"good",message:`响应良好，响应时间 ${s}ms 在警告值 ${r.warning}ms 以内`}:s<=r.error?{grade:"C",level:"fair",message:`响应一般，响应时间 ${s}ms 接近错误阈值 ${r.error}ms`}:{grade:"D",level:"poor",message:`响应较慢，响应时间 ${s}ms 超过错误阈值 ${r.error}ms`}:{grade:"C",level:"fair",message:"未知AI调用类型"}}evaluateDocument(e,s,r){let a;if(e==="single"||s===1)a="single";else if(s<=10)a="batch_10";else if(s<=100)a="batch_100";else{const n=r/s,l=300;return n<=l?{grade:"A",level:"excellent",message:`批量生成优秀，平均每文档 ${n.toFixed(2)}ms`}:n<=l*2?{grade:"B",level:"good",message:`批量生成良好，平均每文档 ${n.toFixed(2)}ms`}:{grade:"C",level:"fair",message:`批量生成一般，平均每文档 ${n.toFixed(2)}ms`}}const i=this.benchmarks.document[a];return r<=i.target?{grade:"A",level:"excellent",message:`生成优秀，总耗时 ${r}ms 小于目标值 ${i.target}ms`}:r<=i.warning?{grade:"B",level:"good",message:`生成良好，总耗时 ${r}ms 在警告值 ${i.warning}ms 以内`}:r<=i.error?{grade:"C",level:"fair",message:`生成一般，总耗时 ${r}ms 接近错误阈值 ${i.error}ms`}:{grade:"D",level:"poor",message:`生成较慢，总耗时 ${r}ms 超过错误阈值 ${i.error}ms`}}evaluateResources(e,s){const r=this.benchmarks.resources[e];return s<=r.target?{grade:"A",level:"excellent",message:`资源使用优秀，${e} 使用率 ${s}${e==="memory"?"MB":"%"} 小于目标值 ${r.target}${e==="memory"?"MB":"%"}`}:s<=r.warning?{grade:"B",level:"good",message:`资源使用良好，${e} 使用率 ${s}${e==="memory"?"MB":"%"} 在警告值 ${r.warning}${e==="memory"?"MB":"%"} 以内`}:s<=r.error?{grade:"C",level:"fair",message:`资源使用一般，${e} 使用率 ${s}${e==="memory"?"MB":"%"} 接近错误阈值 ${r.error}${e==="memory"?"MB":"%"}`}:{grade:"D",level:"poor",message:`资源使用较高，${e} 使用率 ${s}${e==="memory"?"MB":"%"} 超过错误阈值 ${r.error}${e==="memory"?"MB":"%"}，建议优化`}}calculateOverallScore(e){const s={query:100,ai:100,document:100,resources:100};if(e.query&&e.query.length>0){const a=e.query.map(i=>{const n=this.evaluateQuery(i.type,i.time);return this.gradeToScore(n.grade)});s.query=a.reduce((i,n)=>i+n,0)/a.length}if(e.ai&&e.ai.length>0){const a=e.ai.map(i=>{const n=this.evaluateAI(i.type,i.time);return this.gradeToScore(n.grade)});s.ai=a.reduce((i,n)=>i+n,0)/a.length}if(e.document&&e.document.length>0){const a=e.document.map(i=>{const n=this.evaluateDocument(i.method,i.count,i.time);return this.gradeToScore(n.grade)});s.document=a.reduce((i,n)=>i+n,0)/a.length}if(e.resources){const a=this.gradeToScore(this.evaluateResources("memory",e.resources.memory).grade),i=this.gradeToScore(this.evaluateResources("cpu",e.resources.cpu).grade);s.resources=(a+i)/2}const r=(s.query+s.ai+s.document+s.resources)/4;return{overall:Math.round(r),breakdown:s,grade:this.scoreToGrade(r)}}gradeToScore(e){return{A:95,B:80,C:65,D:50,F:30}[e]||70}scoreToGrade(e){return e>=90?"A":e>=80?"B":e>=70?"C":e>=60?"D":"F"}getBenchmarks(){return{...this.benchmarks}}updateBenchmarks(e){this.benchmarks={...this.benchmarks,...e,queries:{...this.benchmarks.queries,...e.queries},ai:{...this.benchmarks.ai,...e.ai},document:{...this.benchmarks.document,...e.document},resources:{...this.benchmarks.resources,...e.resources}}}}class Jt{constructor(e={}){this.metrics=new Map,this.resourceMonitorInterval=null,this.config={maxCacheSize:1e4,sampleRate:1,enableResourceMonitoring:!0,resourceMonitoringInterval:5e3,...e},this.config.enableResourceMonitoring&&this.startResourceMonitoring()}collectQueryPerformance(e){const s={type:"query",name:"query.execution",value:e.executionTime,unit:"ms",timestamp:Date.now(),query:e.query,executionTime:e.executionTime,rowCount:e.rowCount,queryType:e.queryType,cached:e.cached,tables:e.tables,metadata:{rowCount:e.rowCount,cached:e.cached},tags:["query",e.queryType,e.cached?"cached":"uncached"]};return this.storeMetric("query",s),s}collectAIResponseTime(e){const s={type:"ai_call",name:"ai.response_time",value:e.responseTime,unit:"ms",timestamp:Date.now(),promptLength:e.promptLength,responseLength:e.responseLength,tokensUsed:e.tokensUsed||this.estimateTokens(e.prompt,e.responseLength),model:e.model,callType:e.callType,success:e.success,error:e.error,metadata:{model:e.model,callType:e.callType,success:e.success},tags:["ai",e.callType,e.success?"success":"error"]};return this.storeMetric("ai",s),s}collectDocumentGeneration(e){const s={type:"document",name:"document.generation",value:e.generationTime,unit:"ms",timestamp:Date.now(),templateName:e.templateName,dataRowCount:e.dataRowCount,documentCount:e.documentCount,generationTime:e.generationTime,method:e.method,status:e.status,metadata:{templateName:e.templateName,documentCount:e.documentCount,dataRowCount:e.dataRowCount},tags:["document",e.method,e.status]};return this.storeMetric("document",s),s}collectResourceUsage(){const e={memory:this.getMemoryUsage(),cpu:this.getCpuUsage(),storage:this.getStorageUsage(),timestamp:Date.now()};return this.storeMetric("memory",{type:"memory",name:"memory.usage",value:e.memory.used,unit:"bytes",timestamp:e.timestamp,metadata:{total:e.memory.total,percentage:e.memory.percentage},tags:["resource","memory"]}),this.storeMetric("cpu",{type:"cpu",name:"cpu.usage",value:e.cpu.percentage,unit:"%",timestamp:e.timestamp,metadata:{cores:e.cpu.cores},tags:["resource","cpu"]}),e}collectUXMetrics(e){const s={type:"ux",name:`ux.${e.eventType}`,value:1,unit:"count",timestamp:Date.now(),eventType:e.eventType,target:e.target,metadata:{page:e.page,data:e.data},tags:["ux",e.eventType]};return this.storeMetric("ux",s),s}recordPageLoadTime(e,s){const r={type:"ux",name:"ux.page_load",value:e,unit:"ms",timestamp:Date.now(),pageLoadTime:e,firstContentfulPaint:s==null?void 0:s.firstContentfulPaint,timeToInteractive:s==null?void 0:s.timeToInteractive,cumulativeLayoutShift:s==null?void 0:s.cumulativeLayoutShift,firstInputDelay:s==null?void 0:s.firstInputDelay,metadata:s||{},tags:["ux","performance"]};return this.storeMetric("ux",r),r}collectCacheMetrics(e){const s={type:"cache",name:`cache.${e.operation}`,value:e.duration||0,unit:"ms",timestamp:Date.now(),metadata:{operation:e.operation,key:e.key,size:e.size},tags:["cache",e.operation]};return this.storeMetric("cache",s),s}collectCustomMetric(e){const s={type:"custom",name:e.name,value:e.value,unit:e.unit,timestamp:Date.now(),metadata:e.metadata,tags:e.tags};return this.storeMetric("custom",s),s}getMetrics(e,s){const r=this.metrics.get(e)||[];return s?r.slice(-s):r}getMetricsByTimeRange(e,s,r){return(this.metrics.get(e)||[]).filter(i=>i.timestamp>=s&&i.timestamp<=r)}getAllMetrics(){return new Map(this.metrics)}clearMetrics(e){e?this.metrics.delete(e):this.metrics.clear()}getMetricsStats(){let e=0;const s={};let r,a;for(const[i,n]of this.metrics.entries()){const l=n.length;if(e+=l,s[i]=l,n.length>0){const o=n[0].timestamp,c=n[n.length-1].timestamp;(r===void 0||o<r)&&(r=o),(a===void 0||c>a)&&(a=c)}}return{totalMetrics:e,metricsByType:s,oldestMetric:r,newestMetric:a}}storeMetric(e,s){if(Math.random()>this.config.sampleRate)return;this.metrics.has(e)||this.metrics.set(e,[]);const r=this.metrics.get(e);r.push(s),r.length>this.config.maxCacheSize&&r.shift()}startResourceMonitoring(){this.resourceMonitorInterval=window.setInterval(()=>{this.collectResourceUsage()},this.config.resourceMonitoringInterval)}stopResourceMonitoring(){this.resourceMonitorInterval!==null&&(clearInterval(this.resourceMonitorInterval),this.resourceMonitorInterval=null)}getMemoryUsage(){if(typeof performance<"u"&&performance.memory){const e=performance.memory,s=e.usedJSHeapSize||0,r=e.totalJSHeapSize||0,a=e.jsHeapSizeLimit||0,i=a>0&&a>=r?a:r;let n=0;return i>0&&(n=s/i*100,n=Math.max(0,Math.min(100,n))),{used:s,total:r,limit:a,percentage:n}}return{used:50*1024*1024,total:100*1024*1024,limit:500*1024*1024,percentage:10}}getCpuUsage(){return{percentage:0,cores:navigator.hardwareConcurrency||4}}getStorageUsage(){return navigator.storage&&navigator.storage.estimate?navigator.storage.estimate().then(e=>({used:e.usage||0,total:e.quota||0,percentage:e.quota?(e.usage||0)/e.quota*100:0})):{used:0,total:0,percentage:0}}estimateTokens(e,s){const r=Math.ceil(e.length/2),a=Math.ceil(s/2);return r+a}destroy(){this.stopResourceMonitoring(),this.metrics.clear()}}const ir=new Jt;class Kt{constructor(e,s){this.isMonitoring=!1,this.monitoringInterval=null,this.alertCallbacks=new Map,this.activeAlerts=new Map,this.lastAlertTime=new Map,this.config={autoStart:!0,monitoringInterval:1e4,metricsRetention:1440*60*1e3,enableAlerts:!0,alertDedupeTime:6e4,...e},this.collector=s||ir,this.benchmarkEvaluator=new St,this.analyzer=new Yt(this.collector,this.benchmarkEvaluator),this.config.autoStart&&this.startMonitoring()}startMonitoring(){if(this.isMonitoring){console.warn("[PerformanceMonitor] 监控已在运行中");return}this.isMonitoring=!0,this.monitoringInterval=window.setInterval(()=>{this.performMaintenanceTasks()},this.config.monitoringInterval),console.log("[PerformanceMonitor] 监控已启动")}stopMonitoring(){if(!this.isMonitoring){console.warn("[PerformanceMonitor] 监控未运行");return}this.isMonitoring=!1,this.monitoringInterval!==null&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),console.log("[PerformanceMonitor] 监控已停止")}isRunning(){return this.isMonitoring}recordMetric(e){if(!this.isMonitoring){console.warn("[PerformanceMonitor] 监控未运行，指标未记录");return}switch(e.type){case"query":this.collector.collectQueryPerformance(e);break;case"ai_call":this.collector.collectAIResponseTime(e);break;case"document":this.collector.collectDocumentGeneration(e);break;case"cache":this.collector.collectCacheMetrics(e.metadata);break;default:this.collector.collectCustomMetric({name:e.name,value:e.value,unit:e.unit,metadata:e.metadata,tags:e.tags})}this.config.enableAlerts&&this.checkAlerts(e)}recordMetrics(e){e.forEach(s=>this.recordMetric(s))}getReport(e){return this.analyzer.generateReport(e)}getLatestReport(){const e=Date.now();return this.getReport({from:e-36e5,to:e})}getCustomReport(e){const s=Date.now();return this.getReport({from:s-e,to:s})}getRealTimeMetrics(){var D;const e=Date.now(),s=e-6e4,a=this.collector.getMetricsByTimeRange("query",s,e),i=a.length>0?a.reduce((k,P)=>k+P.executionTime,0)/a.length:0,l=this.collector.getMetricsByTimeRange("ai_call",s,e),o=l.length>0?l.reduce((k,P)=>k+P.value,0)/l.length:0,c=l.filter(k=>k.success).length,h=this.collector.getMetricsByTimeRange("document",s,e),m=h.length>0?h.reduce((k,P)=>k+P.generationTime,0)/h.length:0,f=this.collector.getMetricsByTimeRange("memory",s,e),p=f.length>0?f[f.length-1]:null,x=this.collector.getMetricsByTimeRange("cpu",s,e),y=x.length>0?x[x.length-1]:null,R=this.collector.getMetricsByTimeRange("ux",s,e).filter(k=>k.name==="ux.page_load"),F=R.length>0?R.reduce((k,P)=>k+P.value,0)/R.length:0;return{timestamp:e,query:{avgResponseTime:i,queriesPerSecond:a.length/60,activeQueries:0},ai:{avgResponseTime:o,callsPerMinute:l.length,successRate:l.length>0?c/l.length*100:100},document:{avgGenerationTime:m,documentsPerMinute:h.length,successRate:100},resources:{memoryUsage:((D=p==null?void 0:p.metadata)==null?void 0:D.percentage)||0,cpuUsage:(y==null?void 0:y.value)||0,storageUsage:0},ux:{avgPageLoadTime:F,errorRate:0,activeSessions:0}}}setAlert(e,s){const r=`alert_${e.metric}_${Date.now()}`;return this.alertCallbacks.set(r,{threshold:e,callback:s}),r}removeAlert(e){return this.alertCallbacks.delete(e)}getAlerts(){return Array.from(this.activeAlerts.values())}getActiveAlerts(){return Array.from(this.activeAlerts.values()).filter(e=>!e.resolved)}clearAlert(e){const s=this.activeAlerts.get(e);s&&(s.resolved=!0,s.resolvedAt=Date.now())}clearAllAlerts(){this.activeAlerts.forEach(e=>{e.resolved=!0,e.resolvedAt=Date.now()})}checkAlerts(e){for(const[s,{threshold:r,callback:a}]of this.alertCallbacks){if(e.name!==r.metric)continue;if(this.evaluateThreshold(e.value,r)){const n=this.lastAlertTime.get(s),l=Date.now();if(n&&l-n<this.config.alertDedupeTime)continue;const o={alertId:`${s}_${l}`,timestamp:l,threshold:r,currentValue:e.value,message:this.generateAlertMessage(r,e.value),resolved:!1};this.activeAlerts.set(o.alertId,o),this.lastAlertTime.set(s,l);try{a(o)}catch(c){console.error("[PerformanceMonitor] 告警回调执行失败:",c)}(r.severity==="error"||r.severity==="critical")&&console.error("[PerformanceMonitor]",o.message)}}}evaluateThreshold(e,s){switch(s.operator){case">":return e>s.threshold;case"<":return e<s.threshold;case">=":return e>=s.threshold;case"<=":return e<=s.threshold;case"==":return e===s.threshold;default:return!1}}generateAlertMessage(e,s){const r={">":"超过","<":"低于",">=":"超过或等于","<=":"低于或等于","==":"等于"};return`[${{info:"信息",warning:"警告",error:"错误",critical:"严重"}[e.severity]}] 指标 ${e.metric} 当前值 ${s} ${r[e.operator]} 阈值 ${e.threshold}`}performMaintenanceTasks(){const s=Date.now()-this.config.metricsRetention;this.cleanupOldMetrics(s),this.cleanupOldAlerts(s)}cleanupOldMetrics(e){}cleanupOldAlerts(e){for(const[s,r]of this.activeAlerts)r.resolved&&r.resolvedAt&&r.resolvedAt<e&&(this.activeAlerts.delete(s),this.lastAlertTime.delete(s))}getStats(){const e=this.collector.getMetricsStats();return{isMonitoring:this.isMonitoring,metricsCount:e.totalMetrics,activeAlertsCount:this.getActiveAlerts().length,configuredAlertsCount:this.alertCallbacks.size}}reset(){this.stopMonitoring(),this.clearAllAlerts(),this.alertCallbacks.clear(),this.lastAlertTime.clear(),this.collector.clearMetrics()}destroy(){this.stopMonitoring(),this.reset(),this.collector.destroy()}}const lr=new Kt;function Ue(u){lr.recordMetric(u)}const $=class ${static setCollector(e){$.collector=e}static trackFunction(e,s,r){const a=performance.now(),i=$.startTracking(s,r);try{const n=e(),l=performance.now()-a;return $.stopTracking(i,l),n}catch(n){const l=performance.now()-a;throw $.stopTracking(i,l,!1),n}}static async trackAsyncFunction(e,s,r){const a=performance.now(),i=$.startTracking(s,r);try{const n=await e(),l=performance.now()-a;return $.stopTracking(i,l),n}catch(n){const l=performance.now()-a;throw $.stopTracking(i,l,!1),n}}static async trackQuery(e,s,r,a){const i=performance.now();try{const n=await r(),l=performance.now()-i,o=Array.isArray(n)?n.length:0;return $.collector&&$.collector.collectQueryPerformance({query:e,executionTime:l,rowCount:o,queryType:s,cached:(a==null?void 0:a.cached)||!1,tables:a==null?void 0:a.tables}),n}catch(n){const l=performance.now()-i;throw $.collector&&$.collector.collectQueryPerformance({query:e,executionTime:l,rowCount:0,queryType:s,cached:!1,tables:a==null?void 0:a.tables}),n}}static async trackAICall(e,s,r,a){const i=performance.now(),n=e.length;try{const l=await a(),o=performance.now()-i;let c=0;return typeof l=="string"?c=l.length:l&&(c=JSON.stringify(l).length),$.collector&&$.collector.collectAIResponseTime({prompt:e,responseTime:o,promptLength:n,responseLength:c,model:r,callType:s,success:!0}),l}catch(l){const o=performance.now()-i;throw $.collector&&$.collector.collectAIResponseTime({prompt:e,responseTime:o,promptLength:n,responseLength:0,model:r,callType:s,success:!1,error:l instanceof Error?l.message:String(l)}),l}}static async trackDocumentGeneration(e,s,r,a){const i=performance.now();try{const n=await a(),l=performance.now()-i,o=Array.isArray(n)?n.length:1;return $.collector&&$.collector.collectDocumentGeneration({templateName:e,dataRowCount:s,documentCount:o,generationTime:l,method:r,status:"success"}),n}catch(n){const l=performance.now()-i;throw $.collector&&$.collector.collectDocumentGeneration({templateName:e,dataRowCount:s,documentCount:0,generationTime:l,method:r,status:"failed"}),n}}static createDecorator(e,s){return function(r,a,i){const n=i.value,l=e||`${r.constructor.name}.${String(a)}`;return i.value=async function(...o){return $.trackAsyncFunction(()=>n.apply(this,o),l,s)},i}}static createClassDecorator(e,s=[]){return function(r){return class extends r{constructor(...a){super(...a);const i=r.prototype;Object.getOwnPropertyNames(i).filter(l=>typeof i[l]=="function"&&l!=="constructor"&&!s.includes(l)).forEach(l=>{const o=i[l],c=e?`${e}.${l}`:`${r.name}.${l}`;i[l]=function(...d){return o.constructor.name==="AsyncFunction"?$.trackAsyncFunction(()=>o.apply(this,d),c):$.trackFunction(()=>o.apply(this,d),c)}})}}}}static startTracking(e,s){const r=`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a={name:e,startTime:performance.now(),metadata:s};return $.activeTrackers.set(r,a),r}static stopTracking(e,s,r=!0){const a=$.activeTrackers.get(e);if(!a){console.warn(`Tracker ${e} not found`);return}const i=s??performance.now()-a.startTime;$.collector&&$.collector.collectCustomMetric({name:a.name,value:i,unit:"ms",metadata:{...a.metadata,success:r},tags:["custom",r?"success":"error"]}),$.activeTrackers.delete(e)}static measure(e,s){const r=performance.now(),a=s(),i=performance.now()-r;return $.collector&&$.collector.collectCustomMetric({name:e,value:i,unit:"ms"}),{result:a,duration:i}}static async measureAsync(e,s){const r=performance.now(),a=await s(),i=performance.now()-r;return $.collector&&$.collector.collectCustomMetric({name:e,value:i,unit:"ms"}),{result:a,duration:i}}static getActiveTrackers(){return new Map($.activeTrackers)}static clearActiveTrackers(){$.activeTrackers.clear()}};$.activeTrackers=new Map;let he=$;function or(u){he.setCollector(u)}const cr="1.0.0",dr="Phase 2 - 性能优化";new Date().toISOString();function ur(u){const e=new Jt(u==null?void 0:u.collector),s=u!=null&&u.benchmarks?new St({...Fe,...u.benchmarks,queries:{...Fe.queries,...u.benchmarks.queries},ai:{...Fe.ai,...u.benchmarks.ai},document:{...Fe.document,...u.benchmarks.document},resources:{...Fe.resources,...u.benchmarks.resources}}):new St,r=new Yt(e,s);return{monitor:new Kt(u==null?void 0:u.monitor,e),collector:e,analyzer:r,benchmarkEvaluator:s}}function mr(u){const e=ur(u);return or(e.collector),console.log("[PerformanceMonitoring] 系统已初始化",{version:cr,phase:dr,config:u}),e}const pr=({sheets:u,primarySheet:e,onPrimarySheetChange:s,enabledSheets:r,onEnabledSheetsChange:a,disabled:i=!1})=>{const n=N.useMemo(()=>Object.entries(u).map(([m,f])=>{const p=f,x=p.length,y=p.length>0?Object.keys(p[0]).length:0,E=p.length>0?Object.keys(p[0]).slice(0,3):[];return{name:m,rowCount:x,columnCount:y,sampleFields:E}}),[u]),l=N.useMemo(()=>n.find(m=>m.name===e)||n[0],[n,e]),o=N.useMemo(()=>n.filter(m=>m.name!==e),[n,e]),c=m=>{i||(r.includes(m)?a(r.filter(f=>f!==m)):a([...r,m]))},d=()=>{if(i)return;const m=o.map(p=>p.name),f=m.every(p=>r.includes(p));a(f?[]:m)},h=N.useMemo(()=>o.length===0?!1:o.every(m=>r.includes(m.name)),[o,r]);return N.useMemo(()=>{const m=o.filter(f=>r.includes(f.name)).length;return m>0&&m<o.length},[o,r]),t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-white rounded-xl border border-slate-200 overflow-hidden",children:[t.jsx("div",{className:"bg-slate-50/50 border-b border-slate-200 px-4 py-3",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"bg-emerald-100 p-1.5 rounded-lg",children:t.jsx(_t,{className:"w-4 h-4 text-emerald-600"})}),t.jsx("h3",{className:"text-sm font-bold text-slate-800",children:"主数据表"})]})}),t.jsxs("div",{className:"p-4",children:[t.jsx("div",{className:"mb-3",children:t.jsxs("div",{className:"relative group",children:[t.jsx("select",{value:e,onChange:m=>s(m.target.value),disabled:i,className:`
                  w-full px-4 py-2.5 pr-10 rounded-xl border appearance-none
                  text-sm font-medium text-slate-700 transition-all bg-slate-50
                  focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 focus:bg-white
                  ${i?"bg-slate-100 border-slate-200 text-slate-400 cursor-not-allowed":"border-slate-200 hover:border-emerald-400 cursor-pointer"}
                `,children:n.map(m=>t.jsx("option",{value:m.name,children:m.name},m.name))}),t.jsx("div",{className:`
                absolute right-0 top-0 bottom-0 w-10 flex items-center justify-center pointer-events-none rounded-r-xl transition-colors
                ${i?"text-slate-400":"text-slate-500 group-hover:text-emerald-500"}
              `,children:t.jsx(ct,{className:"w-4 h-4"})})]})}),l&&t.jsxs("div",{className:"bg-slate-50 rounded-xl p-3 border border-slate-100 flex flex-col gap-3",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"bg-white p-1.5 rounded border border-slate-200",children:t.jsx($t,{className:"w-3.5 h-3.5 text-slate-500"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"text-[10px] text-slate-400 font-medium leading-none mb-0.5",children:"数据行"}),t.jsx("span",{className:"text-xs font-bold text-slate-700 font-mono leading-none",children:l.rowCount})]})]}),t.jsx("div",{className:"w-px h-6 bg-slate-200"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"bg-white p-1.5 rounded border border-slate-200",children:t.jsx(Ft,{className:"w-3.5 h-3.5 text-slate-500"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"text-[10px] text-slate-400 font-medium leading-none mb-0.5",children:"字段列"}),t.jsx("span",{className:"text-xs font-bold text-slate-700 font-mono leading-none",children:l.columnCount})]})]})]}),l.sampleFields.length>0&&t.jsxs("div",{className:"flex flex-col gap-1.5 pt-2 border-t border-slate-200/60",children:[t.jsx("span",{className:"text-[10px] text-slate-400 font-medium",children:"包含字段预览:"}),t.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[l.sampleFields.slice(0,3).map(m=>t.jsx("span",{className:"text-[10px] bg-white border border-slate-200 px-1.5 py-0.5 rounded text-slate-600 max-w-full truncate",children:m},m)),l.sampleFields.length>3&&t.jsx("span",{className:"text-[10px] text-slate-400 self-center",children:"..."})]})]})]})]})]}),o.length>0?t.jsxs("div",{className:"bg-white rounded-xl border border-slate-200 overflow-hidden",children:[t.jsx("div",{className:"bg-slate-50/50 border-b border-slate-200 px-4 py-3",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"bg-slate-100 p-1.5 rounded-lg border border-slate-200",children:t.jsx(te,{className:"w-3.5 h-3.5 text-slate-600"})}),t.jsx("h3",{className:"text-sm font-bold text-slate-800",children:"辅助数据表"})]}),t.jsx("button",{onClick:d,disabled:i,className:`
                  px-3 py-1.5 rounded-lg text-sm font-medium transition-all
                  ${i?"bg-slate-100 text-slate-400 cursor-not-allowed":"bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-900 border-dashed"}
                `,children:h?"取消全选":"全选"})]})}),t.jsx("div",{className:"p-4 space-y-3 max-h-96 overflow-y-auto",children:o.map(m=>{const f=r.includes(m.name);return t.jsx("div",{className:`
                    rounded-xl border p-3 transition-all
                    ${i?"bg-slate-50 border-slate-200 opacity-60":f?"bg-emerald-50/50 border-emerald-200 shadow-sm":"bg-white border-slate-200 hover:border-emerald-300 hover:shadow-sm cursor-pointer"}
                  `,onClick:()=>!i&&c(m.name),children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:`
                      flex-shrink-0 w-5 h-5 rounded-md border flex items-center justify-center transition-all
                      ${i?"bg-slate-100 border-slate-300":f?"bg-emerald-500 border-emerald-500":"bg-white border-slate-300 group-hover:border-emerald-400"}
                    `,children:f&&t.jsx(Ve,{className:"w-3.5 h-3.5 text-white"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("h4",{className:"text-base font-bold text-slate-800",children:m.name}),t.jsxs("div",{className:"flex items-center gap-3 text-xs text-slate-500",children:[t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx($t,{className:"w-3 h-3"}),m.rowCount," 行"]}),t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(Ft,{className:"w-3 h-3"}),m.columnCount," 列"]})]})]}),m.sampleFields.length>0&&t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsx("span",{className:"text-xs text-slate-500",children:"主要字段:"}),m.sampleFields.map(p=>t.jsx("span",{className:"px-2 py-0.5 bg-slate-100 text-slate-600 text-xs rounded-md font-mono",children:p},p)),m.columnCount>3&&t.jsxs("span",{className:"text-xs text-slate-400",children:["+",m.columnCount-3," 个字段"]})]})]})]})},m.name)})}),r.length>0&&t.jsx("div",{className:"px-4 py-3 bg-blue-50 border-t border-blue-100",children:t.jsxs("p",{className:"text-sm text-blue-700",children:[t.jsxs("span",{className:"font-medium",children:["已启用 ",r.length," 个辅助表"]})," ","可用于跨Sheet查找和关联数据"]})})]}):t.jsxs("div",{className:"bg-slate-50 rounded-xl border border-dashed border-slate-300 p-8 text-center",children:[t.jsx(te,{className:"w-12 h-12 text-slate-400 mx-auto mb-3"}),t.jsx("h4",{className:"text-base font-semibold text-slate-700 mb-2",children:"当前只有一个工作表"}),t.jsx("p",{className:"text-sm text-slate-500",children:"上传包含多个工作表的Excel文件可启用跨Sheet查找功能"})]})]})},hr={sum:"求和",avg:"平均值",count:"计数",max:"最大值",min:"最小值",first:"第一个",last:"最后一个",join:"连接"},gr=({mode:u,aggregateConfig:e,availableFields:s,onModeChange:r,onAggregateConfigChange:a,disabled:i=!1})=>{const[n,l]=N.useState(!1),o=()=>{if(s.length===0)return;const m={field:s[0],operation:"sum",alias:""};a({...e,rules:[...e.rules,m]})},c=m=>{a({...e,rules:e.rules.filter((f,p)=>p!==m)})},d=(m,f)=>{const p=[...e.rules];p[m]={...p[m],...f},a({...e,rules:p})},h=m=>{const f=e.groupBy||[],p=f.includes(m)?f.filter(x=>x!==m):[...f,m];a({...e,groupBy:p})};return t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsxs("h3",{className:"font-semibold text-slate-700 flex items-center gap-2 mb-2",children:[t.jsx(gt,{className:"w-4 h-4"}),"生成模式"]}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsxs("button",{onClick:()=>r("individual"),disabled:i,className:`
              relative px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 border
              ${u==="individual"?"bg-emerald-50 border-emerald-500 text-emerald-700 shadow-sm":"bg-white border-slate-200 text-slate-600 hover:border-emerald-200 hover:bg-slate-50"}
              ${i?"opacity-50 cursor-not-allowed":"cursor-pointer"}
            `,children:[t.jsxs("div",{className:"flex items-center justify-center gap-2",children:[t.jsx(gt,{className:`w-4 h-4 ${u==="individual"?"text-emerald-600":"text-slate-400"}`}),t.jsx("span",{children:"逐行生成"}),u==="individual"&&t.jsx(Ve,{className:"w-4 h-4 ml-auto text-emerald-600"})]}),t.jsx("p",{className:`text-xs mt-1 text-left ${u==="individual"?"text-emerald-600/80":"text-slate-400"}`,children:"为每一行数据生成一个文档"})]}),t.jsxs("button",{onClick:()=>r("aggregate"),disabled:i,className:`
              relative px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 border
              ${u==="aggregate"?"bg-emerald-50 border-emerald-500 text-emerald-700 shadow-sm":"bg-white border-slate-200 text-slate-600 hover:border-emerald-200 hover:bg-slate-50"}
              ${i?"opacity-50 cursor-not-allowed":"cursor-pointer"}
            `,children:[t.jsxs("div",{className:"flex items-center justify-center gap-2",children:[t.jsx(gt,{className:`w-4 h-4 ${u==="aggregate"?"text-emerald-600":"text-slate-400"}`}),t.jsx("span",{children:"聚合汇总"}),u==="aggregate"&&t.jsx(Ve,{className:"w-4 h-4 ml-auto text-emerald-600"})]}),t.jsx("p",{className:`text-xs mt-1 text-left ${u==="aggregate"?"text-emerald-600/80":"text-slate-400"}`,children:"生成统计汇总文档"})]})]})]}),u==="aggregate"&&t.jsxs("div",{className:"bg-slate-50 rounded-xl p-4 border border-slate-200",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("h4",{className:"font-semibold text-slate-700 text-sm flex items-center gap-2",children:[t.jsx(vt,{className:"w-4 h-4 text-emerald-500"}),"聚合规则配置"]}),t.jsxs("button",{onClick:()=>l(!n),className:"text-xs text-purple-600 hover:text-purple-700 font-medium",children:[n?"收起":"展开",t.jsx(ct,{className:`w-3 h-3 inline ml-1 transition-transform ${n?"rotate-180":""}`})]})]}),n&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("span",{className:"text-xs font-medium text-slate-600",children:"聚合规则"}),t.jsxs("button",{onClick:o,disabled:i||s.length===0,className:"text-xs bg-purple-500 text-white px-2 py-1 rounded hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1",children:[t.jsx(Pe,{className:"w-3 h-3"}),"添加规则"]})]}),e.rules.length===0?t.jsx("div",{className:"text-xs text-slate-500 text-center py-4 bg-white rounded border border-slate-200",children:"暂无聚合规则，点击上方按钮添加"}):t.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:e.rules.map((m,f)=>t.jsxs("div",{className:"bg-white p-3 rounded-lg border border-slate-200 shadow-sm",children:[t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsxs("div",{className:"flex-1 grid grid-cols-3 gap-2",children:[t.jsx("select",{value:m.field,onChange:p=>d(f,{field:p.target.value}),disabled:i,className:"px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50",children:s.map(p=>t.jsx("option",{value:p,children:p},p))}),t.jsx("select",{value:m.operation,onChange:p=>d(f,{operation:p.target.value}),disabled:i,className:"px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50",children:Object.entries(hr).map(([p,x])=>t.jsx("option",{value:p,children:x},p))}),t.jsx("input",{type:"text",value:m.alias||"",onChange:p=>d(f,{alias:p.target.value}),placeholder:"别名(可选)",disabled:i,className:"px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50"})]}),t.jsx("button",{onClick:()=>c(f),disabled:i,className:"p-1.5 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:t.jsx(De,{className:"w-4 h-4"})})]}),m.operation==="join"&&t.jsx("input",{type:"text",value:m.delimiter||", ",onChange:p=>d(f,{delimiter:p.target.value}),placeholder:"分隔符(默认: , )",disabled:i,className:"mt-2 px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50 w-full"})]},f))})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-xs font-medium text-slate-600 block mb-2",children:"分组字段（可选）"}),s.length===0?t.jsx("div",{className:"text-xs text-slate-500 text-center py-2 bg-white rounded border border-slate-200",children:"请先上传数据文件"}):t.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.map(m=>{const f=(e.groupBy||[]).includes(m);return t.jsxs("button",{onClick:()=>h(m),disabled:i,className:`
                            px-2.5 py-1.5 text-xs rounded-lg border transition-all
                            ${f?"bg-purple-500 text-white border-purple-500 shadow-sm":"bg-white text-slate-600 border-slate-300 hover:border-purple-400"}
                            ${i?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                          `,children:[m,f&&t.jsx(Ve,{className:"w-3 h-3 inline ml-1"})]},m)})})]}),t.jsx("div",{className:"bg-blue-50 text-blue-700 px-3 py-2 rounded-lg border border-blue-200",children:t.jsxs("p",{className:"text-xs leading-relaxed",children:[t.jsx(vt,{className:"w-3 h-3 inline mr-1"}),t.jsx("strong",{children:"提示："}),e.rules.length===0?"请至少添加一条聚合规则。":e.groupBy&&e.groupBy.length>0?`已配置${e.rules.length}条聚合规则，按${e.groupBy.join("、")}分组，将生成多个汇总文档。`:`已配置${e.rules.length}条聚合规则，将生成单个汇总文档。`]})})]})]})]})},tt=({title:u,icon:e,defaultOpen:s=!0,children:r,badge:a})=>{const[i,n]=N.useState(s);return t.jsxs("div",{className:"space-y-2",children:[t.jsxs("button",{onClick:()=>n(!i),className:"w-full flex items-center justify-between p-3 rounded-xl transition-all hover:bg-slate-50 group border border-transparent hover:border-slate-200",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-shrink-0 text-slate-400 group-hover:text-emerald-500 transition-colors",children:e}),t.jsx("span",{className:"font-semibold text-slate-700 text-sm group-hover:text-slate-900",children:u}),a!==void 0&&t.jsx("span",{className:"px-2 py-0.5 bg-emerald-100 text-emerald-600 rounded-full text-xs font-bold",children:a})]}),t.jsx(ct,{className:`w-4 h-4 text-slate-400 group-hover:text-slate-600 transition-transform duration-200 ${i?"rotate-180":""}`})]}),i&&t.jsx("div",{className:"pl-2 animate-fadeIn",children:r})]})},xr=({templateFile:u,dataFile:e,excelData:s,userInstruction:r,mappingScheme:a,generatedDocs:i,isProcessing:n,processingStage:l,progress:o,logs:c,performanceMetrics:d,primarySheet:h,enabledSheets:m,onTemplateUpload:f,onDataUpload:p,onInstructionChange:x,onPrimarySheetChange:y,onEnabledSheetsChange:E,onGenerateMapping:R,onGenerateDocs:F,onDownloadDoc:D,onDownloadAll:k,onImportScheme:P,generationMode:ue,aggregateConfig:oe,onAggregateConfigChange:ae,availableFields:fe,onGenerationModeChange:ye,isCollapsed:B=!1,onToggleCollapse:V})=>{const ce=async O=>{var G;const Q=(G=O.target.files)==null?void 0:G[0];Q&&await f(Q)},me=async O=>{var G;const Q=(G=O.target.files)==null?void 0:G[0];Q&&await p(Q)},Z=O=>O?O<1e3?`${O}ms`:`${(O/1e3).toFixed(2)}s`:"-",se=O=>{switch(O){case"success":return t.jsx(Te,{className:"w-4 h-4 text-emerald-500"});case"error":return t.jsx(nt,{className:"w-4 h-4 text-red-500"});default:return t.jsx(Ce,{className:"w-4 h-4 text-blue-500 animate-spin"})}},ge=O=>{switch(O){case"success":return"bg-emerald-50 text-emerald-700 border-emerald-200";case"error":return"bg-red-50 text-red-700 border-red-200";default:return"bg-blue-50 text-blue-700 border-blue-200"}};return t.jsxs("div",{className:"flex flex-col h-full bg-slate-50 relative group/sidebar",children:[t.jsx("div",{className:`bg-white border-b border-slate-200 flex-shrink-0 transition-all duration-300 ${B?"p-2":"p-4"}`,children:t.jsxs("div",{className:`flex items-center ${B?"justify-center flex-col gap-2":"justify-between"}`,children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"bg-emerald-500 p-2 rounded-lg flex-shrink-0 relative group",children:[t.jsx(Ze,{className:"w-5 h-5 text-white"}),B&&t.jsx("div",{className:"absolute left-full top-0 ml-2 bg-slate-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none",children:"文档空间"})]}),!B&&t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-bold text-slate-800",children:"文档空间"}),t.jsx("p",{className:"text-xs text-slate-500",children:"智能文档填充工作台"})]})]}),V&&t.jsx("button",{onClick:V,className:`text-slate-400 hover:text-emerald-500 hover:bg-slate-50 rounded-lg transition-colors flex-shrink-0 ${B?"p-1 mt-2":"p-2"}`,title:B?"展开侧边栏":"折叠侧边栏",children:t.jsx("div",{className:"w-5 h-5 flex items-center justify-center",children:B?t.jsx(xt,{className:"w-4 h-4 rotate-180"}):t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 19l-7-7 7-7m8 14l-7-7 7-7"})})})})]})}),t.jsx("div",{className:`flex-1 overflow-y-auto ${B?"px-2 py-4":"p-6"} space-y-6 scrollbar-thin scrollbar-thumb-slate-200 scrollbar-track-transparent`,children:B?t.jsxs("div",{className:"flex flex-col items-center gap-6",children:[t.jsxs("div",{className:"relative group",children:[t.jsxs("label",{className:"cursor-pointer w-10 h-10 flex items-center justify-center bg-orange-50 text-orange-500 hover:bg-orange-100 rounded-xl transition-colors",children:[t.jsx("input",{type:"file",className:"hidden",accept:".docx",onChange:ce}),t.jsx(te,{className:"w-5 h-5"})]}),t.jsx("div",{className:"absolute left-full top-0 ml-2 bg-slate-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none",children:u?"更换模板":"上传模板"}),u&&t.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"})]}),t.jsxs("div",{className:"relative group",children:[t.jsxs("label",{className:"cursor-pointer w-10 h-10 flex items-center justify-center bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded-xl transition-colors",children:[t.jsx("input",{type:"file",className:"hidden",accept:".xlsx,.xls,.csv",onChange:me}),t.jsx(_e,{className:"w-5 h-5"})]}),t.jsx("div",{className:"absolute left-full top-0 ml-2 bg-slate-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none",children:e?"更换数据":"上传数据"}),e&&t.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"})]}),t.jsx("div",{className:"w-8 h-px bg-slate-200"}),t.jsxs("div",{className:"relative group",children:[t.jsx("div",{className:"w-10 h-10 flex items-center justify-center bg-purple-50 text-purple-600 rounded-xl",children:t.jsx(st,{className:"w-5 h-5"})}),t.jsx("div",{className:"absolute left-full top-0 ml-2 bg-slate-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none",children:r?"指令已输入":"展开以输入指令"})]}),t.jsxs("div",{className:"flex flex-col gap-3 mt-auto",children:[t.jsxs("button",{onClick:R,disabled:!u||!s||n,className:"w-10 h-10 flex items-center justify-center bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed group relative",children:[n&&l==="ai_mapping"?t.jsx(Ce,{className:"w-5 h-5 animate-spin"}):t.jsx(ft,{className:"w-5 h-5"}),t.jsx("div",{className:"absolute left-full top-0 ml-2 bg-slate-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none",children:"生成映射"})]}),t.jsxs("button",{onClick:F,disabled:!a||n,className:"w-10 h-10 flex items-center justify-center bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed group relative",children:[n&&l==="document_generation"?t.jsx(Ce,{className:"w-5 h-5 animate-spin"}):t.jsx(Ze,{className:"w-5 h-5"}),t.jsx("div",{className:"absolute left-full top-0 ml-2 bg-slate-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none",children:"生成文档"})]})]})]}):t.jsxs(t.Fragment,{children:[(d.templateUpload||d.aiMapping||d.documentGeneration)&&t.jsx(tt,{title:"性能监控",icon:t.jsx(os,{className:"w-4 h-4 text-blue-500"}),defaultOpen:!1,children:t.jsx("div",{className:"bg-gradient-to-br from-slate-50 to-slate-100 rounded-lg p-3 border border-slate-200",children:t.jsxs("div",{className:"space-y-2 text-xs",children:[d.templateUpload&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-slate-600",children:"模板解析"}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ft,{className:"w-3 h-3 text-yellow-500"}),t.jsx("span",{className:"font-medium text-slate-800",children:Z(d.templateUpload)})]})]}),d.aiMapping&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-slate-600",children:"AI映射"}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ls,{className:"w-3 h-3 text-blue-500"}),t.jsx("span",{className:"font-medium text-slate-800",children:Z(d.aiMapping)})]})]}),d.documentGeneration&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-slate-600",children:"文档生成"}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ft,{className:"w-3 h-3 text-green-500"}),t.jsx("span",{className:"font-medium text-slate-800",children:Z(d.documentGeneration)})]})]})]})})}),n&&t.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 border border-blue-200",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ce,{className:"w-4 h-4 text-blue-500 animate-spin"}),t.jsxs("span",{className:"text-sm font-medium text-blue-700",children:[l==="template_upload"&&"正在解析模板...",l==="data_upload"&&"正在读取数据...",l==="ai_mapping"&&"AI正在生成映射...",l==="ai_batch_processing"&&"AI 深度处理中...",l==="document_generation"&&"正在生成文档..."]})]}),t.jsxs("span",{className:"text-sm font-bold text-blue-700",children:[o,"%"]})]}),t.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:t.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-300",style:{width:`${o}%`}})})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("h3",{className:"flex items-center gap-2 text-sm font-semibold text-slate-700",children:[t.jsx("div",{className:"bg-slate-100 p-1.5 rounded-lg",children:t.jsx(te,{className:"w-4 h-4 text-slate-500"})}),"Word模板文件"]}),t.jsxs("label",{className:`
            group relative flex items-center justify-center w-full h-24 
            border-2 border-dashed rounded-xl cursor-pointer transition-all duration-300
            ${u?"bg-emerald-50 border-emerald-300 hover:border-emerald-500":"bg-slate-50/50 border-slate-200 hover:border-emerald-400 hover:bg-white"}
          `,children:[t.jsx("input",{type:"file",accept:".docx",onChange:ce,className:"hidden",disabled:n}),u?t.jsxs("div",{className:"flex items-center gap-3 w-full px-4",children:[t.jsx("div",{className:"bg-emerald-100 p-2 rounded-lg text-emerald-600",children:t.jsx(te,{className:"w-5 h-5"})}),t.jsxs("div",{className:"flex-1 min-w-0 text-left",children:[t.jsx("p",{className:"text-sm font-semibold text-slate-800 truncate",children:u.name}),t.jsxs("p",{className:"text-xs text-emerald-600 flex items-center gap-1 mt-0.5",children:[t.jsx(Te,{className:"w-3 h-3"}),u.placeholders.length," 个占位符"]})]}),t.jsx("div",{className:"p-1.5 rounded-lg bg-emerald-200/50 text-emerald-700",children:t.jsx(Ze,{className:"w-4 h-4"})})]}):t.jsxs("div",{className:"flex flex-col items-center gap-2 text-slate-400 group-hover:text-emerald-600 transition-colors",children:[t.jsx(qe,{className:"w-6 h-6"}),t.jsx("span",{className:"text-sm font-medium",children:"点击上传 Word 模板"})]})]})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("h3",{className:"flex items-center gap-2 text-sm font-semibold text-slate-700",children:[t.jsx("div",{className:"bg-slate-100 p-1.5 rounded-lg",children:t.jsx(_e,{className:"w-4 h-4 text-slate-500"})}),"Excel数据源"]}),t.jsxs("label",{className:`
            group relative flex items-center justify-center w-full h-24 
            border-2 border-dashed rounded-xl cursor-pointer transition-all duration-300
            ${e?"bg-emerald-50 border-emerald-300 hover:border-emerald-500":"bg-slate-50/50 border-slate-200 hover:border-emerald-400 hover:bg-white"}
          `,children:[t.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:me,className:"hidden",disabled:n}),e?t.jsxs("div",{className:"flex items-center gap-3 w-full px-4",children:[t.jsx("div",{className:"bg-emerald-100 p-2 rounded-lg text-emerald-600",children:t.jsx(_e,{className:"w-5 h-5"})}),t.jsxs("div",{className:"flex-1 min-w-0 text-left",children:[t.jsx("p",{className:"text-sm font-semibold text-slate-800 truncate",children:e.name}),t.jsxs("p",{className:"text-xs text-emerald-600 flex items-center gap-1 mt-0.5",children:[t.jsx(Te,{className:"w-3 h-3"}),"已加载"]})]}),t.jsx("div",{className:"p-1.5 rounded-lg bg-emerald-200/50 text-emerald-700",children:t.jsx(Ze,{className:"w-4 h-4"})})]}):t.jsxs("div",{className:"flex flex-col items-center gap-2 text-slate-400 group-hover:text-emerald-600 transition-colors",children:[t.jsx(qe,{className:"w-6 h-6"}),t.jsx("span",{className:"text-sm font-medium",children:"点击上传 Excel 数据"})]})]})]}),t.jsx("div",{className:"flex justify-end px-1 -mt-2",children:t.jsxs("label",{className:"text-xs text-slate-500 hover:text-emerald-600 cursor-pointer flex items-center gap-1 transition-colors px-2 py-1 rounded hover:bg-emerald-50",title:"导入已保存的映射配置 (.ems)",children:[t.jsx(qe,{className:"w-3 h-3"}),"导入配置",t.jsx("input",{type:"file",accept:".ems,.json",onChange:O=>{var G;const Q=(G=O.target.files)==null?void 0:G[0];Q&&P&&(P(Q),O.target.value="")},className:"hidden",disabled:n})]})}),s&&s.sheets&&Object.keys(s.sheets).length>0&&t.jsx(pr,{sheets:s.sheets,primarySheet:h,onPrimarySheetChange:y,enabledSheets:m,onEnabledSheetsChange:E,disabled:n}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("h3",{className:"flex items-center gap-2 text-sm font-semibold text-slate-700",children:[t.jsx("div",{className:"bg-slate-100 p-1.5 rounded-lg",children:t.jsx(st,{className:"w-4 h-4 text-slate-500"})}),"AI 智能指令"]}),t.jsxs("div",{className:"relative group",children:[t.jsx("textarea",{value:r,onChange:O=>x(O.target.value),placeholder:`请输入处理指令，例如：
“把销售额大于10万的产品信息填入模板，生成产品介绍文档”`,className:"w-full h-32 px-4 py-3 text-sm bg-slate-50 border border-slate-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all placeholder:text-slate-400 group-hover:bg-white",disabled:n}),t.jsx("div",{className:"absolute right-3 bottom-3",children:t.jsx("div",{className:"p-1.5 bg-white rounded-lg border border-slate-200 shadow-sm text-slate-400 group-hover:text-emerald-500 group-focus-within:text-emerald-600 transition-colors",children:t.jsx(xt,{className:"w-4 h-4"})})})]})]}),a&&t.jsx(gr,{mode:ue,aggregateConfig:oe,availableFields:fe,onModeChange:ye,onAggregateConfigChange:ae,disabled:n}),a&&t.jsx(tt,{title:"映射方案",icon:t.jsx(Te,{className:"w-4 h-4 text-emerald-500"}),defaultOpen:!0,children:t.jsxs("div",{className:"bg-slate-50 rounded-lg p-3 space-y-3 border border-slate-200",children:[a.primarySheet&&t.jsx("div",{className:"text-xs bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg border border-emerald-200",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(_e,{className:"w-3 h-3"}),t.jsxs("span",{className:"font-medium",children:["主数据表: ",a.primarySheet]})]})}),t.jsx("p",{className:"text-xs text-slate-600 leading-relaxed",children:a.explanation}),a.mappings.length>0&&t.jsxs("div",{children:[t.jsxs("p",{className:"text-xs font-semibold text-emerald-600 mb-2 flex items-center gap-1",children:[t.jsx(Te,{className:"w-3 h-3"}),"已映射 (",a.mappings.length,")"]}),t.jsx("div",{className:"space-y-1.5 max-h-32 overflow-y-auto",children:a.mappings.map((O,Q)=>t.jsxs("div",{className:"text-xs bg-white p-2 rounded border border-emerald-200 shadow-sm",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"font-medium text-orange-600",children:O.placeholder}),t.jsx("span",{className:"text-slate-400",children:"→"}),t.jsx("span",{className:"text-emerald-600 font-medium",children:O.excelColumn})]}),O.transform&&t.jsxs("span",{className:"text-slate-400 block mt-1 text-[10px] italic",children:["转换: ",O.transform]})]},Q))})]}),a.crossSheetMappings&&a.crossSheetMappings.length>0&&t.jsxs("div",{children:[t.jsxs("p",{className:"text-xs font-semibold text-purple-600 mb-2 flex items-center gap-1",children:[t.jsx(te,{className:"w-3 h-3"}),"跨Sheet查找 (",a.crossSheetMappings.length,")"]}),t.jsx("div",{className:"space-y-1.5 max-h-32 overflow-y-auto",children:a.crossSheetMappings.map((O,Q)=>t.jsxs("div",{className:"text-xs bg-purple-50 p-2 rounded border border-purple-200 shadow-sm",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("span",{className:"font-medium text-orange-600",children:O.placeholder}),t.jsx("span",{className:"text-slate-400",children:"→"}),t.jsxs("span",{className:"text-purple-600 font-medium",children:[O.sourceSheet,".",O.sourceColumn]})]}),t.jsxs("div",{className:"text-[10px] text-slate-500",children:["关联字段: ",O.lookupKey," (",O.relationshipType,")"]}),O.transform&&t.jsxs("span",{className:"text-slate-400 block mt-1 text-[10px] italic",children:["转换: ",O.transform]})]},Q))})]}),a.filterCondition&&t.jsxs("div",{children:[t.jsx("p",{className:"text-xs font-semibold text-blue-600 mb-1",children:"筛选条件"}),t.jsx("code",{className:"text-xs bg-blue-50 text-blue-700 p-2 rounded block border border-blue-200",children:a.filterCondition})]}),a.unmappedPlaceholders.length>0&&t.jsxs("div",{children:[t.jsxs("p",{className:"text-xs font-semibold text-amber-600 mb-2 flex items-center gap-1",children:[t.jsx(nt,{className:"w-3 h-3"}),"未映射 (",a.unmappedPlaceholders.length,")"]}),t.jsx("div",{className:"flex flex-wrap gap-1",children:a.unmappedPlaceholders.map((O,Q)=>t.jsx("span",{className:"text-xs bg-amber-50 text-amber-700 px-2 py-1 rounded border border-amber-200",children:O},Q))})]}),a.confidence!==void 0&&t.jsxs("div",{className:"text-xs text-slate-500",children:["置信度: ",Math.round(a.confidence*100),"%"]})]})}),i.length>0&&t.jsx(tt,{title:"已生成文档",icon:t.jsx(te,{className:"w-4 h-4 text-emerald-500"}),defaultOpen:!0,children:t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"flex items-center justify-end",children:t.jsxs("button",{onClick:k,className:"text-xs bg-blue-500 text-white px-3 py-1.5 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1 shadow-sm",children:[t.jsx(Le,{className:"w-3 h-3"}),"下载全部"]})}),t.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:i.map((O,Q)=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg hover:border-emerald-300 transition-all group",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[t.jsx(te,{className:"w-4 h-4 text-emerald-500 flex-shrink-0"}),t.jsx("span",{className:"text-sm text-slate-700 truncate",children:O.fileName})]}),t.jsxs("button",{onClick:()=>D(O),className:"text-xs bg-emerald-500 text-white px-3 py-1.5 rounded-lg hover:bg-emerald-600 hover:shadow-md transition-all flex items-center gap-1 shadow-sm",children:[t.jsx(Le,{className:"w-3 h-3"}),"下载"]})]},Q))})]})}),c.length>0&&t.jsx(tt,{title:"处理日志",icon:t.jsx(xt,{className:"w-4 h-4 text-slate-500"}),defaultOpen:!1,children:t.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto pr-1",children:c.slice(0,20).map(O=>{var Q;return t.jsx("div",{className:`text-xs p-3 rounded-lg border transition-all ${ge(O.status)}`,children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("div",{className:"flex-shrink-0 mt-0.5",children:se(O.status)}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"break-words",children:O.message}),((Q=O.details)==null?void 0:Q.duration)&&t.jsxs("p",{className:"text-[10px] mt-1 opacity-75",children:["耗时: ",Z(O.details.duration)]})]})]})},O.id)})})})]})}),!B&&t.jsxs("div",{className:"p-4 border-t border-slate-200 bg-white space-y-2 shadow-lg",children:[t.jsx("button",{onClick:R,disabled:!u||!e||!r.trim()||n,className:"w-full py-3 bg-orange-500 text-white rounded-lg font-medium hover:bg-orange-600 disabled:bg-slate-300 disabled:text-slate-600 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg",children:n&&l==="ai_mapping"?t.jsxs(t.Fragment,{children:[t.jsx(Ce,{className:"w-4 h-4 animate-spin"}),"AI分析中..."]}):t.jsxs(t.Fragment,{children:[t.jsx(st,{className:"w-4 h-4"}),"生成映射方案"]})}),a&&t.jsx("button",{onClick:F,disabled:n,className:"w-full py-3 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600 disabled:bg-slate-300 disabled:text-slate-600 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg",children:n&&l==="document_generation"?t.jsxs(t.Fragment,{children:[t.jsx(Ce,{className:"w-4 h-4 animate-spin"}),"生成中... (",o,"%)"]}):t.jsxs(t.Fragment,{children:[t.jsx(Le,{className:"w-4 h-4"}),"生成Word文档"]})})]})]})},fr=({templateFile:u})=>{const e=h=>h.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=N.useMemo(()=>{let h=u.htmlPreview;return h=h.replace(/\n/g,"<br>"),u.placeholders.forEach(m=>{const f=new RegExp(e(m),"g");h=h.replace(f,`<span class="bg-yellow-200 text-orange-700 px-2 py-1 rounded font-medium border-2 border-orange-300">${m}</span>`)}),h},[u]),r=()=>{const h=u.placeholders.join(`
`);navigator.clipboard.writeText(h)},a=h=>h<1024?h+" B":h<1024*1024?(h/1024).toFixed(2)+" KB":(h/(1024*1024)).toFixed(2)+" MB",[i,n]=Be.useState(!1),[l,o]=Be.useState(""),c=N.useMemo(()=>l?u.placeholders.filter(h=>h.toLowerCase().includes(l.toLowerCase())):u.placeholders,[u.placeholders,l]),d=i?"fixed inset-4 z-50 bg-slate-100 shadow-2xl rounded-xl border border-slate-200 flex flex-col overflow-hidden":"flex-1 flex flex-col overflow-hidden bg-slate-100";return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[t.jsx("div",{className:"flex-shrink-0 bg-white border-b border-slate-200 px-6 py-4",children:t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"bg-blue-50 p-2 rounded-xl border border-blue-100",children:t.jsx(te,{className:"w-5 h-5 text-blue-600"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"font-bold text-slate-800 text-lg",children:u.name}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 mt-0.5",children:[t.jsx("span",{children:"Word 模板"}),t.jsx("span",{className:"w-1 h-1 rounded-full bg-slate-300"}),t.jsxs("span",{children:[u.placeholders.length," 个占位符"]}),t.jsx("span",{className:"w-1 h-1 rounded-full bg-slate-300"}),t.jsx("span",{children:a(u.size)})]})]})]})})}),t.jsxs("div",{className:"flex-1 flex overflow-hidden relative",children:[t.jsxs("div",{className:"w-80 bg-slate-50 border-r border-slate-200 flex flex-col",children:[t.jsxs("div",{className:"flex-shrink-0 px-4 py-3 border-b border-slate-200 bg-white",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("h3",{className:"text-sm font-bold text-slate-700 flex items-center gap-2",children:[t.jsx(cs,{className:"w-4 h-4"}),"占位符列表"]}),t.jsx("span",{className:"bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full text-xs font-bold",children:c.length})]}),t.jsxs("div",{className:"relative",children:[t.jsx(dt,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),t.jsx("input",{type:"text",value:l,onChange:h=>o(h.target.value),placeholder:"搜索占位符...",className:"w-full pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all"})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-3 space-y-2",children:c.length>0?c.map((h,m)=>t.jsx("div",{className:"bg-white p-3 rounded-lg border border-slate-200 hover:border-orange-300 hover:shadow-sm transition-all duration-200 cursor-pointer group",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("code",{className:"text-sm font-mono text-orange-600 font-medium break-all",children:h}),t.jsx("button",{onClick:()=>navigator.clipboard.writeText(h),className:"opacity-0 group-hover:opacity-100 transition-opacity p-1.5 hover:bg-slate-100 rounded text-slate-400 hover:text-orange-500",title:"复制",children:t.jsx(Dt,{className:"w-3.5 h-3.5"})})]})},m)):t.jsx("div",{className:"text-center py-8 text-slate-400 text-sm",children:"未找到匹配的占位符"})}),t.jsx("div",{className:"flex-shrink-0 px-4 py-3 border-t border-slate-200 bg-white",children:t.jsxs("button",{onClick:r,className:"w-full py-2.5 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 hover:shadow-md transition-all duration-200 flex items-center justify-center gap-2",children:[t.jsx(Dt,{className:"w-4 h-4"}),"复制全部占位符"]})})]}),!i&&t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden bg-slate-100",children:[t.jsxs("div",{className:"flex-shrink-0 px-6 py-3 border-b border-slate-200 bg-white/50 backdrop-blur-sm flex items-center justify-between z-10 sticky top-0",children:[t.jsxs("h3",{className:"text-sm font-bold text-slate-700 flex items-center gap-2",children:[t.jsx(it,{className:"w-4 h-4"}),"文档预览"]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"text-xs text-slate-500 bg-yellow-50 px-3 py-1.5 rounded-full border border-yellow-200 flex items-center gap-2 shadow-sm",children:[t.jsx(nt,{className:"w-3 h-3 text-yellow-600"}),t.jsx("span",{children:"仅供参考，不支持分页"})]}),t.jsx("button",{onClick:()=>n(!0),className:"p-1.5 hover:bg-slate-200 rounded text-slate-500 transition-colors",title:"全屏查看",children:t.jsx(Ht,{className:"w-4 h-4"})})]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-8 relative scroll-smooth bg-slate-100/50",children:[t.jsx("div",{className:"max-w-[210mm] mx-auto bg-white shadow-xl min-h-[297mm] p-[25mm] relative",children:t.jsx("div",{className:"prose prose-slate max-w-none prose-p:my-2 prose-headings:my-4",dangerouslySetInnerHTML:{__html:s},style:{lineHeight:"1.75",fontSize:"11pt",color:"#1e293b",fontFamily:'"Times New Roman", "SimSun", serif'}})}),t.jsx("div",{className:"h-10"})]})]}),t.jsxs("div",{className:`${d} ${i?"":"hidden"}`,children:[t.jsxs("div",{className:"flex-shrink-0 px-6 py-3 border-b border-slate-200 bg-white/50 backdrop-blur-sm flex items-center justify-between z-10 sticky top-0",children:[t.jsxs("h3",{className:"text-sm font-bold text-slate-700 flex items-center gap-2",children:[t.jsx(it,{className:"w-4 h-4"}),"文档预览（全文）"]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"text-xs text-slate-500 bg-yellow-50 px-3 py-1.5 rounded-full border border-yellow-200 flex items-center gap-2 shadow-sm",children:[t.jsx(nt,{className:"w-3 h-3 text-yellow-600"}),t.jsx("span",{children:"预览格式仅供参考，不支持分页，请以最终下载文件为准"})]}),t.jsx("button",{onClick:()=>n(!1),className:"p-1.5 hover:bg-slate-200 rounded text-slate-500 transition-colors",title:"退出全屏",children:t.jsx(Wt,{className:"w-4 h-4"})})]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-8 relative scroll-smooth bg-slate-100/50",children:[t.jsx("div",{className:"mx-auto bg-white shadow-xl min-h-[297mm] p-[25mm] relative transition-all duration-300 max-w-[210mm]",children:t.jsx("div",{className:`prose prose-slate max-w-none 
                    prose-p:my-2 prose-p:leading-relaxed 
                    prose-headings:font-bold prose-headings:text-slate-900 
                    prose-h1:text-2xl prose-h1:text-center prose-h1:my-6
                    prose-h2:text-xl prose-h2:my-4 prose-h2:border-b prose-h2:border-slate-200 prose-h2:pb-2
                    prose-h3:text-lg prose-h3:my-3
                    prose-table:border-collapse prose-td:border prose-td:border-slate-300 prose-td:p-2 prose-th:bg-slate-50 prose-th:border prose-th:border-slate-300 prose-th:p-2`,dangerouslySetInnerHTML:{__html:s},style:{lineHeight:"1.75",fontSize:"11pt",color:"#1e293b",fontFamily:'"Times New Roman", "SimSun", serif'}})}),t.jsx("div",{className:"h-20"})]})]})]})]}),i&&t.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-40 transition-opacity",onClick:()=>n(!1)})]})},yr=({data:u,headers:e,sortColumn:s,sortDirection:r,rowHeight:a=40,headerHeight:i=48,height:n=600,onSort:l,loading:o=!1})=>{const c=N.useMemo(()=>e.length===0?100:100/e.length,[e.length]);return u.length===0&&!o?t.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:`${n}px`,color:"rgb(148 163 184)",fontSize:"14px"},children:"暂无数据"}):o?t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:`${n}px`,color:"rgb(148 163 184)",fontSize:"14px"},children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500 mr-2"}),"加载中..."]}):t.jsxs("div",{style:{height:`${n}px`,display:"flex",flexDirection:"column",overflow:"auto",border:"1px solid rgb(226 232 240)",borderRadius:"8px",position:"relative"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",height:i,backgroundColor:"rgb(248 250 252)",borderBottom:"2px solid rgb(226 232 240)",position:"sticky",top:0,zIndex:10,width:"fit-content",minWidth:"100%"},children:[t.jsx("div",{style:{width:60,flexShrink:0,padding:"12px 16px",fontSize:"12px",fontWeight:600,color:"rgb(71 85 105)",borderRight:"1px solid rgb(241 245 249)",backgroundColor:"rgb(248 250 252)"},children:"#"}),e.map(d=>t.jsxs("div",{onClick:()=>l&&l(d),style:{width:`${c}%`,minWidth:"120px",flexShrink:0,padding:"12px 16px",fontSize:"12px",fontWeight:600,color:"rgb(71 85 105)",cursor:l?"pointer":"default",display:"flex",alignItems:"center",gap:"8px",transition:"background-color 0.2s",borderRight:"1px solid rgb(241 245 249)"},className:"hover:bg-slate-100",children:[t.jsx("span",{className:"truncate",children:d}),s===d&&t.jsx(ds,{className:`w-3 h-3 text-emerald-500 flex-shrink-0 ${r==="desc"?"rotate-180":""}`})]},d))]}),t.jsx("div",{style:{flex:1,overflow:"auto"},children:t.jsx("div",{style:{width:"fit-content",minWidth:"100%"},children:u.map((d,h)=>t.jsxs("div",{style:{display:"flex",alignItems:"center",minHeight:a,borderBottom:"1px solid rgb(241 245 249)",transition:"background-color 0.2s"},className:"hover:bg-slate-50",children:[t.jsx("div",{style:{width:60,flexShrink:0,padding:"12px 16px",fontSize:"14px",color:"rgb(148 163 184)",textAlign:"center",borderRight:"1px solid rgb(241 245 249)"},children:h+1}),e.map(m=>t.jsx("div",{style:{width:`${c}%`,minWidth:"120px",flexShrink:0,padding:"12px 16px",fontSize:"14px",color:"rgb(51 65 85)",borderRight:"1px solid rgb(241 245 249)"},children:t.jsx("div",{className:"truncate",title:String(d[m]||""),children:String(d[m]||"")})},`${h}-${m}`))]},h))})}),u.length>0&&t.jsxs("div",{style:{padding:"8px 16px",fontSize:"12px",color:"rgb(100 116 139)",borderTop:"1px solid rgb(226 232 240)",backgroundColor:"rgb(248 250 252)"},children:["共 ",u.length," 行数据"]})]})},br=({excelData:u,currentSheetName:e,onSheetChange:s})=>{const[r,a]=N.useState(""),[i,n]=N.useState(null),[l,o]=N.useState("asc"),c=N.useMemo(()=>!u||!u.sheets?[]:u.sheets[e]||[],[u,e]),d=N.useMemo(()=>c.length===0?[]:Object.keys(c[0]),[c]),h=N.useMemo(()=>{let y=[...c];return r&&(y=y.filter(E=>d.some(R=>String(E[R]).toLowerCase().includes(r.toLowerCase())))),i&&y.sort((E,R)=>{const F=E[i],D=R[i];if(F===D)return 0;if(F==null)return 1;if(D==null)return-1;const k=String(F).localeCompare(String(D),"zh-CN");return l==="asc"?k:-k}),y},[c,r,i,l,d]),m=y=>{i===y?o(l==="asc"?"desc":"asc"):(n(y),o("asc"))},f=()=>{n(null),a("")},p=N.useMemo(()=>!u||!u.sheets?[]:Object.keys(u.sheets),[u]),x=N.useMemo(()=>{var y;return(y=u==null?void 0:u.metadata)==null||y[e],{rowCount:c.length,columnCount:d.length,totalSheets:p.length}},[c,d,p,u,e]);return t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[t.jsx("div",{className:"flex-shrink-0 bg-white border-b border-slate-200 px-6 py-4",children:t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"bg-emerald-50 p-2 rounded-xl border border-emerald-100",children:t.jsx(_t,{className:"w-5 h-5 text-emerald-600"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"font-bold text-slate-800 text-lg",children:(u==null?void 0:u.fileName)||"数据文件"}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 mt-0.5",children:[t.jsx("span",{children:"Excel 数据预览"}),t.jsx("span",{className:"w-1 h-1 rounded-full bg-slate-300"}),t.jsxs("span",{children:[x.rowCount," 行"]}),t.jsx("span",{className:"w-1 h-1 rounded-full bg-slate-300"}),t.jsxs("span",{children:[x.columnCount," 列"]}),t.jsx("span",{className:"w-1 h-1 rounded-full bg-slate-300"}),t.jsxs("span",{children:[x.totalSheets," 个Sheet"]})]})]})]})})}),p.length>1&&t.jsxs("div",{className:"px-4 py-3 border-b border-slate-200 bg-white",children:[t.jsx("label",{className:"text-base font-medium text-slate-700 mb-2 block",children:"选择工作表"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:p.map(y=>t.jsx("button",{onClick:()=>s(y),className:`
                    px-4 py-2 rounded-lg text-base font-medium transition-all duration-200
                    ${e===y?"bg-emerald-500 text-white shadow-md":"bg-white text-slate-600 border border-slate-200 hover:border-emerald-300"}
                  `,children:y},y))})]}),t.jsxs("div",{className:"flex-shrink-0 p-4 border-b border-slate-200 bg-white",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"relative flex-1 max-w-md",children:[t.jsx(dt,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),t.jsx("input",{type:"text",value:r,onChange:y=>a(y.target.value),placeholder:"搜索数据...",className:"w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"})]}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("button",{onClick:f,className:"px-4 py-2 bg-slate-100 text-slate-600 rounded-lg text-base font-medium hover:bg-slate-200 hover:shadow-sm transition-all duration-200 flex items-center gap-2",children:[t.jsx(us,{className:"w-4 h-4"}),"重置筛选"]})})]}),r&&t.jsxs("div",{className:"mt-2 text-xs text-slate-500",children:["找到 ",t.jsx("span",{className:"font-bold text-emerald-600",children:h.length})," 条结果"]}),t.jsxs("div",{className:"mt-2 text-xs text-slate-500",children:["总数据: ",t.jsx("span",{className:"font-bold text-slate-700",children:c.length})," 行 |",r&&` 筛选后: ${h.length} 行 |`,h.length>1e3&&t.jsx("span",{className:"text-emerald-600 ml-1",children:"已启用虚拟化渲染，流畅浏览大数据集"})]})]}),t.jsx("div",{className:"flex-1 p-4 overflow-hidden",children:t.jsx(yr,{data:h,headers:d,sortColumn:i,sortDirection:l,onSort:m,height:600,rowHeight:40,headerHeight:48})})]})},Ct=[{id:"DATE_ISO",label:"日期 (2023-12-31)",category:"date",description:"标准 ISO 日期格式",generateCode:()=>`
      if (!value) return '';
      const date = new Date(value);
      if (isNaN(date.getTime())) return value;
      return date.toISOString().split('T')[0];
    `.trim()},{id:"DATE_CN",label:"日期 (2023年12月31日)",category:"date",description:"中文日期格式",generateCode:()=>"\n      if (!value) return '';\n      const date = new Date(value);\n      if (isNaN(date.getTime())) return value;\n      return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;\n    ".trim()},{id:"DATE_DOT",label:"日期 (2023.12.31)",category:"date",description:"点号分隔日期",generateCode:()=>"\n      if (!value) return '';\n      const date = new Date(value);\n      if (isNaN(date.getTime())) return value;\n      return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;\n    ".trim()},{id:"CURRENCY_CN",label:"金额 (¥1,000.00)",category:"number",description:"人民币格式，保留两位小数",generateCode:()=>`
      if (value === null || value === undefined || value === '') return '';
      const num = parseFloat(String(value));
      if (isNaN(num)) return value;
      return '¥' + num.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');
    `.trim()},{id:"NUMBER_THOUSAND",label:"数字 (1,000)",category:"number",description:"千分位分隔",generateCode:()=>`
      if (value === null || value === undefined || value === '') return '';
      const num = parseFloat(String(value));
      if (isNaN(num)) return value;
      return num.toLocaleString();
    `.trim()},{id:"TRIM",label:"去除首尾空格",category:"text",description:"自动清理文本前后的空白字符",generateCode:()=>"return String(value || '').trim();"},{id:"UPPERCASE",label:"转大写 (ABC)",category:"text",description:"转换为大写字母",generateCode:()=>"return String(value || '').toUpperCase();"},{id:"MASK_PHONE",label:"手机号脱敏 (138****0000)",category:"mask",description:"隐藏手机号中间四位",generateCode:()=>`
      const str = String(value || '');
      if (str.length !== 11) return str;
      return str.replace(/(\\d{3})\\d{4}(\\d{4})/, '$1****$2');
    `.trim()},{id:"MASK_ID",label:"身份证脱敏 (末4位)",category:"mask",description:"隐藏身份证号中间部分，只保留首尾",generateCode:()=>`
       const str = String(value || '');
       if (str.length < 10) return str;
       return str.substring(0, 3) + '***********' + str.substring(str.length - 4);
    `.trim()}],Tt={getFormatters:()=>Ct,getFormattersByCategory:()=>{const u={};return Ct.forEach(e=>{u[e.category]||(u[e.category]=[]),u[e.category].push(e)}),u}},Nr=Object.freeze(Object.defineProperty({__proto__:null,FormatterService:Tt,PRESET_FORMATTERS:Ct},Symbol.toStringTag,{value:"Module"})),vr=({mappingScheme:u,templatePlaceholders:e,excelHeaders:s,sampleData:r,onMappingChange:a,allSheetsHeaders:i={},onExportScheme:n})=>{var Je,Ke;const[l,o]=N.useState(!1),[c,d]=N.useState(u),[h,m]=N.useState(!1),[f,p]=N.useState(!1),[x,y]=N.useState({type:"const",value:""}),[E,R]=N.useState(!1),F=()=>{if(!x.name||!x.value){alert("请填写名称和值");return}const g={id:`vc_${Date.now()}`,name:`[虚拟] ${x.name}`,type:x.type||"const",value:x.value||""},v=[...c.virtualColumns||[],g];d({...c,virtualColumns:v}),y({type:"const",value:""}),p(!1)},D=g=>{const v=(c.virtualColumns||[]).filter(T=>T.id!==g);d({...c,virtualColumns:v})},k=c.virtualColumns||[],[P,ue]=N.useState(null),[oe,ae]=N.useState({}),[fe,ye]=N.useState({});Be.useEffect(()=>{(async()=>{if(!r)return;const w={};await Promise.all(u.mappings.map(async(v,T)=>{if(v.transform&&v.transform.length>20)return;const _=v.excelColumn,b=r[_];if(b!=null){const S=await We.analyzeColumnContent(_,[b]);S.suggestedFormatter&&(w[T]=S.suggestedFormatter)}})),ye(w)})()},[u,r]),Be.useEffect(()=>{u.mappings.length>0&&u.mappings.some(g=>g.ruleType==="ai")},[u]),Be.useEffect(()=>{d(u)},[u]);const B=(g,w,v)=>{const T=w||c.crossSheetMappings||[],_=v||c.loopMappings||[],b=e.filter(S=>!g.some(L=>L.placeholder===S)&&!T.some(L=>L.placeholder===S)&&!_.some(L=>L.loopPlaceholder===S||L.mappings.some(j=>j.placeholder===S)));d({...c,mappings:g,crossSheetMappings:T,loopMappings:_,unmappedPlaceholders:b})},V=()=>{a(c),o(!1)},ce=()=>{d(u),o(!1)},me=()=>{let g=e.find(v=>!c.mappings.some(T=>T.placeholder===v)&&!(c.crossSheetMappings||[]).some(T=>T.placeholder===v));g||(g=e[0]||"");const w=[...c.mappings,{placeholder:g,excelColumn:s[0]||"",ruleType:"direct"}];B(w)},Z=g=>{const w=c.mappings.filter((v,T)=>T!==g);B(w)},se=(g,w,v)=>{const T=[...c.mappings],_={...T[g],[w]:v};if(w==="format"){const b=Tt.getFormatters().find(S=>S.id===v);b&&(_.transform=b.generateCode(),_.ruleType="script")}T[g]=_,w==="transform"&&(typeof v=="string"&&v.trim().startsWith("// AI")?T[g].ruleType="ai":v&&String(v).trim()?T[g].ruleType="script":T[g].ruleType="direct"),B(T)},ge=()=>{const w=Object.keys(i||{}).filter(b=>b!==u.primarySheet)[0]||"",v=i[w]||[];let T=e.find(b=>!c.mappings.some(S=>S.placeholder===b)&&!(c.crossSheetMappings||[]).some(S=>S.placeholder===b));T||(T=e[0]||"");const _=[...c.crossSheetMappings||[],{placeholder:T,sourceSheet:w,lookupKey:s[0]||"",sourceColumn:v[0]||"",relationshipType:"one_to_one"}];B(c.mappings,_)},O=g=>{const w=(c.crossSheetMappings||[]).filter((v,T)=>T!==g);B(c.mappings,w)},Q=(g,w,v)=>{const T=[...c.crossSheetMappings||[]],_=T[g];if(w==="sourceSheet"){const b=i[v]||[];T[g]={..._,sourceSheet:v,sourceColumn:b[0]||""}}else T[g]={..._,[w]:v};B(c.mappings,T)},[G,Ee]=N.useState(null),Se=()=>{const w=Object.keys(i||{}).filter(_=>_!==u.primarySheet)[0]||"",v={id:`loop_${Date.now()}`,loopPlaceholder:"Loop",type:"lookup",sourceSheet:w,foreignKey:s[0]||"",groupByColumn:s[0]||"",mappings:[]},T=c.loopMappings||[];B(c.mappings,void 0,[...T,v]),Ee(T.length)},ke=g=>{const v=(c.loopMappings||[]).filter((T,_)=>_!==g);B(c.mappings,void 0,v),G===g&&Ee(null)},ve=(g,w,v)=>{const T=[...c.loopMappings||[]];T[g]={...T[g],[w]:v},B(c.mappings,void 0,T)},ze=g=>{const w=[...c.loopMappings||[]],v=w[g],T=i[v.sourceSheet]||[],_={placeholder:e[0]||"",excelColumn:T[0]||"",ruleType:"direct"};v.mappings=[...v.mappings,_],w[g]=v,B(c.mappings,void 0,w)},C=(g,w,v,T)=>{const _=[...c.loopMappings||[]],b=_[g],S=[...b.mappings];S[w]={...S[w],[v]:T},b.mappings=S,_[g]=b,B(c.mappings,void 0,_)},ut=(g,w)=>{const v=[...c.loopMappings||[]],T=v[g];T.mappings=T.mappings.filter((_,b)=>b!==w),v[g]=T,B(c.mappings,void 0,v)},mt=async(g,w)=>{if(!r){alert("需要有Excel数据才能试运行规则");return}ue(g),ae(v=>({...v,[g]:null}));try{const v=await We.processRule(w,r);ae(T=>({...T,[g]:v}))}catch(v){console.error(v),ae(T=>({...T,[g]:{result:"",error:"测试失败, 请重试"}}))}finally{ue(null)}},Qe={mapped:u.mappings.length,total:e.length,percentage:Math.round(u.mappings.length/e.length*100)},Ye=g=>{var v;return g.ruleType==="ai"||g.transform&&g.transform.startsWith("// AI")?t.jsxs("div",{className:"flex items-center gap-2 text-xs bg-purple-50 text-purple-700 px-3 py-1.5 rounded border border-purple-100 w-full",children:[t.jsx("span",{className:"flex-shrink-0 w-1.5 h-1.5 rounded-full bg-purple-500 animate-pulse"}),t.jsx("span",{className:"font-semibold flex-shrink-0",children:"AI 规则:"}),t.jsx("span",{className:"truncate italic opacity-90",children:((v=g.transform)==null?void 0:v.replace("// AI","").trim())||"根据上下文智能分析"})]}):g.transform?t.jsx("div",{className:"truncate text-xs text-slate-500 bg-slate-100 px-2 py-1.5 rounded border border-slate-200 font-mono w-full",title:g.transform,children:g.transform}):t.jsx("span",{className:"text-xs text-slate-300 italic pl-1",children:"直接映射"})};return t.jsxs("div",{className:`flex-1 flex flex-col overflow-hidden bg-slate-50 transition-all duration-300 ${h?"fixed inset-0 z-50":"h-full"}`,children:[t.jsx("div",{className:"flex-shrink-0 bg-white border-b border-slate-200 px-6 py-4 z-10 shadow-sm",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"flex flex-col gap-1",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>m(!h),className:"p-2 -ml-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors",title:h?"退出全屏":"全屏编辑",children:h?t.jsx(Wt,{className:"w-5 h-5"}):t.jsx(Ht,{className:"w-5 h-5"})}),t.jsx("div",{className:"bg-emerald-50 p-2 rounded-xl border border-emerald-100",children:t.jsx(rt,{className:"w-5 h-5 text-emerald-600"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"font-bold text-slate-800 text-lg",children:"字段映射方案"}),t.jsx("span",{className:"text-xs text-slate-500",children:"配置 Excel 列与 Word 占位符的对应关系"})]}),r&&t.jsxs("div",{className:"ml-4 px-3 py-1 bg-purple-50 text-purple-600 text-xs rounded-full flex items-center gap-1 border border-purple-100",children:[t.jsx(qt,{className:"w-3 h-3"}),"AI 试运行已就绪 (数据源: Excel 第1行)"]})]})}),t.jsxs("div",{className:"flex items-center gap-4",children:[n&&t.jsxs("button",{onClick:n,className:"flex items-center gap-1 text-slate-500 hover:text-emerald-600 px-3 py-1.5 rounded-lg hover:bg-emerald-50 transition-colors text-sm font-medium border border-transparent hover:border-emerald-200",title:"导出配置 (.ems)",children:[t.jsx(Le,{className:"w-4 h-4"}),t.jsx("span",{className:"hidden sm:inline",children:"保存配置"})]}),t.jsxs("div",{className:"flex items-center gap-3 pr-4 border-r border-slate-200",children:[t.jsxs("div",{className:"text-right",children:[t.jsx("p",{className:"text-xs text-slate-500",children:"映射完成度"}),t.jsxs("p",{className:"text-sm font-bold text-slate-700",children:[t.jsx("span",{className:"text-emerald-600",children:Qe.mapped}),t.jsx("span",{className:"text-slate-400 mx-1",children:"/"}),Qe.total]})]}),t.jsx("div",{className:"w-24 bg-slate-100 rounded-full h-2",children:t.jsx("div",{className:"bg-emerald-500 h-2 rounded-full transition-all duration-300",style:{width:`${Qe.percentage}%`}})})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("button",{onClick:()=>p(!0),className:"px-3 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg text-sm font-medium hover:border-purple-300 hover:text-purple-600 hover:bg-purple-50 transition-all shadow-sm flex items-center gap-2",title:"管理虚拟列",children:[t.jsx(Qt,{className:"w-4 h-4"}),t.jsx("span",{className:"hidden sm:inline",children:"虚拟列"}),k.length>0&&t.jsx("span",{className:"bg-purple-100 text-purple-700 text-xs px-1.5 py-0.5 rounded-full font-bold",children:k.length})]}),l?t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("button",{onClick:ce,className:"px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors flex items-center gap-2",children:[t.jsx(Ge,{className:"w-4 h-4"}),"取消"]}),t.jsxs("button",{onClick:V,className:"px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm font-medium hover:bg-emerald-600 transition-colors flex items-center gap-2 shadow-sm shadow-emerald-200",children:[t.jsx(Ve,{className:"w-4 h-4"}),"保存更改"]})]}):t.jsxs("button",{onClick:()=>o(!0),className:"px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg text-sm font-medium hover:border-emerald-500 hover:text-emerald-600 transition-all shadow-sm flex items-center gap-2 group",children:[t.jsx(ms,{className:"w-4 h-4 text-slate-400 group-hover:text-emerald-500"}),"编辑映射"]})]})]})]})}),t.jsx("div",{className:"flex-1 flex overflow-hidden min-h-0",children:t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden bg-white max-w-5xl mx-auto w-full shadow-sm border-x border-slate-100 h-full relative",children:[t.jsx("div",{className:"flex-shrink-0 p-5 border-b border-slate-100 bg-blue-50/30",children:t.jsxs("div",{className:"flex items-start gap-3 text-sm text-blue-800",children:[t.jsx(vt,{className:"w-5 h-5 mt-0.5 flex-shrink-0 text-blue-500"}),t.jsxs("div",{className:"leading-relaxed opacity-90",children:[t.jsx("span",{className:"font-semibold block mb-1",children:"AI 映射分析："}),u.explanation]})]})}),f&&t.jsx("div",{className:"absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4",children:t.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]",children:[t.jsxs("div",{className:"p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50 rounded-t-xl",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Qt,{className:"w-5 h-5 text-purple-600"}),t.jsx("h3",{className:"font-bold text-slate-800",children:"虚拟列管理 (Virtual Columns)"})]}),t.jsx("button",{onClick:()=>p(!1),className:"p-1 hover:bg-slate-200 rounded text-slate-500",children:t.jsx(Ge,{className:"w-5 h-5"})})]}),t.jsx("div",{className:"p-4 flex-1 overflow-y-auto",children:t.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg border border-purple-100 mb-6",children:[t.jsx("h4",{className:"text-xs font-bold text-purple-800 mb-3 uppercase tracking-wider",children:"新建虚拟列"}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-purple-700 mb-1",children:"列名称"}),t.jsx("input",{type:"text",placeholder:"例如: 打印时间",className:"w-full px-3 py-2 border border-purple-200 rounded text-sm focus:border-purple-500 focus:ring-1 focus:ring-purple-500",value:x.name||"",onChange:g=>y({...x,name:g.target.value})})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-purple-700 mb-1",children:"类型"}),t.jsxs("select",{className:"w-full px-3 py-2 border border-purple-200 rounded text-sm focus:border-purple-500",value:x.type,onChange:g=>y({...x,type:g.target.value}),children:[t.jsx("option",{value:"const",children:"静态文本 (Const)"}),t.jsx("option",{value:"var",children:"系统变量 (Variable)"}),t.jsx("option",{value:"ai",children:"AI 生成 (AI)"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-purple-700 mb-1",children:x.type==="ai"?"占位符名称":"值 / 表达式"}),t.jsx("input",{type:"text",placeholder:x.type==="ai"?"例如: 试用期评价":"输入值...",className:"w-full px-3 py-2 border border-purple-200 rounded text-sm focus:border-purple-500",value:x.value||"",onChange:g=>y({...x,value:g.target.value})})]})]}),x.type==="ai"&&t.jsxs("div",{className:"mt-3",children:[t.jsxs("label",{className:"block text-xs font-medium text-purple-700 mb-1 flex items-center justify-between",children:[t.jsx("span",{children:"AI 生成指令 (Prompt)"}),t.jsxs("span",{className:"text-xs text-purple-400 font-normal",children:["可用 ","{{字段名}}"," 引用当前行数据"]})]}),t.jsx("textarea",{className:"w-full px-3 py-2 border border-purple-200 rounded text-sm focus:border-purple-500 h-20 resize-none",placeholder:"例如: 根据 {{入职日期}} 和 {{基本工资}} 生成一段试用期评价，要求语气由正式转为轻松...",value:x.aiPrompt||"",onChange:g=>y({...x,aiPrompt:g.target.value})})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-purple-700 mb-1",children:x.type==="const"?"文本内容":x.type==="var"?"变量名":"Prompt"}),x.type==="var"?t.jsxs("select",{className:"w-full px-3 py-2 border border-purple-200 rounded text-sm",value:x.value,onChange:g=>y({...x,value:g.target.value}),children:[t.jsx("option",{value:"",children:"请选择..."}),t.jsx("option",{value:"CurrentDate",children:"当前日期 (YYYY-MM-DD)"}),t.jsx("option",{value:"CurrentTime",children:"当前时间 (HH:mm:ss)"}),t.jsx("option",{value:"UUID",children:"唯一ID (UUID)"}),t.jsx("option",{value:"RowIndex",children:"行号 (Row Index)"})]}):t.jsx("input",{type:"text",placeholder:x.type==="ai"?"例如: 总结备注列的情感":"例如: 绝密文件",className:"w-full px-3 py-2 border border-purple-200 rounded text-sm",value:x.value||"",onChange:g=>y({...x,value:g.target.value})})]})]}),t.jsx("button",{onClick:F,className:"w-full py-2 bg-purple-600 text-white rounded font-medium text-sm hover:bg-purple-700 transition",children:"添加"})]})}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("h4",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:["已定义虚拟列 (",k.length,")"]}),k.length===0?t.jsx("div",{className:"text-center py-8 text-slate-400 text-sm border-2 border-dashed border-slate-100 rounded-lg",children:"暂无虚拟列"}):k.map(g=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg shadow-sm hover:border-purple-200 transition",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:`w-8 h-8 rounded-lg flex items-center justify-center ${g.type==="ai"?"bg-amber-100 text-amber-600":g.type==="var"?"bg-blue-100 text-blue-600":"bg-slate-100 text-slate-600"}`,children:g.type==="ai"?t.jsx(et,{className:"w-4 h-4"}):g.type==="var"?t.jsx(et,{className:"w-4 h-4"}):t.jsx("div",{className:"font-bold text-xs",children:"TXT"})}),t.jsxs("div",{children:[t.jsx("div",{className:"font-bold text-slate-700 text-sm",children:g.name}),t.jsxs("div",{className:"text-xs text-slate-400",children:[t.jsx("span",{className:"uppercase font-bold mr-1",children:g.type}),g.value]})]})]}),t.jsx("button",{onClick:()=>D(g.id),className:"p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded",children:t.jsx(De,{className:"w-4 h-4"})})]},g.id))]})]})}),t.jsxs("div",{className:"flex-shrink-0 bg-slate-50 border-b border-slate-200 px-6 py-3 flex items-center text-xs font-bold text-slate-500 uppercase tracking-wider",children:[t.jsx("div",{className:"w-[30%]",children:"模板占位符"}),t.jsx("div",{className:"w-8 flex-shrink-0"}),t.jsx("div",{className:"w-[25%] px-2",children:"Excel 列"}),t.jsx("div",{className:"flex-1 px-4",children:"转换规则 / AI 逻辑"}),l&&t.jsx("div",{className:"w-12 text-right",children:"操作"})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto px-4 py-4 min-h-0 scrollbar-thin scrollbar-thumb-slate-200 scrollbar-track-transparent",children:[t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[t.jsx("div",{className:"w-1 h-4 bg-emerald-500 rounded-full"}),t.jsx("h3",{className:"text-sm font-bold text-slate-700",children:"主表映射 (Primary Sheet)"}),t.jsx("span",{className:"text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded",children:"Current Sheet"})]}),t.jsxs("div",{className:"space-y-2",children:[((l?c.mappings:u.mappings)||[]).map((g,w)=>{var v,T,_,b,S,L;return t.jsxs("div",{className:`group flex items-center px-4 py-3 rounded-lg border transition-all ${l?"hover:bg-slate-50 border-slate-200":"hover:bg-slate-50 border-transparent hover:border-slate-100"}`,children:[t.jsx("div",{className:"w-[30%] min-w-0 pr-2",children:l?t.jsx("div",{className:"relative",children:t.jsx("select",{value:g.placeholder,onChange:j=>se(w,"placeholder",j.target.value),className:"w-full pl-2 pr-8 py-2 border border-slate-200 rounded text-sm focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 bg-white",children:e.map(j=>t.jsx("option",{value:j,children:j},j))})}):t.jsxs("div",{className:"flex items-center gap-2",title:g.placeholder,children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-orange-400 flex-shrink-0"}),t.jsx("code",{className:"text-sm font-mono text-slate-700 truncate font-medium",children:g.placeholder})]})}),t.jsx("div",{className:"w-8 flex-shrink-0 flex justify-center",children:t.jsx(jt,{className:"w-4 h-4 text-slate-300 group-hover:text-slate-400"})}),t.jsx("div",{className:"w-[25%] min-w-0 px-2",children:l?t.jsx("div",{className:"relative",children:t.jsxs("select",{value:g.excelColumn,onChange:j=>se(w,"excelColumn",j.target.value),className:"w-full pl-2 pr-8 py-2 border border-slate-200 rounded text-sm focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 bg-white",children:[t.jsx("optgroup",{label:"Excel Columns",children:s.map(j=>t.jsx("option",{value:j,children:j},j))}),k.length>0&&t.jsx("optgroup",{label:"Virtual Columns (虚拟列)",children:k.map(j=>t.jsx("option",{value:j.name,children:j.name},j.id))}),g.excelColumn&&!s.includes(g.excelColumn)&&!k.some(j=>j.name===g.excelColumn)&&t.jsx("optgroup",{label:"AI Generated / Flattened",children:t.jsx("option",{value:g.excelColumn,children:g.excelColumn})})]})}):t.jsxs("div",{className:"flex items-center gap-2",title:g.excelColumn,children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-500 flex-shrink-0"}),t.jsx("span",{className:"text-sm font-medium text-slate-700 truncate",children:g.excelColumn})]})}),t.jsx("div",{className:"flex-1 min-w-0 px-4",children:l?t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",className:`flex-1 px-3 py-2 border rounded text-xs font-mono focus:outline-none focus:border-blue-500 placeholder:text-slate-300 ${(v=g.transform)!=null&&v.startsWith("// AI")?"border-purple-300 bg-purple-50/50 text-purple-800":"border-slate-200"}`,placeholder:"输入JS代码或以 // AI 开头输入规则",value:g.transform||"",onChange:j=>se(w,"transform",j.target.value)}),((T=g.transform)==null?void 0:T.trim().startsWith("// AI"))&&t.jsx("button",{onClick:()=>mt(w,g.transform),disabled:P===w,className:"p-2 text-purple-600 bg-purple-100 hover:bg-purple-200 rounded-lg transition-colors disabled:opacity-50",title:"试运行 AI 规则 (使用第一行数据)",children:P===w?t.jsx(Ce,{className:"w-4 h-4 animate-spin"}):t.jsx(qt,{className:"w-4 h-4 fill-current"})}),t.jsxs("div",{className:"relative group/formatter",children:[t.jsx("button",{className:`p-2 rounded-lg transition-colors border border-transparent 
                                    ${fe[w]?"text-amber-500 hover:text-amber-600 hover:bg-amber-50":"text-slate-400 hover:text-emerald-600 hover:bg-emerald-50"}`,title:fe[w]?"智能建议可用":"内置格式化工具",children:fe[w]?t.jsxs("div",{className:"relative",children:[t.jsx(et,{className:"w-4 h-4"}),t.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-amber-500 rounded-full animate-pulse"})]}):t.jsx(et,{className:"w-4 h-4"})}),t.jsx("div",{className:"absolute right-0 top-full mt-1 w-64 bg-white rounded-xl shadow-xl border border-slate-200 z-50 hidden group-hover/formatter:block",children:t.jsxs("div",{className:"p-2",children:[t.jsxs("div",{className:"text-xs font-bold text-slate-400 px-2 py-1 uppercase tracking-wider flex justify-between",children:[t.jsx("span",{children:"预置格式化"}),fe[w]&&t.jsxs("span",{className:"text-amber-500 flex items-center gap-1",children:[t.jsx(it,{className:"w-3 h-3"})," 智能推荐"]})]}),Tt.getFormatters().map(j=>{const I=fe[w]===j.id;return t.jsxs("button",{onClick:()=>se(w,"format",j.id),className:`w-full text-left px-3 py-2 text-sm rounded transition-colors flex flex-col mb-1 relative
                                                    ${I?"bg-amber-50 text-amber-900 hover:bg-amber-100 border border-amber-200":"text-slate-700 hover:bg-emerald-50 hover:text-emerald-700 border border-transparent"}`,children:[t.jsxs("div",{className:"flex justify-between items-center w-full",children:[t.jsx("span",{className:"font-medium",children:j.label}),I&&t.jsx("span",{className:"px-1.5 py-0.5 bg-amber-200 text-amber-800 text-[10px] rounded-full font-bold",children:"推荐"})]}),t.jsx("span",{className:`text-xs ${I?"text-amber-700/80":"text-slate-400"}`,children:j.description})]},j.id)})]})})]})]}),oe[w]&&t.jsxs("div",{className:`text-xs p-2 rounded border ${(_=oe[w])!=null&&_.error?"bg-red-50 border-red-200 text-red-600":"bg-emerald-50 border-emerald-200 text-emerald-700"}`,children:[t.jsx("span",{className:"font-bold mr-1",children:(b=oe[w])!=null&&b.error?"Error:":"Preview:"}),((S=oe[w])==null?void 0:S.error)||((L=oe[w])==null?void 0:L.result)]})]}):Ye(g)}),l&&t.jsx("div",{className:"w-12 flex justify-end",children:t.jsx("button",{onClick:()=>Z(w),className:"p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors",title:"删除映射",children:t.jsx(De,{className:"w-4 h-4"})})})]},`main-${w}`)}),l&&t.jsx("div",{className:"pt-2 px-1",children:t.jsxs("button",{onClick:me,className:"w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-500 text-sm font-medium hover:border-emerald-400 hover:text-emerald-600 hover:bg-emerald-50/30 transition-all flex items-center justify-center gap-2",children:[t.jsx(Pe,{className:"w-4 h-4"}),"添加主表映射"]})})]})]}),(((Je=l?c.crossSheetMappings:u.crossSheetMappings)==null?void 0:Je.length)>0||l)&&t.jsxs("div",{className:"pt-4 border-t border-slate-200",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[t.jsx("div",{className:"w-1 h-4 bg-purple-500 rounded-full"}),t.jsx("h3",{className:"text-sm font-bold text-slate-700",children:"跨表关联 (Cross-Sheet VLOOKUP)"}),t.jsx("span",{className:"text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded",children:"Foreign Keys"})]}),t.jsxs("div",{className:"space-y-2",children:[((l?c.crossSheetMappings:u.crossSheetMappings)||[]).map((g,w)=>t.jsxs("div",{className:`group flex items-start flex-col sm:flex-row sm:items-center px-4 py-3 rounded-lg border bg-purple-50/30 ${l?"border-purple-200":"border-transparent"}`,children:[t.jsx("div",{className:"w-full sm:w-[25%] pr-2 mb-2 sm:mb-0",children:l?t.jsx("select",{value:g.placeholder,onChange:v=>Q(w,"placeholder",v.target.value),className:"w-full px-2 py-1.5 border border-slate-200 rounded text-xs bg-white focus:border-purple-500",children:e.map(v=>t.jsx("option",{value:v,children:v},v))}):t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-orange-400"}),t.jsx("code",{className:"text-sm font-medium text-slate-700 truncate",children:g.placeholder})]})}),t.jsx("div",{className:"hidden sm:block w-6 text-center text-slate-300",children:"←"}),t.jsx("div",{className:"flex-1 flex gap-2 w-full",children:l?t.jsxs(t.Fragment,{children:[t.jsx("select",{value:g.sourceSheet,onChange:v=>Q(w,"sourceSheet",v.target.value),className:"w-1/3 px-2 py-1.5 border border-slate-200 rounded text-xs bg-white focus:border-purple-500",title:"Source Sheet",children:Object.keys(i||{}).filter(v=>v!==(l?c.primarySheet:u.primarySheet)).map(v=>t.jsx("option",{value:v,children:v},v))}),t.jsx("span",{className:"text-slate-400 py-1",children:"."}),t.jsx("select",{value:g.sourceColumn,onChange:v=>Q(w,"sourceColumn",v.target.value),className:"flex-1 px-2 py-1.5 border border-slate-200 rounded text-xs bg-white focus:border-purple-500",title:"Target Value Column",children:((i==null?void 0:i[g.sourceSheet])||[]).map(v=>t.jsx("option",{value:v,children:v},v))})]}):t.jsxs("div",{className:"flex items-center gap-1 text-sm bg-white px-2 py-1 rounded border border-purple-100",children:[t.jsx(_e,{className:"w-3 h-3 text-purple-500"}),t.jsx("span",{className:"font-bold text-slate-700",children:g.sourceSheet}),t.jsx("span",{className:"text-slate-400",children:"."}),t.jsx("span",{className:"text-purple-700",children:g.sourceColumn})]})}),t.jsxs("div",{className:"mt-2 sm:mt-0 sm:ml-4 w-full sm:w-[30%] flex items-center gap-2",children:[t.jsx("span",{className:"text-xs text-slate-400 font-mono",children:"ON:"}),l?t.jsxs("div",{className:"flex-1 flex gap-1 items-center",children:[t.jsx("select",{value:g.lookupKey,onChange:v=>Q(w,"lookupKey",v.target.value),className:"flex-1 px-2 py-1.5 border border-slate-200 rounded text-xs bg-white focus:border-purple-500",title:"Foreign Key in Primary Sheet",children:s.map(v=>t.jsx("option",{value:v,children:v},v))}),t.jsx("span",{className:"text-slate-300",children:"="}),t.jsx("div",{className:"text-xs text-slate-500 truncate",title:"Assumes same column name in source sheet",children:g.lookupKey})]}):t.jsxs("div",{className:"flex items-center gap-1 text-xs text-slate-600 bg-slate-100 px-2 py-1 rounded",children:[t.jsx("span",{children:"Key:"}),t.jsx("span",{className:"font-mono font-bold",children:g.lookupKey})]})]}),l&&t.jsx("div",{className:"hidden sm:flex w-8 justify-end ml-2",children:t.jsx("button",{onClick:()=>O(w),className:"p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors",children:t.jsx(De,{className:"w-4 h-4"})})})]},`cross-${w}`)),l&&t.jsx("div",{className:"pt-2 px-1",children:t.jsxs("button",{onClick:ge,className:"w-full py-2 border-2 border-dashed border-purple-200 rounded-lg text-purple-600/70 text-xs font-bold hover:border-purple-400 hover:text-purple-700 hover:bg-purple-50 transition-all flex items-center justify-center gap-2",children:[t.jsx(Pe,{className:"w-3 h-3"}),"添加跨表关联"]})})]})]})]}),(((Ke=l?c.loopMappings:u.loopMappings)==null?void 0:Ke.length)>0||l)&&t.jsxs("div",{className:"pt-4 border-t border-slate-200 mt-4",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[t.jsx("div",{className:"w-1 h-4 bg-cyan-500 rounded-full"}),t.jsx("h3",{className:"text-sm font-bold text-slate-700",children:"列表/表格映射 (Table Generation)"}),t.jsx("span",{className:"text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded",children:"Many-to-One"})]}),t.jsxs("div",{className:"space-y-3",children:[((l?c.loopMappings:u.loopMappings)||[]).map((g,w)=>{const v=G===w,T=g.type==="group_by";return t.jsxs("div",{className:`rounded-lg border overflow-hidden ${l?"border-cyan-200 shadow-sm":"border-slate-200"}`,children:[t.jsxs("div",{className:"flex items-center p-3 bg-cyan-50/30 gap-3",children:[t.jsx("button",{onClick:()=>Ee(v?null:w),className:"p-1 rounded hover:bg-cyan-100 text-slate-500 transition-colors",children:v?t.jsx(ct,{className:"w-4 h-4"}):t.jsx(ps,{className:"w-4 h-4"})}),t.jsxs("div",{className:"flex-1 grid grid-cols-12 gap-3 items-center",children:[t.jsxs("div",{className:"col-span-3 flex items-center gap-2",children:[T?t.jsx(hs,{className:"w-4 h-4 text-orange-500"}):t.jsx(_e,{className:"w-4 h-4 text-cyan-600"}),l?t.jsx("input",{type:"text",className:"w-full px-2 py-1.5 text-sm border border-slate-200 rounded focus:border-cyan-500 font-mono bg-white",value:g.loopPlaceholder,onChange:_=>ve(w,"loopPlaceholder",_.target.value),placeholder:"Loop Tag"}):t.jsxs("span",{className:"font-mono font-bold text-sm text-cyan-700",children:["#",g.loopPlaceholder]})]}),t.jsx("div",{className:"col-span-3",children:l?t.jsxs("select",{value:g.type||"lookup",onChange:_=>ve(w,"type",_.target.value),className:"w-full px-2 py-1.5 text-xs font-medium border border-slate-200 rounded bg-white focus:border-cyan-500",children:[t.jsx("option",{value:"lookup",children:"🔗 Cross-Sheet (Lookup)"}),t.jsx("option",{value:"group_by",children:"📂 Group By (List)"})]}):t.jsx("span",{className:`text-[10px] uppercase font-bold px-2 py-1 rounded border ${T?"bg-orange-50 text-orange-600 border-orange-100":"bg-cyan-50 text-cyan-600 border-cyan-100"}`,children:T?"Group By":"Lookup"})}),t.jsx("div",{className:"col-span-5 flex items-center gap-2",children:T?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-xs text-slate-400 whitespace-nowrap",children:"Group By:"}),l?t.jsx("select",{value:g.groupByColumn,onChange:_=>ve(w,"groupByColumn",_.target.value),className:"flex-1 px-2 py-1.5 text-xs border border-slate-200 rounded bg-white",children:s.map(_=>t.jsx("option",{value:_,children:_},_))}):t.jsx("span",{className:"text-xs font-medium bg-white px-2 py-1 border rounded",children:g.groupByColumn||"-"})]}):t.jsx(t.Fragment,{children:l?t.jsxs(t.Fragment,{children:[t.jsx("select",{value:g.sourceSheet,onChange:_=>ve(w,"sourceSheet",_.target.value),className:"w-1/2 px-2 py-1.5 text-xs border border-slate-200 rounded bg-white",title:"Source Sheet",children:Object.keys(i||{}).filter(_=>_!==(l?c.primarySheet:u.primarySheet)).map(_=>t.jsx("option",{value:_,children:_},_))}),t.jsx("span",{className:"text-slate-300",children:"."}),t.jsx("select",{value:g.foreignKey,onChange:_=>ve(w,"foreignKey",_.target.value),className:"w-1/2 px-2 py-1.5 text-xs border border-slate-200 rounded bg-white",title:"Match Key",children:s.map(_=>t.jsx("option",{value:_,children:_},_))})]}):t.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[t.jsx("span",{className:"bg-white px-2 py-1 border rounded text-slate-600",children:g.sourceSheet}),t.jsx("span",{className:"text-slate-300",children:"on"}),t.jsx("span",{className:"font-mono",children:g.foreignKey})]})})}),l&&t.jsx("div",{className:"col-span-1 text-right",children:t.jsx("button",{onClick:()=>ke(w),className:"text-slate-400 hover:text-red-500 transition-colors p-1.5 hover:bg-red-50 rounded",children:t.jsx(De,{className:"w-4 h-4"})})})]})]}),v&&t.jsx("div",{className:"bg-slate-50 p-3 border-t border-cyan-100 shadow-inner",children:t.jsxs("div",{className:"space-y-2 pl-8",children:[t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsxs("h5",{className:"text-xs font-bold text-slate-400 uppercase tracking-wider",children:["Inner Mappings (",(g.mappings||[]).length,")"]}),t.jsx("span",{className:"text-[10px] text-slate-400 bg-white px-2 py-0.5 rounded border",children:T?"Select columns from this sheet":`Select columns from ${g.sourceSheet||"Source"}`})]}),(g.mappings||[]).map((_,b)=>t.jsxs("div",{className:"flex items-center gap-3 bg-white p-2 border border-slate-200 rounded shadow-sm",children:[t.jsx(jt,{className:"w-3 h-3 text-slate-300"}),t.jsx("div",{className:"flex-1",children:l?t.jsx("select",{value:_.placeholder,onChange:S=>C(w,b,"placeholder",S.target.value),className:"w-full text-xs p-1.5 border border-slate-200 rounded bg-slate-50 hover:bg-white focus:bg-white focus:border-cyan-500 transition-colors",children:e.map(S=>t.jsx("option",{value:S,children:S},S))}):t.jsx("code",{className:"text-xs font-medium text-slate-700",children:_.placeholder})}),t.jsx("span",{className:"text-slate-300",children:"→"}),t.jsx("div",{className:"flex-1",children:l?t.jsx("select",{value:_.excelColumn,onChange:S=>C(w,b,"excelColumn",S.target.value),className:"w-full text-xs p-1.5 border border-slate-200 rounded bg-slate-50 hover:bg-white focus:bg-white focus:border-cyan-500 transition-colors",children:(T?s:(i==null?void 0:i[g.sourceSheet||""])||[]).map(S=>t.jsx("option",{value:S,children:S},S))}):t.jsx("span",{className:"text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded",children:_.excelColumn})}),l&&t.jsx("button",{onClick:()=>ut(w,b),className:"text-slate-300 hover:text-red-500 p-1",children:t.jsx(Ge,{className:"w-3 h-3"})})]},b)),l&&t.jsxs("button",{onClick:()=>ze(w),className:"text-xs text-cyan-600 hover:text-cyan-700 font-medium flex items-center gap-1 mt-3 px-2 py-1 hover:bg-cyan-50 rounded transition-colors",children:[t.jsx(Pe,{className:"w-3 h-3"})," Add Field to Loop"]})]})})]},`loop-${w}`)}),l&&t.jsx("div",{className:"pt-2 px-1",children:t.jsxs("button",{onClick:Se,className:"w-full py-2 border-2 border-dashed border-cyan-200 rounded-lg text-cyan-600/70 text-xs font-bold hover:border-cyan-400 hover:text-cyan-700 hover:bg-cyan-50 transition-all flex items-center justify-center gap-2",children:[t.jsx(Pe,{className:"w-3 h-3"}),"添加列表循环 (Table)"]})})]})]}),((l?c:u).unmappedPlaceholders||[]).length>0&&t.jsxs("div",{className:"mt-8 mx-4 mb-6 pt-6 border-t border-slate-100",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3 text-xs font-bold text-amber-600 uppercase tracking-wider",children:[t.jsx(Ot,{className:"w-4 h-4"}),"未映射字段 (",(l?c:u).unmappedPlaceholders.length,")"]}),t.jsx("p",{className:"text-xs text-slate-400 mb-3",children:"以下字段未配置映射，生成文档时可能为空："}),t.jsx("div",{className:"flex flex-wrap gap-2",children:((l?c:u).unmappedPlaceholders||[]).map((g,w)=>t.jsx("span",{className:"px-3 py-1.5 text-xs bg-amber-50 text-amber-700 border border-amber-100 rounded-full font-medium",children:g},w))})]}),t.jsx("div",{className:"h-12"})]})]})})]})},jr=({documents:u,selectedDoc:e,onSelect:s,onDownload:r,onDownloadAll:a,performanceMetrics:i})=>{const[n,l]=N.useState(""),[o,c]=N.useState("list"),d=N.useMemo(()=>n?u.filter(p=>p.fileName.toLowerCase().includes(n.toLowerCase())):u,[u,n]),h=N.useMemo(()=>{const p=u.reduce((y,E)=>y+E.blob.size,0),x=u.length>0?p/u.length:0;return{totalDocs:u.length,totalSize:p,avgSize:x,avgGenerationTime:i!=null&&i.documentGeneration?i.documentGeneration/u.length:0}},[u,i]),m=p=>p<1024?p+" B":p<1024*1024?(p/1024).toFixed(2)+" KB":(p/(1024*1024)).toFixed(2)+" MB",f=p=>p<1e3?p+"ms":(p/1e3).toFixed(2)+"s";return t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[t.jsx("div",{className:"flex-shrink-0 bg-white border-b border-slate-200 px-6 py-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"bg-purple-50 p-2 rounded-xl border border-purple-100",children:t.jsx(gs,{className:"w-5 h-5 text-purple-600"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"font-bold text-slate-800 text-lg",children:"生成文档"}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 mt-0.5",children:[t.jsx("span",{children:"批量处理结果"}),t.jsx("span",{className:"w-1 h-1 rounded-full bg-slate-300"}),t.jsxs("span",{children:[h.totalDocs," 个文件"]}),t.jsx("span",{className:"w-1 h-1 rounded-full bg-slate-300"}),t.jsx("span",{children:m(h.totalSize)}),t.jsx("span",{className:"w-1 h-1 rounded-full bg-slate-300"}),t.jsxs("span",{children:["平均耗时 ",f(h.avgTime)]})]})]})]}),t.jsxs("button",{onClick:a,className:"px-4 py-2 bg-emerald-500 text-white rounded-xl font-medium hover:bg-emerald-600 transition-all flex items-center gap-2 shadow-sm shadow-emerald-200",children:[t.jsx(xs,{className:"w-4 h-4"}),"下载全部(ZIP)"]})]})}),t.jsx("div",{className:"p-4 border-b border-slate-200 bg-white",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"relative flex-1 max-w-md",children:[t.jsx(dt,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),t.jsx("input",{type:"text",value:n,onChange:p=>l(p.target.value),placeholder:"搜索文档...",className:"w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"flex bg-slate-100 rounded-lg p-1",children:[t.jsx("button",{onClick:()=>c("list"),className:`px-3 py-1.5 rounded text-sm font-medium transition-all ${o==="list"?"bg-white text-slate-800 shadow-md":"text-slate-600 hover:text-slate-800 hover:bg-slate-50"}`,children:"列表"}),t.jsx("button",{onClick:()=>c("grid"),className:`px-3 py-1.5 rounded text-sm font-medium transition-all ${o==="grid"?"bg-white text-slate-800 shadow-md":"text-slate-600 hover:text-slate-800 hover:bg-slate-50"}`,children:"网格"})]}),t.jsx("div",{className:"text-sm text-slate-500",children:n&&t.jsxs("span",{children:["找到 ",t.jsx("span",{className:"font-bold text-purple-600",children:d.length})," 个文档"]})})]})]})}),t.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:d.length===0?t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center text-slate-400",children:[t.jsx(te,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),t.jsx("p",{className:"text-lg font-medium mb-2",children:n?"没有找到匹配的文档":"暂无文档"}),t.jsx("p",{className:"text-sm",children:n?"请尝试其他搜索词":"请先生成文档"})]})}):o==="list"?t.jsx("div",{className:"space-y-3",children:d.map((p,x)=>t.jsx("div",{className:`
                  bg-white border rounded-lg p-4 transition-all hover:shadow-md
                  ${e===p?"border-purple-400 shadow-md ring-2 ring-purple-100":"border-slate-200 hover:border-purple-300"}
                `,children:t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("div",{className:"flex-shrink-0",children:t.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg flex items-center justify-center",children:t.jsx(te,{className:"w-6 h-6 text-purple-600"})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:"text-sm font-semibold text-slate-800 truncate",children:p.fileName}),t.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-slate-500",children:[t.jsx("span",{children:m(p.blob.size)}),t.jsx("span",{children:"•"}),t.jsxs("span",{children:["索引: ",p.dataIndex+1]}),p.recordData&&t.jsxs(t.Fragment,{children:[t.jsx("span",{children:"•"}),t.jsx("span",{className:"truncate max-w-[200px]",children:Object.entries(p.recordData).slice(0,2).map(([y,E])=>`${y}: ${E}`).join(" | ")})]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>s(p),className:"p-2 text-blue-600 bg-blue-50 hover:text-blue-700 hover:bg-blue-100 rounded-lg transition-all shadow-sm",title:"预览",children:t.jsx(it,{className:"w-4 h-4"})}),t.jsxs("button",{onClick:()=>r(p),className:"px-4 py-2 bg-purple-500 text-white rounded-lg text-sm font-medium hover:bg-purple-600 hover:shadow-md transition-all flex items-center gap-2 shadow-sm",children:[t.jsx(Le,{className:"w-4 h-4"}),"下载"]})]})]})},x))}):t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:d.map((p,x)=>t.jsx("div",{className:`
                  bg-white border rounded-lg p-4 transition-all hover:shadow-md cursor-pointer
                  ${e===p?"border-purple-400 shadow-md ring-2 ring-purple-100":"border-slate-200 hover:border-purple-300"}
                `,onClick:()=>s(p),children:t.jsxs("div",{className:"flex flex-col items-center text-center",children:[t.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg flex items-center justify-center mb-3",children:t.jsx(te,{className:"w-8 h-8 text-purple-600"})}),t.jsx("h3",{className:"text-sm font-semibold text-slate-800 mb-2 line-clamp-2",children:p.fileName}),t.jsxs("div",{className:"text-xs text-slate-500 mb-3",children:[t.jsx("div",{children:m(p.blob.size)}),t.jsxs("div",{children:["索引: ",p.dataIndex+1]})]}),t.jsxs("button",{onClick:y=>{y.stopPropagation(),r(p)},className:"w-full py-2 bg-purple-500 text-white rounded-lg text-sm font-medium hover:bg-purple-600 transition-colors flex items-center justify-center gap-2",children:[t.jsx(Le,{className:"w-4 h-4"}),"下载"]})]})},x))})}),u.length>0&&t.jsx("div",{className:"p-4 border-t border-slate-200 bg-slate-50",children:t.jsxs("div",{className:"flex items-center justify-between text-sm",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("span",{className:"text-slate-500",children:["总计 ",t.jsx("span",{className:"font-bold text-slate-700",children:u.length})," 个文档"]}),t.jsxs("span",{className:"text-slate-500",children:["总大小 ",t.jsx("span",{className:"font-bold text-slate-700",children:m(h.totalSize)})]})]}),t.jsxs("div",{className:"flex items-center gap-2 text-emerald-600",children:[t.jsx(Te,{className:"w-4 h-4"}),t.jsx("span",{className:"font-medium",children:"全部生成完成"})]})]})})]})},wr=({document:u,onClose:e})=>{const[s,r]=N.useState(""),[a,i]=N.useState(!0),[n,l]=N.useState(null),[o,c]=N.useState(100),d=N.useRef(null);N.useEffect(()=>{h()},[u]);const h=async()=>{i(!0),l(null);try{const E=await u.blob.arrayBuffer(),F=await(await He(()=>import("./docx-vendor-Bfp-vY9X.js").then(D=>D.i),__vite__mapDeps([0,1,2]),import.meta.url)).convertToHtml({arrayBuffer:E},{styleMap:["p[style-name='Heading 1'] => h1:fresh","p[style-name='Heading 2'] => h2:fresh","p[style-name='Heading 3'] => h3:fresh","p[style-name='Title'] => h1.title:fresh"],includeDefaultStyleMap:!0});r(F.value),F.messages&&F.messages.length>0&&Ne.warn("文档转换警告:",F.messages)}catch(E){const R=E instanceof Error?E.message:"未知错误";l(`无法加载文档: ${R}`),Ne.error("文档预览错误:",E)}finally{i(!1)}},m=()=>{const E=URL.createObjectURL(u.blob),R=window.document.createElement("a");R.href=E,R.download=u.fileName,R.click(),URL.revokeObjectURL(E)},f=()=>{c(E=>Math.min(E+10,200))},p=()=>{c(E=>Math.max(E-10,50))},x=()=>{c(100)},y=E=>E<1024?E+" B":E<1024*1024?(E/1024).toFixed(2)+" KB":(E/(1024*1024)).toFixed(2)+" MB";return t.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:t.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col",children:[t.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-200",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"bg-blue-100 p-2 rounded-lg",children:t.jsx(te,{className:"w-5 h-5 text-blue-600"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-slate-800 truncate max-w-md",children:u.fileName}),t.jsxs("p",{className:"text-xs text-slate-500",children:[y(u.blob.size),u.recordData&&t.jsxs("span",{className:"ml-2",children:["• 索引: ",u.dataIndex+1]})]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"flex items-center gap-1 mr-2",children:[t.jsx("button",{onClick:p,disabled:o<=50,className:"p-2 text-slate-600 hover:bg-slate-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed",title:"缩小",children:t.jsx(fs,{className:"w-4 h-4"})}),t.jsxs("span",{className:"text-sm font-medium text-slate-700 min-w-[60px] text-center",children:[o,"%"]}),t.jsx("button",{onClick:f,disabled:o>=200,className:"p-2 text-slate-600 hover:bg-slate-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed",title:"放大",children:t.jsx(ys,{className:"w-4 h-4"})}),t.jsx("button",{onClick:x,className:"p-2 text-slate-600 hover:bg-slate-100 rounded-lg",title:"重置缩放",children:t.jsx(bs,{className:"w-4 h-4"})})]}),t.jsx("div",{className:"h-6 w-px bg-slate-200 mx-1"}),t.jsxs("button",{onClick:m,className:"px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors flex items-center gap-2",children:[t.jsx(Le,{className:"w-4 h-4"}),"下载"]}),t.jsx("button",{onClick:e,className:"p-2 text-slate-600 hover:bg-slate-100 rounded-lg",children:t.jsx(Ge,{className:"w-5 h-5"})})]})]}),t.jsx("div",{className:"flex-1 overflow-hidden bg-slate-50",children:a?t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center text-slate-400",children:[t.jsx(Ce,{className:"w-12 h-12 mx-auto mb-4 animate-spin"}),t.jsx("p",{className:"text-lg font-medium mb-2",children:"正在加载文档..."}),t.jsx("p",{className:"text-sm",children:"请稍候"})]})}):n?t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center text-red-400",children:[t.jsx(te,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),t.jsx("p",{className:"text-lg font-medium mb-2",children:"加载失败"}),t.jsx("p",{className:"text-sm mb-4",children:n}),t.jsx("button",{onClick:h,className:"px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors",children:"重试"})]})}):s?t.jsx("div",{ref:d,className:"flex-1 overflow-auto p-8",style:{transformOrigin:"top center"},children:t.jsx("div",{className:"bg-white shadow-lg rounded-lg p-8 mx-auto",style:{maxWidth:"800px",transform:`scale(${o/100})`,transformOrigin:"top center"},children:t.jsx("div",{className:"prose prose-slate max-w-none",dangerouslySetInnerHTML:{__html:s}})})}):t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center text-slate-400",children:[t.jsx(te,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),t.jsx("p",{className:"text-lg font-medium",children:"无法预览此文档"}),t.jsx("p",{className:"text-sm mt-2",children:"请下载后查看"})]})})}),u.recordData&&t.jsx("div",{className:"p-4 border-t border-slate-200 bg-slate-50",children:t.jsxs("div",{className:"text-sm text-slate-600",children:[t.jsx("span",{className:"font-medium",children:"文档数据："}),t.jsxs("span",{className:"ml-2",children:[Object.entries(u.recordData).slice(0,5).map(([E,R],F)=>t.jsxs("span",{className:"inline-flex items-center",children:[F>0&&t.jsx("span",{className:"mx-1 text-slate-300",children:"•"}),t.jsxs("span",{className:"text-slate-700",children:[E,":"]}),t.jsx("span",{className:"text-slate-500 ml-1",children:String(R)})]},E)),Object.keys(u.recordData).length>5&&t.jsxs("span",{className:"text-slate-400 ml-2",children:["...等 ",Object.keys(u.recordData).length," 个字段"]})]})]})})]})})};class Er{constructor(){this.storageKey="excelmind_template_library",this.fileStorageKey="excelmind_template_files"}async getAllTemplates(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("[TemplateStorage] Failed to get templates:",e),[]}}async saveTemplate(e,s){try{const r=`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a=await e.arrayBuffer(),i=Array.from(new Uint8Array(a));localStorage.setItem(`${this.fileStorageKey}_${r}`,JSON.stringify(i));const n={...s,id:r,createdAt:Date.now(),updatedAt:Date.now(),fileSize:e.size},l=await this.getAllTemplates();return l.push(n),localStorage.setItem(this.storageKey,JSON.stringify(l)),n}catch(r){throw console.error("[TemplateStorage] Failed to save template:",r),r}}async loadTemplateFile(e){try{const s=localStorage.getItem(`${this.fileStorageKey}_${e}`);if(!s)return null;const r=JSON.parse(s);return new Uint8Array(r).buffer}catch(s){return console.error("[TemplateStorage] Failed to load template file:",s),null}}async deleteTemplate(e){try{localStorage.removeItem(`${this.fileStorageKey}_${e}`);const r=(await this.getAllTemplates()).filter(a=>a.id!==e);localStorage.setItem(this.storageKey,JSON.stringify(r))}catch(s){throw console.error("[TemplateStorage] Failed to delete template:",s),s}}async updateTemplate(e,s){try{const r=await this.getAllTemplates(),a=r.findIndex(i=>i.id===e);if(a===-1)throw new Error("Template not found");r[a]={...r[a],...s,updatedAt:Date.now()},localStorage.setItem(this.storageKey,JSON.stringify(r))}catch(r){throw console.error("[TemplateStorage] Failed to update template:",r),r}}}const ot=new Er,Sr=({onUseTemplate:u,onUploadTemplate:e})=>{const[s,r]=N.useState([]),[a,i]=N.useState(!0);N.useEffect(()=>{n()},[]);const n=async()=>{try{i(!0);const d=await ot.getAllTemplates();r(d)}catch(d){console.error("[TemplateLibrary] Failed to load templates:",d)}finally{i(!1)}},l=async(d,h)=>{if(h.stopPropagation(),!!confirm("确定要删除这个模板吗?"))try{await ot.deleteTemplate(d),await n()}catch(m){console.error("[TemplateLibrary] Failed to delete template:",m),alert("删除失败,请重试")}},o=d=>d<1024?`${d} B`:d<1024*1024?`${(d/1024).toFixed(1)} KB`:`${(d/(1024*1024)).toFixed(1)} MB`,c=d=>new Date(d).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"});return a?t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsx("div",{className:"text-slate-400",children:"加载中..."})}):t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden bg-slate-50",children:[t.jsx("div",{className:"p-6 bg-white border-b border-slate-200",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-slate-800",children:"模板库"}),t.jsx("p",{className:"text-sm text-slate-500 mt-1",children:"管理和使用您保存的Word模板"})]}),t.jsxs("button",{onClick:e,className:"flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 hover:shadow-lg transition-all",children:[t.jsx(qe,{className:"w-4 h-4"}),"上传模板"]})]})}),t.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:s.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[t.jsx("div",{className:"w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4",children:t.jsx(te,{className:"w-10 h-10 text-slate-400"})}),t.jsx("h3",{className:"text-lg font-medium text-slate-600 mb-2",children:"暂无模板"}),t.jsx("p",{className:"text-sm text-slate-400 mb-6",children:"点击上方按钮上传您的第一个模板"})]}):t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(d=>t.jsxs("div",{onClick:()=>u(d),className:"bg-white rounded-lg border border-slate-200 p-4 hover:shadow-lg hover:border-orange-300 transition-all cursor-pointer group",children:[t.jsxs("div",{className:"flex items-start justify-between mb-3",children:[t.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-orange-100 to-red-100 rounded-lg flex items-center justify-center",children:t.jsx(te,{className:"w-6 h-6 text-orange-500"})}),t.jsx("button",{onClick:h=>l(d.id,h),className:"opacity-0 group-hover:opacity-100 p-2 hover:bg-red-50 rounded-lg transition-all",title:"删除模板",children:t.jsx(De,{className:"w-4 h-4 text-red-500"})})]}),t.jsx("h3",{className:"font-medium text-slate-800 mb-1 truncate",children:d.name}),d.description&&t.jsx("p",{className:"text-sm text-slate-500 mb-3 line-clamp-2",children:d.description}),t.jsxs("div",{className:"space-y-1 text-xs text-slate-400",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ns,{className:"w-3 h-3"}),t.jsx("span",{children:d.fileName})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(vs,{className:"w-3 h-3"}),t.jsx("span",{children:c(d.createdAt)})]}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("span",{children:["大小: ",o(d.fileSize)]})}),d.placeholders&&d.placeholders.length>0&&t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("span",{children:[d.placeholders.length," 个占位符"]})})]}),d.tags&&d.tags.length>0&&t.jsx("div",{className:"flex flex-wrap gap-1 mt-3",children:d.tags.slice(0,3).map((h,m)=>t.jsx("span",{className:"px-2 py-0.5 bg-orange-50 text-orange-600 rounded text-xs",children:h},m))})]},d.id))})})]})},Cr=({onClose:u,onSuccess:e})=>{const[s,r]=N.useState(null),[a,i]=N.useState(""),[n,l]=N.useState(""),[o,c]=N.useState(""),[d,h]=N.useState(""),[m,f]=N.useState(!1),p=y=>{var R;const E=(R=y.target.files)==null?void 0:R[0];E&&E.name.endsWith(".docx")?(r(E),a||i(E.name.replace(".docx",""))):alert("请选择.docx格式的Word文档")},x=async()=>{if(!s||!a.trim()){alert("请选择文件并输入模板名称");return}try{f(!0);const y=await Rt(s);await ot.saveTemplate(s,{name:a.trim(),fileName:s.name,description:n.trim()||void 0,category:o.trim()||void 0,tags:d.trim()?d.split(",").map(E=>E.trim()).filter(Boolean):void 0,placeholders:y.placeholders}),alert("模板上传成功!"),e()}catch(y){console.error("[TemplateUploadToLibrary] Upload failed:",y),alert("上传失败,请重试")}finally{f(!1)}};return t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4",children:[t.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-slate-200",children:[t.jsx("h2",{className:"text-xl font-bold text-slate-800",children:"上传模板到库"}),t.jsx("button",{onClick:u,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:t.jsx(Ge,{className:"w-5 h-5 text-slate-500"})})]}),t.jsxs("div",{className:"p-6 space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"选择模板文件 *"}),t.jsxs("div",{className:"relative",children:[t.jsx("input",{type:"file",accept:".docx",onChange:p,className:"hidden",id:"template-file-input"}),t.jsxs("label",{htmlFor:"template-file-input",className:"flex items-center justify-center gap-2 px-4 py-3 border-2 border-dashed border-slate-300 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition-all cursor-pointer",children:[t.jsx(qe,{className:"w-5 h-5 text-slate-400"}),t.jsx("span",{className:"text-slate-600",children:s?s.name:"点击选择.docx文件"})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"模板名称 *"}),t.jsx("input",{type:"text",value:a,onChange:y=>i(y.target.value),placeholder:"例如: 销售合同模板",className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"描述"}),t.jsx("textarea",{value:n,onChange:y=>l(y.target.value),placeholder:"简要描述这个模板的用途...",rows:3,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[t.jsx(js,{className:"w-4 h-4 inline mr-1"}),"分类"]}),t.jsx("input",{type:"text",value:o,onChange:y=>c(y.target.value),placeholder:"例如: 合同, 报告, 通知",className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[t.jsx(ws,{className:"w-4 h-4 inline mr-1"}),"标签"]}),t.jsx("input",{type:"text",value:d,onChange:y=>h(y.target.value),placeholder:"用逗号分隔,例如: 销售, 合同, 标准",className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"}),t.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"多个标签请用逗号分隔"})]})]}),t.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-slate-200",children:[t.jsx("button",{onClick:u,disabled:m,className:"px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50",children:"取消"}),t.jsx("button",{onClick:x,disabled:m||!s||!a.trim(),className:"flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 hover:shadow-lg transition-all disabled:bg-slate-300 disabled:text-slate-600 disabled:cursor-not-allowed",children:m?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"上传中..."]}):t.jsxs(t.Fragment,{children:[t.jsx(qe,{className:"w-4 h-4"}),"上传到库"]})})]})]})})},Tr=(u,e,s,r={})=>{const a=u.map(n=>{var o;const l=e.mappings.find(c=>c.placeholder===n);if(l){if(l.excelColumn.startsWith("[虚拟] ")){const c=l.excelColumn,d=(o=e.virtualColumns)==null?void 0:o.find(h=>h.name===c);return d?{placeholder:n,status:"valid",mappedSource:`Virtual: ${d.type}`,details:d.type==="ai"?`Prompt: ${d.aiPrompt}`:`Value: ${d.value}`}:{placeholder:n,status:"missing_source",mappedSource:c,details:"Virtual column definition missing"}}return s.includes(l.excelColumn)?{placeholder:n,status:"valid",mappedSource:`Excel: ${l.excelColumn}`}:{placeholder:n,status:"missing_source",mappedSource:l.excelColumn,details:`Column not found in sheet "${e.primarySheet}"`}}if(e.crossSheetMappings){const c=e.crossSheetMappings.find(d=>d.placeholder===n);if(c){const d=r[c.sourceSheet];return d?d.includes(c.sourceColumn)?{placeholder:n,status:"valid",mappedSource:`Cross-Sheet: ${c.sourceSheet}.${c.sourceColumn}`}:{placeholder:n,status:"missing_source",mappedSource:`Sheet: ${c.sourceSheet}`,details:`Column "${c.sourceColumn}" not found`}:{placeholder:n,status:"missing_source",mappedSource:`Sheet: ${c.sourceSheet}`,details:"Source sheet not found"}}}if(e.loopMappings){const c=e.loopMappings.find(d=>d.loopPlaceholder===n||d.loopPlaceholder===`#${n}`||d.loopPlaceholder===n.replace(/^#/,""));if(c)return r[c.sourceSheet]?{placeholder:n,status:"valid",mappedSource:`Loop: ${c.sourceSheet}`}:{placeholder:n,status:"missing_source",mappedSource:`Loop Source: ${c.sourceSheet}`,details:"Loop source sheet not found"}}return{placeholder:n,status:"unmapped",suggestion:"Click to Map"}}),i={total:a.length,valid:a.filter(n=>n.status==="valid").length,missing:a.filter(n=>n.status==="missing_source").length,unmapped:a.filter(n=>n.status==="unmapped").length};return{items:a,summary:i}},_r=({mappingScheme:u,templatePlaceholders:e,excelHeaders:s,allSheetsHeaders:r,primarySheetData:a,onAutoFix:i,onSelectGap:n})=>{const l=N.useMemo(()=>Tr(e,u,s,r),[e,u,s,r]),o=l.items.filter(d=>d.status==="valid"),c=l.items.filter(d=>d.status!=="valid");return t.jsxs("div",{className:"flex flex-col h-full bg-slate-50 overflow-hidden",children:[t.jsxs("div",{className:"flex-shrink-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm z-10",children:[t.jsxs("div",{children:[t.jsxs("h2",{className:"text-lg font-bold text-slate-800 flex items-center gap-2",children:[t.jsx(st,{className:"w-5 h-5 text-violet-500"}),"Agent Orchestrator (Data Supply Chain)"]}),t.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Visualize and repair the gap between Data Supply and Template Demand"})]}),t.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-emerald-50 text-emerald-700 rounded-full border border-emerald-100",children:[t.jsx(Te,{className:"w-4 h-4"}),t.jsx("span",{className:"font-bold",children:o.length})," Connected"]}),t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-amber-50 text-amber-700 rounded-full border border-amber-100",children:[t.jsx(Ot,{className:"w-4 h-4"}),t.jsx("span",{className:"font-bold",children:c.filter(d=>d.status==="missing_source").length})," Missing Source"]}),t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-red-50 text-red-700 rounded-full border border-red-100",children:[t.jsx(Ut,{className:"w-4 h-4"}),t.jsx("span",{className:"font-bold",children:c.filter(d=>d.status==="unmapped").length})," Unmapped"]})]})]}),t.jsxs("div",{className:"flex-1 flex overflow-hidden p-6 gap-6",children:[t.jsxs("div",{className:"flex-1 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col",children:[t.jsxs("div",{className:"p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl flex items-center gap-2",children:[t.jsx(_t,{className:"w-4 h-4 text-slate-500"}),t.jsx("h3",{className:"font-bold text-slate-700",children:"Data Supply (Excel)"}),t.jsxs("span",{className:"ml-auto text-xs bg-slate-200 px-2 py-0.5 rounded text-slate-600",children:[s.length," Cols"]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1",children:s.map(d=>t.jsxs("div",{className:"p-2 bg-slate-50 border border-slate-100 rounded text-sm text-slate-600 flex items-center gap-2 group hover:border-slate-300 transition-colors cursor-default",children:[t.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-slate-400 group-hover:bg-blue-400"}),t.jsx("span",{className:"truncate flex-1",children:d}),a&&a.length>0&&t.jsx("span",{className:"text-xs text-slate-400 truncate max-w-[80px]",children:Or(a[0][d])})]},d))})]}),t.jsx("div",{className:"w-1/3 flex flex-col gap-4",children:t.jsxs("div",{className:"flex-1 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col overflow-hidden",children:[t.jsxs("div",{className:"p-4 border-b border-slate-100 bg-slate-50 flex items-center gap-2",children:[t.jsx(Ut,{className:"w-4 h-4 text-slate-500"}),t.jsx("h3",{className:"font-bold text-slate-700",children:"Connections & Gaps"})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-0",children:[c.map(d=>t.jsxs("div",{className:"p-3 border-b border-slate-50 hover:bg-slate-50 transition-colors flex items-center justify-between group cursor-pointer",onClick:()=>n==null?void 0:n(d.placeholder),children:[t.jsxs("div",{className:"flex items-center gap-3 overflow-hidden",children:[Rr(d.status),t.jsxs("div",{className:"flex flex-col min-w-0",children:[t.jsx("span",{className:"text-sm font-medium text-slate-800 truncate",children:d.placeholder}),t.jsx("span",{className:"text-xs text-slate-400 truncate",children:d.details||d.suggestion||"Unmapped"})]})]}),t.jsx("button",{className:"opacity-0 group-hover:opacity-100 p-1.5 bg-violet-100 text-violet-600 rounded-md text-xs font-semibold hover:bg-violet-200 transition-all",onClick:h=>{h.stopPropagation(),i==null||i(d.placeholder)},children:"Repair"})]},d.placeholder)),t.jsxs("div",{className:"px-4 py-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider sticky top-0",children:["Active Connections (",o.length,")"]}),o.map(d=>t.jsx("div",{className:"p-3 border-b border-slate-50 flex items-center justify-between opacity-70 hover:opacity-100",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:"w-2 h-2 rounded-full bg-emerald-400"}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"text-sm text-slate-700",children:d.placeholder}),t.jsxs("span",{className:"text-xs text-slate-400 flex items-center gap-1",children:[t.jsx(jt,{className:"w-3 h-3"}),d.mappedSource]})]})]})},d.placeholder))]})]})}),t.jsxs("div",{className:"flex-1 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col",children:[t.jsxs("div",{className:"p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl flex items-center gap-2",children:[t.jsx(te,{className:"w-4 h-4 text-slate-500"}),t.jsx("h3",{className:"font-bold text-slate-700",children:"Template Demand"}),t.jsxs("span",{className:"ml-auto text-xs bg-slate-200 px-2 py-0.5 rounded text-slate-600",children:[e.length," Requirements"]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1",children:e.map(d=>{var m;const h=((m=l.items.find(f=>f.placeholder===d))==null?void 0:m.status)||"unmapped";return t.jsxs("div",{className:`p-2 border rounded text-sm flex items-center gap-2 ${h==="valid"?"bg-emerald-50/50 border-emerald-100 text-emerald-800":"bg-white border-dashed border-slate-300 text-slate-500"}`,children:[t.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${h==="valid"?"bg-emerald-500":"bg-slate-300"}`}),t.jsx("span",{className:"font-mono text-xs",children:`{{${d}}}`})]},d)})})]})]})]})},Or=u=>u==null?"-":String(u),Rr=u=>{switch(u){case"valid":return t.jsx(Te,{className:"w-4 h-4 text-emerald-500"});case"unmapped":return t.jsx(Es,{className:"w-4 h-4 text-red-500"});case"missing_source":return t.jsx(Ot,{className:"w-4 h-4 text-amber-500"});default:return t.jsx(dt,{className:"w-4 h-4 text-slate-400"})}},Mr=({activeTab:u,templateFile:e,excelData:s,mappingScheme:r,generatedDocs:a,selectedDoc:i,performanceMetrics:n,onTabChange:l,onDocSelect:o,onSheetChange:c,onTemplateFileChange:d,onMappingChange:h,aiProgress:m,allSheetsHeaders:f,onExportScheme:p})=>{const[x,y]=N.useState(!1),[E,R]=N.useState(!1),[F,D]=N.useState("classic"),k=async V=>{try{const ce=await ot.loadTemplateFile(V.id);if(!ce){console.error("[DocumentSpaceMain] Failed to load template file");return}const me=new File([ce],V.fileName,{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),Z=await Rt(me);d(Z),l("upload"),console.log("[DocumentSpaceMain] Template loaded from library:",V.name)}catch(ce){console.error("[DocumentSpaceMain] Failed to use template from library:",ce)}},P=()=>{y(!0)},ue=()=>{y(!1)},oe=[{id:"templates",label:"模板库",icon:Ss},{id:"template",label:"模板预览",icon:te,disabled:!e},{id:"data",label:"数据预览",icon:_e,disabled:!s},{id:"mapping",label:"映射方案",icon:rt,disabled:!r},{id:"generate",label:"生成文档",icon:Pt,disabled:a.length===0,badge:a.length>0?a.length:void 0}],ae=N.useMemo(()=>oe.filter(V=>u===V.id||!V.disabled),[oe,u]),fe=()=>{var V,ce,me,Z,se;switch(u){case"templates":return t.jsx(Sr,{onUseTemplate:k,onUploadTemplate:P});case"template":return e?t.jsx(fr,{templateFile:e}):ye("模板",te,"请先上传Word模板文件");case"data":return s?t.jsx(br,{excelData:s,currentSheetName:s.currentSheetName,onSheetChange:c}):ye("数据",_e,"请先上传Excel数据文件");case"mapping":return r?F==="agent"?t.jsx(_r,{mappingScheme:r,templatePlaceholders:(e==null?void 0:e.placeholders)||[],excelHeaders:s!=null&&s.sheets?Object.keys(((V=s.sheets[s.currentSheetName])==null?void 0:V[0])||{}):[],primarySheetData:(ce=s==null?void 0:s.sheets)==null?void 0:ce[s.currentSheetName],allSheetsHeaders:f,onAutoFix:ge=>{D("classic"),setTimeout(()=>alert(`请在映射编辑器中为 "${ge}" 手动选择列或创建虚拟列`),100)}}):t.jsx(vr,{mappingScheme:r,templatePlaceholders:(e==null?void 0:e.placeholders)||[],excelHeaders:s!=null&&s.sheets?Object.keys(((me=s.sheets[s.currentSheetName])==null?void 0:me[0])||{}):[],sampleData:(se=(Z=s==null?void 0:s.sheets)==null?void 0:Z[s.currentSheetName])==null?void 0:se[0],onMappingChange:h,allSheetsHeaders:f,onExportScheme:p}):ye("映射方案",rt,"请先生成映射方案");case"generate":return a.length>0?t.jsx(jr,{documents:a,selectedDoc:i,onSelect:o,onDownload:ge=>{const O=URL.createObjectURL(ge.blob),Q=document.createElement("a");Q.href=O,Q.download=ge.fileName,Q.click(),URL.revokeObjectURL(O)},onDownloadAll:async()=>{const ge=(await He(async()=>{const{default:Se}=await import("./vendor-VUkWwLEC.js").then(ke=>ke.J);return{default:Se}},__vite__mapDeps([2,1]),import.meta.url)).default,O=new ge;a.forEach(Se=>{O.file(Se.fileName,Se.blob)});const Q=await O.generateAsync({type:"blob"}),G=URL.createObjectURL(Q),Ee=document.createElement("a");Ee.href=G,Ee.download=`批量文档_${Date.now()}.zip`,Ee.click(),URL.revokeObjectURL(G)},performanceMetrics:n}):ye("生成文档",Pt,"请先生成文档");default:return B()}},ye=(V,ce,me)=>t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center text-slate-400",children:[t.jsx("div",{className:"inline-flex items-center justify-center w-20 h-20 bg-slate-100 rounded-full mb-4",children:t.jsx(ce,{className:"w-10 h-10 text-slate-400"})}),t.jsx("h3",{className:"text-lg font-medium text-slate-600 mb-2",children:V}),t.jsx("p",{className:"text-sm text-slate-400",children:me})]})}),B=()=>t.jsx("div",{className:"flex-1 flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100",children:t.jsxs("div",{className:"text-center max-w-md",children:[t.jsx("div",{className:"inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-orange-100 to-red-100 rounded-full mb-6",children:t.jsx(te,{className:"w-12 h-12 text-orange-500"})}),t.jsx("h2",{className:"text-2xl font-bold text-slate-700 mb-3",children:"智能文档填充"}),t.jsx("p",{className:"text-slate-500 mb-6 leading-relaxed",children:"上传Word模板和Excel数据，AI将自动生成映射方案并批量生成文档"}),t.jsxs("div",{className:"space-y-3 text-sm text-left bg-white rounded-lg p-6 shadow-sm border border-slate-200",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 font-bold text-xs",children:"1"}),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-slate-700",children:"上传Word模板"}),t.jsx("p",{className:"text-slate-500",children:"支持.docx格式，占位符使用双花括号格式，如：&lbrace;&lbrace;字段名&rbrace;&rbrace;"})]})]}),t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 font-bold text-xs",children:"2"}),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-slate-700",children:"上传Excel数据"}),t.jsx("p",{className:"text-slate-500",children:"支持.xlsx/.xls/.csv格式，可包含多个工作表"})]})]}),t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xs",children:"3"}),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-slate-700",children:"AI智能映射"}),t.jsx("p",{className:"text-slate-500",children:"输入自然语言指令，AI自动生成映射方案"})]})]}),t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold text-xs",children:"4"}),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-slate-700",children:"批量生成文档"}),t.jsx("p",{className:"text-slate-500",children:"一键生成所有文档，支持单个或批量下载"})]})]})]})]})});return t.jsxs(t.Fragment,{children:[i&&t.jsx(wr,{document:i,onClose:()=>o(null)}),x&&t.jsx(Cr,{onClose:()=>y(!1),onSuccess:ue}),t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden bg-white",children:[t.jsx("div",{className:"border-b border-slate-200 bg-white",children:t.jsxs("div",{className:"flex items-center gap-1 px-6 py-3",children:[ae.map((V,ce)=>{const me=V.icon,Z=u===V.id;return t.jsxs("button",{onClick:()=>!V.disabled&&l(V.id),disabled:V.disabled,className:`
                    flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 border
                    ${Z?"bg-emerald-50 text-emerald-700 border-emerald-200 shadow-sm":"text-slate-600 bg-transparent border-transparent hover:bg-slate-50 hover:text-slate-900"}
                    ${V.disabled?"opacity-40 cursor-not-allowed !text-slate-400":"cursor-pointer"}
                  `,children:[t.jsx(me,{className:`w-4 h-4 ${Z?"text-emerald-600":"text-slate-400"}`}),t.jsx("span",{children:V.label}),V.badge&&t.jsx("span",{className:`
                      ml-1 px-2 py-0.5 rounded-full text-xs font-bold
                      ${Z?"bg-emerald-100 text-emerald-600":"bg-slate-100 text-slate-500"}
                    `,children:V.badge})]},V.id)}),u==="mapping"&&t.jsxs("div",{className:"ml-auto flex items-center bg-slate-100 p-1 rounded-lg border border-slate-200",children:[t.jsxs("button",{onClick:()=>D("classic"),className:`px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-2 ${F==="classic"?"bg-white text-slate-700 shadow-sm":"text-slate-500 hover:text-slate-700"}`,children:[t.jsx(rt,{className:"w-3.5 h-3.5"}),"经典视图"]}),t.jsxs("button",{onClick:()=>D("agent"),className:`px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-2 ${F==="agent"?"bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white shadow-sm":"text-slate-500 hover:text-slate-700"}`,children:[t.jsx(Cs,{className:"w-3.5 h-3.5"}),"Agent 编排"]})]})]})}),t.jsx("div",{className:"flex-1 overflow-hidden",children:fe()})]})]})},Ir={async processBatch(u,e,s){const r=e.mappings.filter(d=>d.ruleType==="ai"||d.transform&&d.transform.trim().startsWith("// AI"));if(r.length===0)return{enrichedData:u,runtimeMapping:e};console.log(`[AI Batch] Found ${r.length} AI rules. Processing ${u.length} rows.`);const a=e.mappings.map(d=>r.includes(d)?{...d,excelColumn:`__AI_${d.placeholder}`,transform:void 0,ruleType:"direct"}:d),i={...e,mappings:a},n=5,l=[...u],o=u.length;let c=0;for(let d=0;d<o;d+=n){const h=l.slice(d,d+n),m=h.map(async(f,p)=>{const x=d+p,y={...f};for(const E of r){const R=E.transform||"",F=await We.processRule(R,f);y[`__AI_${E.placeholder}`]=F.result||""}l[x]=y});await Promise.all(m),c+=h.length,c>o&&(c=o),s&&s(c,o)}return{enrichedData:l,runtimeMapping:i}}};function Lr(u,e,s,r,a){const i={};return e.forEach(n=>{const l=n.loopPlaceholder.replace(/^\{\#|\}$/g,"").replace(/^#/,"");n.type==="lookup"?i[l]=kr(u,n,s,r,a):n.type==="group_by"&&(i[l]=Ar(u,n,s,a))}),i}function kr(u,e,s,r,a){if(!e.sourceSheet||!e.foreignKey)return console.warn(`Loop ${e.loopPlaceholder} missing sourceSheet or foreignKey`),[];const i=u[e.foreignKey];if(!i)return[];let n=[];return a&&a.has(e.loopPlaceholder)?n=a.get(e.loopPlaceholder).get(String(i))||[]:n=(s[e.sourceSheet]||[]).filter(o=>String(o[e.foreignKey]||"")===String(i)),n.map(l=>Xt(l,e))}function Ar(u,e,s,r){const a=e.groupByColumn;if(!a)return[];const i=u[a];if(!i)return[];let n=[];if(r&&r.has(e.loopPlaceholder))n=r.get(e.loopPlaceholder).get(String(i))||[];else{const l=e.sourceSheet||"Sheet1";n=(s[l]||[]).filter(c=>String(c[a])===String(i))}return n.map(l=>Xt(l,e))}function Xt(u,e){const s={};return e.mappings.forEach(r=>{const a=r.placeholder.replace(/^\{\{|\}\}$/g,"").trim();let i=u[r.excelColumn];i==null&&(i=""),s[a]=i}),s}const Vr=()=>{var _;const{currentExcelData:u,currentTemplate:e,setExcelData:s,setTemplate:r}=Zt(),[a,i]=N.useState(null),[n,l]=N.useState(null),[o,c]=N.useState(null),[d,h]=N.useState(""),[m,f]=N.useState(null),[p,x]=N.useState([]),[y,E]=N.useState(""),[R,F]=N.useState([]),[D,k]=N.useState("individual"),[P,ue]=N.useState({rules:[]}),[oe,ae]=N.useState("upload"),[fe,ye]=N.useState(null),[B,V]=N.useState(!1),[ce,me]=N.useState("classic"),[Z,se]=N.useState(!1),[ge,O]=N.useState(""),[Q,G]=N.useState(0),[Ee,Se]=N.useState([]),[ke,ve]=N.useState({}),ze=N.useMemo(()=>{const b=new Qs;return b.addExamples(zt),b},[]);N.useEffect(()=>{if(u&&!o){c(u);const b=Object.keys(u.sheets||{});b.length>0&&!y&&E(u.currentSheetName||b[0]),e||ae("data")}e&&!a&&(i(e),!p||p.length),u&&e&&!m&&ae("mapping")},[u,e]),N.useEffect(()=>{const b=mr({monitor:{autoStart:!0,monitoringInterval:1e3,enableAlerts:!0},benchmarks:{ai:{simple:{target:3e3,warning:5e3,error:1e4},complex:{target:5e3,warning:8e3,error:15e3}},document:{single:{target:2e3,warning:3e3,error:5e3},batch_10:{target:5e3,warning:8e3,error:12e3},batch_100:{target:2e4,warning:3e4,error:45e3}},queries:{simple:{target:100,warning:200,error:500},filter:{target:200,warning:400,error:800},aggregate:{target:300,warning:600,error:1e3},join:{target:500,warning:1e3,error:2e3}},resources:{memory:{target:50,warning:70,error:90},cpu:{target:30,warning:50,error:75}}}});return()=>{b.monitor.stopMonitoring()}},[]);const C=N.useCallback((b,S,L,j)=>{const I={id:Date.now().toString()+Math.random().toString(36).substr(2,9),timestamp:Date.now(),stage:b,status:S,message:L,details:j};if(Se(q=>[I,...q]),S==="success"){const q=j==null?void 0:j.duration;q&&ve(H=>({...H,[b]:q}))}},[]),ut=N.useCallback(async b=>{if(!b.name.endsWith(".docx")){C("template_upload","error","请上传.docx格式的Word文档");return}se(!0),O("template_upload"),G(0),C("template_upload","pending","正在解析Word模板...");const S=he.startTracking("template.upload"),L=performance.now();try{const j=await Rt(b);i(j),r(j),ae("template");const I=performance.now()-L;he.stopTracking(S,I),C("template_upload","success",`模板 "${b.name}" 解析成功，检测到 ${j.placeholders.length} 个占位符`,{duration:I,placeholderCount:j.placeholders.length}),Ue({type:"custom",name:"template.parse",value:I,unit:"ms",timestamp:Date.now()})}catch(j){const I=j instanceof Error?j.message:String(j);C("template_upload","error",`模板解析失败: ${I}`)}finally{se(!1),G(100)}},[C]),mt=N.useCallback(async b=>{se(!0),O("data_upload"),G(0),C("data_upload","pending","正在读取Excel数据...");const S=he.startTracking("data.upload"),L=performance.now();try{const j=await es(b);if(!j||!j.sheets)throw new Error("Excel数据解析失败：返回数据格式不正确");l(b),c(j),s(j),ae("data");const I=Object.keys(j.sheets);I.length>0&&!y&&E(j.currentSheetName||I[0]);const q=performance.now()-L;he.stopTracking(S,q);const H=Object.keys(j.sheets).length,ee=j.sheets[j.currentSheetName]||[];C("data_upload","success",`数据 "${b.name}" 读取成功，共${H}个工作表，当前工作表${ee.length}行数据`,{duration:q,sheetCount:H,rowCount:ee.length}),Ue({type:"custom",name:"excel.parse",value:q,unit:"ms",timestamp:Date.now()})}catch(j){const I=j instanceof Error?j.message:String(j);console.error("[handleDataUpload] Error:",j),C("data_upload","error",`数据读取失败: ${I}`),c(null),l(null)}finally{se(!1),G(100)}},[C]),Qe=N.useCallback(async()=>{var L;if(!a||!o||!o.sheets||!d.trim()){C("mapping","error","请先上传模板和数据，并输入指令");return}se(!0),O("ai_mapping"),G(0),C("mapping","pending","AI正在分析并生成映射方案...");const b=he.startTracking("ai.mapping"),S=performance.now();try{const j=Object.entries(o.sheets).map(([K,X])=>({sheetName:K,headers:Array.isArray(X)&&X.length>0?Object.keys(X[0]):[],rowCount:Array.isArray(X)?X.length:0,sampleData:Array.isArray(X)?X.slice(0,5):[]})),I=o.sheets[o.currentSheetName]||[],q=Array.isArray(I)&&I.length>0?Object.keys(I[0]):[],H=ze.findRelevantExamples(d,q,5);C("mapping","pending",`检索到 ${H.length} 个相关示例，正在分析 ${j.length} 个工作表...`);const ee=await Is({allSheetsInfo:j,primarySheet:y||void 0,templatePlaceholders:a.placeholders,userInstruction:d.trim()}),xe=new nr().validateMappingResult(ee,{templatePlaceholders:a.placeholders,excelHeaders:q});xe.isValid||C("mapping","warning",`映射生成完成，但存在警告: ${xe.warnings.join(", ")}`),f(ee),ae("mapping"),ee.primarySheet&&ee.primarySheet!==y&&(E(ee.primarySheet),C("mapping","pending",`AI建议使用 "${ee.primarySheet}" 作为主数据表`));const pe=performance.now()-S;he.stopTracking(b,pe);const de=((L=ee.crossSheetMappings)==null?void 0:L.length)||0,W=de>0?`AI映射完成：${ee.mappings.length}个映射，${de}个跨Sheet查找，${ee.unmappedPlaceholders.length}个未映射`:`AI映射完成：${ee.mappings.length}个映射，${ee.unmappedPlaceholders.length}个未映射`;C("mapping","success",W,{duration:pe,mappingCount:ee.mappings.length,crossSheetCount:de,unmappedCount:ee.unmappedPlaceholders.length,exampleCount:H.length,confidence:ee.confidence,primarySheet:ee.primarySheet}),Ue({type:"custom",name:"mapping.generation",value:pe,unit:"ms",timestamp:Date.now(),metadata:{mappingCount:ee.mappings.length,exampleCount:H.length}}),ve(K=>({...K,aiMapping:pe}))}catch(j){const I=j instanceof Error?j.message:String(j);C("mapping","error",`映射生成失败: ${I}`)}finally{se(!1),G(100)}},[a,o,d,ze,C]),Ye=N.useCallback((b,S)=>{const L=new Map;return b.forEach(j=>{const I=String(j[S]||"");I&&L.set(I,j)}),L},[o,y,R]),Je=N.useCallback((b,S)=>{const L=new Map;return b.forEach(j=>{const I=String(j[S]||"");if(I){const q=L.get(I)||[];q.push(j),L.set(I,q)}}),L},[o,y,R]),Ke=N.useCallback(async()=>{if(!a||!o||!m){C("generating","error","Please generate mapping first");return}se(!0),O("document_generation"),G(0),C("generating","pending","Using aggregate mode to generate documents...");const b=he.startTracking("document.generation"),S=performance.now();try{const L=m.primarySheet||o.currentSheetName,j=o.sheets[L]||[],I=a.name.replace(".docx","");let q=P;if(!q.rules||q.rules.length===0){const W=j.length>0?Object.keys(j[0]):[];q={...P,rules:W.filter(K=>K.includes("销售额")||K.includes("金额")||K.includes("数量")).map(K=>({field:K,operation:"sum",alias:`总${K}`}))},q.rules.length===0&&q.rules.push({field:W[0]||"id",operation:"count",alias:"总数"}),ue(q),C("generating","info",`Auto-inferred aggregate config: ${q.rules.length} rules`)}C("generating","pending",`Aggregate config: ${q.rules.length} rules, ${j.length} rows`);const{executeAggregate:H}=await He(async()=>{const{executeAggregate:W}=await import("./aggregateService-BakqqAdc.js");return{executeAggregate:W}},[],import.meta.url),je=await(async W=>await Promise.all(W.map(async(X,Oe)=>{const we={...X};if(m.virtualColumns)for(const Y of m.virtualColumns)Y.type==="const"?we[Y.name]=Y.value:Y.type==="var"&&(Y.value==="CurrentDate"&&(we[Y.name]=new Date().toLocaleDateString()),Y.value==="UUID"&&(we[Y.name]=crypto.randomUUID()),Y.value==="RowIndex"&&(we[Y.name]=Oe+1));return m.mappings.forEach(Y=>{const ie=Y.placeholder.replace(/\{\{|\}\}/g,"").trim();ie!==Y.excelColumn&&(we[ie]=X[Y.excelColumn])}),we})))(j),xe=H(je,q);C("generating","pending",`Aggregation complete, will generate ${xe.length} summary documents`);const pe=[];for(let W=0;W<xe.length;W++){const K=xe[W],X={};m.mappings.forEach(ie=>{const Re=ie.placeholder.replace(/\{\{|\}\}/g,"").trim();K[Re]!==void 0?X[Re]=K[Re]:K[ie.excelColumn]!==void 0&&(X[Re]=K[ie.excelColumn])}),Object.keys(K).forEach(ie=>{X[ie]===void 0&&(X[ie]=K[ie])});const Oe=await lt.generateDocument({templateBuffer:a.arrayBuffer,data:X}),we=xe.length===1?`${I}_汇总.docx`:`${I}_汇总_${W+1}.docx`;pe.push({blob:Oe,fileName:we,dataIndex:W,recordData:K});const Y=Math.round((W+1)/xe.length*100);G(Y),C("generating","pending",`Generating summary document: ${W+1}/${xe.length} (${Y}%)`)}x(pe),ae("generate");const de=performance.now()-S;he.stopTracking(b,de),C("generating","success",`Aggregate mode: Successfully generated ${pe.length} summary documents`,{duration:de,documentCount:pe.length,avgTime:de/pe.length}),Ue({type:"custom",name:"aggregate.generate",value:de,unit:"ms",timestamp:Date.now(),metadata:{mode:"aggregate",documentCount:pe.length,aggregateRules:q.rules.length}}),ve(W=>({...W,documentGeneration:de}))}catch(L){const j=L instanceof Error?L.message:String(L);C("generating","error",`Aggregate document generation failed: ${j}`)}finally{se(!1),G(100)}},[a,o,m,P,C]),g=N.useCallback(async()=>{var L;if(D==="aggregate")return Ke();if(!a||!o||!m){C("generating","error","请先生成映射方案");return}se(!0),O("document_generation"),G(0),C("generating","pending","正在批量生成Word文档...");const b=he.startTracking("document.generation"),S=performance.now();try{const j=m.primarySheet||o.currentSheetName;let I=o.sheets[j]||[];const q=a.name.replace(".docx","");let H=m;if(m.mappings.some(M=>M.ruleType==="ai"||M.transform&&M.transform.trim().startsWith("// AI"))){O("ai_batch_processing"),C("generating","pending","Detected AI rules, starting batch processing...");try{const M=await Ir.processBatch(I,m,(J,A)=>{const U=Math.round(J/A*100);G(U)});I=M.enrichedData,H=M.runtimeMapping,C("generating","success","AI batch processing completed successfully")}catch(M){throw console.error("AI Batch Processing Failed:",M),C("generating","error",`AI processing failed: ${M instanceof Error?M.message:String(M)}`),new Error("AI processing failed, cannot generate documents.")}}O("document_generation"),G(0),C("generating","pending",`使用主数据表 "${j}" (${I.length}行) 生成文档...`);const je=H.crossSheetMappings&&H.crossSheetMappings.length>0;je&&C("generating","info",`检测到 ${H.crossSheetMappings.length} 个跨Sheet映射，正在构建查找索引...`);const xe=new Map;let pe=0;je&&H.crossSheetMappings.forEach(M=>{const J=o.sheets[M.sourceSheet];if(J){const A=Ye(J,M.lookupKey);xe.set(M.sourceSheet,A),pe+=J.length,C("generating","info",`为Sheet "${M.sourceSheet}" 构建索引 (${J.length}行，键字段: ${M.lookupKey})`)}else C("generating","warning",`找不到来源Sheet: ${M.sourceSheet}`)});let de=0,W=0;const K=new Map;H.loopMappings&&H.loopMappings.forEach(M=>{const J=M.type==="group_by",A=J?M.sourceSheet||j:M.sourceSheet,U=J?M.groupByColumn:M.foreignKey,z=o.sheets[A];if(z&&U){const re=Je(z,U);K.set(M.loopPlaceholder,re),C("generating","info",`为 Loop #${M.loopPlaceholder} 构建多值索引 (${z.length}行)`)}else C("generating","warning",`Loop #${M.loopPlaceholder} 无法构建索引 (Sheet: ${A}, Key: ${U})`)});let X=I;H.virtualColumns&&H.virtualColumns.length>0&&(X=await Promise.all(I.map(async(M,J)=>{const A={...M};for(const U of H.virtualColumns){const z=U.name;if(U.type==="const"){const re=/^(new Date|Math\.|Date\.)/i;if(typeof U.value=="string"&&re.test(U.value.trim()))try{const le=new Function(`return ${U.value}`);A[z]=le()}catch{A[z]=U.value}else A[z]=U.value}else if(U.type==="var")U.value==="CurrentDate"?A[z]=new Date().toLocaleDateString():U.value==="CurrentTime"?A[z]=new Date().toLocaleTimeString():U.value==="RowIndex"?A[z]=J+1:U.value==="UUID"&&(A[z]=crypto.randomUUID());else if(U.type==="ai")if(J<3)try{let le=U.aiPrompt||U.value;Object.keys(M).forEach(Ie=>{le=le.replace(new RegExp(`\\{\\{${Ie}\\}\\}`,"g"),String(M[Ie]||""))});const Me=await We.generateCellContent(le,M);A[z]=Me.result||"[AI Error]"}catch{A[z]="[AI Failed]"}else A[z]="[AI Preview Limited]"}return A})));const Oe=(L=H.loopMappings)==null?void 0:L.find(M=>M.type==="group_by");if(Oe&&Oe.groupByColumn){const M=Oe.groupByColumn,J=new Set,A=[];X.forEach(U=>{let z=String(U[M]||"");(z==="undefined"||z==="null"||z==="")&&(z="Default_Merge_Group"),z&&!J.has(z)&&(J.add(z),A.push(U))}),A.length>0&&(o.sheets[j]=X,X=A,C("generating","info",`Group By 模式: 依据 "${M}" 合并为 ${A.length} 个文档`))}const we=await Promise.all(X.map(async(M,J)=>{const A={},U={...M};let z={};H.loopMappings&&H.loopMappings.length>0&&(z=Lr(U,H.loopMappings,o.sheets,J,K),Object.entries(z).forEach(([re,le])=>{Array.isArray(le)&&le.length>0&&le.forEach((Me,Ie)=>{const Ae=`_${Ie+1}`;Object.entries(Me).forEach(([pt,Xe])=>{var kt;const It=`${pt}${Ae}`;A[It]=Xe,U[It]=Xe;const Lt=(kt=H.loopMappings)==null?void 0:kt.find($e=>$e.loopPlaceholder.replace(/^\{\#|\}$/g,"").replace(/^#/,"")===re);if(Lt){const $e=Lt.mappings.find(At=>At.placeholder.replace(/\{\{|\}\}/g,"").trim()===pt);if($e&&$e.excelColumn&&$e.excelColumn!==pt){const ht=`${$e.excelColumn}${Ae}`;A[ht]===void 0&&(A[ht]=Xe,U[ht]=Xe)}}})})}));for(const re of H.mappings){const le=re.placeholder.replace(/\{\{|\}\}/g,"").trim();re.excelColumn.startsWith("[虚拟] ")?A[le]=U[re.excelColumn]||"":A[le]=U[re.excelColumn]}return je&&H.crossSheetMappings.forEach(re=>{const le=String(M[re.lookupKey]||""),Me=re.placeholder.replace(/\{\{|\}\}/g,"").trim();if(!le){C("generating","warning",`第${J+1}行: 关联字段 "${re.lookupKey}" 为空，无法查找跨Sheet数据`),A[Me]="";return}W++;const Ie=xe.get(re.sourceSheet);let Ae=null;Ie&&(Ae=Ie.get(le)),Ae?(A[Me]=Ae[re.sourceColumn],de++):(J<3&&C("generating","warning",`第${J+1}行: 在Sheet "${re.sourceSheet}" 中找不到关联键 "${le}" 对应的数据`),A[Me]="")}),Object.assign(A,z),A}));if(je&&W>0){const M=(de/W*100).toFixed(1);C("generating","info",`跨Sheet查找统计: 成功 ${de}/${W} (${M}%)`)}const Y=await lt.batchGenerate({templateBuffer:a.arrayBuffer,dataList:we,baseFileName:q,options:{concurrency:3,batchSize:10,onProgress:(M,J)=>{const A=Math.round(M/J*100);G(A),C("generating","pending",`正在生成文档: ${M}/${J} (${A}%)`)}}});x(Y),ae("generate");const ie=performance.now()-S;he.stopTracking(b,ie);let Re=`成功生成 ${Y.length} 个Word文档`;if(je){const M=W>0?`，跨Sheet查找成功率 ${(de/W*100).toFixed(1)}%`:"";Re+=` (使用 ${m.crossSheetMappings.length} 个跨Sheet映射${M})`}C("generating","success",Re,{duration:ie,documentCount:Y.length,avgTime:ie/Y.length,crossSheetMappingCount:je?m.crossSheetMappings.length:0,crossSheetLookupSuccess:de,crossSheetLookupTotal:W,indexedRows:pe}),Ue({type:"custom",name:"batch.generate",value:ie,unit:"ms",timestamp:Date.now(),metadata:{documentCount:Y.length,avgTime:ie/Y.length,crossSheetMappings:je?m.crossSheetMappings.length:0,lookupSuccessRate:W>0?de/W*100:100}}),ve(M=>({...M,documentGeneration:ie}))}catch(j){const I=j instanceof Error?j.message:String(j);C("generating","error",`文档生成失败: ${I}`)}finally{se(!1),G(100)}},[a,o,m,C,Ye,D]);N.useCallback(b=>{at(b.blob,b.fileName),C("download","success",`已下载 ${b.fileName}`)},[C]),N.useCallback(async()=>{if(p.length!==0)try{const b=`批量文档_${Date.now()}.zip`;await Gt(p,b),C("download","success",`已下载打包的 ${p.length} 个文档`)}catch(b){const S=b instanceof Error?b.message:String(b);C("download","error",`下载失败: ${S}`)}},[p,C]),N.useCallback(b=>{ae(b)},[]),N.useCallback(b=>{ye(b)},[]),N.useCallback(b=>{o&&(c({...o,currentSheetName:b}),C("sheet_change","success",`切换到工作表: ${b}`))},[o,C]);const w=N.useCallback(()=>{if(!m){C("scheme_export","error","没有可导出的映射方案");return}try{const b=JSON.stringify(m,null,2),S=new Blob([b],{type:"application/json"}),L=`mapping_scheme_${Date.now()}.json`;at(S,L),C("scheme_export","success",`映射方案已导出为 ${L}`)}catch(b){const S=b instanceof Error?b.message:String(b);C("scheme_export","error",`导出映射方案失败: ${S}`)}},[m,C]),v=N.useCallback(async b=>{if(!b.name.endsWith(".json")){C("scheme_import","error","请上传.json格式的映射方案文件");return}try{const S=new FileReader;S.onload=async L=>{var j;try{const I=(j=L.target)==null?void 0:j.result,q=JSON.parse(I);if(!q.mappings||!Array.isArray(q.mappings))throw new Error("导入的映射方案结构不正确");f(q),ae("mapping"),C("scheme_import","success",`映射方案 "${b.name}" 导入成功`)}catch(I){const q=I instanceof Error?I.message:String(I);C("scheme_import","error",`解析映射方案文件失败: ${q}`)}},S.readAsText(b)}catch(S){const L=S instanceof Error?S.message:String(S);C("scheme_import","error",`导入映射方案失败: ${L}`)}},[C]);N.useMemo(()=>a&&o&&d.trim()&&!Z,[a,o,d,Z]),N.useMemo(()=>m&&!Z,[m,Z]);const T=N.useMemo(()=>{if(!o||!o.sheets)return{};const b={};return Object.entries(o.sheets).forEach(([S,L])=>{Array.isArray(L)&&L.length>0?b[S]=Object.keys(L[0]):b[S]=[]}),b},[o]);return t.jsxs("div",{className:"flex h-full bg-slate-50",children:[t.jsx("div",{className:`flex-shrink-0 transition-all duration-300 ease-in-out border-r border-slate-200 bg-white z-10 ${B?"w-[64px]":"w-[400px]"}`,children:t.jsx(xr,{isCollapsed:B,onToggleCollapse:()=>V(!B),templateFile:a,dataFile:n,excelData:o,userInstruction:d,mappingScheme:m,generatedDocs:p,isProcessing:Z,processingStage:ge,progress:Q,logs:Ee,performanceMetrics:ke,primarySheet:y,enabledSheets:R,availableFields:o!=null&&o.sheets?Object.keys(((_=o.sheets[o.currentSheetName])==null?void 0:_[0])||{}):[],generationMode:D,aggregateConfig:P,onGenerationModeChange:k,onAggregateConfigChange:ue,onTemplateUpload:ut,onDataUpload:mt,onInstructionChange:h,onPrimarySheetChange:E,onEnabledSheetsChange:F,onGenerateMapping:Qe,onGenerateDocs:g,onDownloadDoc:b=>at(b.blob,b.fileName),onDownloadAll:()=>Gt(p,`批量文档_${Date.now()}.zip`),onImportScheme:v})}),t.jsx(Mr,{activeTab:oe,templateFile:a,excelData:o,mappingScheme:m,generatedDocs:p,allSheetsHeaders:T,selectedDoc:fe,performanceMetrics:ke,onTabChange:ae,onDocSelect:ye,onSheetChange:b=>{o&&c({...o,currentSheetName:b})},onTemplateFileChange:i,onMappingChange:f,aiProgress:null,onExportScheme:w})]})},Gr=[{id:"upload",label:"上传",icon:()=>null},{id:"templates",label:"模板库",icon:()=>null},{id:"template",label:"模板预览",icon:()=>null},{id:"data",label:"数据预览",icon:()=>null},{id:"mapping",label:"映射方案",icon:()=>null},{id:"preview",label:"文档预览",icon:()=>null},{id:"generate",label:"生成文档",icon:()=>null}],Hr=[{id:"template_upload",label:"上传模板",status:"pending"},{id:"data_upload",label:"上传数据",status:"pending"},{id:"ai_mapping",label:"AI生成映射",status:"pending"},{id:"document_generation",label:"生成文档",status:"pending"}];export{br as DataPreview,jr as DocumentList,Vr as DocumentSpace,Mr as DocumentSpaceMain,xr as DocumentSpaceSidebar,vr as MappingEditor,Hr as PROCESSING_STAGES,pr as SheetSelector,Gr as TAB_CONFIGS,fr as TemplatePreview,Vr as default};
