import{j as e,r as w,b as Ke}from"./react-vendor-GaDxkzs9.js";import{e as fe,r as Ge}from"./excelService-5ufxowtn.js";import{l as P,u as Ve,A as Xe}from"./index-BMR0u2QP.js";import{utils as re,write as He}from"./xlsx-vendor-CkFp8p6R.js";import{o as We}from"./vendor-VUkWwLEC.js";import{i as Ye,j as ie,X as Ze,d as G,k as et,l as tt,P as Re,m as st,n as at,o as rt,p as lt,C as nt,q as ot,r as Ee,s as X,D as ke,t as le,T as be,E as ye,u as it,f as ct,g as dt,I as je,v as we,w as mt,F as ut,x as ve,Z as Ne,c as Se,y as xt,h as ht,z as gt,G as pt,J as ft}from"./icons-vendor-YN3v5u9K.js";import"./ui-utils-vendor-BNe0Xlio.js";const bt=()=>"/api",Ae=bt(),ce=()=>localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token"),yt=()=>{let d=localStorage.getItem("excelmind_client_id");return d||(d=`client_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("excelmind_client_id",d)),d},ne=async(d,t,s)=>{var l,c;const a=`${Ae}/v2/ai/smart-process${t}`,i=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{P.debug("[smartProcessApi] Sending request",{method:d,endpoint:t,requestId:i});const r=await fetch(a,{method:d,headers:{"Content-Type":"application/json","X-Client-ID":yt(),"X-Request-ID":i,...ce()&&{Authorization:`Bearer ${ce()}`}},...s&&{body:JSON.stringify(s)}}),o=await r.json();if(!r.ok)throw new Error(((l=o.error)==null?void 0:l.message)||o.message||"APIè°ƒç”¨å¤±è´¥");if(!o.success)throw new Error(((c=o.error)==null?void 0:c.message)||"æ“ä½œå¤±è´¥");return P.debug("[smartProcessApi] Request successful",{method:d,endpoint:t,requestId:i}),o.data}catch(r){throw P.error("[smartProcessApi] Request failed",{method:d,endpoint:t,requestId:i,error:r instanceof Error?r.message:"Unknown error"}),r}},Y={async execute(d){try{P.info("[smartProcessApi] Starting smart process");const t=await ne("POST","/",{command:d.command,files:d.files,options:d.options});return P.info("[smartProcessApi] Task started",{taskId:t.taskId,status:t.status}),t}catch(t){throw P.error("[smartProcessApi] Execute failed",{error:t instanceof Error?t.message:"Unknown error"}),new Error(t instanceof Error?t.message:"å¯åŠ¨æ™ºèƒ½å¤„ç†å¤±è´¥")}},async getStatus(d){try{const t=await ne("GET",`/${d}`);return P.debug("[smartProcessApi] Got task status",{taskId:d,status:t.status}),t}catch(t){throw P.error("[smartProcessApi] Get status failed",{taskId:d,error:t instanceof Error?t.message:"Unknown error"}),t}},async waitForCompletion(d,t={}){const{pollInterval:s=2e3,timeout:a=6e4,onProgress:i}=t,l=Date.now();return new Promise((c,r)=>{const o=async()=>{try{if(Date.now()-l>a){r(new Error("ä»»åŠ¡æ‰§è¡Œè¶…æ—¶"));return}const n=await this.getStatus(d);i&&i(n),n.status==="completed"&&n.result?(P.info("[smartProcessApi] Task completed",{taskId:d}),c(n.result)):n.status==="failed"?r(new Error("ä»»åŠ¡æ‰§è¡Œå¤±è´¥")):setTimeout(o,s)}catch(n){P.error("[smartProcessApi] Poll failed",{taskId:d,error:n instanceof Error?n.message:"Unknown error"}),r(n)}};o()})},async cancel(d){try{const t=await ne("POST",`/${d}/cancel`);return P.info("[smartProcessApi] Task cancelled",{taskId:d}),{success:!0,message:t.message||"ä»»åŠ¡å·²å–æ¶ˆ"}}catch(t){throw P.error("[smartProcessApi] Cancel failed",{taskId:d,error:t instanceof Error?t.message:"Unknown error"}),t}},stream(d,t){const s=`${Ae}/v2/ai/smart-process/${d}/stream`,a=ce(),i=a?`?token=${encodeURIComponent(a)}`:"",l=new EventSource(s+i);return l.addEventListener("progress",c=>{var r;try{const o=JSON.parse(c.data);(r=t.onProgress)==null||r.call(t,o)}catch(o){P.error("[smartProcessApi] Failed to parse progress event",{taskId:d,error:o})}}),l.addEventListener("log",c=>{var r;try{const o=JSON.parse(c.data);(r=t.onLog)==null||r.call(t,o)}catch(o){P.error("[smartProcessApi] Failed to parse log event",{taskId:d,error:o})}}),l.addEventListener("complete",c=>{var r;try{const o=JSON.parse(c.data);(r=t.onComplete)==null||r.call(t,o),l.close()}catch(o){P.error("[smartProcessApi] Failed to parse complete event",{taskId:d,error:o})}}),l.addEventListener("error",c=>{var r;try{const o=JSON.parse(c.data);(r=t.onError)==null||r.call(t,o)}catch(o){P.error("[smartProcessApi] Failed to parse error event",{taskId:d,error:o})}l.close()}),l.onerror=c=>{var r;P.error("[smartProcessApi] EventSource error",{taskId:d,error:c}),(r=t.onError)==null||r.call(t,{code:"STREAM_ERROR",message:"å®æ—¶è¿æ¥ä¸­æ–­"})},P.info("[smartProcessApi] Started streaming",{taskId:d}),l}},jt=({currentMode:d,onModeChange:t,disabled:s=!1})=>e.jsxs("div",{className:"flex items-center gap-2 bg-slate-100 rounded-lg p-1",children:[e.jsxs("button",{onClick:()=>t("processing"),disabled:s,className:`
          flex items-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-all
          ${d==="processing"?"bg-white text-emerald-700 shadow-sm":"text-slate-600 hover:bg-slate-200"}
          ${s?"opacity-50 cursor-not-allowed":""}
        `,title:"æ•°æ®å¤„ç†æ¨¡å¼ï¼šä½¿ç”¨AIè¿›è¡Œæ•°æ®è½¬æ¢ã€åˆå¹¶ç­‰æ“ä½œ",children:[e.jsx(Ye,{className:"w-4 h-4"}),"æ•°æ®å¤„ç†æ¨¡å¼"]}),e.jsxs("button",{onClick:()=>t("quality"),disabled:s,className:`
          flex items-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-all
          ${d==="quality"?"bg-white text-blue-700 shadow-sm":"text-slate-600 hover:bg-slate-200"}
          ${s?"opacity-50 cursor-not-allowed":""}
        `,title:"è´¨é‡æ£€æŸ¥æ¨¡å¼ï¼šä½¿ç”¨è§„åˆ™æ£€æŸ¥æ•°æ®è´¨é‡",children:[e.jsx(ie,{className:"w-4 h-4"}),"è´¨é‡æ£€æŸ¥æ¨¡å¼"]})]}),Ce="excelmind_quality_rules",$e="excelmind_rule_usage_stats",oe=[{id:"official-email-format",name:"é‚®ç®±æ ¼å¼æ£€æŸ¥",description:'æ£€æŸ¥æ‰€æœ‰åŒ…å«"é‚®ç®±"æˆ–"email"çš„åˆ—ï¼Œç¡®ä¿é‚®ç®±æ ¼å¼æ­£ç¡®',category:"æ ¼å¼æ£€æŸ¥",checkContent:'æ£€æŸ¥æ‰€æœ‰åŒ…å«"é‚®ç®±"ã€"email"ã€"é‚®ä»¶"çš„åˆ—',criteria:"å¿…é¡»åŒ…å«@ç¬¦å·ï¼Œä¸”@åå¿…é¡»æœ‰åŸŸåï¼ˆå¦‚qq.comã€163.comã€gmail.comï¼‰",severity:"P1",executionType:"local",localRule:{type:"format",params:{pattern:"^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$"}},exampleColumns:["é‚®ç®±","email","Email","ç”µå­é‚®ä»¶","è”ç³»é‚®ç®±"]},{id:"official-phone-format",name:"æ‰‹æœºå·æ ¼å¼æ£€æŸ¥",description:"æ£€æŸ¥æ‰‹æœºå·åˆ—ï¼Œç¡®ä¿æ ¼å¼ä¸ºä¸­å›½å¤§é™†æ‰‹æœºå·",category:"æ ¼å¼æ£€æŸ¥",checkContent:'æ£€æŸ¥æ‰€æœ‰åŒ…å«"ç”µè¯"ã€"æ‰‹æœº"ã€"phone"ã€"tel"çš„åˆ—',criteria:"å¿…é¡»ä¸º11ä½æ•°å­—ï¼Œä¸”ä»¥1å¼€å¤´ï¼Œç¬¬äºŒä½ä¸º3-9",severity:"P1",executionType:"local",localRule:{type:"format",params:{pattern:"^1[3-9]\\d{9}$"}},exampleColumns:["æ‰‹æœºå·","ç”µè¯","phone","Phone","è”ç³»ç”µè¯","æ‰‹æœº"]},{id:"official-required-fields",name:"å¿…å¡«å­—æ®µæ£€æŸ¥",description:"æ£€æŸ¥å…³é”®ä¸šåŠ¡å­—æ®µï¼Œç¡®ä¿ä¸èƒ½ä¸ºç©º",category:"å®Œæ•´æ€§æ£€æŸ¥",checkContent:"æ£€æŸ¥å…³é”®ä¸šåŠ¡å­—æ®µï¼ˆå¦‚å§“åã€èº«ä»½è¯ã€è®¢å•å·ã€é‡‘é¢ç­‰ï¼‰",criteria:"å­—æ®µå€¼ä¸èƒ½ä¸ºç©ºã€nullã€ç©ºå­—ç¬¦ä¸²æˆ–ä»…åŒ…å«ç©ºç™½å­—ç¬¦",severity:"P0",executionType:"local",localRule:{type:"not_null",params:{}},exampleColumns:["å§“å","èº«ä»½è¯å·","è®¢å•å·","é‡‘é¢","äº§å“åç§°"]},{id:"official-age-range",name:"å¹´é¾„èŒƒå›´æ£€æŸ¥",description:"æ£€æŸ¥å¹´é¾„å­—æ®µæ˜¯å¦åœ¨åˆç†èŒƒå›´å†…",category:"åˆç†æ€§æ£€æŸ¥",checkContent:'æ£€æŸ¥åŒ…å«"å¹´é¾„"çš„åˆ—',criteria:"å¹´é¾„å¿…é¡»åœ¨18-65å²ä¹‹é—´ï¼ˆé€‚ç”¨äºèŒåœºæ•°æ®ï¼‰",severity:"P1",executionType:"local",localRule:{type:"range",params:{min:18,max:65}},exampleColumns:["å¹´é¾„","Age","å‘˜å·¥å¹´é¾„"]},{id:"official-id-card-format",name:"èº«ä»½è¯å·æ ¼å¼æ£€æŸ¥",description:"æ£€æŸ¥ä¸­å›½å¤§é™†èº«ä»½è¯å·æ ¼å¼æ˜¯å¦æ­£ç¡®",category:"æ ¼å¼æ£€æŸ¥",checkContent:'æ£€æŸ¥åŒ…å«"èº«ä»½è¯"ã€"id"çš„åˆ—',criteria:"å¿…é¡»ä¸º18ä½æ•°å­—ï¼Œæˆ–17ä½æ•°å­—+X/xï¼ˆæœ€åä¸€ä½ä¸ºæ ¡éªŒä½ï¼‰",severity:"P0",executionType:"local",localRule:{type:"format",params:{pattern:"^[1-9]\\d{5}(18|19|20)\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])\\d{3}[\\dXx]$"}},exampleColumns:["èº«ä»½è¯å·","èº«ä»½è¯","id_card","IdCard"]},{id:"official-amount-non-negative",name:"é‡‘é¢éè´Ÿæ£€æŸ¥",description:"æ£€æŸ¥é‡‘é¢å­—æ®µï¼Œç¡®ä¿é‡‘é¢ä¸ä¸ºè´Ÿæ•°",category:"åˆç†æ€§æ£€æŸ¥",checkContent:'æ£€æŸ¥æ‰€æœ‰åŒ…å«"é‡‘é¢"ã€"ä»·æ ¼"ã€"price"ã€"amount"çš„åˆ—',criteria:"é‡‘é¢å¿…é¡»å¤§äºæˆ–ç­‰äº0",severity:"P0",executionType:"local",localRule:{type:"range",params:{min:0}},exampleColumns:["é‡‘é¢","ä»·æ ¼","Price","Amount","å•ä»·","æ€»ä»·","é”€å”®é¢"]},{id:"official-unique-check",name:"é‡å¤å€¼æ£€æŸ¥",description:"æ£€æŸ¥å”¯ä¸€æ€§å­—æ®µï¼Œç¡®ä¿æ²¡æœ‰é‡å¤å€¼",category:"å”¯ä¸€æ€§æ£€æŸ¥",checkContent:"æ£€æŸ¥å”¯ä¸€æ€§å­—æ®µï¼ˆå¦‚è®¢å•å·ã€IDã€å·¥å·ç­‰ï¼‰",criteria:"å­—æ®µå€¼ä¸èƒ½æœ‰é‡å¤ï¼Œæ¯ä¸ªå€¼åªèƒ½å‡ºç°ä¸€æ¬¡",severity:"P0",executionType:"local",localRule:{type:"unique",params:{}},exampleColumns:["è®¢å•å·","ID","å·¥å·","å­¦å·","äº§å“ç¼–å·"]},{id:"official-date-range",name:"æ—¥æœŸåˆç†æ€§æ£€æŸ¥",description:"æ£€æŸ¥æ—¥æœŸå­—æ®µæ˜¯å¦åœ¨åˆç†èŒƒå›´å†…",category:"åˆç†æ€§æ£€æŸ¥",checkContent:"æ£€æŸ¥æ‰€æœ‰æ—¥æœŸç±»å‹çš„åˆ—",criteria:"æ—¥æœŸå¿…é¡»åœ¨1900-01-01åˆ°å½“å‰å¹´ä»½+1ä¹‹é—´",severity:"P2",executionType:"local",localRule:{type:"range",params:{min:new Date("1900-01-01").getTime(),max:new Date().setFullYear(new Date().getFullYear()+1)}},exampleColumns:["æ—¥æœŸ","Date","å‡ºç”Ÿæ—¥æœŸ","å…¥èŒæ—¥æœŸ","è®¢å•æ—¥æœŸ"]},{id:"official-text-length",name:"æ•°æ®é•¿åº¦æ£€æŸ¥",description:"æ£€æŸ¥æ–‡æœ¬å­—æ®µé•¿åº¦ï¼Œé˜²æ­¢è¶…é•¿æ•°æ®",category:"æ ¼å¼æ£€æŸ¥",checkContent:"æ£€æŸ¥æ–‡æœ¬å­—æ®µçš„é•¿åº¦",criteria:"æ–‡æœ¬é•¿åº¦ä¸èƒ½è¶…è¿‡å­—æ®µé™åˆ¶ï¼ˆé»˜è®¤50å­—ç¬¦ï¼‰",severity:"P2",executionType:"local",localRule:{type:"custom",params:{maxLength:50}},exampleColumns:["å§“å","äº§å“åç§°","å¤‡æ³¨","æè¿°"]},{id:"official-custom-business-rule",name:"ä¸šåŠ¡è§„åˆ™è‡ªå®šä¹‰æ£€æŸ¥",description:"ä½¿ç”¨AIè¿›è¡Œè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘æ£€æŸ¥",category:"ä¸šåŠ¡è§„åˆ™",checkContent:"ç”¨æˆ·è‡ªå®šä¹‰çš„ä¸šåŠ¡é€»è¾‘æè¿°",criteria:"ç”¨æˆ·è‡ªå®šä¹‰çš„è¯„åˆ¤æ ‡å‡†",severity:"P1",executionType:"ai",localRule:void 0,exampleColumns:[]}];class wt{constructor(){this.rules=new Map,this.usageStats=new Map,this.loadFromStorage()}loadFromStorage(){try{const t=localStorage.getItem(Ce);t&&JSON.parse(t).forEach(i=>{this.rules.set(i.id,i)});const s=localStorage.getItem($e);if(s){const a=JSON.parse(s);this.usageStats=new Map(Object.entries(a))}this.rules.size===0&&this.initializeOfficialRules()}catch(t){console.error("åŠ è½½è§„åˆ™æ•°æ®å¤±è´¥:",t),this.initializeOfficialRules()}}saveToStorage(){try{const t=Array.from(this.rules.values());localStorage.setItem(Ce,JSON.stringify(t));const s=Object.fromEntries(this.usageStats);localStorage.setItem($e,JSON.stringify(s))}catch(t){console.error("ä¿å­˜è§„åˆ™æ•°æ®å¤±è´¥:",t)}}initializeOfficialRules(){oe.forEach(t=>{const s={id:t.id,name:t.name,description:t.description,category:t.category,checkContent:t.checkContent,criteria:t.criteria,severity:t.severity,executionType:t.executionType,localRule:t.localRule,targetColumns:t.exampleColumns,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),usageCount:0,isOfficial:!0,isEnabled:!0};this.rules.set(s.id,s)}),this.saveToStorage()}generateId(){return`rule_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async saveRule(t){var i,l;const s=new Date().toISOString(),a={...t,id:t.id||this.generateId(),createdAt:t.id&&((i=this.rules.get(t.id))==null?void 0:i.createdAt)||s,updatedAt:s,usageCount:t.id&&((l=this.rules.get(t.id))==null?void 0:l.usageCount)||0};return this.rules.set(a.id,a),this.saveToStorage(),a}async getRule(t){return this.rules.get(t)||null}async listRules(t){let s=Array.from(this.rules.values());if(t&&(t.category&&(s=s.filter(a=>a.category===t.category)),t.severity&&(s=s.filter(a=>a.severity===t.severity)),t.executionType&&(s=s.filter(a=>a.executionType===t.executionType)),t.isOfficial!==void 0&&(s=s.filter(a=>a.isOfficial===t.isOfficial)),t.isEnabled!==void 0&&(s=s.filter(a=>a.isEnabled===t.isEnabled)),t.searchTerm)){const a=t.searchTerm.toLowerCase();s=s.filter(i=>i.name.toLowerCase().includes(a)||i.description.toLowerCase().includes(a)||i.category.toLowerCase().includes(a))}return s.sort((a,i)=>a.isOfficial!==i.isOfficial?a.isOfficial?-1:1:i.usageCount-a.usageCount)}async deleteRule(t){if(!this.rules.has(t))throw new Error(`è§„åˆ™ä¸å­˜åœ¨: ${t}`);if(this.rules.get(t).isOfficial)throw new Error("ä¸èƒ½åˆ é™¤å®˜æ–¹è§„åˆ™ï¼Œå¯ä»¥ç¦ç”¨");this.rules.delete(t),this.usageStats.delete(t),this.saveToStorage()}async toggleRule(t){const s=this.rules.get(t);if(!s)throw new Error(`è§„åˆ™ä¸å­˜åœ¨: ${t}`);return s.isEnabled=!s.isEnabled,s.updatedAt=new Date().toISOString(),this.saveToStorage(),s}async incrementUsage(t){const s=this.rules.get(t);s&&(s.usageCount++,this.saveToStorage())}async getOfficialRules(){return Array.from(this.rules.values()).filter(t=>t.isOfficial)}async getCustomRules(){return Array.from(this.rules.values()).filter(t=>!t.isOfficial)}async getStatistics(){const t=Array.from(this.rules.values()),s={},a={P0:0,P1:0,P2:0,P3:0};t.forEach(l=>{s[l.category]=(s[l.category]||0)+1,a[l.severity]++});const i=t.sort((l,c)=>c.usageCount-l.usageCount).slice(0,5).map(l=>({ruleId:l.id,name:l.name,usageCount:l.usageCount}));return{totalRules:t.length,officialRules:t.filter(l=>l.isOfficial).length,customRules:t.filter(l=>!l.isOfficial).length,enabledRules:t.filter(l=>l.isEnabled).length,rulesByCategory:s,rulesBySeverity:a,mostUsedRules:i}}async getTemplates(){return oe}async createFromTemplate(t,s){const a=oe.find(l=>l.id===t);if(!a)throw new Error(`æ¨¡æ¿ä¸å­˜åœ¨: ${t}`);const i={name:s.name||a.name,description:s.description||a.description,category:s.category||a.category,checkContent:s.checkContent||a.checkContent,criteria:s.criteria||a.criteria,severity:s.severity||a.severity,executionType:s.executionType||a.executionType,localRule:s.localRule||a.localRule,targetColumns:s.targetColumns||a.exampleColumns,isOfficial:!1,isEnabled:!0};return this.saveRule(i)}async exportRules(t){const s=t?t.map(a=>this.rules.get(a)).filter(Boolean):Array.from(this.rules.values());return JSON.stringify(s,null,2)}async importRules(t,s=!1){const a=JSON.parse(t);let i=0;for(const l of a){const c=this.rules.get(l.id);c?s&&(l.usageCount=c.usageCount,this.rules.set(l.id,l),i++):(l.id=this.generateId(),l.usageCount=0,this.rules.set(l.id,l),i++)}return this.saveToStorage(),i}async resetToDefault(){this.rules.clear(),this.usageStats.clear(),this.initializeOfficialRules()}async clearCustomRules(){Array.from(this.rules.values()).filter(s=>!s.isOfficial).map(s=>s.id).forEach(s=>{this.rules.delete(s),this.usageStats.delete(s)}),this.saveToStorage()}}const K=new wt,vt=({rule:d,onClose:t,onSave:s})=>{const[a,i]=w.useState(d?2:1),[l,c]=w.useState(null),[r,o]=w.useState(!1),[n,x]=w.useState({name:"",description:"",category:"",checkContent:"",criteria:"",severity:"P1",executionType:"ai",targetColumns:[],isEnabled:!0,isOfficial:!1,localRule:void 0}),[p,j]=w.useState([]);w.useEffect(()=>{S(),d&&(x({...d,targetColumns:Array.isArray(d.targetColumns)?[...d.targetColumns]:[]}),o(!1))},[d]);const S=async()=>{const b=await K.getTemplates();j(b)},R=()=>{a<5&&i(a+1)},v=()=>{a>1&&i(a-1)},I=async()=>{try{if(d){const b={...n,id:d.id,createdAt:d.createdAt,updatedAt:new Date().toISOString(),usageCount:d.usageCount};await K.saveRule(b)}else r&&l?await K.createFromTemplate(l,n):await K.saveRule(n);s()}catch(b){console.error("ä¿å­˜è§„åˆ™å¤±è´¥:",b),alert(`ä¿å­˜å¤±è´¥: ${b instanceof Error?b.message:"æœªçŸ¥é”™è¯¯"}`)}},_=()=>{switch(a){case 1:return d?!0:r?l!==null:!0;case 2:return n.name&&n.description&&n.category;case 3:return!0;case 4:return n.checkContent&&n.criteria;case 5:return!0;default:return!1}},O=(b,F)=>{x(J=>({...J,[b]:F}))},f=()=>{switch(a){case 1:return N();case 2:return D();case 3:return B();case 4:return q();case 5:return U()}},N=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:d?"ç¼–è¾‘è§„åˆ™":"é€‰æ‹©åˆ›å»ºæ–¹å¼"}),d&&e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 mb-2",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{className:"font-semibold",children:"æ­£åœ¨ç¼–è¾‘è§„åˆ™"})]}),e.jsxs("div",{className:"text-sm text-blue-700 space-y-1",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"åç§°ï¼š"}),d.name]}),e.jsxs("div",{children:[e.jsx("strong",{children:"åˆ†ç±»ï¼š"}),d.category]}),e.jsxs("div",{children:[e.jsx("strong",{children:"æè¿°ï¼š"}),d.description]})]}),e.jsx("p",{className:"text-xs text-blue-600 mt-2",children:'ç‚¹å‡»"ä¸‹ä¸€æ­¥"å¯ä¿®æ”¹è§„åˆ™çš„æ‰€æœ‰å†…å®¹'})]}),!d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:()=>{var b;o(!0),c(((b=p[0])==null?void 0:b.id)||null)},className:`w-full p-4 rounded-lg border-2 text-left transition-all ${r?"border-emerald-500 bg-emerald-50":"border-slate-200 hover:border-emerald-300"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-slate-800",children:"ä»æ¨¡æ¿åˆ›å»º"}),r&&e.jsx(G,{className:"w-5 h-5 text-emerald-600"})]}),e.jsx("p",{className:"text-sm text-slate-600",children:"åŸºäºå®˜æ–¹æ¨¡æ¿å¿«é€Ÿåˆ›å»ºè§„åˆ™ï¼Œç„¶åè‡ªå®šä¹‰ä¿®æ”¹"})]}),e.jsxs("button",{onClick:()=>o(!1),className:`w-full p-4 rounded-lg border-2 text-left transition-all ${r?"border-slate-200 hover:border-blue-300":"border-blue-500 bg-blue-50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-semibold text-slate-800",children:"è‡ªå®šä¹‰åˆ›å»º"}),!r&&e.jsx(G,{className:"w-5 h-5 text-blue-600"})]}),e.jsx("p",{className:"text-sm text-slate-600",children:"å®Œå…¨è‡ªå®šä¹‰è§„åˆ™ï¼Œé€‚ç”¨äºç‰¹æ®Šä¸šåŠ¡éœ€æ±‚"})]})]}),r&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"é€‰æ‹©æ¨¡æ¿"}),e.jsxs("select",{value:l||"",onChange:b=>c(b.target.value),className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none",children:[e.jsx("option",{value:"",children:"è¯·é€‰æ‹©æ¨¡æ¿..."}),p.map(b=>e.jsx("option",{value:b.id,children:b.name},b.id))]})]})]})]}),D=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"åŸºæœ¬ä¿¡æ¯"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"è§„åˆ™åç§° *"}),e.jsx("input",{type:"text",value:n.name||"",onChange:b=>O("name",b.target.value),placeholder:"ä¾‹å¦‚ï¼šé‚®ç®±æ ¼å¼æ£€æŸ¥",className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"è§„åˆ™æè¿° *"}),e.jsx("textarea",{value:n.description||"",onChange:b=>O("description",b.target.value),placeholder:"ç®€è¦æè¿°è¿™ä¸ªè§„åˆ™çš„ä½œç”¨...",rows:3,className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"è§„åˆ™åˆ†ç±» *"}),e.jsxs("select",{value:n.category||"",onChange:b=>O("category",b.target.value),className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none",children:[e.jsx("option",{value:"",children:"è¯·é€‰æ‹©åˆ†ç±»..."}),e.jsx("option",{value:"æ ¼å¼æ£€æŸ¥",children:"æ ¼å¼æ£€æŸ¥"}),e.jsx("option",{value:"å®Œæ•´æ€§æ£€æŸ¥",children:"å®Œæ•´æ€§æ£€æŸ¥"}),e.jsx("option",{value:"ä¸€è‡´æ€§æ£€æŸ¥",children:"ä¸€è‡´æ€§æ£€æŸ¥"}),e.jsx("option",{value:"åˆç†æ€§æ£€æŸ¥",children:"åˆç†æ€§æ£€æŸ¥"}),e.jsx("option",{value:"å”¯ä¸€æ€§æ£€æŸ¥",children:"å”¯ä¸€æ€§æ£€æŸ¥"}),e.jsx("option",{value:"ä¸šåŠ¡è§„åˆ™",children:"ä¸šåŠ¡è§„åˆ™"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"ä¸¥é‡çº§åˆ«"}),e.jsx("div",{className:"flex gap-2",children:["P0","P1","P2","P3"].map(b=>e.jsx("button",{onClick:()=>O("severity",b),className:`px-4 py-2 rounded-lg font-medium transition-all ${n.severity===b?b==="P0"?"bg-red-100 text-red-700 border-2 border-red-300":b==="P1"?"bg-orange-100 text-orange-700 border-2 border-orange-300":b==="P2"?"bg-yellow-100 text-yellow-700 border-2 border-yellow-300":"bg-blue-100 text-blue-700 border-2 border-blue-300":"bg-slate-100 text-slate-600 border-2 border-transparent hover:border-slate-300"}`,children:b},b))}),e.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:[n.severity==="P0"&&"é˜»å¡é—®é¢˜ï¼šå¿…é¡»ä¿®å¤",n.severity==="P1"&&"ä¸¥é‡é—®é¢˜ï¼šåº”è¯¥ä¿®å¤",n.severity==="P2"&&"ä¸€èˆ¬é—®é¢˜ï¼šå»ºè®®ä¿®å¤",n.severity==="P3"&&"æç¤ºæ€§é—®é¢˜ï¼šå¯é€‰ä¿®å¤"]})]})]}),B=()=>{var b;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"é€‰æ‹©ç›®æ ‡åˆ—"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"ç›®æ ‡åˆ—åï¼ˆç”¨é€—å·åˆ†éš”ï¼‰"}),e.jsx("textarea",{value:((b=n.targetColumns)==null?void 0:b.join(", "))||"",onChange:F=>O("targetColumns",F.target.value.split(/[,ï¼Œ]/).map(J=>J.trim()).filter(Boolean)),placeholder:"ä¾‹å¦‚ï¼šé‚®ç®±, æ‰‹æœºå·, è”ç³»ç”µè¯",rows:3,className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"å¦‚æœç•™ç©ºï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹åŒ…å«å…³é”®å­—çš„åˆ—"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"æ‰§è¡Œæ–¹å¼"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>O("executionType","local"),className:`w-full p-3 rounded-lg border-2 text-left transition-all ${n.executionType==="local"?"border-emerald-500 bg-emerald-50":"border-slate-200 hover:border-emerald-300"}`,children:[e.jsx("div",{className:"font-semibold text-slate-800 mb-1",children:"æœ¬åœ°æ‰§è¡Œ"}),e.jsx("div",{className:"text-sm text-slate-600",children:"å¿«é€Ÿã€å…è´¹ï¼Œé€‚åˆæ ‡å‡†åŒ–æ£€æŸ¥"})]}),e.jsxs("button",{onClick:()=>O("executionType","ai"),className:`w-full p-3 rounded-lg border-2 text-left transition-all ${n.executionType==="ai"?"border-blue-500 bg-blue-50":"border-slate-200 hover:border-blue-300"}`,children:[e.jsx("div",{className:"font-semibold text-slate-800 mb-1",children:"AIæ‰§è¡Œ"}),e.jsx("div",{className:"text-sm text-slate-600",children:"çµæ´»ã€æœ‰æˆæœ¬ï¼Œé€‚åˆå¤æ‚ä¸šåŠ¡é€»è¾‘"})]})]})]})]})},q=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"å®šä¹‰è§„åˆ™å†…å®¹"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"æ£€æŸ¥å†…å®¹ *"}),e.jsx("textarea",{value:n.checkContent||"",onChange:b=>O("checkContent",b.target.value),placeholder:"ä¾‹å¦‚ï¼šæ£€æŸ¥æ‰€æœ‰åŒ…å«'é‚®ç®±'çš„åˆ—",rows:3,className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"ç”¨è‡ªç„¶è¯­è¨€æè¿°è¦æ£€æŸ¥ä»€ä¹ˆ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"è¯„åˆ¤æ ‡å‡† *"}),e.jsx("textarea",{value:n.criteria||"",onChange:b=>O("criteria",b.target.value),placeholder:"ä¾‹å¦‚ï¼šå¿…é¡»åŒ…å«@ç¬¦å·ï¼Œä¸”@åå¿…é¡»æœ‰åŸŸå",rows:3,className:"w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"ç”¨è‡ªç„¶è¯­è¨€æè¿°ä»€ä¹ˆæ ·çš„æ•°æ®æ˜¯åˆæ ¼çš„"})]}),n.executionType==="local"&&e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx("div",{className:"text-sm font-medium text-blue-800 mb-1",children:"æœ¬åœ°æ‰§è¡Œéœ€è¦é…ç½®"}),e.jsx("p",{className:"text-xs text-blue-600",children:"æœ¬åœ°æ‰§è¡Œéœ€è¦åœ¨ä¸‹ä¸€æ­¥ä¸­é…ç½®å…·ä½“çš„æ£€æŸ¥é€»è¾‘ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ã€èŒƒå›´ç­‰ï¼‰"})]})]}),U=()=>{var b;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"ç¡®è®¤å¹¶æµ‹è¯•"}),e.jsxs("div",{className:"p-4 bg-slate-50 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"è§„åˆ™åç§°ï¼š"}),e.jsx("span",{className:"text-sm text-slate-800 ml-2",children:n.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"åˆ†ç±»ï¼š"}),e.jsx("span",{className:"text-sm text-slate-800 ml-2",children:n.category})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"ä¸¥é‡çº§åˆ«ï¼š"}),e.jsx("span",{className:`text-sm ml-2 px-2 py-0.5 rounded ${n.severity==="P0"?"bg-red-100 text-red-700":n.severity==="P1"?"bg-orange-100 text-orange-700":n.severity==="P2"?"bg-yellow-100 text-yellow-700":"bg-blue-100 text-blue-700"}`,children:n.severity})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"æ‰§è¡Œæ–¹å¼ï¼š"}),e.jsx("span",{className:"text-sm text-slate-800 ml-2",children:n.executionType==="local"?"æœ¬åœ°æ‰§è¡Œ":"AIæ‰§è¡Œ"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"ç›®æ ‡åˆ—ï¼š"}),e.jsx("span",{className:"text-sm text-slate-800 ml-2",children:(b=n.targetColumns)!=null&&b.length?n.targetColumns.join(", "):"è‡ªåŠ¨æ£€æµ‹"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"æ£€æŸ¥å†…å®¹ï¼š"}),e.jsx("p",{className:"text-sm text-slate-800 mt-1",children:n.checkContent})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"è¯„åˆ¤æ ‡å‡†ï¼š"}),e.jsx("p",{className:"text-sm text-slate-800 mt-1",children:n.criteria})]})]}),e.jsxs("div",{className:"p-4 bg-emerald-50 rounded-lg border border-emerald-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 mb-1",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{className:"font-semibold",children:"å‡†å¤‡å°±ç»ª"})]}),e.jsx("p",{className:"text-sm text-emerald-700",children:'ç‚¹å‡»"å®Œæˆ"åˆ›å»ºè§„åˆ™ï¼Œåˆ›å»ºåå¯ä»¥åœ¨è§„åˆ™åˆ—è¡¨ä¸­å¯ç”¨å¹¶æ‰§è¡Œ'})]})]})};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-800",children:d?"ç¼–è¾‘è§„åˆ™":"åˆ›å»ºæ–°è§„åˆ™"}),d&&e.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:["æ­£åœ¨ç¼–è¾‘ï¼š",d.name]})]}),e.jsx("button",{onClick:t,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:e.jsx(Ze,{className:"w-5 h-5 text-slate-500"})})]}),e.jsxs("div",{className:"px-6 py-4 bg-slate-50 border-b border-slate-200",children:[e.jsx("div",{className:"flex items-center justify-between",children:[1,2,3,4,5].map(b=>e.jsxs(Ke.Fragment,{children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full font-semibold text-sm transition-all ${b===a?"bg-emerald-600 text-white":b<a?"bg-emerald-100 text-emerald-700":"bg-slate-200 text-slate-500"}`,children:b<a?e.jsx(G,{className:"w-4 h-4"}):b}),b<5&&e.jsx("div",{className:`flex-1 h-1 mx-2 rounded ${b<a?"bg-emerald-600":"bg-slate-200"}`})]},b))}),e.jsxs("div",{className:"flex justify-between mt-2 text-xs text-slate-600",children:[e.jsx("span",{children:"æ–¹å¼"}),e.jsx("span",{children:"åŸºæœ¬ä¿¡æ¯"}),e.jsx("span",{children:"ç›®æ ‡åˆ—"}),e.jsx("span",{children:"è§„åˆ™å†…å®¹"}),e.jsx("span",{children:"ç¡®è®¤"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:f()}),e.jsxs("div",{className:"flex items-center justify-between p-4 border-t border-slate-200 bg-slate-50",children:[e.jsxs("button",{onClick:v,disabled:a===1,className:"flex items-center gap-2 px-4 py-2 text-slate-700 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(et,{className:"w-4 h-4"}),"ä¸Šä¸€æ­¥"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:t,className:"px-4 py-2 text-slate-700 hover:bg-slate-100 rounded-lg transition-colors",children:"å–æ¶ˆ"}),a<5?e.jsxs("button",{onClick:R,disabled:!_(),className:"flex items-center gap-2 px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium",children:["ä¸‹ä¸€æ­¥",e.jsx(tt,{className:"w-4 h-4"})]}):e.jsxs("button",{onClick:I,className:"flex items-center gap-2 px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium",children:[e.jsx(G,{className:"w-4 h-4"}),"å®Œæˆ"]})]})]})]})})},Nt=({onRulesChange:d,onExecuteRules:t,executing:s=!1})=>{const[a,i]=w.useState([]),[l,c]=w.useState([]),[r,o]=w.useState({}),[n,x]=w.useState(!1),[p,j]=w.useState(null),[S,R]=w.useState(""),[v,I]=w.useState(""),[_,O]=w.useState("");w.useEffect(()=>{f()},[]),w.useEffect(()=>{N()},[a,r,S,v,_]);const f=async()=>{const h=await K.listRules();i(h),d==null||d(h)},N=()=>{let h=[...a];if(S){const A=S.toLowerCase();h=h.filter(Q=>Q.name.toLowerCase().includes(A)||Q.description.toLowerCase().includes(A))}v&&(h=h.filter(A=>A.category===v)),_&&(h=h.filter(A=>A.severity===_)),r.isEnabled!==void 0&&(h=h.filter(A=>A.isEnabled===r.isEnabled)),r.isOfficial!==void 0&&(h=h.filter(A=>A.isOfficial===r.isOfficial)),c(h)},D=async h=>{try{await K.toggleRule(h),await f()}catch(A){console.error("åˆ‡æ¢è§„åˆ™å¤±è´¥:",A),alert(`åˆ‡æ¢è§„åˆ™å¤±è´¥: ${A instanceof Error?A.message:"æœªçŸ¥é”™è¯¯"}`)}},B=async h=>{if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§„åˆ™å—ï¼Ÿ"))try{await K.deleteRule(h),await f()}catch(A){console.error("åˆ é™¤è§„åˆ™å¤±è´¥:",A),alert(`åˆ é™¤è§„åˆ™å¤±è´¥: ${A instanceof Error?A.message:"æœªçŸ¥é”™è¯¯"}`)}},q=h=>{j(h),x(!0)},U=h=>{switch(h){case"P0":return"text-red-600 bg-red-50 border-red-200";case"P1":return"text-orange-600 bg-orange-50 border-orange-200";case"P2":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"P3":return"text-blue-600 bg-blue-50 border-blue-200"}},b=h=>{switch(h){case"local":return"æœ¬åœ°";case"ai":return"AI";case"hybrid":return"æ··åˆ";default:return h}},F=Array.from(new Set(a.map(h=>h.category))),J=l.filter(h=>h.isEnabled).length;return e.jsxs("div",{className:"h-full flex flex-col bg-white",children:[e.jsxs("div",{className:"p-4 border-b border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"è´¨é‡è§„åˆ™"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-slate-500",children:["å·²å¯ç”¨ ",J," / ",l.length]}),e.jsxs("button",{onClick:()=>{j(null),x(!0)},className:"flex items-center gap-1 px-3 py-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm font-medium transition-colors",children:[e.jsx(Re,{className:"w-4 h-4"}),"æ–°å»ºè§„åˆ™"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(st,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"æœç´¢è§„åˆ™...",value:S,onChange:h=>R(h.target.value),className:"w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none"})]}),e.jsxs("select",{value:v,onChange:h=>I(h.target.value),className:"px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none",children:[e.jsx("option",{value:"",children:"æ‰€æœ‰åˆ†ç±»"}),F.map(h=>e.jsx("option",{value:h,children:h},h))]}),e.jsxs("select",{value:_,onChange:h=>O(h.target.value),className:"px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none",children:[e.jsx("option",{value:"",children:"æ‰€æœ‰çº§åˆ«"}),e.jsx("option",{value:"P0",children:"P0 - é˜»å¡"}),e.jsx("option",{value:"P1",children:"P1 - ä¸¥é‡"}),e.jsx("option",{value:"P2",children:"P2 - ä¸€èˆ¬"}),e.jsx("option",{value:"P3",children:"P3 - æç¤º"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("button",{onClick:()=>o({...r,isEnabled:!0}),className:`px-2 py-1 rounded ${r.isEnabled===!0?"bg-emerald-100 text-emerald-700":"text-slate-500 hover:bg-slate-100"}`,children:"å·²å¯ç”¨"}),e.jsx("button",{onClick:()=>o({...r,isOfficial:!0}),className:`px-2 py-1 rounded ${r.isOfficial===!0?"bg-blue-100 text-blue-700":"text-slate-500 hover:bg-slate-100"}`,children:"å®˜æ–¹æ¨¡æ¿"}),e.jsx("button",{onClick:()=>o({}),className:`px-2 py-1 rounded ${Object.keys(r).length===0?"bg-slate-200 text-slate-700":"text-slate-500 hover:bg-slate-100"}`,children:"å…¨éƒ¨"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:l.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-400",children:[e.jsx("p",{children:"æ²¡æœ‰æ‰¾åˆ°è§„åˆ™"}),e.jsx("p",{className:"text-xs mt-1",children:'ç‚¹å‡»"æ–°å»ºè§„åˆ™"åˆ›å»ºç¬¬ä¸€ä¸ªè§„åˆ™'})]}):e.jsx("div",{className:"space-y-2",children:l.map(h=>e.jsx("div",{className:`p-3 rounded-lg border transition-all ${h.isEnabled?"bg-white border-slate-200 hover:border-emerald-300":"bg-slate-50 border-slate-200 opacity-60"}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx("button",{onClick:()=>D(h.id),disabled:s,className:"mt-1",children:h.isEnabled?e.jsx(at,{className:"w-5 h-5 text-emerald-600"}):e.jsx(rt,{className:"w-5 h-5 text-slate-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:`font-semibold text-sm ${h.isEnabled?"text-slate-800":"text-slate-500"}`,children:h.name}),h.isOfficial&&e.jsx(lt,{className:"w-3.5 h-3.5 text-yellow-500 fill-yellow-500"}),e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium border ${U(h.severity)}`,children:h.severity}),e.jsx("span",{className:"px-2 py-0.5 rounded text-xs bg-slate-100 text-slate-600",children:b(h.executionType)})]}),e.jsx("p",{className:"text-xs text-slate-500 mb-1",children:h.description}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-slate-400",children:[e.jsx("span",{children:h.category}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(nt,{className:"w-3 h-3"}),"ä½¿ç”¨ ",h.usageCount," æ¬¡"]}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:h.targetColumns.length>0?h.targetColumns.join(", "):"è‡ªåŠ¨æ£€æµ‹"})]})]})]}),e.jsx("div",{className:"flex items-center gap-1",children:!h.isOfficial&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>q(h),disabled:s||h.isEnabled,className:"p-1.5 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded transition-colors disabled:opacity-50",title:"ç¼–è¾‘",children:e.jsx(ot,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>B(h.id),disabled:s||h.isEnabled,className:"p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors disabled:opacity-50",title:"åˆ é™¤",children:e.jsx(Ee,{className:"w-4 h-4"})})]})})]})},h.id))})}),J>0&&e.jsx("div",{className:"p-4 border-t border-slate-200 bg-slate-50",children:e.jsx("button",{onClick:()=>t==null?void 0:t(l.filter(h=>h.isEnabled)),disabled:s,className:`
              w-full py-2.5 rounded-lg font-medium text-white transition-all
              flex items-center justify-center gap-2
              ${s?"bg-slate-300 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-blue-900/20"}
            `,children:s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"æ‰§è¡Œä¸­..."]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4"}),"æ‰§è¡Œæ£€æŸ¥ (",J," æ¡è§„åˆ™)"]})})}),n&&e.jsx(vt,{rule:p,onClose:()=>{x(!1),j(null)},onSave:async()=>{await f(),x(!1),j(null)}})]})},St=({results:d,batchResult:t,data:s,onIssueClick:a,onClose:i})=>{const[l,c]=w.useState(new Set),[r,o]=w.useState("all"),[n,x]=w.useState(!0),p={total:d.length,passed:d.filter(f=>f.pass).length,failed:d.filter(f=>!f.pass).length,totalIssues:d.reduce((f,N)=>f+N.issues.length,0),totalIssueRows:d.reduce((f,N)=>f+N.issueRows,0)},j=[];d.forEach(f=>{f.issues.forEach(N=>{j.push({issue:N,ruleName:f.ruleName})})});const S=r==="all"?j:j.filter(({issue:f})=>f.severity===r),R={P0:[],P1:[],P2:[],P3:[]};S.forEach(({issue:f,ruleName:N})=>{R[f.severity].push({issue:f,ruleName:N})});const v=f=>{c(N=>{const D=new Set(N);return D.has(f)?D.delete(f):D.add(f),D})},I=f=>{switch(f){case"P0":return"text-red-600 bg-red-50 border-red-200";case"P1":return"text-orange-600 bg-orange-50 border-orange-200";case"P2":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"P3":return"text-blue-600 bg-blue-50 border-blue-200"}},_=f=>{switch(f){case"P0":return e.jsx(le,{className:"w-4 h-4"});case"P1":return e.jsx(be,{className:"w-4 h-4"});case"P2":return e.jsx(je,{className:"w-4 h-4"});case"P3":return e.jsx(je,{className:"w-4 h-4"})}},O=()=>{const f={timestamp:new Date().toISOString(),summary:(t==null?void 0:t.overallSummary)||"",statistics:p,results:d.map(q=>({ruleName:q.ruleName,pass:q.pass,summary:q.summary,issueCount:q.issues.length,issues:q.issues}))},N=new Blob([JSON.stringify(f,null,2)],{type:"application/json"}),D=URL.createObjectURL(N),B=document.createElement("a");B.href=D,B.download=`quality-report-${Date.now()}.json`,B.click(),URL.revokeObjectURL(D)};return e.jsxs("div",{className:"h-full flex flex-col bg-white",children:[e.jsxs("div",{className:"p-4 border-b border-slate-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"æ£€æŸ¥ç»“æœ"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:O,className:"flex items-center gap-1 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-100 rounded-lg transition-colors",title:"å¯¼å‡ºæŠ¥å‘Š",children:[e.jsx(ke,{className:"w-4 h-4"}),"å¯¼å‡º"]}),i&&e.jsx("button",{onClick:i,className:"text-slate-400 hover:text-slate-600",children:"âœ•"})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[e.jsxs("div",{className:"p-3 bg-emerald-50 rounded-lg border border-emerald-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-700 mb-1",children:[e.jsx(X,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:"é€šè¿‡"})]}),e.jsx("div",{className:"text-2xl font-bold text-emerald-800",children:p.passed})]}),e.jsxs("div",{className:"p-3 bg-red-50 rounded-lg border border-red-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-700 mb-1",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:"å¤±è´¥"})]}),e.jsx("div",{className:"text-2xl font-bold text-red-800",children:p.failed})]}),e.jsxs("div",{className:"p-3 bg-orange-50 rounded-lg border border-orange-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-orange-700 mb-1",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:"é—®é¢˜æ•°"})]}),e.jsx("div",{className:"text-2xl font-bold text-orange-800",children:p.totalIssues})]}),e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-700 mb-1",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:"é—®é¢˜è¡Œ"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-800",children:p.totalIssueRows})]})]}),(t==null?void 0:t.overallSummary)&&e.jsx("div",{className:"mt-3 p-3 bg-slate-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-slate-700 whitespace-pre-line",children:t.overallSummary})})]}),e.jsxs("div",{className:"px-4 py-3 border-b border-slate-200 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(it,{className:"w-4 h-4 text-slate-400"}),e.jsx("span",{className:"text-sm font-medium text-slate-700",children:"ç­›é€‰ï¼š"}),e.jsxs("button",{onClick:()=>o("all"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="all"?"bg-slate-800 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:["å…¨éƒ¨ (",p.totalIssues,")"]}),e.jsxs("button",{onClick:()=>o("P0"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="P0"?"bg-red-600 text-white":"bg-red-50 text-red-600 hover:bg-red-100"}`,children:["P0 (",R.P0.length,")"]}),e.jsxs("button",{onClick:()=>o("P1"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="P1"?"bg-orange-600 text-white":"bg-orange-50 text-orange-600 hover:bg-orange-100"}`,children:["P1 (",R.P1.length,")"]}),e.jsxs("button",{onClick:()=>o("P2"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="P2"?"bg-yellow-600 text-white":"bg-yellow-50 text-yellow-600 hover:bg-yellow-100"}`,children:["P2 (",R.P2.length,")"]}),e.jsxs("button",{onClick:()=>o("P3"),className:`px-3 py-1 text-xs rounded-full transition-colors ${r==="P3"?"bg-blue-600 text-white":"bg-blue-50 text-blue-600 hover:bg-blue-100"}`,children:["P3 (",R.P3.length,")"]})]}),e.jsxs("button",{onClick:()=>x(!n),className:"text-sm text-slate-600 hover:text-slate-800",children:[n?"éšè—":"æ˜¾ç¤º","å»ºè®®"]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsx("div",{className:"p-4 space-y-3",children:d.map(f=>e.jsxs("div",{className:`border rounded-lg overflow-hidden ${f.pass?"border-emerald-200 bg-emerald-50":"border-red-200 bg-red-50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between p-3 cursor-pointer hover:bg-opacity-80",onClick:()=>v(f.ruleId),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[f.pass?e.jsx(X,{className:"w-5 h-5 text-emerald-600"}):e.jsx(le,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-slate-800",children:f.ruleName}),e.jsx("div",{className:"text-xs text-slate-600",children:f.summary})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:[f.issues.length," ä¸ªé—®é¢˜ â€¢ ",f.executionTime,"ms"]}),l.has(f.ruleId)?e.jsx(ct,{className:"w-4 h-4 text-slate-400"}):e.jsx(dt,{className:"w-4 h-4 text-slate-400"})]})]}),l.has(f.ruleId)&&f.issues.length>0&&e.jsx("div",{className:"border-t border-slate-200 p-3 bg-white",children:e.jsxs("div",{className:"space-y-2",children:[f.issues.slice(0,20).map((N,D)=>e.jsxs("div",{className:`p-2 rounded border text-sm cursor-pointer hover:bg-slate-50 ${I(N.severity)}`,onClick:()=>a==null?void 0:a(N.row,N.column),children:[e.jsxs("div",{className:"flex items-start justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[_(N.severity),e.jsxs("span",{className:"font-medium",children:["è¡Œ ",N.row," - ",N.column]})]}),a&&e.jsx(ye,{className:"w-3 h-3 text-slate-400"})]}),e.jsx("div",{className:"text-slate-700 mb-1",children:N.description}),N.suggestion&&e.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:["ğŸ’¡ ",N.suggestion]})]},D)),f.issues.length>20&&e.jsxs("div",{className:"text-center text-xs text-slate-500 pt-2",children:["è¿˜æœ‰ ",f.issues.length-20," ä¸ªé—®é¢˜..."]})]})}),l.has(f.ruleId)&&n&&f.suggestions.length>0&&e.jsxs("div",{className:"border-t border-slate-200 p-3 bg-blue-50",children:[e.jsx("div",{className:"text-sm font-medium text-blue-800 mb-2",children:"ä¿®å¤å»ºè®®ï¼š"}),e.jsx("ul",{className:"space-y-1",children:f.suggestions.map((N,D)=>e.jsxs("li",{className:"text-sm text-blue-700 flex items-start gap-2",children:[e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:N})]},D))})]})]},f.ruleId))}),p.totalIssues===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-slate-400",children:[e.jsx(X,{className:"w-16 h-16 mb-4 text-emerald-500"}),e.jsx("p",{className:"text-lg font-medium",children:"æ•°æ®è´¨é‡è‰¯å¥½"}),e.jsx("p",{className:"text-sm",children:"æ‰€æœ‰è§„åˆ™éƒ½å·²é€šè¿‡"})]})]})]})},Ct=({data:d,issues:t,highlightedCell:s,onCellClick:a,children:i})=>{const l=w.useMemo(()=>{const n=new Map;return t.forEach(x=>{const p=`${x.row}_${x.column}`;n.has(p)||n.set(p,[]),n.get(p).push(x)}),n},[t]),c=(n,x)=>{const j=`${n+1}_${x}`,S=l.get(j);if(!S||S.length===0)return{};const R=S.reduce((_,O)=>{const f=["P0","P1","P2","P3"];return Math.max(f.indexOf(O.severity),f.indexOf(_))},"P3"),I={P0:{bg:"rgba(239, 68, 68, 0.2)",border:"#ef4444"},P1:{bg:"rgba(249, 115, 22, 0.2)",border:"#f97316"},P2:{bg:"rgba(234, 179, 8, 0.2)",border:"#eab308"},P3:{bg:"rgba(59, 130, 246, 0.2)",border:"#3b82f6"}}[R];return{backgroundColor:I.bg,border:`2px solid ${I.border}`,cursor:"pointer"}},r=(n,x)=>{const p=n+1,j=`${p}_${x}`,S=l.get(j),R="transition-all hover:opacity-80";return!S||S.length===0?R:(s==null?void 0:s.row)===p&&(s==null?void 0:s.column)===x?`${R} ring-2 ring-offset-1 ring-emerald-500`:R},o=(n,x)=>{const p=n+1,j=`${p}_${x}`,S=l.get(j);S&&S.length>0&&(a==null||a(p,x))};return e.jsx(e.Fragment,{children:i({getCellStyle:c,getCellClassName:r,handleCellClick:o})})},$t={stopOnFirstError:!1,maxIssues:1e3,sampleSize:0,enableCache:!0,parallel:!1};class Rt{constructor(){this.cache=new Map}async executeRule(t,s,a={}){const i={...$t,...a},l=Date.now();if(i.enableCache){const n=this.getCacheKey(t,s),x=this.cache.get(n);if(x)return x}if(!t.localRule)return{ruleId:t.id,ruleName:t.name,pass:!1,issues:[],summary:"è§„åˆ™æœªå®šä¹‰æœ¬åœ°æ‰§è¡Œé€»è¾‘",suggestions:["è¯·ä½¿ç”¨AIæ‰§è¡Œæˆ–å®šä¹‰æœ¬åœ°è§„åˆ™"],executionTime:Date.now()-l,checkedRows:0,issueRows:0};const c=t.targetColumns.length>0?t.targetColumns:this.detectTargetColumns(t,s);if(c.length===0)return{ruleId:t.id,ruleName:t.name,pass:!0,issues:[],summary:"æœªæ£€æµ‹åˆ°ç›®æ ‡åˆ—",suggestions:["è¯·æ‰‹åŠ¨æŒ‡å®šè¦æ£€æŸ¥çš„åˆ—"],executionTime:Date.now()-l,checkedRows:0,issueRows:0};let r=[];switch(t.localRule.type){case"not_null":r=this.checkNotNull(t,s,c,i);break;case"format":r=this.checkFormat(t,s,c,i);break;case"range":r=this.checkRange(t,s,c,i);break;case"unique":r=this.checkUnique(t,s,c,i);break;case"custom":r=this.checkCustom(t,s,c,i);break;default:r=[]}const o={ruleId:t.id,ruleName:t.name,pass:r.length===0,issues:r.slice(0,i.maxIssues),summary:this.buildSummary(t,r,s.length,c),suggestions:this.buildSuggestions(t,r),executionTime:Date.now()-l,checkedRows:s.length,issueRows:new Set(r.map(n=>n.row)).size};if(i.enableCache){const n=this.getCacheKey(t,s);this.cache.set(n,o)}return o}detectTargetColumns(t,s){if(s.length===0)return[];const a=Object.keys(s[0]);if(t.targetColumns&&t.targetColumns.length>0)return t.targetColumns.filter(c=>a.includes(c));const i=t.checkContent.toLowerCase(),l=[/åŒ…å«["'](.+?)["']çš„åˆ—/,/["'](.+?)["']åˆ—/,/æ£€æŸ¥["'](.+?)["']/];for(const c of l){const r=i.match(c);if(r&&r[1]){const o=r[1].split(/[,ï¼Œã€]/).map(x=>x.trim().toLowerCase()),n=a.filter(x=>o.some(p=>x.toLowerCase().includes(p)||p.includes(x.toLowerCase())));if(n.length>0)return n}}if(t.localRule&&"exampleColumns"in t){const c=t.exampleColumns||[],r=a.filter(o=>c.some(n=>o.toLowerCase().includes(n.toLowerCase())||n.toLowerCase().includes(o.toLowerCase())));if(r.length>0)return r}return[]}checkNotNull(t,s,a,i){const l=[];for(let c=0;c<s.length;c++){const r=s[c];for(const o of a){const n=r[o];if((n==null||n===""||typeof n=="string"&&n.trim()==="")&&(l.push({row:c+1,column:o,value:n,description:`å­—æ®µ "${o}" ä¸ºç©º`,severity:t.severity,suggestion:`è¯·å¡«å†™ ${o} å­—æ®µ`}),i.stopOnFirstError))return l}}return l}checkFormat(t,s,a,i){var o,n;const l=[],c=(n=(o=t.localRule)==null?void 0:o.params)==null?void 0:n.pattern;if(!c)return l;const r=new RegExp(c);for(let x=0;x<s.length;x++){const p=s[x];for(const j of a){const S=p[j];if(S!=null&&S!==""){const R=String(S).trim();if(!r.test(R)&&(l.push({row:x+1,column:j,value:S,description:`å­—æ®µ "${j}" çš„æ ¼å¼ä¸ç¬¦åˆè¦æ±‚: ${S}`,severity:t.severity,suggestion:`è¯·æ£€æŸ¥ ${j} å­—æ®µæ ¼å¼æ˜¯å¦æ­£ç¡®`}),i.stopOnFirstError))return l}}}return l}checkRange(t,s,a,i){var o,n,x,p;const l=[],c=(n=(o=t.localRule)==null?void 0:o.params)==null?void 0:n.min,r=(p=(x=t.localRule)==null?void 0:x.params)==null?void 0:p.max;for(let j=0;j<s.length;j++){const S=s[j];for(const R of a){const v=S[R];if(v==null||v==="")continue;let I;if(v instanceof Date)I=v.getTime();else if(typeof v=="string"&&!isNaN(Date.parse(v)))I=new Date(v).getTime();else if(typeof v=="number")I=v;else continue;if(c!==void 0&&I<c&&l.push({row:j+1,column:R,value:v,description:`å­—æ®µ "${R}" çš„å€¼ ${v} å°äºæœ€å°å€¼ ${c}`,severity:t.severity,suggestion:`è¯·å°† ${R} å­—æ®µçš„å€¼è°ƒæ•´ä¸ºå¤§äºæˆ–ç­‰äº ${c}`}),r!==void 0&&I>r&&l.push({row:j+1,column:R,value:v,description:`å­—æ®µ "${R}" çš„å€¼ ${v} å¤§äºæœ€å¤§å€¼ ${r}`,severity:t.severity,suggestion:`è¯·å°† ${R} å­—æ®µçš„å€¼è°ƒæ•´ä¸ºå°äºæˆ–ç­‰äº ${r}`}),i.stopOnFirstError&&l.length>0)return l}}return l}checkUnique(t,s,a,i){const l=[];for(const c of a){const r=new Map;for(let o=0;o<s.length;o++){const n=s[o][c];if(n!=null&&n!==""){const x=r.get(n)||[];x.push(o+1),r.set(n,x)}}r.forEach((o,n)=>{if(o.length>1){for(const x of o)l.push({row:x,column:c,value:n,description:`å­—æ®µ "${c}" çš„å€¼ "${n}" é‡å¤å‡ºç° ${o.length} æ¬¡`,severity:t.severity,suggestion:`è¯·ç¡®ä¿ ${c} å­—æ®µçš„å€¼å”¯ä¸€`});if(i.stopOnFirstError)return l}})}return l}checkCustom(t,s,a,i){var r,o;const l=[],c=(o=(r=t.localRule)==null?void 0:r.params)==null?void 0:o.maxLength;if(c!==void 0)for(let n=0;n<s.length;n++){const x=s[n];for(const p of a){const j=x[p];if(j!=null){const S=String(j);if(S.length>c&&(l.push({row:n+1,column:p,value:j,description:`å­—æ®µ "${p}" çš„é•¿åº¦ ${S.length} è¶…è¿‡æœ€å¤§é•¿åº¦ ${c}`,severity:t.severity,suggestion:`è¯·å°† ${p} å­—æ®µçš„é•¿åº¦ç¼©çŸ­åˆ° ${c} å­—ç¬¦ä»¥å†…`}),i.stopOnFirstError))return l}}}return l}buildSummary(t,s,a,i){if(s.length===0)return`âœ… é€šè¿‡ï¼šæ£€æŸ¥äº† ${a} è¡Œæ•°æ®ï¼Œ${i.join(", ")} åˆ—ç¬¦åˆè§„åˆ™`;const l=new Set(s.map(o=>o.row)).size,c=s.reduce((o,n)=>(o[n.severity]=(o[n.severity]||0)+1,o),{}),r=Object.entries(c).map(([o,n])=>`${o}: ${n}ä¸ª`).join(", ");return`âŒ ä¸é€šè¿‡ï¼š${l} è¡Œæœ‰é—®é¢˜ï¼Œå…± ${s.length} ä¸ªé—®é¢˜ (${r})`}buildSuggestions(t,s){if(s.length===0)return["æ•°æ®è´¨é‡è‰¯å¥½ï¼Œç»§ç»­ä¿æŒ"];const a=new Set;return s.forEach(i=>{i.suggestion&&a.add(i.suggestion)}),t.severity==="P0"&&a.add("è¿™æ˜¯é˜»å¡æ€§é—®é¢˜ï¼Œå¿…é¡»ä¿®å¤æ‰èƒ½ç»§ç»­å¤„ç†"),Array.from(a).slice(0,5)}getCacheKey(t,s){return`${t.id}_${s.length}_${JSON.stringify(t.targetColumns)}`}clearCache(){this.cache.clear()}getCacheSize(){return this.cache.size}}const W=new Rt,Et={stopOnFirstError:!1,maxIssues:100,sampleSize:50,enableCache:!0,parallel:!1};class kt{constructor(){this.cache=new Map}async executeRule(t,s,a={}){const i={...Et,...a},l=Date.now();if(i.enableCache){const x=this.getCacheKey(t,s),p=this.cache.get(x);if(p)return p}const c=i.sampleSize||Math.min(100,s.length),r=s.length>c?this.sampleData(s,c):s,o=t.targetColumns.length>0?t.targetColumns:Object.keys(r[0]||{}),n=this.buildPrompt(t,r,o);try{const x=await this.callAIService(n),p=this.parseAIResult(t,x,s.length,o,l);if(i.enableCache){const j=this.getCacheKey(t,s);this.cache.set(j,p)}return p}catch(x){return{ruleId:t.id,ruleName:t.name,pass:!1,issues:[],summary:`AIæ‰§è¡Œå¤±è´¥: ${x instanceof Error?x.message:"æœªçŸ¥é”™è¯¯"}`,suggestions:["è¯·æ£€æŸ¥è§„åˆ™å®šä¹‰æ˜¯å¦æ¸…æ™°","å°è¯•ä½¿ç”¨æœ¬åœ°è§„åˆ™","è”ç³»æŠ€æœ¯æ”¯æŒ"],executionTime:Date.now()-l,checkedRows:r.length,issueRows:0}}}sampleData(t,s){if(t.length<=s)return t;const a=Math.floor(t.length/s),i=[];for(let l=0;l<t.length&&(i.push(t[l]),!(i.length>=s));l+=a);return i}buildPrompt(t,s,a){return`
ä½ æ˜¯ä¸€ä¸ªæ•°æ®è´¨é‡æ£€æŸ¥ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹è§„åˆ™è¯„ä¼°æ•°æ®ï¼š

## è§„åˆ™ä¿¡æ¯
- è§„åˆ™åç§°ï¼š${t.name}
- è§„åˆ™æè¿°ï¼š${t.description}
- æ£€æŸ¥å†…å®¹ï¼š${t.checkContent}
- è¯„åˆ¤æ ‡å‡†ï¼š${t.criteria}
- ä¸¥é‡çº§åˆ«ï¼š${t.severity}

## æ•°æ®é¢„è§ˆ
- åˆ—åï¼š${a.join(", ")}
- æ•°æ®è¡Œæ•°ï¼š${s.length} è¡Œ
- å‰10è¡Œæ•°æ®ï¼š
${JSON.stringify(s.slice(0,10),null,2)}

## ä»»åŠ¡è¦æ±‚
è¯·æ£€æŸ¥æ•°æ®å¹¶è¿”å›JSONæ ¼å¼ç»“æœï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
\`\`\`json
{
  "pass": true/false,
  "issues": [
    {
      "row": è¡Œå·ï¼ˆä»1å¼€å§‹ï¼‰,
      "column": "åˆ—å",
      "value": "é—®é¢˜å€¼",
      "description": "é—®é¢˜æè¿°",
      "severity": "P0/P1/P2/P3",
      "suggestion": "ä¿®å¤å»ºè®®"
    }
  ],
  "summary": "æ‰§è¡Œæ‘˜è¦",
  "suggestions": ["å»ºè®®1", "å»ºè®®2", "å»ºè®®3"]
}
\`\`\`

## æ³¨æ„äº‹é¡¹
1. åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—è¯´æ˜
2. rowå­—æ®µå¿…é¡»æ˜¯å®é™…æ•°æ®ä¸­çš„è¡Œå·
3. å¦‚æœæ•°æ®é‡‡æ ·æ£€æŸ¥ï¼Œè¯·åœ¨summaryä¸­è¯´æ˜
4. issuesæ•°ç»„æœ€å¤šè¿”å›100ä¸ªé—®é¢˜
5. suggestionsæ•°ç»„æœ€å¤šè¿”å›5æ¡å»ºè®®
`.trim()}async callAIService(t){var s,a,i,l,c;try{let r=globalThis.__VITE_API_BASE_URL__||"/api/v2";r.startsWith("http")||(r=`http://localhost:3001${r}`),r=r.replace(/\/$/,""),console.log("[AI Rule Executor] è°ƒç”¨AIæœåŠ¡:",{url:`${r}/ai/chat`,promptLength:t.length});const o=await fetch(`${r}/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t,history:[],contextDocs:""})});if(!o.ok){let j="";try{const S=await o.json();j=JSON.stringify(S),console.error("[AI Rule Executor] AIæœåŠ¡é”™è¯¯å“åº”:",{status:o.status,statusText:o.statusText,error:S})}catch{j=await o.text(),console.error("[AI Rule Executor] AIæœåŠ¡é”™è¯¯å“åº” (æ— æ³•è§£æJSON):",{status:o.status,statusText:o.statusText,text:j})}throw new Error(`AIæœåŠ¡å“åº”å¤±è´¥: ${o.status} - ${j}`)}const n=await o.json();if(!n.success)throw console.error("[AI Rule Executor] AIæœåŠ¡è¿”å›å¤±è´¥:",n),new Error(((s=n.error)==null?void 0:s.message)||"AIè°ƒç”¨å¤±è´¥");const x=((a=n.data)==null?void 0:a.response)||((l=(i=n.data)==null?void 0:i.message)==null?void 0:l.content)||((c=n.data)==null?void 0:c.content);if(!x)throw console.error("[AI Rule Executor] AIè¿”å›å†…å®¹ä¸ºç©º:",n),new Error("AIè¿”å›å†…å®¹ä¸ºç©º");console.log("[AI Rule Executor] AIè¿”å›å†…å®¹é•¿åº¦:",x.length);const p=x.match(/```json\n([\s\S]*?)\n```/)||x.match(/\{[\s\S]*\}/);if(p){const j=p[1]||p[0];return console.log("[AI Rule Executor] æˆåŠŸæå–JSONç»“æœ"),JSON.parse(j)}return console.warn("[AI Rule Executor] æœªæ‰¾åˆ°JSONæ ¼å¼ç»“æœï¼Œè¿”å›é»˜è®¤é€šè¿‡"),{pass:!0,issues:[],summary:"AIæ£€æŸ¥å®Œæˆï¼ˆæœªè¿”å›ç»“æ„åŒ–ç»“æœï¼‰",suggestions:[]}}catch(r){throw console.error("[AI Rule Executor] AIæœåŠ¡è°ƒç”¨å¤±è´¥:",r),r}}parseAIResult(t,s,a,i,l){if(!s||typeof s!="object")throw new Error("AIè¿”å›ç»“æœæ ¼å¼é”™è¯¯");const c=(s.issues||[]).map(r=>({row:r.row||0,column:r.column||"",value:r.value,description:r.description||"æ•°æ®è´¨é‡é—®é¢˜",severity:r.severity||t.severity,suggestion:r.suggestion}));return{ruleId:t.id,ruleName:t.name,pass:s.pass||c.length===0,issues:c.slice(0,100),summary:s.summary||this.buildSummary(t,c,a,i),suggestions:s.suggestions||[],executionTime:Date.now()-l,checkedRows:a,issueRows:new Set(c.map(r=>r.row)).size}}buildSummary(t,s,a,i){if(s.length===0)return`âœ… é€šè¿‡ï¼ˆAIæ£€æŸ¥ï¼‰ï¼šæ£€æŸ¥äº† ${a} è¡Œæ•°æ®ï¼Œ${i.join(", ")} åˆ—ç¬¦åˆè§„åˆ™`;const l=new Set(s.map(o=>o.row)).size,c=s.reduce((o,n)=>(o[n.severity]=(o[n.severity]||0)+1,o),{}),r=Object.entries(c).map(([o,n])=>`${o}: ${n}ä¸ª`).join(", ");return`âŒ ä¸é€šè¿‡ï¼ˆAIæ£€æŸ¥ï¼‰ï¼š${l} è¡Œæœ‰é—®é¢˜ï¼Œå…± ${s.length} ä¸ªé—®é¢˜ (${r})`}getCacheKey(t,s){const a=this.hashData(s);return`ai_${t.id}_${a}`}hashData(t){const s=JSON.stringify(t.slice(0,5));return`${t.length}_${s.length}`}clearCache(){this.cache.clear()}getCacheSize(){return this.cache.size}async testAvailability(){try{const t={id:"test",name:"æµ‹è¯•è§„åˆ™",description:"æµ‹è¯•",category:"æµ‹è¯•",checkContent:"æµ‹è¯•",criteria:"æµ‹è¯•",severity:"P1",executionType:"ai",targetColumns:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),usageCount:0,isOfficial:!1,isEnabled:!0},s=[{a:1,b:2}];return(await this.executeRule(t,s,{sampleSize:1})).executionTime>0}catch(t){return console.error("AIæœåŠ¡ä¸å¯ç”¨:",t),!1}}}const V=new kt;class At{async executeRules(t,s,a={}){const i=Date.now(),l=t.filter(p=>p.isEnabled);if(l.length===0)return{totalRules:t.length,executedRules:0,skippedRules:t.length,results:[],overallSummary:"æ²¡æœ‰å¯ç”¨çš„è§„åˆ™",totalExecutionTime:0};const c=l.filter(p=>p.executionType==="local"),r=l.filter(p=>p.executionType==="ai"),o=await this.executeLocalRules(c,s,a),n=await this.executeAIRules(r,s,a),x=[...o,...n];for(const p of l)await K.incrementUsage(p.id);return{totalRules:t.length,executedRules:l.length,skippedRules:t.length-l.length,results:x,overallSummary:this.buildOverallSummary(x,s.length),totalExecutionTime:Date.now()-i}}async executeLocalRules(t,s,a){if(t.length===0)return[];const i=t.map(l=>W.executeRule(l,s,a));return Promise.all(i)}async executeAIRules(t,s,a){if(t.length===0)return[];const i=[];for(const l of t)try{const c=await V.executeRule(l,s,a);i.push(c)}catch(c){console.error(`AIè§„åˆ™æ‰§è¡Œå¤±è´¥ (${l.name}):`,c),i.push({ruleId:l.id,ruleName:l.name,pass:!1,issues:[],summary:`æ‰§è¡Œå¤±è´¥: ${c instanceof Error?c.message:"æœªçŸ¥é”™è¯¯"}`,suggestions:["è¯·ç¨åé‡è¯•","å°è¯•ä½¿ç”¨æœ¬åœ°è§„åˆ™"],executionTime:0,checkedRows:0,issueRows:0})}return i}async executeSingleRule(t,s,a={}){return t.executionType==="local"?W.executeRule(t,s,a):t.executionType==="ai"?V.executeRule(t,s,a):this.executeHybridRule(t,s,a)}async executeHybridRule(t,s,a){if(t.localRule){const i=await W.executeRule(t,s,a);if(!i.pass&&i.issues.length>0){console.log(`æœ¬åœ°è§„åˆ™å‘ç°é—®é¢˜ï¼Œä½¿ç”¨AIæ·±åº¦åˆ†æ: ${t.name}`);const l=await V.executeRule(t,s,{...a,sampleSize:Math.min(50,s.length)});return{...i,issues:[...i.issues,...l.issues],suggestions:[...i.suggestions,...l.suggestions],summary:`${i.summary}ï¼ŒAIæ·±åº¦åˆ†æ: ${l.summary}`,executionTime:i.executionTime+l.executionTime}}return i}return V.executeRule(t,s,a)}buildOverallSummary(t,s){const a=t.filter(o=>o.pass).length,i=t.filter(o=>!o.pass).length,l=t.reduce((o,n)=>o+n.issues.length,0),c=t.reduce((o,n)=>o+n.issueRows,0),r=(a/t.length*100).toFixed(1);return`
æ‰§è¡Œå®Œæˆï¼
- æ€»è§„åˆ™æ•°ï¼š${t.length}
- é€šè¿‡ï¼š${a} (${r}%)
- å¤±è´¥ï¼š${i}
- é—®é¢˜æ€»æ•°ï¼š${l}
- é—®é¢˜è¡Œæ•°ï¼š${c} / ${s}
    `.trim()}async getExecutionSuggestions(t,s){const a=[],i=t.filter(r=>r.executionType==="local"),l=t.filter(r=>r.executionType==="ai");i.length===0&&a.push("å»ºè®®æ·»åŠ æœ¬åœ°è§„åˆ™ä»¥åŠ å¿«æ‰§è¡Œé€Ÿåº¦"),l.length>5&&a.push("AIè§„åˆ™è¾ƒå¤šï¼Œæ‰§è¡Œå¯èƒ½è¾ƒæ…¢ä¸”æœ‰æˆæœ¬ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨æœ¬åœ°è§„åˆ™"),s>1e4&&a.push("æ•°æ®é‡è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨é‡‡æ ·æ£€æŸ¥ä»¥åŠ å¿«é€Ÿåº¦");const c=new Set(t.map(r=>r.category));return c.has("æ ¼å¼æ£€æŸ¥")||a.push("å»ºè®®æ·»åŠ æ ¼å¼æ£€æŸ¥è§„åˆ™"),c.has("å®Œæ•´æ€§æ£€æŸ¥")||a.push("å»ºè®®æ·»åŠ å®Œæ•´æ€§æ£€æŸ¥è§„åˆ™"),a}clearAllCaches(){W.clearCache(),V.clearCache()}getCacheStats(){return{local:W.getCacheSize(),ai:V.getCacheSize()}}}const Pt=new At,Lt=()=>{var pe;const{filesData:d,activeFileId:t,setFilesData:s,setActiveFileId:a,setExcelData:i,setView:l}=Ve(),[c,r]=w.useState(""),[o,n]=w.useState(new Set),[x,p]=w.useState(""),[j,S]=w.useState(!1),[R,v]=w.useState([]),[I,_]=w.useState(!1),[O,f]=w.useState(""),[N,D]=w.useState(null),[B,q]=w.useState([]),[U,b]=w.useState(!0),[F,J]=w.useState("processing"),[h,A]=w.useState([]),[Q,Z]=w.useState([]),[Pe,ee]=w.useState(null),[Te,de]=w.useState(!1),[Ie,te]=w.useState(null),me=w.useRef(null),se=w.useRef(null);w.useCallback(m=>{D(m),m.progress.percentage>0&&v(g=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`è¿›åº¦: ${m.progress.percentage}% - ${m.progress.message}`},...g])},[]);const Oe=w.useMemo(()=>({idle:"ç©ºé—²",observing:"è§‚å¯Ÿæ•°æ®...",thinking:"AIæ€è€ƒä¸­...",acting:"æ‰§è¡Œè½¬æ¢...",evaluating:"è¯„ä¼°ç»“æœ...",repairing:"ä¿®å¤é”™è¯¯...",completed:"å·²å®Œæˆ",failed:"å¤±è´¥",cancelled:"å·²å–æ¶ˆ"}),[]),ue=w.useCallback(m=>`${Math.round(m*100)}%`,[]),De=w.useCallback(async m=>{if(d.length===0){alert("è¯·å…ˆä¸Šä¼ æ–‡ä»¶");return}const g=d.find(u=>u.id===t);if(!g||!c){alert("è¯·é€‰æ‹©æ–‡ä»¶å’Œå·¥ä½œè¡¨");return}const y=g.sheets[c];if(!y||y.length===0){alert("å½“å‰å·¥ä½œè¡¨æ²¡æœ‰æ•°æ®");return}de(!0),Z([]),ee(null),te(null),v(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`å¼€å§‹æ‰§è¡Œè´¨é‡æ£€æŸ¥ï¼Œå…± ${m.length} æ¡è§„åˆ™...`},...u]);try{const u=await Pt.executeRules(m,y,{sampleSize:y.length>1e3?100:0,maxIssues:100});Z(u.results),ee(u);const C=u.results.filter(E=>E.pass).length,$=u.results.filter(E=>!E.pass).length,k=u.results.reduce((E,T)=>E+T.issues.length,0);v(E=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:$===0?"success":"error",message:`è´¨é‡æ£€æŸ¥å®Œæˆï¼é€šè¿‡ ${C}/${u.results.length}ï¼Œå‘ç° ${k} ä¸ªé—®é¢˜ï¼Œè€—æ—¶ ${Math.round(u.totalExecutionTime/1e3)}s`},...E])}catch(u){console.error("è´¨é‡æ£€æŸ¥å¤±è´¥:",u);const C=u instanceof Error?u.message:"æœªçŸ¥é”™è¯¯";v($=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:`è´¨é‡æ£€æŸ¥å¤±è´¥: ${C}`},...$]),alert(`è´¨é‡æ£€æŸ¥å¤±è´¥: ${C}`)}finally{de(!1)}},[d,t,c]),xe=w.useCallback((m,g)=>{te({row:m,column:g});const y=document.querySelector(`tr[data-row="${m}"]`);y&&y.scrollIntoView({behavior:"smooth",block:"center"}),v(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`è·³è½¬åˆ°é—®é¢˜ä½ç½®ï¼šè¡Œ ${m}ï¼Œåˆ— ${g}`},...u])},[]),_e=w.useCallback(m=>{A(m)},[]),Fe=w.useCallback(()=>{Z([]),ee(null),te(null)},[]),Me=w.useCallback(async()=>{se.current&&(se.current.abort(),se.current=null),S(!1),v(m=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:"ç”¨æˆ·å–æ¶ˆäº†æ‰§è¡Œ"},...m])},[]);w.useEffect(()=>{if(t){const m=d.find(g=>g.id===t);m&&!c&&r(m.currentSheetName)}else r("")},[t,d]);const Le=async m=>{if(m.target.files&&m.target.files.length>0){const g=[];for(let y=0;y<m.target.files.length;y++)try{const u=await Ge(m.target.files[y]);g.push(u)}catch(u){P.error(`Error reading file ${m.target.files[y].name}`,u)}s([...d,...g]),!t&&g.length>0&&(a(g[0].id),r(g[0].currentSheetName))}},qe=async()=>{if(!(d.length===0||!x.trim())){S(!0),f(""),D(null);try{const m=d.map(g=>({id:g.id,fileName:g.fileName,sheets:g.sheets,currentSheetName:g.currentSheetName,metadata:g.metadata}));if(U){v(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:"å¯åŠ¨å¤šæ­¥åˆ†æç³»ç»Ÿ (Observe-Think-Act-Evaluate)... é€šè¿‡åç«¯APIæœåŠ¡"},...u]);const g=await Y.execute({command:x,files:m,options:{useAgenticMode:!0,maxRetries:3,qualityThreshold:.7,enableAutoRepair:!0}});v(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`ä»»åŠ¡å·²åˆ›å»º (ID: ${g.taskId})ï¼Œæ­£åœ¨å¤„ç†...`},...u]);const y=await Y.waitForCompletion(g.taskId,{pollInterval:2e3,timeout:3e5,onProgress:u=>{u.status==="processing"&&v(C=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`å¤„ç†ä¸­... (å·²ç”¨æ—¶: ${Math.round((u.elapsed||0)/1e3)}s)`},...C])}});if(y.success&&y.data){const u=[...d];let C=0;if(Object.entries(y.data).forEach(([$,k])=>{if(typeof k=="object"&&!Array.isArray(k)){const E=k,T=u.findIndex(L=>L.fileName===$);if(T>=0){const L=u[T];Object.entries(E).forEach(([ae,H])=>{Array.isArray(H)&&(L.sheets[ae]=H)}),C++}else{const L=Object.keys(E)[0];u.push({id:$+"-"+Date.now(),fileName:$,sheets:E,currentSheetName:L}),C++}}else if(Array.isArray(k)){const E=u.findIndex(T=>T.fileName===$);if(E>=0){const T=u[E];T.sheets[T.currentSheetName]=k,C++}else u.push({id:$+"-"+Date.now(),fileName:$,sheets:{Sheet1:k},currentSheetName:"Sheet1"}),C++}}),s(u),y.qualityReport){const $=ue(y.qualityReport.overallQuality);v(k=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"success",message:`æ‰§è¡Œå®Œæˆï¼è´¨é‡è¯„åˆ†: ${$}ï¼Œå¤„ç†äº† ${C} ä¸ªæ–‡ä»¶ï¼Œè€—æ—¶ ${Math.round(y.executionSummary.totalTime/1e3)}s`},...k])}else v($=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"success",message:`æ‰§è¡Œå®Œæˆã€‚å¤„ç†äº† ${C} ä¸ªæ–‡ä»¶ã€‚`},...$])}else throw new Error("å¤šæ­¥åˆ†æå¤±è´¥ï¼Œå°è¯•é™çº§åˆ°å•æ­¥æ‰§è¡Œ")}else await he(m)}catch(m){if(U){v(g=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:`å¤šæ­¥åˆ†æå¤±è´¥: ${m.message}ï¼Œé™çº§åˆ°å•æ­¥æ‰§è¡Œ...`},...g]);try{const g=d.map(y=>({id:y.id,fileName:y.fileName,sheets:y.sheets,currentSheetName:y.currentSheetName,metadata:y.metadata}));await he(g)}catch(g){v(y=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:`æ‰§è¡Œå¤±è´¥: ${g.message}`},...y])}}else v(g=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:m.message},...g])}finally{S(!1)}}},he=async m=>{v(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:"ä½¿ç”¨å¿«é€Ÿæ‰§è¡Œæ¨¡å¼ï¼ˆé€šè¿‡APIï¼‰..."},...u]),v(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:"æ­£åœ¨é€šè¿‡ API æ‰§è¡Œä»»åŠ¡..."},...u]);const g=await Y.execute({command:x,files:m,options:{maxRetries:1,qualityThreshold:0,enableAutoRepair:!1,logLevel:"warn"}});v(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`ä»»åŠ¡å·²åˆ›å»º (ID: ${g.taskId})ï¼Œæ­£åœ¨æ‰§è¡Œ...`},...u]);const y=await Y.waitForCompletion(g.taskId,{pollInterval:1e3,timeout:6e4,onProgress:u=>{u.status==="processing"&&v(C=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"pending",message:`æ‰§è¡Œä¸­... (å·²ç”¨æ—¶: ${Math.round((u.elapsed||0)/1e3)}s)`},...C])}});if(y.success&&y.data){const u=[...d];let C=0;if(Object.entries(y.data).forEach(([$,k])=>{if(typeof k=="object"&&!Array.isArray(k)){const E=k,T=u.findIndex(L=>L.fileName===$);if(T>=0){const L=u[T];Object.entries(E).forEach(([ae,H])=>{Array.isArray(H)&&(L.sheets[ae]=H)}),C++}else{const L=Object.keys(E)[0];u.push({id:$+"-"+Date.now(),fileName:$,sheets:E,currentSheetName:L}),C++}}else if(Array.isArray(k)){const E=u.findIndex(T=>T.fileName===$);if(E>=0){const T=u[E];T.sheets[T.currentSheetName]=k,C++}else u.push({id:$+"-"+Date.now(),fileName:$,sheets:{Sheet1:k},currentSheetName:"Sheet1"}),C++}}),C===0)throw new Error("æ²¡æœ‰æˆåŠŸå¤„ç†ä»»ä½•æ–‡ä»¶æ•°æ®");s(u),v($=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"success",message:`æ‰§è¡Œå®Œæˆã€‚å¤„ç†äº† ${C} ä¸ªæ–‡ä»¶ã€‚`},...$])}else throw new Error(y.error||"å¿«é€Ÿæ‰§è¡Œå¤±è´¥")},Ue=(m,g)=>{g.stopPropagation(),s(y=>y.filter(u=>u.id!==m)),n(y=>{const u=new Set(y);return u.delete(m),u}),t===m&&(a(null),r(""))},ze=(m,g)=>{g.stopPropagation(),fe(m.sheets,m.fileName)},Je=(m,g)=>{g.stopPropagation(),n(y=>{const u=new Set(y);return u.has(m)?u.delete(m):u.add(m),u})},ge=(m,g)=>{g==null||g.stopPropagation(),i(m),l(Xe.DOCUMENT_SPACE)},Be=()=>{o.size===d.length?n(new Set):n(new Set(d.map(m=>m.id)))},Qe=async()=>{if(o.size===0)return;S(!0);const m=new We;let g=0;if(d.forEach(y=>{if(o.has(y.id)){const u=re.book_new();Object.entries(y.sheets).forEach(([k,E])=>{const T=re.json_to_sheet(E);re.book_append_sheet(u,T,k)});const C=He(u,{bookType:"xlsx",type:"array"});let $=y.fileName;$.endsWith(".xlsx")||($+=".xlsx"),m.file($,C),g++}}),g>0)try{const y=await m.generateAsync({type:"blob"}),u=window.URL.createObjectURL(y),C=document.createElement("a");C.href=u,C.download=`excelmind_batch_export_${Date.now()}.zip`,C.click(),window.URL.revokeObjectURL(u),v($=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"success",message:`æˆåŠŸæ‰“åŒ…å¹¶ä¸‹è½½ ${g} ä¸ªæ–‡ä»¶ã€‚`},...$])}catch(y){P.error(y),v(u=>[{id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fileName:"System",status:"error",message:"æ‰“åŒ…å¤±è´¥ã€‚"},...u])}S(!1)},M=d.find(m=>m.id===t),z=M&&c?M.sheets[c]:null;return e.jsxs("div",{className:"h-full flex flex-col bg-slate-50",children:[e.jsxs("div",{className:"bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-800",children:F==="processing"?"æ™ºèƒ½å¤šæ–‡ä»¶å¤„ç†å·¥ä½œåŒº":"æ•°æ®è´¨é‡æ£€æŸ¥å·¥ä½œåŒº"}),e.jsx("p",{className:"text-sm text-slate-500",children:F==="processing"?"ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œè¿›è¡Œè·¨è¡¨æ ¸å¯¹ã€åˆå¹¶æˆ–ç­›é€‰":"ä½¿ç”¨è´¨é‡è§„åˆ™æ£€æŸ¥æ•°æ®ï¼Œå‘ç°å¹¶ä¿®å¤é—®é¢˜"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(jt,{currentMode:F,onModeChange:J,disabled:d.length===0}),e.jsx("input",{type:"file",multiple:!0,accept:".xlsx, .xls",onChange:Le,className:"hidden",ref:me}),e.jsxs("button",{onClick:()=>{var m;return(m=me.current)==null?void 0:m.click()},className:"flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 rounded-lg transition-colors font-medium text-sm border border-emerald-200",children:[e.jsx(Re,{className:"w-4 h-4"}),"æ·»åŠ æ–‡ä»¶"]})]})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:"w-[400px] flex flex-col border-r border-slate-200 bg-white shadow-sm z-10",children:F==="processing"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:Be,className:"text-slate-500 hover:text-emerald-600 transition-colors",title:"å…¨é€‰/å–æ¶ˆå…¨é€‰",children:d.length>0&&o.size===d.length?e.jsx(ie,{className:"w-5 h-5 text-emerald-600"}):e.jsx(we,{className:"w-5 h-5"})}),e.jsxs("span",{className:"text-sm font-semibold text-slate-700",children:["æ–‡ä»¶åˆ—è¡¨ (",d.length,")"]})]}),o.size>0&&e.jsxs("button",{onClick:Qe,className:"text-xs flex items-center gap-1 bg-emerald-600 text-white px-3 py-1 rounded-lg hover:bg-emerald-700 transition-all shadow-sm",children:[e.jsx(mt,{className:"w-3.5 h-3.5"}),"ä¸‹è½½é€‰ä¸­ (",o.size,")"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 border-b border-slate-100",children:d.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-400 border-2 border-dashed border-slate-100 rounded-xl",children:[e.jsx("p",{children:"å·¥ä½œåŒºä¸ºç©º"}),e.jsx("p",{className:"text-xs mt-1",children:"è¯·æ·»åŠ  Excel æ–‡ä»¶"})]}):e.jsx("ul",{className:"space-y-2",children:d.map(m=>e.jsxs("li",{onClick:()=>a(m.id),className:`group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all border ${t===m.id?"bg-emerald-50 border-emerald-200 shadow-sm":"bg-white border-slate-100 hover:bg-slate-50"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 overflow-hidden",children:[e.jsx("div",{onClick:g=>Je(m.id,g),className:"flex-shrink-0 text-slate-400 hover:text-emerald-600 transition-colors",children:o.has(m.id)?e.jsx(ie,{className:"w-4 h-4 text-emerald-600"}):e.jsx(we,{className:"w-4 h-4"})}),e.jsx("div",{className:`p-2 rounded-lg ${t===m.id?"bg-emerald-200 text-emerald-700":"bg-slate-100 text-slate-500"}`,children:e.jsx(ut,{className:"w-4 h-4"})}),e.jsxs("div",{className:"truncate",children:[e.jsx("p",{className:`text-sm font-medium truncate ${t===m.id?"text-slate-800":"text-slate-600"}`,children:m.fileName}),e.jsxs("p",{className:"text-xs text-slate-400",children:[Object.keys(m.sheets).length," ä¸ªå·¥ä½œè¡¨"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:g=>ge(m,g),className:"text-slate-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity p-1",title:"å‘é€åˆ°æ–‡æ¡£ç”Ÿæˆ",children:e.jsx(ve,{className:"w-4 h-4"})}),e.jsx("button",{onClick:g=>ze(m,g),className:"text-slate-300 hover:text-emerald-400 opacity-0 group-hover:opacity-100 transition-opacity p-1",title:"ä¸‹è½½æ–‡ä»¶",children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsx("button",{onClick:g=>Ue(m.id,g),className:"text-slate-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1",title:"åˆ é™¤æ–‡ä»¶",children:e.jsx(Ee,{className:"w-4 h-4"})})]})]},m.id))})}),e.jsxs("div",{className:"p-4 bg-slate-50 border-t border-slate-200",children:[N&&j&&e.jsxs("div",{className:"mb-3 p-3 bg-gradient-to-r from-emerald-50 to-blue-50 rounded-xl border border-emerald-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4 text-emerald-600"}),e.jsx("span",{className:"text-xs font-bold text-emerald-700",children:"å¤šæ­¥åˆ†æç³»ç»Ÿ"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-xs font-semibold text-slate-600",children:[N.progress.percentage,"%"]})})]}),e.jsx("div",{className:"w-full bg-slate-200 rounded-full h-2 mb-2",children:e.jsx("div",{className:"bg-gradient-to-r from-emerald-500 to-blue-500 h-2 rounded-full transition-all duration-300",style:{width:`${N.progress.percentage}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"font-medium text-slate-700",children:Oe[N.status]||N.status}),N.qualityReport&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:`w-3 h-3 ${N.qualityReport.overallQuality>=.8?"text-green-500":"text-yellow-500"}`}),e.jsxs("span",{className:"font-semibold text-slate-600",children:["è´¨é‡: ",ue(N.qualityReport.overallQuality)]})]})]}),e.jsx("div",{className:"mt-2 flex items-center gap-1 text-xs",children:[{key:"observing",label:"è§‚å¯Ÿ",icon:"ğŸ‘ï¸"},{key:"thinking",label:"æ€è€ƒ",icon:"ğŸ§ "},{key:"acting",label:"æ‰§è¡Œ",icon:"âš¡"},{key:"evaluating",label:"è¯„ä¼°",icon:"âœ…"}].map(m=>{const g=N.status===m.key,y=["observing","thinking"].includes(m.key)&&["acting","evaluating","completed"].includes(N.status);return e.jsxs("div",{className:`flex-1 flex items-center justify-center gap-1 py-1 px-2 rounded-lg transition-all ${g?"bg-emerald-500 text-white font-bold":y?"bg-emerald-100 text-emerald-700":"bg-slate-100 text-slate-400"}`,children:[e.jsx("span",{children:m.icon}),e.jsx("span",{className:"hidden sm:inline",children:m.label})]},m.key)})}),N.status==="repairing"&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-amber-600 bg-amber-50 p-2 rounded-lg",children:[e.jsx(Se,{className:"w-3 h-3"}),e.jsx("span",{className:"font-medium",children:"æ£€æµ‹åˆ°é”™è¯¯ï¼Œæ­£åœ¨è‡ªåŠ¨ä¿®å¤..."})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-bold text-slate-700",children:"AI æŒ‡ä»¤"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>b(!U),className:`text-xs px-2 py-1 rounded-lg font-medium transition-all flex items-center gap-1 ${U?"bg-emerald-100 text-emerald-700 border border-emerald-300":"bg-slate-100 text-slate-600 border border-slate-200"}`,title:U?"å¤šæ­¥åˆ†ææ¨¡å¼ï¼šæ”¯æŒè‡ªæˆ‘ä¿®å¤å’Œè´¨é‡è¯„ä¼°":"å•æ­¥æ‰§è¡Œæ¨¡å¼ï¼šå¿«é€Ÿæ‰§è¡Œ",children:[e.jsx(Ne,{className:"w-3 h-3"}),U?"æ™ºèƒ½æ¨¡å¼":"å¿«é€Ÿæ¨¡å¼"]}),e.jsxs("button",{onClick:()=>_(!I),className:"text-xs font-normal text-slate-400 hover:text-emerald-600 flex items-center gap-1",children:[e.jsx(xt,{className:"w-3 h-3"})," ",I?"éšè—ä»£ç ":"æŸ¥çœ‹ä»£ç "]})]})]}),I&&O&&e.jsx("div",{className:"mb-3 p-2 bg-slate-900 text-green-400 text-xs font-mono rounded-lg max-h-32 overflow-y-auto",children:e.jsx("pre",{children:O})}),e.jsx("textarea",{value:x,onChange:m=>p(m.target.value),placeholder:`æè¿°æ‚¨çš„è·¨æ–‡ä»¶éœ€æ±‚... 
ä¾‹å¦‚ï¼š'å¯¹æ¯”è¡¨Aå’Œè¡¨Bï¼Œæ‰¾å‡ºé‡‘é¢ä¸ä¸€è‡´çš„è¡Œï¼Œå­˜ä¸ºæ–°æ–‡ä»¶å·®å¼‚è¡¨'`,className:"w-full h-24 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none text-slate-700 resize-none bg-white text-sm shadow-sm"}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsxs("button",{onClick:qe,disabled:j||!x||d.length===0,className:`flex-1 py-2.5 rounded-xl flex items-center justify-center gap-2 font-bold text-white transition-all text-sm ${j||!x||d.length===0?"bg-slate-300 cursor-not-allowed":"bg-emerald-600 hover:bg-emerald-700 shadow-md hover:shadow-emerald-900/20"}`,children:[j?e.jsx(ht,{className:"w-4 h-4 animate-spin"}):e.jsx(gt,{className:"w-4 h-4"}),"æ‰§è¡Œæ™ºèƒ½å¤„ç†"]}),j&&e.jsxs("button",{onClick:Me,className:"px-4 py-2.5 rounded-xl bg-red-100 text-red-600 hover:bg-red-200 transition-all font-bold text-sm flex items-center gap-2",title:"å–æ¶ˆæ‰§è¡Œ",children:[e.jsx(Se,{className:"w-4 h-4"}),"å–æ¶ˆ"]})]}),N&&!j&&N.status==="completed"&&e.jsxs("div",{className:"mt-3 p-3 bg-green-50 rounded-xl border border-green-200",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-700 font-bold text-sm mb-2",children:[e.jsx(X,{className:"w-4 h-4"}),"æ‰§è¡Œå®Œæˆ"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-xs text-slate-600",children:((pe=N.result)==null?void 0:pe.executionSummary)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:["æ€»æ­¥éª¤: ",N.result.executionSummary.totalSteps]}),e.jsxs("div",{children:["æˆåŠŸ: ",N.result.executionSummary.successfulSteps]}),e.jsxs("div",{children:["è€—æ—¶: ",Math.round(N.result.executionSummary.totalTime/1e3),"s"]}),e.jsxs("div",{children:["å¤±è´¥: ",N.result.executionSummary.failedSteps]})]})})]})]}),e.jsx("div",{className:"h-32 bg-slate-900 overflow-y-auto p-3 text-xs font-mono",children:R.length===0?e.jsx("span",{className:"text-slate-600",children:"ç­‰å¾…æŒ‡ä»¤..."}):R.map(m=>e.jsxs("div",{className:"mb-1.5 flex gap-2",children:[e.jsxs("span",{className:`uppercase font-bold ${m.status==="success"?"text-green-400":m.status==="error"?"text-red-400":"text-yellow-400"}`,children:["[",m.status,"]"]}),e.jsx("span",{className:"text-slate-300",children:m.message})]},m.id))})]}):e.jsxs(e.Fragment,{children:[e.jsx(Nt,{onRulesChange:_e,onExecuteRules:De,executing:Te}),e.jsx("div",{className:"h-32 bg-slate-900 overflow-y-auto p-3 text-xs font-mono border-t border-slate-200",children:R.length===0?e.jsx("span",{className:"text-slate-600",children:"ç­‰å¾…è´¨é‡æ£€æŸ¥..."}):R.map(m=>e.jsxs("div",{className:"mb-1.5 flex gap-2",children:[e.jsxs("span",{className:`uppercase font-bold ${m.status==="success"?"text-green-400":m.status==="error"?"text-red-400":"text-yellow-400"}`,children:["[",m.status,"]"]}),e.jsx("span",{className:"text-slate-300",children:m.message})]},m.id))})]})}),e.jsx("div",{className:"flex-1 bg-slate-50 flex flex-col overflow-hidden",children:F==="quality"&&Q.length>0?e.jsx(St,{results:Q,batchResult:Pe||void 0,data:z||[],onIssueClick:xe,onClose:Fe}):M&&z?e.jsx(Ct,{data:z,issues:Q.flatMap(m=>m.issues),highlightedCell:Ie,onCellClick:xe,children:({getCellStyle:m,getCellClassName:g,handleCellClick:y})=>e.jsxs("div",{className:"flex-1 flex flex-col m-4 bg-white rounded-xl shadow border border-slate-200 overflow-hidden",children:[e.jsxs("div",{className:"p-3 border-b border-slate-100 flex justify-between items-center bg-white",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-bold text-slate-700",children:M.fileName}),Object.keys(M.sheets).length>1&&e.jsx("select",{value:c,onChange:u=>r(u.target.value),className:"text-xs px-2 py-1 bg-emerald-50 text-emerald-700 rounded-full border border-emerald-200 outline-none cursor-pointer hover:bg-emerald-100 transition-colors",children:Object.keys(M.sheets).map(u=>e.jsx("option",{value:u,children:u},u))}),Object.keys(M.sheets).length===1&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-slate-100 text-slate-500 rounded-full",children:c}),e.jsxs("span",{className:"text-xs text-slate-400",children:["(",z.length," è¡Œ)"]}),F==="quality"&&Q.length>0&&e.jsxs("span",{className:"text-xs px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full",children:[Q.reduce((u,C)=>u+C.issues.length,0)," ä¸ªé—®é¢˜"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>ge(M),className:"text-xs flex items-center gap-1 text-white bg-blue-600 hover:bg-blue-700 font-medium px-3 py-1.5 rounded-lg shadow-sm transition-all",title:"ä½¿ç”¨æ­¤æ•°æ®ç”Ÿæˆæ–‡æ¡£",children:[e.jsx(ve,{className:"w-3.5 h-3.5"})," å‘é€åˆ°ç”Ÿæˆå™¨"]}),e.jsxs("button",{onClick:()=>fe(M.sheets,M.fileName),className:"text-xs flex items-center gap-1 text-slate-600 hover:text-emerald-600 font-medium px-3 py-1.5 rounded-lg border border-slate-200 hover:border-emerald-200 hover:bg-emerald-50 transition-all",title:"å¯¼å‡ºæ‰€æœ‰å·¥ä½œè¡¨",children:[e.jsx(pt,{className:"w-3.5 h-3.5"})," å¯¼å‡ºæ–‡ä»¶ ",Object.keys(M.sheets).length>1&&`(${Object.keys(M.sheets).length}ä¸ªå·¥ä½œè¡¨)`]})]})]}),e.jsxs("div",{className:"flex-1 overflow-auto w-full",children:[e.jsxs("table",{className:"w-full text-left text-sm border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-12 p-2 bg-slate-50 border-b border-r border-slate-200 text-center text-slate-400 text-xs font-mono sticky top-0 z-10",children:"#"}),z.length>0&&Object.keys(z[0]).map(u=>e.jsx("th",{className:"p-2 border-b border-r border-slate-100 bg-slate-50 sticky top-0 font-semibold text-slate-600 whitespace-nowrap min-w-[100px] z-10",children:u},u))]})}),e.jsx("tbody",{children:z.slice(0,200).map((u,C)=>e.jsxs("tr",{className:"hover:bg-blue-50/30 border-b border-slate-50 last:border-0 group",children:[e.jsx("td",{className:"p-2 bg-slate-50 border-r border-slate-100 text-center text-slate-400 text-xs font-mono group-hover:bg-blue-50/30",children:C+1}),Object.entries(u).map(([$,k],E)=>e.jsx("td",{style:m(C,$),className:g(C,$),onClick:()=>y(C,$),children:String(k)},E))]},C))})]}),z.length===0&&e.jsx("div",{className:"p-10 text-center text-slate-400",children:"æ­¤è¡¨æ— æ•°æ®"}),z.length>200&&e.jsxs("div",{className:"p-2 text-center text-xs text-slate-400 bg-slate-50 border-t border-slate-100",children:["é¢„è§ˆå‰ 200 è¡Œ (å…± ",z.length," è¡Œ)"]})]})]})}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-slate-300",children:[e.jsx(ft,{className:"w-16 h-16 mb-4 opacity-20"}),e.jsx("p",{className:"font-medium",children:"é€‰æ‹©å·¦ä¾§æ–‡ä»¶ä»¥é¢„è§ˆæ•°æ®"})]})})]})]})};export{Lt as SmartExcel,Lt as default};
