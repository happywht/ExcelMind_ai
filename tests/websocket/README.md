# WebSocket 稳定性测试

**Week 0 技术验证 - WebSocket 实时通信稳定性测试**

## 📋 目录

- [概述](#概述)
- [测试场景](#测试场景)
- [快速开始](#快速开始)
- [测试报告](#测试报告)
- [验收标准](#验收标准)
- [故障排查](#故障排查)

---

## 概述

本测试套件用于验证 WebSocket 在 Phase 2 开发中的稳定性和性能，确保实时通信机制满足生产环境要求。

### 测试目标

| 场景 | 描述 | 验收标准 |
|------|------|----------|
| 连接稳定性 | 长连接保持 1 小时 | 无断线 |
| 重连机制 | 断线后自动重连 | 5秒内恢复 |
| 心跳检测 | 空闲连接检测 | 30秒超时 |
| 并发连接 | 10 个并发连接 | 无崩溃 |
| 消息顺序 | 乱序消息检测 | 严格顺序 |

### 性能指标

| 指标 | 目标值 | 测量方式 |
|------|--------|----------|
| 消息延迟 | < 100ms (P99) | 延迟测试 |
| 吞吐量 | > 100 msg/s | 吞吐量测试 |
| CPU 使用率 | < 20% | 资源监控 |
| 内存使用 | < 100MB | 资源监控 |

---

## 测试场景

### 1. 连接稳定性测试

**目的**: 验证长连接的稳定性

**测试步骤**:
1. 建立单个 WebSocket 连接
2. 保持连接 1 小时（演示版为 1 分钟）
3. 持续发送测试消息
4. 监控连接状态

**验证点**:
- ✅ 连接保持不中断
- ✅ 消息正常收发
- ✅ 无内存泄漏

### 2. 重连机制测试

**目的**: 验证自动重连功能

**测试步骤**:
1. 建立连接
2. 模拟服务器重启
3. 监控客户端重连行为
4. 测量重连时间

**验证点**:
- ✅ 自动检测断线
- ✅ 5秒内完成重连
- ✅ 重连后消息正常

### 3. 心跳检测测试

**目的**: 验证心跳机制

**测试步骤**:
1. 建立连接
2. 等待心跳消息
3. 测量心跳间隔
4. 测试超时检测

**验证点**:
- ✅ 心跳正常接收
- ✅ 心跳间隔 < 30秒
- ✅ 超时自动断开

### 4. 并发连接测试

**目的**: 验证服务器并发处理能力

**测试步骤**:
1. 创建 10 个并发连接
2. 所有连接同时发送消息
3. 监控服务器稳定性
4. 测量响应时间

**验证点**:
- ✅ 所有连接成功建立
- ✅ 服务器不崩溃
- ✅ 消息正确路由

### 5. 消息顺序测试

**目的**: 验证消息顺序保证

**测试步骤**:
1. 建立连接
2. 快速发送 100 条消息
3. 记录每条消息序列号
4. 验证接收顺序

**验证点**:
- ✅ 消息严格按序到达
- ✅ 无消息丢失
- ✅ 无消息重复

---

## 快速开始

### 安装依赖

```bash
npm install
```

### 运行快速测试

**快速验证基本功能**（推荐先运行）:

```bash
npm run test:websocket
```

### 运行完整测试套件

**稳定性测试**（所有 5 个场景）:

```bash
npm run test:websocket:stability
```

**性能测试**（延迟、吞吐量、资源）:

```bash
npm run test:websocket:performance
```

### 单独运行测试服务器

如果需要手动测试:

```bash
npm run test:websocket:server
```

服务器将在 `ws://localhost:8080` 启动。

---

## 测试报告

### 报告生成

测试完成后，报告会自动生成并保存到 `test-results/` 目录。

报告内容包括:
- 📊 测试结果汇总
- 📈 性能指标图表
- 🔍 详细测试数据
- 💡 优化建议

### 报告示例

```markdown
# WebSocket 稳定性测试报告

## 测试摘要
- 总测试数: 5
- 通过: 5
- 失败: 0
- 通过率: 100%

## 稳定性测试结果
### 1. 连接稳定性
✅ 通过 - 连接保持 1 小时无中断

### 2. 重连机制
✅ 通过 - 3.2秒内完成重连

...

## 性能测试结果
### 消息延迟
- P99: 85ms
- P95: 62ms
- 平均: 45ms

### 吞吐量
- 127 msg/s

### 资源使用
- CPU: 15.2%
- 内存: 78MB

## 验证结论
✅ **通过** - WebSocket 实现满足所有稳定性要求
```

---

## 验收标准

### 通过条件

✅ **无条件通过** (≥ 95% 测试通过)
- 所有关键测试通过
- 性能指标达标
- 可以进入 Phase 2

⚠️ **有条件通过** (80% - 94% 测试通过)
- 关键测试通过
- 部分性能指标未达标
- 需要优化建议

❌ **不通过** (< 80% 测试通过)
- 关键测试失败
- 必须修复后重新测试

### 关键测试

以下测试失败将导致**不通过**:
1. ❌ 连接稳定性测试
2. ❌ 重连机制测试
3. ❌ 消息顺序测试

以下测试失败允许**有条件通过**:
1. ⚠️ 心跳检测测试
2. ⚠️ 性能测试

---

## 故障排查

### 常见问题

#### 1. 端口已被占用

**错误**: `Error: listen EADDRINUSE: address already in use :::8080`

**解决方案**:
```bash
# Windows
netstat -ano | findstr :8080
taskkill /PID <PID> /F

# 或修改测试代码中的端口号
const PORT = 8081; // 改为其他端口
```

#### 2. 连接超时

**错误**: `Connection timeout`

**解决方案**:
- 检查防火墙设置
- 确保 WebSocket 服务器正在运行
- 增加超时时间

#### 3. 消息丢失

**错误**: 检测到消息丢失

**解决方案**:
- 检查网络稳定性
- 减少消息发送频率
- 增加缓冲区大小

#### 4. 内存泄漏

**错误**: 内存持续增长

**解决方案**:
- 检查事件监听器是否正确清理
- 确保连接关闭时释放资源
- 使用内存分析工具定位泄漏点

### 调试模式

启用详细日志:

```typescript
// 在测试文件中设置
const DEBUG = true;
```

### 手动测试

使用在线 WebSocket 测试工具:

1. 访问 [WebSocket Echo Test](https://www.websocket.org/echo.html)
2. 连接到 `ws://localhost:8080`
3. 发送测试消息

---

## 文件结构

```
tests/websocket/
├── WebSocketTestServer.ts      # 测试服务器
├── WebSocketTestClient.ts      # 测试客户端
├── WebSocketStabilityTest.ts   # 稳定性测试套件
├── WebSocketPerformanceTest.ts # 性能测试套件
├── WebSocketTestReport.ts      # 报告生成器
├── quickTest.ts                 # 快速测试
└── README.md                    # 本文档
```

---

## 下一步

测试通过后:

1. ✅ 将 WebSocket 集成到 Phase 2 架构
2. ✅ 实施生产环境监控
3. ✅ 设置告警机制
4. ✅ 定期执行压力测试

---

**文档版本**: v1.0
**创建日期**: 2026-01-24
**负责人**: DevOps 工程师
**状态**: ✅ 准备就绪

---

## 附录

### A. 测试命令参考

| 命令 | 描述 | 用时 |
|------|------|------|
| `npm run test:websocket` | 快速测试 | ~10 秒 |
| `npm run test:websocket:stability` | 稳定性测试 | ~5 分钟 |
| `npm run test:websocket:performance` | 性能测试 | ~2 分钟 |
| `npm run test:websocket:server` | 启动服务器 | 持续运行 |

### B. 性能基准

| 指标 | 最低要求 | 推荐值 | 理想值 |
|------|---------|--------|--------|
| P99 延迟 | < 150ms | < 100ms | < 50ms |
| 吞吐量 | > 50 msg/s | > 100 msg/s | > 200 msg/s |
| CPU 使用 | < 30% | < 20% | < 10% |
| 内存使用 | < 150MB | < 100MB | < 50MB |

### C. 联系方式

- **技术支持**: DevOps 团队
- **问题报告**: GitHub Issues
- **文档更新**: 提交 Pull Request
