<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide å†…å­˜å‹åŠ›æµ‹è¯• - Week 0 æŠ€æœ¯éªŒè¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .test-config {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-config h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .config-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .config-item .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .config-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-card .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .test-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-result-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }

        .test-result-item.failed {
            border-left-color: #dc3545;
        }

        .test-result-item.crashed {
            border-left-color: #ffc107;
        }

        .test-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .test-result-name {
            font-weight: bold;
            color: #333;
        }

        .test-result-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .test-result-status.pass {
            background: #d4edda;
            color: #155724;
        }

        .test-result-status.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .test-result-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .recommendations {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .recommendations h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 10px 0;
            color: #856404;
            border-bottom: 1px solid #ffc107;
        }

        .recommendations li:last-child {
            border-bottom: none;
        }

        .conclusion {
            text-align: center;
            padding: 30px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .conclusion.pass {
            background: #d4edda;
            color: #155724;
        }

        .conclusion.conditional {
            background: #fff3cd;
            color: #856404;
        }

        .conclusion.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .log-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-line {
            margin-bottom: 5px;
        }

        .log-line.error {
            color: #f48771;
        }

        .log-line.warn {
            color: #cca700;
        }

        .log-line.info {
            color: #4fc1ff;
        }

        .log-line.success {
            color: #89d185;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .memory-chart {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .memory-chart canvas {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª Pyodide å†…å­˜å‹åŠ›æµ‹è¯•</h1>
            <p>Week 0 æŠ€æœ¯éªŒè¯ - ExcelMind AI Phase 2</p>
        </div>

        <div class="content">
            <!-- æµ‹è¯•é…ç½® -->
            <div class="test-config">
                <h3>ğŸ“‹ æµ‹è¯•é…ç½®</h3>
                <div class="config-grid">
                    <div class="config-item">
                        <div class="label">å°æ–‡ä»¶æµ‹è¯•</div>
                        <div class="value">5 MB / 25K è¡Œ</div>
                    </div>
                    <div class="config-item">
                        <div class="label">ä¸­æ–‡ä»¶æµ‹è¯•</div>
                        <div class="value">15 MB / 75K è¡Œ</div>
                    </div>
                    <div class="config-item">
                        <div class="label">å¤§æ–‡ä»¶æµ‹è¯•</div>
                        <div class="value">30 MB / 150K è¡Œ</div>
                    </div>
                    <div class="config-item">
                        <div class="label">è¶…å¤§æ–‡ä»¶æµ‹è¯•</div>
                        <div class="value">50 MB / 250K è¡Œ</div>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button id="startTest" class="btn btn-primary">
                    <span>â–¶ï¸</span>
                    <span>å¼€å§‹æµ‹è¯•</span>
                </button>
                <button id="downloadReport" class="btn btn-secondary" disabled>
                    <span>ğŸ“¥</span>
                    <span>ä¸‹è½½æŠ¥å‘Š</span>
                </button>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div id="progressSection" class="progress-section">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
                </div>
                <div id="progressText" class="progress-text">å‡†å¤‡ä¸­...</div>
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div id="resultsSection" class="results-section">
                <!-- æ±‡æ€»å¡ç‰‡ -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="label">æ€»æµ‹è¯•æ•°</div>
                        <div id="totalTests" class="value">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">é€šè¿‡</div>
                        <div id="passedTests" class="value">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">å¤±è´¥</div>
                        <div id="failedTests" class="value">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">é€šè¿‡ç‡</div>
                        <div id="passRate" class="value">0%</div>
                    </div>
                </div>

                <!-- æµ‹è¯•ç»“æœ -->
                <div class="test-results">
                    <h3>ğŸ“Š è¯¦ç»†æµ‹è¯•ç»“æœ</h3>
                    <div id="testResultsList"></div>
                </div>

                <!-- å†…å­˜æ³„æ¼åˆ†æ -->
                <div class="test-results">
                    <h3>ğŸ” å†…å­˜æ³„æ¼åˆ†æ</h3>
                    <div id="leakAnalysis"></div>
                </div>

                <!-- å»ºè®® -->
                <div id="recommendations" class="recommendations" style="display: none;">
                    <h3>ğŸ’¡ å»ºè®®</h3>
                    <ul id="recommendationsList"></ul>
                </div>

                <!-- æœ€ç»ˆç»“è®º -->
                <div id="conclusion" class="conclusion"></div>

                <!-- å†…å­˜å›¾è¡¨ -->
                <div class="memory-chart">
                    <h3>ğŸ“ˆ å†…å­˜ä½¿ç”¨æ›²çº¿</h3>
                    <canvas id="memoryChart"></canvas>
                </div>

                <!-- æ—¥å¿—è¾“å‡º -->
                <div class="test-results">
                    <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
                    <div id="logOutput" class="log-output"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥æµ‹è¯•æ¨¡å—
        import { runPyodideMemoryStressTest } from './pyodide-memory-stress-test.ts';

        // å…¨å±€çŠ¶æ€
        let testReport = null;
        let logMessages = [];

        // DOM å…ƒç´ 
        const startButton = document.getElementById('startTest');
        const downloadButton = document.getElementById('downloadReport');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logMessages.push({ message: logMessage, type });

            const logOutput = document.getElementById('logOutput');
            const logLine = document.createElement('div');
            logLine.className = `log-line ${type}`;
            logLine.textContent = logMessage;
            logOutput.appendChild(logLine);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            progressFill.style.width = `${percent}%`;
            progressFill.textContent = `${percent}%`;
            progressText.textContent = text;
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(report) {
            resultsSection.classList.add('active');

            // æ±‡æ€»å¡ç‰‡
            document.getElementById('totalTests').textContent = report.summary.totalTests;
            document.getElementById('passedTests').textContent = report.summary.passed;
            document.getElementById('failedTests').textContent = report.summary.failed;
            document.getElementById('passRate').textContent = `${report.summary.passRate.toFixed(1)}%`;

            // æµ‹è¯•ç»“æœåˆ—è¡¨
            const testResultsList = document.getElementById('testResultsList');
            testResultsList.innerHTML = '';

            report.testResults.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = `test-result-item ${result.success ? '' : 'failed'} ${result.crashed ? 'crashed' : ''}`;

                const statusClass = result.success ? 'pass' : 'fail';
                const statusText = result.crashed ? 'ğŸ’¥ å´©æºƒ' : (result.success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥');

                item.innerHTML = `
                    <div class="test-result-header">
                        <div class="test-result-name">${index + 1}. ${result.testCase.name}</div>
                        <div class="test-result-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="test-result-metrics">
                        <div>ğŸ“Š å®é™…å†…å­˜: ${result.actualMaxMemory.toFixed(2)} MB</div>
                        <div>ğŸ¯ é¢„æœŸå†…å­˜: ${result.testCase.expectedMaxMemory} MB</div>
                        <div>â±ï¸ æ‰§è¡Œæ—¶é—´: ${result.executionTime} ms</div>
                    </div>
                    ${result.error ? `<div style="color: #dc3545; margin-top: 10px;">é”™è¯¯: ${result.error}</div>` : ''}
                `;

                testResultsList.appendChild(item);
            });

            // å†…å­˜æ³„æ¼åˆ†æ
            const leakAnalysis = document.getElementById('leakAnalysis');
            const severityColors = {
                'none': '#28a745',
                'low': '#ffc107',
                'medium': '#fd7e14',
                'high': '#dc3545',
                'critical': '#6f42c1'
            };

            leakAnalysis.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 5px;">æ³„æ¼æ£€æµ‹</div>
                        <div style="font-size: 24px; font-weight: bold;">
                            ${report.memoryLeakAnalysis.hasLeak ? 'âš ï¸ å‘ç°æ³„æ¼' : 'âœ… æ— æ³„æ¼'}
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 5px;">æ³„æ¼é€Ÿç‡</div>
                        <div style="font-size: 24px; font-weight: bold;">
                            ${report.memoryLeakAnalysis.leakRate.toFixed(2)} MB/æ–‡ä»¶
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 5px;">ä¸¥é‡ç¨‹åº¦</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${severityColors[report.memoryLeakAnalysis.severity]}">
                            ${report.memoryLeakAnalysis.severity.toUpperCase()}
                        </div>
                    </div>
                </div>
            `;

            // å»ºè®®
            if (report.recommendations.length > 0) {
                const recommendationsDiv = document.getElementById('recommendations');
                const recommendationsList = document.getElementById('recommendationsList');
                recommendationsDiv.style.display = 'block';
                recommendationsList.innerHTML = '';

                report.recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    recommendationsList.appendChild(li);
                });
            }

            // æœ€ç»ˆç»“è®º
            const conclusionDiv = document.getElementById('conclusion');
            const conclusionTexts = {
                'PASS': 'âœ… PASS - Pyodide å†…å­˜ç®¡ç†è¡¨ç°è‰¯å¥½ï¼Œå¯ä»¥è¿›å…¥ Phase 2',
                'CONDITIONAL_PASS': 'âš ï¸ CONDITIONAL_PASS - éœ€è¦å®æ–½ç¼“è§£æªæ–½åæ‰èƒ½è¿›å…¥ Phase 2',
                'FAIL': 'âŒ FAIL - ä¸¥é‡çš„å†…å­˜ç®¡ç†é—®é¢˜ï¼Œä¸å»ºè®®è¿›å…¥ Phase 2'
            };

            conclusionDiv.className = `conclusion ${report.riskAssessment === 'PASS' ? 'pass' : report.riskAssessment === 'CONDITIONAL_PASS' ? 'conditional' : 'fail'}`;
            conclusionDiv.textContent = conclusionTexts[report.riskAssessment];

            // ç»˜åˆ¶å†…å­˜å›¾è¡¨
            drawMemoryChart(report);

            // å¯ç”¨ä¸‹è½½æŒ‰é’®
            downloadButton.disabled = false;
        }

        // ç»˜åˆ¶å†…å­˜å›¾è¡¨
        function drawMemoryChart(report) {
            const canvas = document.getElementById('memoryChart');
            const ctx = canvas.getContext('2d');

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = 300 * 2;
            ctx.scale(2, 2);

            const width = canvas.offsetWidth;
            const height = 300;

            // æ”¶é›†æ‰€æœ‰å†…å­˜å¿«ç…§
            const allSnapshots = report.testResults.flatMap(r => r.memorySnapshots);

            if (allSnapshots.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ— å†…å­˜æ•°æ®', width / 2, height / 2);
                return;
            }

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const maxMemory = Math.max(...allSnapshots.map(s => s.usedJSHeapSize));
            const minMemory = Math.min(...allSnapshots.map(s => s.usedJSHeapSize));
            const memoryRange = maxMemory - minMemory;

            // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;

            for (let i = 0; i <= 4; i++) {
                const y = (height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }

            // ç»˜åˆ¶å†…å­˜æ›²çº¿
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();

            allSnapshots.forEach((snapshot, index) => {
                const x = (index / (allSnapshots.length - 1)) * width;
                const y = height - ((snapshot.usedJSHeapSize - minMemory) / memoryRange) * height;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // ç»˜åˆ¶é˜ˆå€¼çº¿
            const thresholdLine = report.testResults[0]?.testCase.expectedMaxMemory * 1024 * 1024 * 1.2;
            if (thresholdLine) {
                const y = height - ((thresholdLine - minMemory) / memoryRange) * height;

                ctx.strokeStyle = '#dc3545';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = '#dc3545';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(`é˜ˆå€¼: ${(thresholdLine / 1024 / 1024).toFixed(0)} MB`, width - 10, y - 5);
            }
        }

        // ä¸‹è½½æŠ¥å‘Š
        function downloadReport() {
            if (!testReport) return;

            const reportContent = JSON.stringify(testReport, null, 2);
            const blob = new Blob([reportContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `pyodide-memory-test-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // è¿è¡Œæµ‹è¯•
        async function runTest() {
            startButton.disabled = true;
            progressSection.classList.add('active');
            resultsSection.classList.remove('active');

            log('å¼€å§‹ Pyodide å†…å­˜å‹åŠ›æµ‹è¯•...', 'info');
            updateProgress(5, 'åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...');

            try {
                // æ‹¦æˆª console.log ä»¥æ˜¾ç¤ºåœ¨æ—¥å¿—åŒºåŸŸ
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;

                console.log = (...args) => {
                    originalLog.apply(console, args);
                    log(args.join(' '), 'info');
                };

                console.error = (...args) => {
                    originalError.apply(console, args);
                    log(args.join(' '), 'error');
                };

                console.warn = (...args) => {
                    originalWarn.apply(console, args);
                    log(args.join(' '), 'warn');
                };

                // è¿è¡Œæµ‹è¯•
                updateProgress(10, 'è¿è¡Œæµ‹è¯•ä¸­...');
                testReport = await runPyodideMemoryStressTest();

                // æ¢å¤ console
                console.log = originalLog;
                console.error = originalError;
                console.warn = originalWarn;

                updateProgress(100, 'æµ‹è¯•å®Œæˆï¼');
                log('æµ‹è¯•å®Œæˆï¼', 'success');

                // æ˜¾ç¤ºç»“æœ
                setTimeout(() => {
                    displayResults(testReport);
                }, 500);

            } catch (error) {
                log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                updateProgress(0, 'æµ‹è¯•å¤±è´¥');
            } finally {
                startButton.disabled = false;
            }
        }

        // äº‹ä»¶ç›‘å¬
        startButton.addEventListener('click', runTest);
        downloadButton.addEventListener('click', downloadReport);

        // åˆå§‹åŒ–
        log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
    </script>
</body>
</html>
